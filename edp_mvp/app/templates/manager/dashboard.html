{% extends "manager/base_manager.html" %}

{% block title %}Dashboard Ejecutivo - EDP Manager{% endblock %}

{% block content %}

<div class="container mx-auto px-4 py-6 space-y-6">
<div id="charts-data" class="hidden">{{ charts_data | safe }}</div> <!-- Story-telling headline -->
  <div class="bg-[color:var(--bg-subtle)] border-l-4 border-[color:var(--accent-blue)] p-4 rounded-lg shadow-lg relative mb-6">
    <h2 class="font-bold text-lg">
      {% if kpis.vs_meta_ingresos > 0 %}
      Ingresos {{ kpis.vs_meta_ingresos }}% sobre meta, 
      {% else %}
      Ingresos {{ kpis.vs_meta_ingresos|abs }}% bajo meta, 
      {% endif %}
      pero cobranza en riesgo ${{ kpis.monto_pendiente }}M; 
      <span class="{% if kpis.concentracion_atraso > 50 %}text-red-500 dark:text-red-400{% endif %}">
        {{ kpis.proyectos_criticos }} proyectos concentran {{ kpis.concentracion_atraso }}% del atraso
      </span>
    </h2>
  </div>

  <!-- Header con KPIs principales y filtros -->
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
    <div>
      <h1 class="text-3xl font-bold text-[color:var(--text-primary)]">Dashboard Ejecutivo</h1>
      <p class="text-[color:var(--text-secondary)]">Vista panorámica del rendimiento empresarial</p>
    </div>
    
    <!-- Filtros mejorados -->
    <div class="flex flex-wrap gap-2">
      <form class="flex flex-wrap gap-2" method="get" id="dashboard-filters">
        <!-- Rango de fecha personalizado -->
        <div class="flex items-center gap-1">
          <input type="date" name="fecha_inicio" value="{{ fecha_inicio|default('') }}" 
            class="bg-[color:var(--bg-card)] text-[color:var(--text-primary)] border border-[color:var(--border-color)] rounded-lg px-2 py-2 text-sm w-32 dark:color-scheme-dark">
          <span class="text-[color:var(--text-primary)]">a</span>
          <input type="date" name="fecha_fin" value="{{ fecha_fin|default('') }}" 
            class="bg-[color:var(--bg-card)] text-[color:var(--text-primary)] border border-[color:var(--border-color)] rounded-lg px-2 py-2 text-sm w-32 dark:color-scheme-dark">
        </div>
        
        <!-- Selector de periodo predefinido -->
        <select name="periodo" class="bg-[color:var(--bg-card)] text-[color:var(--text-primary)] border border-[color:var(--border-color)] rounded-lg px-3 py-2 text-sm">
          <option value="all_dates" {% if periodo == 'all_dates' %}selected{% endif %}>Todos</option>
          <option value="mes" {% if periodo == 'mes' %}selected{% endif %}>Este Mes</option>
          <option value="trimestre" {% if periodo == 'trimestre' %}selected{% endif %}>Trimestre</option>
          <option value="año" {% if periodo == 'año' %}selected{% endif %}>Año</option>
        </select>
        
        <!-- Selector de gestor -->
        <select name="departamento" class="bg-[color:var(--bg-card)] text-[color:var(--text-primary)] border border-[color:var(--border-color)] rounded-lg px-3 py-2 text-sm">
          <option value="todos" {% if departamento == 'todos' %}selected{% endif %}>Todos los gestores</option>
          {% for gestor in gestores %}
          <option value="{{ gestor.nombre }}" {% if departamento == gestor.nombre %}selected{% endif %}>{{ gestor.nombre }}</option>
          {% endfor %}
        </select>
        
        <!-- Selector de cliente (nuevo) -->
        <select name="cliente" class="bg-[color:var(--bg-card)] text-[color:var(--text-primary)] border border-[color:var(--border-color)] rounded-lg px-3 py-2 text-sm">
          <option value="todos" {% if cliente == 'todos' %}selected{% endif %}>Todos los clientes</option>
          {% for cliente in clientes %}
          <option value="{{ cliente.nombre }}" {% if cliente_seleccionado == cliente.nombre %}selected{% endif %}>{{ cliente.nombre }}</option>
          {% endfor %}
        </select>
        
        <!-- Selector de estado (nuevo) -->
        <select name="estado" class="bg-[color:var(--bg-card)] text-[color:var(--text-primary)] border border-[color:var(--border-color)] rounded-lg px-3 py-2 text-sm">
          <option value="todos" {% if estado == 'todos' %}selected{% endif %}>Todos los estados</option>
          <option value="a_tiempo" {% if estado == 'a_tiempo' %}selected{% endif %}>A tiempo</option>
          <option value="en_riesgo" {% if estado == 'en_riesgo' %}selected{% endif %}>En riesgo</option>
          <option value="retrasado" {% if estado == 'retrasado' %}selected{% endif %}>Retrasado</option>
        </select>
        
        <button type="submit" class="bg-[color:var(--accent-blue)] text-white rounded-lg px-3 py-2 text-sm hover:bg-blue-600 transition">
          Aplicar Filtros
        </button>
        
        <button type="button" class="text-[color:var(--text-secondary)] hover:text-[color:var(--text-primary)] rounded-lg px-3 py-2 text-sm border border-[color:var(--border-color)] transition" onclick="resetFilters()">
          Restablecer
        </button>
      </form>
      
      <!-- Botón de exportación -->
      <button class="flex items-center gap-2 bg-[color:var(--bg-card)] text-[color:var(--text-primary)] border border-[color:var(--border-color)] rounded-lg px-3 py-2 text-sm hover:bg-[color:var(--bg-highlight)] transition" id="export-dashboard">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg>
        Exportar
      </button>
    </div>
  </div>
  
  <!-- KPIs Principales - Primera fila con contexto aumentado -->
  <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
    <!-- KPI: Ingresos totales con contexto y más detalles -->
    <div class="bg-gradient-to-br from-green-600 to-green-700 rounded-xl p-5 text-white shadow-lg relative">
      <div class="absolute top-2 right-2">
        <button class="text-white/80 hover:text-white" aria-label="Ver detalles de ingresos" title="Ver detalles" data-tooltip="Incluye todos los ingresos facturados en el período seleccionado">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
          </svg>
        </button>
      </div>
      <div class="flex justify-between items-start">
        <div>
          <p class="text-emerald-100 text-sm font-medium">Ingresos Totales</p>
          <p class="text-3xl font-bold mt-1">${{ kpis.ingresos_totales }}M</p>
          <div class="flex items-center mt-1">
            <svg class="w-4 h-4 mr-1 {% if kpis.crecimiento_ingresos < 0 %}rotate-180 text-red-300{% else %}text-emerald-200{% endif %}" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
            </svg>
            <span class="text-sm {% if kpis.crecimiento_ingresos < 0 %}text-red-300{% endif %}">{{ kpis.crecimiento_ingresos|abs }}% {% if kpis.crecimiento_ingresos < 0 %}menos{% endif %} vs periodo anterior</span>
          </div>
          
          <!-- Meta vs Actual - Contexto añadido -->
          <div class="mt-3 pt-2 border-t border-white/20">
            <div class="flex justify-between items-center mb-1">
              <span class="text-xs text-emerald-100">Meta: ${{ kpis.meta_ingresos }}M</span>
              <span class="text-xs {% if kpis.vs_meta_ingresos >= 0 %}text-emerald-200{% else %}text-red-300{% endif %}">
                {{ kpis.vs_meta_ingresos|abs }}% 
                {% if kpis.vs_meta_ingresos >= 0 %}sobre meta{% else %}bajo meta{% endif %}
              </span>
            </div>
            <div class="w-full bg-emerald-700/40 rounded-full h-1.5">
              <div class="bg-white h-1.5 rounded-full" style="width: {{ kpis.pct_meta_ingresos }}%"></div>
            </div>
          </div>
        </div>
        <span class="w-10 h-10 rounded-full bg-white bg-opacity-20 flex items-center justify-center">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
          </svg>
        </span>
      </div>
    </div>
    
    <!-- KPI: Proyectos Activos con contexto y más detalles -->
    <div class="bg-gradient-to-br from-blue-600 to-blue-700 rounded-xl p-5 text-white shadow-lg relative">
      <div class="absolute top-2 right-2">
        <button class="text-white/80 hover:text-white" aria-label="Ver detalles de proyectos" title="Ver detalles" data-tooltip="Proyectos con actividad en los últimos 30 días">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
          </svg>
        </button>
      </div>
      <div class="flex justify-between items-start">
        <div>
          <p class="text-blue-100 text-sm font-medium">Proyectos Activos</p>
          <p class="text-3xl font-bold mt-1">{{ kpis.proyectos_activos }}</p>
          <div class="flex items-center mt-1">
            <span class="text-sm">{{ kpis.proyectos_on_time }}% a tiempo</span>
          </div>
          
          <!-- Desglose de proyectos - Contexto añadido -->
          <div class="mt-3 space-y-1.5">
            <div class="flex justify-between text-xs">
              <span class="text-blue-100">A tiempo:</span>
              <span class="font-medium">{{ kpis.num_proyectos_on_time }}</span>
            </div>
            <div class="flex justify-between text-xs">
              <span class="text-blue-100">En riesgo:</span>
              <span class="font-medium">{{ kpis.num_proyectos_riesgo }}</span>
            </div>
            <div class="flex justify-between text-xs">
              <span class="text-blue-100">Retrasados:</span>
              <span class="font-medium">{{ kpis.num_proyectos_retrasados }}</span>
            </div>
          </div>
        </div>
        <span class="w-10 h-10 rounded-full bg-white bg-opacity-20 flex items-center justify-center">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
          </svg>
        </span>
      </div>
    </div>
    
    <!-- KPI: Calidad - Con definición clara y contexto -->
    <div class="bg-gradient-to-br from-purple-600 to-purple-700 rounded-xl p-5 text-white shadow-lg relative">
      <div class="absolute top-2 right-2">
        <button class="text-white/80 hover:text-white" aria-label="Ver definición de calidad" title="Ver definición" data-tooltip="Índice que combina conformidad de entregables (40%), satisfacción del cliente (40%) y auditorías internas (20%)">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
          </svg>
        </button>
      </div>
      <div class="flex justify-between items-start">
        <div>
          <p class="text-purple-100 text-sm font-medium">Índice de Calidad</p>
          <p class="text-3xl font-bold mt-1">{{ kpis.indice_calidad }}%</p>
          <div class="flex items-center mt-1">
            <svg class="w-4 h-4 mr-1 {% if kpis.retrabajos_reducidos < 0 %}rotate-180 text-red-300{% else %}text-purple-200{% endif %}" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
            </svg>
            <span class="text-sm">+{{ kpis.retrabajos_reducidos }}% mejora</span>
          </div>
          
          <!-- Componentes de calidad -->
          <div class="mt-3 space-y-1.5">
            <div class="flex justify-between text-xs">
              <span class="text-purple-100">Conformidad:</span>
              <span class="font-medium">{{ kpis.tasa_conformidad }}%</span>
            </div>
            <div class="flex justify-between text-xs">
              <span class="text-purple-100">Satisfacción:</span>
              <span class="font-medium">{{ kpis.satisfaccion_cliente }}%</span>
            </div>
            <div class="flex justify-between text-xs">
              <span class="text-purple-100">Auditorías:</span>
              <span class="font-medium">{{ kpis.auditorias_aprobadas }}%</span>
            </div>
          </div>
        </div>
        <span class="w-10 h-10 rounded-full bg-white bg-opacity-20 flex items-center justify-center">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
          </svg>
        </span>
      </div>
    </div>
    
    <!-- KPI: Satisfacción del Cliente - Con contexto y benchmarks -->
    <div class="bg-gradient-to-br from-gray-600 to-gray-700 rounded-xl p-5 text-white shadow-lg relative">
      <div class="absolute top-2 right-2">
        <button class="text-white/80 hover:text-white" aria-label="Ver detalles de satisfacción" title="Ver detalles" data-tooltip="Promedio ponderado de encuestas de satisfacción post-proyecto">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
          </svg>
        </button>
      </div>
      <div class="flex justify-between items-start">
        <div>
          <p class="text-amber-100 text-sm font-medium">Satisfacción Cliente</p>
          <p class="text-3xl font-bold mt-1">{{ kpis.satisfaccion_cliente }}%</p>
          <div class="flex items-center mt-1">
            <span class="text-sm">{{kpis.roi_promedio}}% ROI promedio</span>
          </div>
          
          <!-- Comparativa con industria - Contexto de benchmark -->
          <div class="mt-3 space-y-1.5">
            <div class="flex justify-between text-xs">
              <span class="text-amber-100">Benchmark industria:</span>
              <span class="font-medium">85%</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-xs text-amber-100">NPS:</span>
              <span class="text-xs font-medium">
                <span class="px-1.5 py-0.5 bg-amber-700 text-amber-100 rounded">{{ kpis.nps_score }}</span>
                {% if kpis.nps_score > 50 %}Excelente{% elif kpis.nps_score > 30 %}Bueno{% else %}Mejorable{% endif %}
              </span>
            </div>
          </div>
        </div>
        <span class="w-10 h-10 rounded-full bg-white bg-opacity-20 flex items-center justify-center">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v1h8v-1zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-1a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v1h-3zM4.75 12.094A5.973 5.973 0 004 15v1H1v-1a3 3 0 013.75-2.906z"></path>
          </svg>
        </span>
      </div>
    </div>
  </div>
  
  <!-- KPIs Financieros conectados - Segunda fila mejorada -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
    <!-- KPI: Monto Pendiente con DSO mejorado y contexto -->
    <div class="bg-[color:var(--bg-card)] p-4 rounded-xl border border-[color:var(--border-color)] shadow-lg relative">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-[color:var(--text-secondary)]">Monto Pendiente</p>
          <p class="text-xl font-bold mt-1">${{ kpis.monto_pendiente }}M</p>
          <div class="flex items-center mt-1">
            <span class="text-xs {% if kpis.tendencia_pendiente > 0 %}text-red-500 dark:text-red-400{% else %}text-green-500 dark:text-green-400{% endif %}">
              {% if kpis.tendencia_pendiente > 0 %}+{% endif %}{{ kpis.tendencia_pendiente }}% vs mes anterior
            </span>
          </div>
        </div>
        <span class="w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center text-blue-600 dark:text-blue-300">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"></path>
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd"></path>
          </svg>
        </span>
      </div>
      <div class="flex items-center justify-between mt-2">
        <div>
          <span class="text-xs text-[color:var(--text-secondary)]">DSO:</span>
          <span class="text-xs font-medium ml-1">{{ kpis.dso }} días</span>
        </div>
        <div>
          <span class="text-xs {% if kpis.dso > 90 %}text-red-500 dark:text-red-400{% else %}text-[color:var(--text-secondary)]{% endif %}">
            (Industria: 90 días)
          </span>
        </div>
      </div>
    </div>
    
    <!-- KPI: Monto Pendiente Crítico - Separado claramente del total -->
    <div class="bg-[color:var(--bg-card)] p-4 rounded-xl border border-[color:var(--border-color)] shadow-lg relative">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-[color:var(--text-secondary)]">Monto Crítico (>90d)</p>
          <p class="text-xl font-bold mt-1 text-red-600">${{ kpis.monto_pendiente_critico }}M</p>
          <div class="flex items-center mt-1">
            <span class="text-xs text-[color:var(--text-secondary)]">{{ kpis.pct_critico }}% del total pendiente</span>
          </div>
        </div>
        <span class="w-8 h-8 rounded-full bg-red-100 dark:bg-red-900 flex items-center justify-center text-red-600 dark:text-red-300">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
          </svg>
        </span>
      </div>
      <div class="flex items-center justify-between mt-2">
        <span class="text-xs text-[color:var(--text-secondary)]">Costo financiero:</span>
        <span class="text-xs font-medium ml-1 text-red-600 dark:text-red-400">${{ kpis.costo_financiero }}M</span>
      </div>
    </div>
    
    <!-- KPI: Eficiencia Operativa - Nuevo KPI consolidado -->
    <div class="bg-[color:var(--bg-card)] p-4 rounded-xl border border-[color:var(--border-color)] shadow-lg relative">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-[color:var(--text-secondary)]">Eficiencia Operativa</p>
          <p class="text-xl font-bold mt-1">{{ kpis.eficiencia_global }}%</p>
          <div class="flex items-center mt-1">
            <span class="text-xs {% if kpis.mejora_eficiencia > 0 %}text-green-500 dark:text-green-400{% else %}text-red-500 dark:text-red-400{% endif %}">
              {% if kpis.mejora_eficiencia > 0 %}+{% endif %}{{ kpis.mejora_eficiencia }}% YoY
            </span>
          </div>
        </div>
        <span class="w-8 h-8 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center text-green-600 dark:text-green-300">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 5.943 14.478 3 10 3a9.958 9.958 0 00-4.512 1.074l-1.78-1.781zm4.261 4.26l1.514 1.515a2.003 2.003 0 012.45 2.45l1.514 1.514a4 4 0 00-5.478-5.478z" clip-rule="evenodd"></path>
            <path d="M12.454 16.697L9.75 13.992a4 4 0 01-3.742-3.741L2.335 6.578A9.98 9.98 0 00.458 10c1.274 4.057 5.065 7 9.542 7 .847 0 1.669-.105 2.454-.303z"></path>
          </svg>
        </span>
      </div>
      <div class="flex items-center justify-between mt-2">
        <span class="text-xs text-[color:var(--text-secondary)]">Tiempo medio por ciclo:</span>
        <span class="text-xs font-medium ml-1">{{ kpis.tiempo_medio_ciclo }} días</span>
      </div>
    </div>
    
    <!-- KPI: Proyectos Críticos - con acciones directas -->
    <div class="bg-[color:var(--bg-card)] p-4 rounded-xl border border-[color:var(--border-color)] shadow-lg relative">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-[color:var(--text-secondary)]">Proyectos Críticos</p>
          <p class="text-xl font-bold mt-1">{{ kpis.proyectos_criticos }}</p>
          <div class="flex items-center mt-1">
            <span class="text-xs text-[color:var(--text-secondary)]">${{ kpis.valor_proyectos_criticos }}M en riesgo</span>
          </div>
        </div>
        <span class="w-8 h-8 rounded-full bg-amber-100 dark:bg-amber-900 flex items-center justify-center text-amber-600 dark:text-amber-300">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 1.944A11.954 11.954 0 012.166 5C2.056 5.649 2 6.319 2 7c0 5.225 3.34 9.67 8 11.317C14.66 16.67 18 12.225 18 7c0-.682-.057-1.35-.166-2.001A11.954 11.954 0 0110 1.944zM11 14a1 1 0 11-2 0 1 1 0 012 0zm0-7a1 1 0 10-2 0v3a1 1 0 102 0V7z" clip-rule="evenodd"></path>
          </svg>
        </span>
      </div>
      <!-- Botón de acción directa -->
      <button class="w-full mt-2 text-xs py-1 px-2 bg-amber-100 hover:bg-amber-200 dark:bg-amber-900 dark:hover:bg-amber-800 text-amber-800 dark:text-amber-200 rounded flex items-center justify-center font-medium transition-colors">
        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
          <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>
          <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path>
        </svg>
        Ver proyectos críticos
      </button>
    </div>
  </div>
  
  <!-- Gráficos principales mejorados -->
  <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
    <!-- Gráfico de tendencia financiera con comparativos -->
    <div class="bg-[color:var(--bg-card)] p-5 rounded-xl border border-[color:var(--border-color)] shadow-lg relative">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-bold">Tendencia Financiera</h2>
        <div class="flex items-center space-x-3">
          <button class="text-xs px-2 py-1 rounded bg-[color:var(--bg-subtle)] text-[color:var(--text-secondary)] border border-[color:var(--border-color)] hover:bg-[color:var(--bg-card)] active-chart-btn" data-chart-view="ingresos">Ingresos</button>
          <button class="text-xs px-2 py-1 rounded bg-[color:var(--bg-subtle)] text-[color:var(--text-secondary)] border border-[color:var(--border-color)] hover:bg-[color:var(--bg-card)]" data-chart-view="margen">Margen</button>
          <button class="text-xs px-2 py-1 rounded bg-[color:var(--bg-subtle)] text-[color:var(--text-secondary)] border border-[color:var(--border-color)] hover:bg-[color:var(--bg-card)]" data-chart-view="cashflow">Cash Flow</button>
        </div>
      </div>
      <div class="h-80">
        <canvas id="financialTrendChart"></canvas>
      </div>
      <!-- Leyenda mejorada con comparativos -->
      <div class="mt-4 grid grid-cols-4 text-center text-xs border-t border-[color:var(--border-color-subtle)] pt-3">
        <div>
          <p class="text-[color:var(--text-secondary)]">YTD</p>
          <p class="font-medium">${{ kpis.ingresos_ytd }}M</p>
        </div>
        <div>
          <p class="text-[color:var(--text-secondary)]">Meta anual</p>
          <p class="font-medium">${{ kpis.meta_anual }}M</p>
        </div>
        <div>
          <p class="text-[color:var(--text-secondary)]">Proyección</p>
          <p class="font-medium">${{ kpis.proyeccion_anual }}M</p>
        </div>
        <div>
          <p class="text-[color:var(--text-secondary)]">Año anterior</p>
          <p class="font-medium">${{ kpis.ingresos_ano_anterior }}M</p>
        </div>
      </div>
    </div>
    
    <!-- Distribución de proyectos - Ahora con bubble chart -->
    <div class="bg-[color:var(--bg-card)] p-5 rounded-xl border border-[color:var(--border-color)] shadow-lg relative">
      <h2 class="text-lg font-bold mb-4">Estado de Proyectos</h2>
      <div class="flex flex-col md:flex-row h-80">
        <div class="w-full md:w-1/2 mb-4 md:mb-0 md:pr-4 relative">
          <!-- Toggle entre visualizaciones -->
          <div class="absolute top-0 left-0 z-10 flex space-x-1">
            <button class="text-xs px-2 py-1 rounded bg-[color:var(--bg-card)] border border-[color:var(--border-color)] active-view-btn" data-view="chart">
              Gráfica
            </button>
            <button class="text-xs px-2 py-1 rounded bg-[color:var(--bg-subtle)] text-[color:var(--text-secondary)] border border-[color:var(--border-color)]" data-view="bubble">
              Mapa riesgo
            </button>
          </div>
          
          <!-- Vista 1: Gráfica de pastel -->
          <div id="project-chart-view">
            <canvas id="projectStatusChart"></canvas>
          </div>
          
          <!-- Vista 2: Bubble chart de riesgos (inicialmente oculta) -->
          <div id="project-bubble-view" class="hidden h-full">
            <canvas id="projectBubbleChart"></canvas>
          </div>
        </div>
        
        <div class="w-full md:w-1/2 flex flex-col justify-center">
          <div class="space-y-4">
            <!-- Estado de proyectos detalle -->
            <div class="flex items-center justify-between">
              <div class="flex items-center">
                <span class="w-3 h-3 rounded-full bg-[#10B981] mr-2"></span>
                <span>A tiempo</span>
              </div>
              <span class="font-semibold">{{ kpis.proyectos_on_time }}%</span>
            </div>
            
            <div class="flex items-center justify-between">
              <div class="flex items-center">
                <span class="w-3 h-3 rounded-full bg-[#FBBF24] mr-2"></span>
                <span>En riesgo</span>
              </div>
              <span class="font-semibold">{{ 100 - kpis.proyectos_on_time - kpis.proyectos_retrasados }}%</span>
            </div>
            
            <div class="flex items-center justify-between">
              <div class="flex items-center">
                <span class="w-3 h-3 rounded-full bg-[#F87171] mr-2"></span>
                <span>Retrasados</span>
              </div>
              <span class="font-semibold">{{ kpis.proyectos_retrasados }}%</span>
            </div>
            
            <div class="flex items-center justify-between">
              <div class="flex items-center">
                <span class="w-3 h-3 rounded-full bg-[#60A5FA] mr-2"></span>
                <span>Completados</span>
              </div>
              <span class="font-semibold">{{ kpis.pct_avance }}%</span>
            </div>
          </div>
          
          <!-- Acciones rápidas con menú expandible -->
          <div class="mt-6">
            <button id="project-actions-btn" class="w-full bg-[color:var(--accent-blue)] hover:bg-blue-600 text-white py-2 px-4 rounded-lg text-sm font-medium transition flex items-center justify-center">
              <span>Acciones de proyecto</span>
              <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            
            <!-- Menú de acciones (inicialmente oculto) -->
            <div id="project-actions-menu" class="hidden mt-2 space-y-2 p-2 bg-[color:var(--bg-subtle)] border border-[color:var(--border-color)] rounded-lg">
              <a href="#" class="block text-sm py-1.5 px-3 rounded hover:bg-[color:var(--bg-card)] transition">
                Ver proyectos en riesgo
              </a>
              <a href="#" class="block text-sm py-1.5 px-3 rounded hover:bg-[color:var(--bg-card)] transition">
                Gestionar planificación
              </a>
              <a href="#" class="block text-sm py-1.5 px-3 rounded hover:bg-[color:var(--bg-card)] transition">
                Asignar recursos
              </a>
              <a href="#" class="block text-sm py-1.5 px-3 rounded hover:bg-[color:var(--bg-card)] transition">
                Actualizar estado
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Financieros conectados y mejorados -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Proyección cash-in conectada con aging buckets -->
    <div class="bg-[color:var(--bg-card)] p-5 rounded-xl border border-[color:var(--border-color)] shadow-lg relative">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-bold">Cash-In Forecast</h2>
        <div class="flex space-x-1">
          <span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 rounded-md">30-60-90d</span>
          <button class="text-[color:var(--text-secondary)] hover:text-[color:var(--text-primary)]" title="Ver metodología de cálculo" data-tooltip="Basado en fechas de conformidad estimadas y probabilidad histórica de cumplimiento por cliente">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
            </svg>
          </button>
        </div>
      </div>
      <div class="h-60">
        <canvas id="cashInForecastChart"></canvas>
      </div>
      <div class="mt-4 pt-4 border-t border-[color:var(--border-color-subtle)]">
        <div class="grid grid-cols-3 gap-2 text-center text-xs">
          <div>
            <p class="text-[color:var(--text-secondary)]">30 días</p>
            <p id="forecast-30d" class="font-medium text-sm mt-1">${{ cash_forecast.total_30d|default('...') }}M</p>
            <p class="text-[color:var(--text-tertiary)] text-xs">{{ cash_forecast.prob_30d|default('...') }}% prob.</p>
          </div>
          <div>
            <p class="text-[color:var(--text-secondary)]">60 días</p>
            <p id="forecast-60d" class="font-medium text-sm mt-1">${{ cash_forecast.total_60d|default('...') }}M</p>
            <p class="text-[color:var(--text-tertiary)] text-xs">{{ cash_forecast.prob_60d|default('...') }}% prob.</p>
          </div>
          <div>
            <p class="text-[color:var(--text-secondary)]">90 días</p>
            <p id="forecast-90d" class="font-medium text-sm mt-1">${{ cash_forecast.total_90d|default('...') }}M</p>
            <p class="text-[color:var(--text-tertiary)] text-xs">{{ cash_forecast.prob_90d|default('...') }}% prob.</p>
          </div>
        </div>
        <div class="mt-3 text-center">
          <p class="text-[color:var(--text-secondary)] text-xs">Total ponderado:</p>
          <p id="forecast-weighted" class="font-semibold text-sm mt-1">${{ cash_forecast.total_ponderado|default('...') }}M</p>
          <div class="mt-2">
            <button class="text-xs text-[color:var(--accent-blue)] hover:underline flex items-center mx-auto">
              <svg class="w-3.5 h-3.5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
              </svg>
              Ajustar escenarios
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Rentabilidad por departamento - con benchmarks y contexto -->
    <div class="bg-[color:var(--bg-card)] p-5 rounded-xl border border-[color:var(--border-color)] shadow-lg relative">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-bold">Rentabilidad por Gestor</h2>
        <button class="text-xs px-2 py-1 rounded bg-[color:var(--bg-subtle)] text-[color:var(--text-secondary)] border border-[color:var(--border-color)] hover:bg-[color:var(--bg-card)]" title="Cambiar vista" id="toggle-profit-view">
          Vista %
        </button>
      </div>
      <div class="h-72">
        <canvas id="departmentProfitChart"></canvas>
      </div>
      
      <!-- Contexto de meta y benchmark -->
      <div class="mt-3 border-t border-[color:var(--border-color-subtle)] pt-3 flex justify-between items-center">
        <span class="text-xs text-[color:var(--text-secondary)]">Meta de rentabilidad: {{ kpis.meta_rentabilidad }}%</span>
        <button class="text-xs text-[color:var(--accent-blue)] hover:underline flex items-center">
          Análisis detallado
          <svg class="w-3 h-3 ml-1" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
          </svg>
        </button>
      </div>
    </div>
    
    <!-- Distribución por Cliente - con análisis de concentración -->
    <div class="bg-[color:var(--bg-card)] p-5 rounded-xl border border-[color:var(--border-color)] shadow-lg relative">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-bold">Distribución por Cliente</h2>
        <div class="text-xs px-2 py-1 rounded {% if kpis.concentracion_clientes > 70 %}bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200{% elif kpis.concentracion_clientes > 50 %}bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200{% else %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200{% endif %}">
          {{ kpis.concentracion_clientes }}% en Top 5
        </div>
      </div>
      <div class="h-72">
        <canvas id="budgetDistributionChart"></canvas>
      </div>
      <!-- Análisis de riesgo de concentración -->
      <div class="mt-3 text-xs text-[color:var(--text-secondary)] border-t border-[color:var(--border-color-subtle)] pt-3">
        {% if kpis.concentracion_clientes > 70 %}
        <p class="flex items-center text-red-500 dark:text-red-400">
          <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
          </svg>
          Alta concentración: riesgo de dependencia significativo
        </p>
        {% elif kpis.concentracion_clientes > 50 %}
        <p class="flex items-center text-amber-500 dark:text-amber-400">
          <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
          </svg>
          Concentración moderada: diversificar cartera
        </p>
        {% else %}
        <p class="flex items-center text-green-500 dark:text-green-400">
          <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
          </svg>
          Buena diversificación: riesgo controlado
        </p>
        {% endif %}
      </div>
    </div>
  </div>
  
  <!-- Tercera fila de gráficos y alertas -->
  <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
    <!-- Aging Buckets conectados con la proyección de cash -->
    <div class="bg-[color:var(--bg-card)] p-5 rounded-xl border border-[color:var(--border-color)] shadow-lg relative lg:col-span-2">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-bold">Distribución por Antigüedad</h2>
        <div class="flex items-center">
          <!-- Benchmarks industry -->
          <span class="text-xs mr-2 text-[color:var(--text-secondary)]">DSO industria: 90d</span>
          <span class="h-4 border-l border-[color:var(--border-color-subtle)] mx-2"></span>
          <button class="text-xs px-2 py-1 rounded bg-[color:var(--bg-subtle)] text-[color:var(--text-secondary)] border border-[color:var(--border-color)] hover:bg-[color:var(--bg-card)]" id="toggle-aging-view">
            Ver tendencia
          </button>
        </div>
      </div>
      <div class="h-60">
        <canvas id="agingBucketsChart"></canvas>
      </div>
      
      <!-- Costo financiero acumulado -->
      <div class="mt-4 pt-3 border-t border-[color:var(--border-color-subtle)]">
        <div class="flex justify-between items-center">
          <span class="text-sm">Costo financiero acumulado:</span>
          <span class="text-sm font-medium text-red-500 dark:text-red-400">${{ kpis.costo_financiero_total }}M</span>
        </div>
        <!-- Acciones directas - Botones conectados con módulos específicos -->
        <div class="mt-3 flex space-x-2">
          <button class="flex-1 text-xs py-1.5 bg-[color:var(--bg-subtle)] hover:bg-[color:var(--bg-card)] border border-[color:var(--border-color)] rounded transition-colors">
            Plan de acción 30d+
          </button>
          <button class="flex-1 text-xs py-1.5 bg-[color:var(--bg-subtle)] hover:bg-[color:var(--bg-card)] border border-[color:var(--border-color)] rounded transition-colors">
            Plan de acción 60d+
          </button>
          <button class="flex-1 text-xs py-1.5 bg-[color:var(--bg-subtle)] hover:bg-[color:var(--bg-card)] border border-[color:var(--border-color)] rounded transition-colors">
            Plan de acción 90d+
          </button>
        </div>
      </div>
    </div>
    
    <!-- Gráfico avanzado - Pareto de clientes con información de riesgo -->
    <div class="bg-[color:var(--bg-card)] p-5 rounded-xl border border-[color:var(--border-color)] shadow-lg relative lg:col-span-2 text[color:var(--text-primary)]">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-bold">Concentración por Cliente</h2>
        <div class="flex space-x-1">
          <button class="text-xs px-2 py-1 rounded bg-[color:var(--accent-blue)] text-white" id="pareto-toggle-ingresos">Ingresos</button>
          <button class="text-xs px-2 py-1 rounded bg-[color:var(--bg-subtle)] text-[color:var(--text-secondary)] border border-[color:var(--border-color)]" id="pareto-toggle-pendiente">Pendiente</button>
        </div>
      </div>
      <div class="h-60">
        <canvas id="paretoClientChart"></canvas>
      </div>
      
      <!-- Análisis de riesgo por cliente principal -->
      <div class="mt-4 pt-3 border-t border-[color:var(--border-color-subtle)]">
        <p class="text-sm font-medium mb-2">Cliente principal: {{ kpis.cliente_principal }}</p>
        <div class="flex space-x-4 text-xs">
          <div>
            <p class="text-[color:var(--text-secondary)]">% Ingresos</p>
            <p class="font-medium">{{ kpis.pct_ingresos_principal }}%</p>
          </div>
          <div>
            <p class="text-[color:var(--text-secondary)]">DSO promedio</p>
            <p class="font-medium">{{ kpis.dso_cliente_principal }}d</p>
          </div>
                            <div>
                    <p class="text-[color:var(--text-secondary)]">Riesgo pago</p>
                    <p class="font-medium {% if kpis.riesgo_pago_principal > 70 %}text-red-500 dark:text-red-400{% elif kpis.riesgo_pago_principal > 40 %}text-amber-500 dark:text-amber-400{% else %}text-green-500 dark:text-green-400{% endif %}">
                      {{ kpis.riesgo_pago_principal }}%
                    </p>
                  </div>
                  <div>
                    <p class="text-[color:var(--text-secondary)]">Histórico</p>
                    <p class="font-medium">
                      {% if kpis.tendencia_pago_principal == 'mejora' %}
                      <span class="text-green-500 dark:text-green-400 flex items-center">
                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        Mejora
                      </span>
                      {% elif kpis.tendencia_pago_principal == 'estable' %}
                      <span class="text-blue-500 dark:text-blue-400 flex items-center">
                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M8 4a1 1 0 100 2h8a1 1 0 100-2H8zM8 10a1 1 0 100 2h8a1 1 0 100-2H8zM8 16a1 1 0 100 2h8a1 1 0 100-2H8z" clip-rule="evenodd"></path>
                        </svg>
                        Estable
                      </span>
                      {% else %}
                      <span class="text-red-500 dark:text-red-400 flex items-center">
                        <svg class="w-3 h-3 mr-1 rotate-180" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        Deterioro
                      </span>
                      {% endif %}
                    </p>
                  </div>
                </div>
                
                <!-- Acciones para mitigar riesgo de cliente -->
                <div class="mt-3 flex justify-between items-center">
                  {% if kpis.riesgo_pago_principal > 50 %}
                    <span class="text-xs text-red-500 dark:text-red-400 flex items-center">
                      <svg class="w-3.5 h-3.5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                      </svg>
                      Revisar exposición financiera
                    </span>
                  {% endif %}
                  <button class="text-xs text-[color:var(--accent-blue)] hover:underline ml-auto">
                    Estrategia de diversificación
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Alertas críticas y panel de acciones -->
            <div class="bg-[color:var(--bg-card)] p-5 rounded-xl border border-[color:var(--border-color)] shadow-lg relative lg:col-span-2">
              <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold flex items-center">
                  Alertas Críticas
                  {% if alertas|length > 3 %}
                  <span class="ml-2 flex h-5 w-5 items-center justify-center rounded-full bg-red-100 dark:bg-red-900">
                    <span class="text-xs font-medium text-red-800 dark:text-red-200">{{ alertas|length }}</span>
                  </span>
                  {% endif %}
                </h2>
                <button class="text-xs px-2 py-1 rounded bg-[color:var(--bg-subtle)] text-[color:var(--text-secondary)] border border-[color:var(--border-color)] hover:bg-[color:var(--bg-card)]">
                  Filtrar
                </button>
              </div>
              <div class="space-y-3 max-h-[280px] overflow-y-auto pr-1">
                {% for alerta in alertas[:5] %}
                <div class="p-3 rounded-lg bg-[color:var(--bg-subtle)] border-l-4 {% if alerta.tipo == 'critico' %}border-red-500{% elif alerta.tipo == 'alto' %}border-amber-500{% else %}border-blue-500{% endif %}">
                  <div class="flex justify-between items-start">
                    <h3 class="font-medium text-sm">{{ alerta.titulo }}</h3>
                    <span class="text-xs px-1.5 py-0.5 rounded {% if alerta.tipo == 'critico' %}bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200{% elif alerta.tipo == 'alto' %}bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200{% else %}bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200{% endif %}">
                      {{ alerta.tipo|title }}
                    </span>
                  </div>
                  <p class="text-sm mt-1 text-[color:var(--text-secondary)]">{{ alerta.descripcion }}</p>
                  
                  <!-- Acciones inmediatas para cada alerta -->
                  <div class="flex justify-between items-center mt-2 pt-2 border-t border-[color:var(--border-color-subtle)]">
                    <span class="text-xs text-[color:var(--text-tertiary)]">{{ alerta.fecha }}</span>
                    <div class="flex space-x-2">
                      <button class="text-xs py-0.5 px-2 bg-[color:var(--bg-card)] rounded border border-[color:var(--border-color)] hover:bg-[color:var(--bg-subtle)]">
                        Asignar
                      </button>
                      <button class="text-xs py-0.5 px-2 bg-[color:var(--accent-blue)] text-white rounded hover:bg-blue-600">
                        {{ alerta.accion_principal }}
                      </button>
                    </div>
                  </div>
                </div>
                {% else %}
                <div class="text-center py-8">
                  <svg class="w-12 h-12 mx-auto text-[color:var(--text-tertiary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <p class="mt-2 text-sm text-[color:var(--text-secondary)]">No hay alertas críticas en este momento</p>
                </div>
                {% endfor %}
              </div>
              
              <!-- Resumen y acciones para todas las alertas -->
              {% if alertas|length > 0 %}
              <div class="mt-4 pt-3 border-t border-[color:var(--border-color-subtle)] flex justify-between items-center">
                <span class="text-sm">
                  <strong>{{ alertas|length }}</strong> alertas requieren atención
                </span>
                <button class="text-xs flex items-center text-[color:var(--accent-blue)] hover:underline">
                  Ver todas
                  <svg class="w-3.5 h-3.5 ml-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                  </svg>
                </button>
              </div>
              {% endif %}
            </div>
            
            <!-- Widget de métricas de eficiencia operativa -->
            <div class="bg-[color:var(--bg-card)] p-5 rounded-xl border border-[color:var(--border-color)] shadow-lg relative lg:col-span-2">
              <h2 class="text-lg font-bold mb-4">Indicadores de Eficiencia</h2>
              
              <div class="space-y-4">
                <!-- Tiempo promedio ciclo completo -->
                <div>
                  <div class="flex justify-between items-center mb-1">
                    <div class="flex items-center">
                      <span class="text-sm">Tiempo medio ciclo EDP</span>
                      <button class="ml-1 text-[color:var(--text-tertiary)]" title="Tiempo desde emisión hasta pago final">
                        <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                      </button>
                    </div>
                    <span class="text-xs font-medium">{{ kpis.tiempo_medio_ciclo }} días</span>
                  </div>
                  <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                    <div class="bg-blue-600 h-2 rounded-full" style="width: {{ kpis.tiempo_medio_ciclo_pct }}%"></div>
                  </div>
                  <div class="flex justify-between text-xs mt-1">
                    <span>Meta: {{ kpis.meta_tiempo_ciclo }}d</span>
                    <span>Benchmark: {{ kpis.benchmark_tiempo_ciclo }}d</span>
                  </div>
                </div>
                
                <!-- Desglose de tiempos por etapa -->
                <div class="mt-6">
                  <p class="text-sm font-medium mb-3">Desglose por etapa (días)</p>
                  <div class="grid grid-cols-4 gap-2">
                    <div class="text-center">
                      <div class="h-20 flex items-end justify-center">
                        <div class="w-full bg-blue-200 dark:bg-blue-900/40 rounded-t-md" style="height: {{ kpis.etapa_emision_pct }}%"></div>
                      </div>
                      <p class="text-xs mt-1">Emisión</p>
                      <p class="text-xs font-medium">{{ kpis.tiempo_emision }}d</p>
                    </div>
                    <div class="text-center">
                      <div class="h-20 flex items-end justify-center">
                        <div class="w-full bg-green-200 dark:bg-green-900/40 rounded-t-md" style="height: {{ kpis.etapa_gestion_pct }}%"></div>
                      </div>
                      <p class="text-xs mt-1">Gestión</p>
                      <p class="text-xs font-medium">{{ kpis.tiempo_gestion }}d</p>
                    </div>
                    <div class="text-center">
                      <div class="h-20 flex items-end justify-center">
                        <div class="w-full bg-purple-200 dark:bg-purple-900/40 rounded-t-md" style="height: {{ kpis.etapa_conformidad_pct }}%"></div>
                      </div>
                      <p class="text-xs mt-1">Conformidad</p>
                      <p class="text-xs font-medium">{{ kpis.tiempo_conformidad }}d</p>
                    </div>
                    <div class="text-center">
                      <div class="h-20 flex items-end justify-center">
                        <div class="w-full bg-amber-200 dark:bg-amber-900/40 rounded-t-md" style="height: {{ kpis.etapa_pago_pct }}%"></div>
                      </div>
                      <p class="text-xs mt-1">Pago</p>
                      <p class="text-xs font-medium">{{ kpis.tiempo_pago }}d</p>
                    </div>
                  </div>
                </div>
                
                <!-- Oportunidad de mejora -->
                <div class="mt-4 pt-3 border-t border-[color:var(--border-color-subtle)]">
                  <p class="text-sm font-medium flex items-center">
                    <svg class="w-4 h-4 mr-1 text-amber-500 dark:text-amber-400" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"></path>
                    </svg>
                    Principal oportunidad de mejora:
                  </p>
                  <div class="flex justify-between items-center mt-2">
                    <span class="text-sm">{{ kpis.oportunidad_mejora }}</span>
                    <button class="text-xs text-[color:var(--accent-blue)] hover:underline">
                      Plan de acción
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Top EDPs por valor -->
          <div class="bg-[color:var(--bg-card)] p-5 rounded-xl border border-[color:var(--border-color)] shadow-lg relative">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-lg font-bold">Top 10 EDPs por Valor Pendiente</h2>
              <div class="flex items-center space-x-2">
                <div class="relative">
                  <input type="text" placeholder="Buscar EDP..." class="py-1 px-3 pr-8 text-sm border border-[color:var(--border-color)] rounded-md bg-[color:var(--bg-card)]">
                  <svg class="w-4 h-4 absolute right-2.5 top-1/2 -translate-y-1/2 text-[color:var(--text-tertiary)]" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                  </svg>
                </div>
                <select class="py-1 px-3 text-sm border border-[color:var(--border-color)] rounded-md bg-[color:var(--bg-card)]">
                  <option value="todos">Todos los estados</option>
                  <option value="pendiente">Pendiente</option>
                  <option value="riesgo">En riesgo</option>
                  <option value="critico">Crítico</option>
                </select>
              </div>
            </div>
            
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-[color:var(--border-color)]">
                <thead>
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-[color:var(--text-secondary)] uppercase tracking-wider">EDP</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-[color:var(--text-secondary)] uppercase tracking-wider">Proyecto</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-[color:var(--text-secondary)] uppercase tracking-wider">Cliente</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-[color:var(--text-secondary)] uppercase tracking-wider">Monto</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-[color:var(--text-secondary)] uppercase tracking-wider">Días</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-[color:var(--text-secondary)] uppercase tracking-wider">Próxima fecha</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-[color:var(--text-secondary)] uppercase tracking-wider">Encargado</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-[color:var(--text-secondary)] uppercase tracking-wider">Acciones</th>
                  </tr>
                </thead>
                <tbody class="bg-[color:var(--bg-card)] divide-y divide-[color:var(--border-color-subtle)]">
                  {% for edp in top_edps %}
                  <tr class="hover:bg-[color:var(--bg-subtle)] transition-colors">
                    <td class="px-4 py-3 whitespace-nowrap">
                      <span class="font-medium">{{ edp.edp }}</span>
                    </td>
                    <td class="px-4 py-3 max-w-xs truncate">{{ edp.proyecto }}</td>
                    <td class="px-4 py-3">{{ edp.cliente }}</td>
                    <td class="px-4 py-3 font-medium">${{ edp.monto|round(1) }}M</td>
                    <td class="px-4 py-3">
                      <span class="{% if edp.dias > 90 %}text-red-500 dark:text-red-400{% elif edp.dias > 60 %}text-amber-500 dark:text-amber-400{% elif edp.dias > 30 %}text-blue-500 dark:text-blue-400{% else %}text-green-500 dark:text-green-400{% endif %} font-medium">
                        {{ edp.dias }}d
                      </span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">
                      <span class="{% if edp.dias_prox_fecha < 0 %}text-red-500 dark:text-red-400{% endif %}">
                        {{ edp.prox_fecha|default("-") }}
                        {% if edp.dias_prox_fecha < 0 %}({{ edp.dias_prox_fecha|abs }}d atraso){% endif %}
                      </span>
                    </td>
                    <td class="px-4 py-3">{{ edp.encargado }}</td>
                    <td class="px-4 py-3 text-right text-sm space-x-2">
                      <button class="text-[color:var(--accent-blue)] hover:underline">Ver</button>
                      <button class="text-[color:var(--accent-blue)] hover:underline">Gestionar</button>
                    </td>
                  </tr>
                  {% else %}
                  <tr>
                    <td colspan="8" class="px-4 py-8 text-center text-[color:var(--text-secondary)]">
                      No se encontraron EDPs con los filtros actuales
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            
            <!-- Paginación -->
            <div class="mt-4 flex justify-between items-center">
              <span class="text-sm text-[color:var(--text-secondary)]">
                Mostrando <span class="font-medium">1</span> a <span class="font-medium">10</span> de <span class="font-medium">{{ total_edps }}</span> EDPs
              </span>
              <div class="flex space-x-1">
                <button class="px-3 py-1 border border-[color:var(--border-color)] rounded-md text-sm bg-[color:var(--bg-subtle)] text-[color:var(--text-secondary)]">
                  Anterior
                </button>
                <button class="px-3 py-1 border border-[color:var(--border-color)] rounded-md text-sm bg-[color:var(--accent-blue)] text-white">
                  Siguiente
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Scripts para funcionalidad interactiva -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script src="{{ url_for('static', filename='js/manager-charts.js') }}"></script>
<script>
        document.addEventListener('DOMContentLoaded', function() {
          // Configuración e inicialización de charts
          // Este código sería generado dinámicamente basado en los datos
          
          // Mostrar/ocultar menú de acciones de proyecto
          const projectActionsBtn = document.getElementById('project-actions-btn');
          const projectActionsMenu = document.getElementById('project-actions-menu');
          
          if (projectActionsBtn && projectActionsMenu) {
            projectActionsBtn.addEventListener('click', function() {
              projectActionsMenu.classList.toggle('hidden');
            });
          }
          
          // Toggle entre vistas de proyectos
          const viewButtons = document.querySelectorAll('[data-view]');
          if (viewButtons.length) {
            viewButtons.forEach(button => {
              button.addEventListener('click', function() {
                // Cambiar estado activo de botones
                document.querySelectorAll('[data-view]').forEach(btn => {
                  btn.classList.remove('active-view-btn');
                  btn.classList.add('bg-[color:var(--bg-subtle)]', 'text-[color:var(--text-secondary)]');
                });
                this.classList.add('active-view-btn');
                this.classList.remove('bg-[color:var(--bg-subtle)]', 'text-[color:var(--text-secondary)]');
                
                // Mostrar vista correspondiente
                const viewToShow = this.getAttribute('data-view');
                if (viewToShow === 'chart') {
                  document.getElementById('project-chart-view').classList.remove('hidden');
                  document.getElementById('project-bubble-view').classList.add('hidden');
                } else {
                  document.getElementById('project-chart-view').classList.add('hidden');
                  document.getElementById('project-bubble-view').classList.remove('hidden');
                }
              });
            });
          }
          
          // Toggle entre vistas de pareto
          const paretoIngresos = document.getElementById('pareto-toggle-ingresos');
          const paretoPendiente = document.getElementById('pareto-toggle-pendiente');
          
          if (paretoIngresos && paretoPendiente) {
            paretoIngresos.addEventListener('click', function() {
              paretoIngresos.classList.add('bg-[color:var(--accent-blue)]', 'text-white');
              paretoIngresos.classList.remove('bg-[color:var(--bg-subtle)]', 'text-[color:var(--text-secondary)]', 'border');
              
              paretoPendiente.classList.remove('bg-[color:var(--accent-blue)]', 'text-white');
              paretoPendiente.classList.add('bg-[color:var(--bg-subtle)]', 'text-[color:var(--text-secondary)]', 'border', 'border-[color:var(--border-color)]');
              
              // Aquí iría el código para actualizar el gráfico
            });
            
            paretoPendiente.addEventListener('click', function() {
              paretoPendiente.classList.add('bg-[color:var(--accent-blue)]', 'text-white');
              paretoPendiente.classList.remove('bg-[color:var(--bg-subtle)]', 'text-[color:var(--text-secondary)]', 'border');
              
              paretoIngresos.classList.remove('bg-[color:var(--accent-blue)]', 'text-white');
              paretoIngresos.classList.add('bg-[color:var(--bg-subtle)]', 'text-[color:var(--text-secondary)]', 'border', 'border-[color:var(--border-color)]');
              
              // Aquí iría el código para actualizar el gráfico
            });
          }
          
          // Función para resetear filtros
          window.resetFilters = function() {
            const form = document.getElementById('dashboard-filters');
            if (form) {
              // Restablecer campos de fecha
              form.querySelectorAll('input[type="date"]').forEach(input => {
                input.value = '';
              });
              
              // Restablecer selects al primer valor
              form.querySelectorAll('select').forEach(select => {
                if (select.options.length) {
                  select.selectedIndex = 0;
                }
              });
              
              // Enviar formulario
              form.submit();
            }
          }
        });
        </script>
{% endblock %}