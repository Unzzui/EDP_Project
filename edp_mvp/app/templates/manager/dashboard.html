{% extends "manager/base_manager.html" %}

{% block title %}Dashboard Ejecutivo - EDP Manager{% endblock %}

{% block content %}

 {% include 'manager/modal-proyectos-criticos.html' %}
<div class="container mx-auto px-4 py-6 space-y-6">
 
<script id="charts-data" type="application/json">
{{ charts_json|safe }}
</script>
  <div class="bg-[color:var(--bg-subtle)] border-l-4 border-[color:var(--accent-blue)] p-4 rounded-lg shadow-lg relative mb-6">
    <h2 class="font-bold text-lg">
      {% if kpis.vs_meta_ingresos > 0 %}
      Ingresos {{ kpis.vs_meta_ingresos }}% sobre meta, 
      {% else %}
      Ingresos {{ kpis.vs_meta_ingresos|abs }}% bajo meta, 
      {% endif %}
      pero cobranza en riesgo ${{ kpis.monto_pendiente }}M; 
      <span class="{% if kpis.concentracion_atraso > 50 %}text-red-500 dark:text-red-400{% endif %}">
        {{ kpis.proyectos_criticos }} proyectos concentran {{ kpis.concentracion_atraso }}% del atraso
      </span>
    </h2>
  </div>

  <!-- Header con KPIs principales y filtros -->
<!-- Header con t√≠tulo y toggle de filtros -->
  <div class="flex justify-between items-center">
    <div>
      <h1 class="text-3xl font-bold text-[color:var(--text-primary)]">Dashboard Ejecutivo</h1>
      <p class="text-[color:var(--text-secondary)]">Vista panor√°mica del rendimiento empresarial</p>
    </div>
    
    <!-- Toggle de filtros prominente -->
    <div class="flex items-center space-x-3">
      <!-- Indicador de filtros activos -->
      {% set filtros_activos = [] %}
      {% if fecha_inicio or fecha_fin %}{% set _ = filtros_activos.append('Fechas') %}{% endif %}
      {% if departamento != 'todos' %}{% set _ = filtros_activos.append('Gestor') %}{% endif %}
      {% if cliente != 'todos' %}{% set _ = filtros_activos.append('Cliente') %}{% endif %}
      {% if estado != 'todos' %}{% set _ = filtros_activos.append('Estado') %}{% endif %}
      {% if vista != 'general' %}{% set _ = filtros_activos.append('Vista') %}{% endif %}
      
      {% if filtros_activos %}
      <div class="flex items-center space-x-1">
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
          {{ filtros_activos|length }} filtro{{ 's' if filtros_activos|length > 1 else '' }}
        </span>
        <a href="{{ url_for('manager_bp.dashboard') }}" class="text-xs text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300">
          Limpiar
        </a>
      </div>
      {% endif %}
      
      <!-- Bot√≥n toggle de filtros -->
      <button id="toggle-filters-btn" class="flex items-center px-4 py-2 bg-[color:var(--accent-blue)] hover:bg-blue-600 text-white rounded-lg transition-colors shadow-md">
        <svg id="filter-icon" class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd"></path>
        </svg>
        <span id="filter-text">Mostrar filtros</span>
        <svg id="filter-chevron" class="w-4 h-4 ml-1 transition-transform" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
        </svg>
      </button>
    </div>
  </div>

  <!-- Secci√≥n de filtros - OCULTA POR DEFECTO -->
  <div id="filters-section" class="hidden">
    <!-- Animaci√≥n suave al mostrar -->
    <div class="section-title-modern mb-5">
      <h2 class="text-xl font-semibold">üîç Filtros de B√∫squeda</h2>
      <div class="section-line"></div>
    </div>

    <form method="GET" class="bg-[color:var(--bg-card)] border border-[color:var(--border-color-subtle)] rounded-xl p-5 mb-6 shadow-sm">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        
        <!-- Rango de fechas mejorado -->
        <div class="form-group md:col-span-2">
          <label class="text-xs font-medium text-[color:var(--text-secondary)] mb-1.5">Rango de fechas</label>
          <div class="grid grid-cols-2 gap-2">
            <div class="relative">
              <input type="date" name="fecha_inicio" id="fecha_inicio" 
                     class="form-input w-full pl-9" 
                     value="{{ fecha_inicio or '' }}"
                     placeholder="Fecha inicio">
              <div class="absolute left-0 top-0 bottom-0 flex items-center justify-center w-9 text-[color:var(--accent-blue)] pointer-events-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                </svg>
              </div>
            </div>
            <div class="relative">
              <input type="date" name="fecha_fin" id="fecha_fin" 
                     class="form-input w-full pl-9" 
                     value="{{ fecha_fin or '' }}"
                     placeholder="Fecha fin">
              <div class="absolute left-0 top-0 bottom-0 flex items-center justify-center w-9 text-[color:var(--accent-blue)] pointer-events-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                </svg>
              </div>
            </div>
          </div>
          <!-- Botones de rango r√°pido -->
          <div class="mt-2 flex gap-1 flex-wrap">
            <button type="submit" name="periodo_rapido" value="7" class="quick-date-btn text-xs px-2 py-1 rounded bg-[color:var(--bg-subtle)] hover:bg-[color:var(--accent-blue)] hover:text-white transition-colors {{ 'bg-[color:var(--accent-blue)] text-white' if periodo_rapido == '7' else '' }}">
              7 d√≠as
            </button>
            <button type="submit" name="periodo_rapido" value="30" class="quick-date-btn text-xs px-2 py-1 rounded bg-[color:var(--bg-subtle)] hover:bg-[color:var(--accent-blue)] hover:text-white transition-colors {{ 'bg-[color:var(--accent-blue)] text-white' if periodo_rapido == '30' else '' }}">
              30 d√≠as
            </button>
            <button type="submit" name="periodo_rapido" value="90" class="quick-date-btn text-xs px-2 py-1 rounded bg-[color:var(--bg-subtle)] hover:bg-[color:var(--accent-blue)] hover:text-white transition-colors {{ 'bg-[color:var(--accent-blue)] text-white' if periodo_rapido == '90' else '' }}">
              90 d√≠as
            </button>
            <button type="submit" name="periodo_rapido" value="365" class="quick-date-btn text-xs px-2 py-1 rounded bg-[color:var(--bg-subtle)] hover:bg-[color:var(--accent-blue)] hover:text-white transition-colors {{ 'bg-[color:var(--accent-blue)] text-white' if periodo_rapido == '365' else '' }}">
              1 a√±o
            </button>
          </div>
        </div>

        <!-- Departamento/Jefe de Proyecto -->
        <div class="form-group">
          <label for="departamento" class="text-xs font-medium text-[color:var(--text-secondary)] mb-1.5">Jefe de Proyecto</label>
          <div class="relative">
            <select name="departamento" id="departamento" class="form-select w-full pl-9">
              <option value="todos" {% if departamento == 'todos' %}selected{% endif %}>Todos</option>
              {% for j in jefes_proyecto %}
                <option value="{{ j }}" {% if departamento == j %}selected{% endif %}>{{ j }}</option>
              {% endfor %}
            </select>
            <div class="absolute left-0 top-0 bottom-0 flex items-center justify-center w-9 text-[color:var(--accent-blue)] pointer-events-none">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
              </svg>
            </div>
          </div>
        </div>

        <!-- Cliente -->
        <div class="form-group">
          <label for="cliente" class="text-xs font-medium text-[color:var(--text-secondary)] mb-1.5">Cliente</label>
          <div class="relative">
            <select name="cliente" id="cliente" class="form-select w-full pl-9">
              <option value="todos" {% if cliente == 'todos' %}selected{% endif %}>Todos</option>
              {% for c in clientes %}
                <option value="{{ c }}" {% if cliente == c %}selected{% endif %}>{{ c }}</option>
              {% endfor %}
            </select>
            <div class="absolute left-0 top-0 bottom-0 flex items-center justify-center w-9 text-[color:var(--accent-blue)] pointer-events-none">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 01-1.581.814l-4.419-3.996-4.419 3.996A1 1 0 014 16V4z" clip-rule="evenodd" />
              </svg>
            </div>
          </div>
        </div>
      </div>

      <!-- Segunda fila -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4">
        <!-- Estado -->
        <div class="form-group">
          <label for="estado" class="text-xs font-medium text-[color:var(--text-secondary)] mb-1.5">Estado</label>
          <div class="relative">
            <select name="estado" id="estado" class="form-select w-full pl-9">
              <option value="todos" {% if estado == 'todos' %}selected{% endif %}>Todos</option>
              <option value="pendientes" {% if estado == 'pendientes' %}selected{% endif %}>Pendientes</option>
              {% for est in ["revisi√≥n", "enviado", "pagado", "validado"] %}
                <option value="{{ est }}" {% if estado == est %}selected{% endif %}>{{ est|title }}</option>
              {% endfor %}
            </select>
            <div class="absolute left-0 top-0 bottom-0 flex items-center justify-center w-9 text-[color:var(--accent-blue)] pointer-events-none">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
              </svg>
            </div>
          </div>
        </div>

        <!-- Vista (filtro r√°pido) -->
        <div class="form-group">
          <label for="vista" class="text-xs font-medium text-[color:var(--text-secondary)] mb-1.5">Vista</label>
          <div class="relative">
            <select name="vista" id="vista" class="form-select w-full pl-9">
              <option value="general" {% if vista == 'general' %}selected{% endif %}>General</option>
              <option value="criticos" {% if vista == 'criticos' %}selected{% endif %}>Solo cr√≠ticos</option>
              <option value="completados" {% if vista == 'completados' %}selected{% endif %}>Completados</option>
              <option value="alto_valor" {% if vista == 'alto_valor' %}selected{% endif %}>Alto valor (>$50M)</option>
            </select>
            <div class="absolute left-0 top-0 bottom-0 flex items-center justify-center w-9 text-[color:var(--accent-blue)] pointer-events-none">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" />
              </svg>
            </div>
          </div>
        </div>

        <!-- Espacios para mantener el layout -->
        <div class="form-group"></div>
        <div class="form-group"></div>
      </div>

      <!-- Filtros avanzados (desplegable opcional) -->
      <div id="advanced-filters" class="hidden mt-4 pt-4 border-t border-[color:var(--border-color-subtle)]">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          
          <!-- Rango de montos -->
          <div class="form-group">
            <label for="monto_min" class="text-xs font-medium text-[color:var(--text-secondary)] mb-1.5">Monto m√≠nimo (millones)</label>
            <div class="relative">
              <input type="number" name="monto_min" id="monto_min" placeholder="0" class="form-input w-full pl-9" value="{{ monto_min or '' }}">
              <div class="absolute left-0 top-0 bottom-0 flex items-center justify-center w-9 text-[color:var(--accent-blue)]">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z" />
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd" />
                </svg>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="monto_max" class="text-xs font-medium text-[color:var(--text-secondary)] mb-1.5">Monto m√°ximo (millones)</label>
            <div class="relative">
              <input type="number" name="monto_max" id="monto_max" placeholder="1000" class="form-input w-full pl-9" value="{{ monto_max or '' }}">
              <div class="absolute left-0 top-0 bottom-0 flex items-center justify-center w-9 text-[color:var(--accent-blue)]">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z" />
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd" />
                </svg>
              </div>
            </div>
          </div>

          <!-- D√≠as de espera -->
          <div class="form-group">
            <label for="dias_min" class="text-xs font-medium text-[color:var(--text-secondary)] mb-1.5">D√≠as m√≠nimos</label>
            <div class="relative">
              <input type="number" name="dias_min" id="dias_min" placeholder="0" class="form-input w-full pl-9" value="{{ dias_min or '' }}">
              <div class="absolute left-0 top-0 bottom-0 flex items-center justify-center w-9 text-[color:var(--accent-blue)]">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                </svg>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Botones de acci√≥n -->
      <div class="mt-4 flex items-center justify-between">
        <button type="button" id="toggle-advanced" class="text-sm text-[color:var(--accent-blue)] hover:text-[color:var(--accent-blue-light)] transition-colors flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" />
          </svg>
          <span id="advanced-text">Filtros avanzados</span>
        </button>

        <div class="flex items-center space-x-3">
          <a href="{{ url_for('manager_bp.dashboard') }}" class="text-sm text-[color:var(--accent-blue)] hover:text-[color:var(--accent-blue-light)] transition-colors">
            Limpiar filtros
          </a>
          <button type="submit" class="btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
            </svg>
            Aplicar filtros
          </button>
        </div>
      </div>
    </form>
  </div>
  
  <!-- KPIs Principales - Primera fila con contexto aumentado -->
<div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
    <!-- KPI: Ingresos totales con contexto y m√°s detalles -->
    <div class="bg-gradient-to-br from-green-600 to-green-700 rounded-xl p-5 text-white shadow-lg relative">
      <div class="absolute top-2 right-2">
    <button class="text-[#f5f5f7]/80 hover:text-[#f5f5f7]" aria-label="Ver detalles de ingresos" title="Ver detalles">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
          </svg>
        </button>
      </div>
      <div class="flex justify-between items-start">
        <div>
      <p style="color:#f5f5f7" class="text-sm font-medium">Ingresos Totales</p>
      <p style="color:#f5f5f7" class="text-3xl font-bold mt-1">${{ kpis.ingresos_totales }}M</p>
          <div class="flex items-center mt-1">
            <svg class="w-4 h-4 mr-1 {% if kpis.crecimiento_ingresos < 0 %}rotate-180 text-red-300{% else %}text-emerald-200{% endif %}" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
            </svg>
            <span class="text-sm {% if kpis.crecimiento_ingresos < 0 %}text-red-300{% endif %}">{{ kpis.crecimiento_ingresos|abs }}% {% if kpis.crecimiento_ingresos < 0 %}menos{% endif %} vs periodo anterior</span>
          </div>
          
          <!-- Meta vs Actual - Contexto a√±adido -->
          <div class="mt-3 pt-2 border-t border-white/20">
            <div class="flex justify-between items-center mb-1">
              <span class="text-xs text-emerald-100">Meta: ${{ kpis.meta_ingresos }}M</span>
              <span class="text-xs {% if kpis.vs_meta_ingresos >= 0 %}text-emerald-200{% else %}text-red-300{% endif %}">
                {{ kpis.vs_meta_ingresos|abs }}% 
                {% if kpis.vs_meta_ingresos >= 0 %}sobre meta{% else %}bajo meta{% endif %}
              </span>
            </div>
            <div class="w-full bg-emerald-700/40 rounded-full h-1.5">
              <div class="bg-white h-1.5 rounded-full" style="width: {{ kpis.pct_meta_ingresos }}%"></div>
            </div>
          </div>
        </div>
        <span class="w-10 h-10 rounded-full bg-white bg-opacity-20 flex items-center justify-center">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
          </svg>
        </span>
      </div>
    </div>
    
    <!-- KPI: Monto Pendiente - AHORA DESTACADO CON GRADIENTE AZUL -->
<div class="bg-gradient-to-br from-blue-600 to-blue-800 rounded-xl p-5 text-white shadow-lg relative">
  <div class="absolute top-2 right-2">
    <button class="text-white/80 hover:text-white" aria-label="Ver detalles de cobranza" title="Ver an√°lisis de cobranza">
      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
      </svg>
    </button>
  </div>
  <div class="flex justify-between items-start">
    <div>
      <p style="color:#f5f5f7" class="text-sm font-medium">Monto Pendiente</p>
      <p style="color:#f5f5f7" class="text-3xl font-bold mt-1">${{ kpis.monto_pendiente }}M</p>
      <div class="flex items-center mt-1">
        <span class="text-sm {% if kpis.tendencia_pendiente > 0 %}text-red-300{% else %}text-blue-200{% endif %}">
          {% if kpis.tendencia_pendiente > 0 %}+{% endif %}{{ kpis.tendencia_pendiente }}% vs mes anterior
        </span>
      </div>
      
      <!-- DSO y benchmarks -->
      <div class="mt-3 pt-2 border-t border-white/20">
        <div class="flex justify-between items-center">
          <span class="text-xs text-blue-100">DSO: {{ kpis.dso }} d√≠as</span>
          <span class="text-xs {% if kpis.dso > 90 %}text-red-300{% else %}text-blue-100{% endif %}">
            (Meta: 90 d√≠as)
          </span>
        </div>
        <div class="w-full bg-blue-700/40 rounded-full h-1.5 mt-1">
          <div class="bg-white h-1.5 rounded-full" style="width: {% if kpis.dso < 90 %}{{ kpis.dso / 0.9 }}{% else %}100{% endif %}%"></div>
        </div>
      </div>
    </div>
    <span class="w-10 h-10 rounded-full bg-white bg-opacity-20 flex items-center justify-center">
      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
        <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"></path>
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd"></path>
      </svg>
    </span>
  </div>
</div>

<!-- KPI: Proyectos y Montos Cr√≠ticos - COMBINADO -->
<div class="bg-gradient-to-br from-red-700 to-red-800 rounded-xl p-5 text-white shadow-lg relative">
  <div class="absolute top-2 right-2">
    <button class="text-white/80 hover:text-white" title="Proyectos y montos con riesgo elevado">
      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
      </svg>
    </button>
  </div>
  
  <div class="flex justify-between items-start">
    <div>
      <!-- T√≠tulo combinado -->
      <div class="flex items-center space-x-2">
        <p style="color:#f5f5f7" class="text-sm font-medium">Proyectos Cr√≠ticos</p>
        <span class="bg-white/20 text-white text-xs px-1.5 py-0.5 rounded">
          {{ kpis.q_proyectos_criticos }} proyectos
        </span>
      </div>
      
      <!-- Valor cr√≠tico -->
      <p style="color:#f5f5f7" class="text-3xl font-bold mt-1">${{ kpis.monto_pendiente_critico }}M</p>
      <div class="flex items-center mt-1">
        <span class="text-sm">{{ kpis.pct_critico }}% del total pendiente</span>
      </div>
      
      <!-- Costo financiero y acciones -->
      <div class="mt-3 pt-2 border-t border-white/20">
        <div class="flex justify-between items-center mb-1">
          <span class="text-xs text-amber-100">Costo financiero:</span>
          <span class="text-xs font-medium">${{ kpis.costo_financiero }}M</span>
        </div>
        
        <!-- Botones de acci√≥n (ambos incluidos) -->
        <div class="grid grid-cols-2 gap-2 mt-2">
          <button id="show-critical-projects-btn" class="text-xs py-1.5 px-2 bg-white/20 hover:bg-white/30 text-white rounded flex items-center justify-center font-medium transition-colors">
            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
              <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>
              <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path>
            </svg>
            Ver detalle
          </button>
          <button class="text-xs py-1.5 px-2 bg-white/20 hover:bg-white/30 text-white rounded flex items-center justify-center font-medium transition-colors">
            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
              <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
            </svg>
            Plan de acci√≥n
          </button>
        </div>
      </div>
    </div>
    
    <!-- Lado derecho con √≠cono y visualizaci√≥n de distribuci√≥n -->
    <div class="flex flex-col items-center">
      <span class="w-10 h-10 rounded-full bg-white bg-opacity-20 flex items-center justify-center">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
        </svg>
      </span>
      
      <!-- Mini gr√°fico de distribuci√≥n por antiguedad -->
      <div class="mt-2 w-1.5 h-16 flex flex-col-reverse">
        <div class="w-full rounded-b-sm" style="height: {{ kpis.pct_mas90d|default(25) }}%; background-color: rgba(239, 68, 68, 0.9);"></div>
        <div class="w-full" style="height: {{ kpis.pct_90d|default(25) }}%; background-color: rgba(245, 158, 11, 0.9);"></div>
        <div class="w-full" style="height: {{ kpis.pct_60d|default(25) }}%; background-color: rgba(245, 158, 11, 0.6);"></div>
        <div class="w-full rounded-t-sm" style="height: {{ kpis.pct_30d|default(25) }}%; background-color: rgba(239, 68, 68, 0.5);"></div>
      </div>
    </div>
  </div>
</div>
<!-- KPI: Rentabilidad General -->
<div class="bg-gradient-to-br from-purple-600 to-purple-800 rounded-xl p-5 text-white shadow-lg relative">
  <div class="absolute top-2 right-2">
    <button class="text-[#f5f5f7]/80 hover:text-[#f5f5f7]" title="An√°lisis de m√°rgenes y estructura de costos">
      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
      </svg>
    </button>
  </div>
  <div class="flex justify-between items-start">
    <div>
      <!-- T√≠tulo y valor principal -->
      <div class="flex items-center space-x-2">
        <p style="color:#f5f5f7" class="text-sm font-medium">Rentabilidad General</p>
        <span class="bg-white/20 text-white text-xs px-1.5 py-0.5 rounded">
          {% if kpis.posicion_vs_benchmark >= 0 %}‚Üó{% else %}‚Üò{% endif %} {{ kpis.posicion_vs_benchmark|abs }}% vs benchmark
        </span>
      </div>
      
      <!-- Margen principal -->
      <p style="color:#f5f5f7" class="text-3xl font-bold mt-1">{{ kpis.rentabilidad_general }}%</p>
      <div class="flex items-center mt-1">
        <svg class="w-4 h-4 mr-1 {% if kpis.tendencia_rentabilidad < 0 %}rotate-180 text-red-300{% else %}text-[#f5f5f7]{% endif %}" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
        </svg>
        <span class="text-sm {% if kpis.tendencia_rentabilidad < 0 %}text-red-300{% else %}text-[#f5f5f7]{% endif %}">{{ kpis.tendencia_rentabilidad|abs }}% {% if kpis.tendencia_rentabilidad < 0 %}menos{% else %}m√°s{% endif %} vs periodo anterior</span>
      </div>
      
      <!-- Desglose financiero -->
      <div class="mt-3 pt-2 border-t border-white/20">
        <div class="grid grid-cols-2 gap-2 text-xs">
          <div class="flex justify-between">
            <span style="color:#f5f5f7; opacity: 0.9">Margen bruto:</span>
            <span style="color:#f5f5f7" class="font-medium">${{ kpis.margen_bruto_absoluto }}M</span>
          </div>
          <div class="flex justify-between">
            <span style="color:#f5f5f7; opacity: 0.9">Costos totales:</span>
            <span style="color:#f5f5f7" class="font-medium">${{ kpis.costos_totales }}M</span>
          </div>
          <div class="flex justify-between">
            <span style="color:#f5f5f7; opacity: 0.9">ROI:</span>
            <span style="color:#f5f5f7" class="font-medium">{{ kpis.roi_calculado }}%</span>
          </div>
          <div class="flex justify-between">
            <span style="color:#f5f5f7; opacity: 0.9">EBITDA:</span>
            <span style="color:#f5f5f7" class="font-medium">{{ kpis.ebitda_porcentaje }}%</span>
          </div>
        </div>
        
        <!-- Barra de progreso vs meta -->
        <div class="mt-3">
          <div class="flex justify-between items-center mb-1">
            <span class="text-xs" style="color:#f5f5f7; opacity: 0.9">Meta: {{ kpis.meta_rentabilidad }}%</span>
            <span class="text-xs {% if kpis.vs_meta_rentabilidad >= 0 %}text-[#f5f5f7]{% else %}text-red-300{% endif %}">
              {{ kpis.vs_meta_rentabilidad|abs }}% 
              {% if kpis.vs_meta_rentabilidad >= 0 %}sobre meta{% else %}bajo meta{% endif %}
            </span>
          </div>
          <div class="w-full bg-purple-700/40 rounded-full h-1.5">
            <div class="bg-white h-1.5 rounded-full" style="width: {{ kpis.pct_meta_rentabilidad }}%"></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Lado derecho con visualizaci√≥n de estructura de costos -->
    <div class="flex flex-col items-center">
      <span class="w-10 h-10 rounded-full bg-white bg-opacity-20 flex items-center justify-center">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11 4a1 1 0 10-2 0v4a1 1 0 102 0V7zm-3 1a1 1 0 10-2 0v3a1 1 0 102 0V8zM8 9a1 1 0 00-2 0v2a1 1 0 102 0V9z" clip-rule="evenodd"></path>
        </svg>
      </span>
      
      <!-- Mini visualizaci√≥n de estructura de costos -->
      <div class="mt-2 w-8 h-16 flex flex-col-reverse">
        <!-- Personal (35% + factor tiempo) -->
        <div class="w-full rounded-b-sm bg-blue-400" style="height: 35%;"></div>
        <!-- Overhead (15%) -->
        <div class="w-full bg-green-400" style="height: 15%;"></div>
        <!-- Tecnolog√≠a (8%) -->
        <div class="w-full bg-yellow-400" style="height: 8%;"></div>
        <!-- Margen (resto) -->
        <div class="w-full rounded-t-sm bg-white/80" style="height: 42%;"></div>
      </div>
      
      <!-- Tooltip explicativo -->
      <div class="text-xs text-center mt-1" style="color:#f5f5f7; opacity: 0.8">
        <div>Personal</div>
        <div>Overhead</div>
        <div>Tech</div>
        <div>Margen</div>
      </div>
    </div>
  </div>
</div>
</div>
  
  <!-- KPIs Financieros conectados - Segunda fila mejorada -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
    <!-- KPI: Distribuci√≥n por Antig√ºedad (NUEVO) - Da contexto visual al monto pendiente -->
    <div style="background-color: var(--bg-card)" class="p-4 rounded-xl border border-[color:var(--border-color)] border-l-[3px] border-l-[color:var(--accent-blue)] shadow-lg relative">
      <p class="text-sm text-[color:var(--text-secondary)]">Distribuci√≥n por Antig√ºedad</p>
      <div class="flex items-center justify-between mt-3 h-8">
        <div class="h-full flex rounded-md overflow-hidden w-full">
 <div class="h-full bg-green-500" style="width: {{ kpis.pct_30d|default(25) }}%"></div>
<div class="h-full bg-blue-500" style="width: {{ kpis.pct_60d|default(25) }}%"></div>
<div class="h-full bg-yellow-500" style="width: {{ kpis.pct_90d|default(25) }}%"></div>
<div class="h-full bg-red-500" style="width: {{ kpis.pct_mas90d|default(25) }}%"></div>
        </div>
      </div>
      <div class="flex justify-between text-xs mt-3">
        <span class="flex flex-col items-center">
          <span class="w-2 h-2 bg-green-500 rounded-full mb-1"></span>
          <span>0-30d</span>
<span class="font-medium">{{ kpis.pct_30d|default(25) }}%</span>
        </span>
        <span class="flex flex-col items-center">
          <span class="w-2 h-2 bg-blue-500 rounded-full mb-1"></span>
          <span>30-60d</span>
<span class="font-medium">{{ kpis.pct_60d|default(25) }}%</span>
        </span>
        <span class="flex flex-col items-center">
          <span class="w-2 h-2 bg-yellow-500 rounded-full mb-1"></span>
          <span>60-90d</span>
<span class="font-medium">{{ kpis.pct_90d|default(25) }}%</span>
        </span>
        <span class="flex flex-col items-center">
          <span class="w-2 h-2 bg-red-500 rounded-full mb-1"></span>
          <span>>90d</span>
<span class="font-medium">{{ kpis.pct_mas90d|default(25) }}%</span>        </span>
      </div>
    </div>
    
    <!-- KPI: Eficiencia Operativa - NUEVO (reemplaza monto cr√≠tico duplicado) -->
    <div style="background-color: var(--bg-card)" class="p-4 rounded-xl border border-[color:var(--border-color)] border-l-[3px] border-l-[color:var(--accent-green)] shadow-lg relative">      
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-[color:var(--text-secondary)]">Eficiencia Operativa</p>
          <p class="text-xl font-bold mt-1">{{ kpis.eficiencia_global }}%</p>
          <div class="flex items-center mt-1">
            <span class="text-xs {% if kpis.mejora_eficiencia > 0 %}text-green-500 dark:text-green-400{% else %}text-red-500 dark:text-red-400{% endif %}">
              {% if kpis.mejora_eficiencia > 0 %}+{% endif %}{{ kpis.mejora_eficiencia }}% YoY
            </span>
          </div>
        </div>
        <span class="w-8 h-8 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center text-green-600 dark:text-green-300">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 5.943 14.478 3 10 3a9.958 9.958 0 00-4.512 1.074l-1.78-1.781zm4.261 4.26l1.514 1.515a2.003 2.003 0 012.45 2.45l1.514 1.514a4 4 0 00-5.478-5.478z" clip-rule="evenodd"></path>
            <path d="M12.454 16.697L9.75 13.992a4 4 0 01-3.742-3.741L2.335 6.578A9.98 9.98 0 00.458 10c1.274 4.057 5.065 7 9.542 7 .847 0 1.669-.105 2.454-.303z"></path>
          </svg>
        </span>
      </div>
      <div class="flex items-center justify-between mt-2">
        <span class="text-xs text-[color:var(--text-secondary)]">Tiempo medio por ciclo:</span>
        <span class="text-xs font-medium ml-1">{{ kpis.tiempo_medio_ciclo }} d√≠as</span>
      </div>
    </div>
    
    <!-- KPI: Liquidez Proyectada (NUEVO) - Conectado con el flujo de caja -->
    <div style="background-color: var(--bg-card)" class="p-4 rounded-xl border border-[color:var(--border-color)] border-l-[3px] border-l-[color:var(--accent-purple)] shadow-lg relative">      
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-[color:var(--text-secondary)]">Liquidez Proyectada</p>
          <p class="text-xl font-bold mt-1">${{ kpis.liquidez_proyectada|default('3.5') }}M</p>
          <div class="flex items-center mt-1">
            <span class="text-xs text-[color:var(--text-secondary)]">Pr√≥ximos 30 d√≠as</span>
          </div>
        </div>
        <span class="w-8 h-8 rounded-full bg-purple-100 dark:bg-purple-900 flex items-center justify-center text-purple-600 dark:text-purple-300">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path>
          </svg>
        </span>
      </div>
      <div class="mt-2 w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full">
        <div class="bg-purple-600 h-2 rounded-full" style="width: {{ kpis.pct_liquidez|default('65') }}%"></div>
      </div>
      <div class="flex items-center justify-between mt-1">
        <span class="text-xs text-[color:var(--text-secondary)]">Cobertura:</span>
        <span class="text-xs font-medium ml-1">{{ kpis.ratio_cobertura|default('0.8') }}x</span>
      </div>
    </div>
    
    <!-- KPI: Satisfacci√≥n del Cliente - NUEVO (reemplaza proyectos cr√≠ticos duplicado) -->
    <div style="background-color: var(--bg-card)" class="p-4 rounded-xl border border-[color:var(--border-color)] border-l-[3px] border-l-[color:var(--accent-gray)] shadow-lg relative">      
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-[color:var(--text-secondary)]">Satisfacci√≥n Cliente</p>
          <p class="text-xl font-bold mt-1">{{ kpis.satisfaccion_cliente }}%</p>
          <div class="flex items-center mt-1">
            <span class="text-xs text-[color:var(--text-secondary)]">{{ kpis.nps_score }} NPS</span>
          </div>
        </div>
        <span class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-gray-600 dark:text-gray-300">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v1h8v-1zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-1a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v1h-3zM4.75 12.094A5.973 5.973 0 004 15v1H1v-1a3 3 0 013.75-2.906z"></path>
          </svg>
        </span>
      </div>
      <div class="mt-2 w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full">
        <div class="bg-green-600 h-2 rounded-full" style="width: {{ kpis.satisfaccion_cliente }}%"></div>
      </div>
      <div class="flex items-center justify-between mt-1">
        <span class="text-xs text-[color:var(--text-secondary)]">Benchmark:</span>
        <span class="text-xs font-medium ml-1">85%</span>
      </div>
    </div>
  </div>
  
  <!-- Gr√°ficos principales mejorados -->
  <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
    <!-- Gr√°fico de tendencia financiera con comparativos -->
    <div class="bg-[color:var(--bg-card)] p-5 rounded-xl border border-[color:var(--border-color)] shadow-lg relative">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-bold">Tendencia Financiera</h2>
        <div class="flex items-center space-x-3">
          <button class="text-xs px-2 py-1 rounded bg-[color:var(--bg-subtle)] text-[color:var(--text-secondary)] border border-[color:var(--border-color)] hover:bg-[color:var(--bg-card)] active-chart-btn" data-chart-view="ingresos">Ingresos</button>
          <button class="text-xs px-2 py-1 rounded bg-[color:var(--bg-subtle)] text-[color:var(--text-secondary)] border border-[color:var(--border-color)] hover:bg-[color:var(--bg-card)]" data-chart-view="margen">Margen</button>
          <button class="text-xs px-2 py-1 rounded bg-[color:var(--bg-subtle)] text-[color:var(--text-secondary)] border border-[color:var(--border-color)] hover:bg-[color:var(--bg-card)]" data-chart-view="cashflow">Cash Flow</button>
        </div>
      </div>
      <div class="h-80">
        <canvas id="financialTrendChart"></canvas>
      </div>
      <!-- Leyenda mejorada con comparativos -->
      <div class="mt-4 grid grid-cols-4 text-center text-xs border-t border-[color:var(--border-color-subtle)] pt-3">
        <div>
          <p class="text-[color:var(--text-secondary)]">YTD</p>
          <p class="font-medium">${{ kpis.ingresos_ytd }}M</p>
        </div>
        <div>
          <p class="text-[color:var(--text-secondary)]">Meta anual</p>
          <p class="font-medium">${{ kpis.meta_anual }}M</p>
        </div>
        <div>
          <p class="text-[color:var(--text-secondary)]">Proyecci√≥n</p>
          <p class="font-medium">${{ kpis.proyeccion_anual }}M</p>
        </div>
        <div>
          <p class="text-[color:var(--text-secondary)]">A√±o anterior</p>
          <p class="font-medium">${{ kpis.ingresos_ano_anterior }}M</p>
        </div>
      </div>
    </div>
    
    <!-- Distribuci√≥n de proyectos - Ahora con bubble chart -->
    <div class="bg-[color:var(--bg-card)] p-5 rounded-xl border border-[color:var(--border-color)] shadow-lg relative">
      <h2 class="text-lg font-bold mb-4">Estado de Proyectos</h2>
      <div class="flex flex-col md:flex-row h-80">
        <div class="w-full md:w-1/2 mb-4 md:mb-0 md:pr-4 relative">
          <!-- Toggle entre visualizaciones -->
          <div class="absolute top-0 left-0 z-10 flex space-x-1">
            <button class="text-xs px-2 py-1 rounded bg-[color:var(--bg-card)] border border-[color:var(--border-color)] active-view-btn" data-view="chart">
              Gr√°fica
            </button>
            <button class="text-xs px-2 py-1 rounded bg-[color:var(--bg-subtle)] text-[color:var(--text-secondary)] border border-[color:var(--border-color)]" data-view="bubble">
              Mapa riesgo
            </button>
          </div>
          
          <!-- Vista 1: Gr√°fica de pastel -->
          <div id="project-chart-view">
            <canvas id="projectStatusChart"></canvas>
          </div>
          
          <!-- Vista 2: Bubble chart de riesgos (inicialmente oculta) -->
          <div id="project-bubble-view" class="hidden h-full">
            <canvas id="projectBubbleChart"></canvas>
          </div>
        </div>
        
        <div class="w-full md:w-1/2 flex flex-col justify-center">
          <div class="space-y-4">
            <!-- Estado de proyectos detalle -->
            <div class="flex items-center justify-between">
              <div class="flex items-center">
                <span class="w-3 h-3 rounded-full bg-[#10B981] mr-2"></span>
                <span>A tiempo</span>
              </div>
              <span class="font-semibold">{{ kpis.proyectos_on_time }}%</span>
            </div>
            
            <div class="flex items-center justify-between">
              <div class="flex items-center">
                <span class="w-3 h-3 rounded-full bg-[#FBBF24] mr-2"></span>
                <span>En riesgo</span>
              </div>
              <span class="font-semibold">{{ 100 - kpis.proyectos_on_time - kpis.proyectos_retrasados }}%</span>
            </div>
            
            <div class="flex items-center justify-between">
              <div class="flex items-center">
                <span class="w-3 h-3 rounded-full bg-[#F87171] mr-2"></span>
                <span>Retrasados</span>
              </div>
              <span class="font-semibold">{{ kpis.proyectos_retrasados }}%</span>
            </div>
            
            <div class="flex items-center justify-between">
              <div class="flex items-center">
                <span class="w-3 h-3 rounded-full bg-[#60A5FA] mr-2"></span>
                <span>Completados</span>
              </div>
              <span class="font-semibold">{{ kpis.pct_avance }}%</span>
            </div>
          </div>
          
          <!-- Acciones r√°pidas con men√∫ expandible -->
          <div class="mt-6">
            <button id="project-actions-btn" class="w-full bg-[color:var(--accent-blue)] hover:bg-blue-600 text-white py-2 px-4 rounded-lg text-sm font-medium transition flex items-center justify-center">
              <span>Acciones de proyecto</span>
              <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            
            <!-- Men√∫ de acciones (inicialmente oculto) -->
            <div id="project-actions-menu" class="hidden mt-2 space-y-2 p-2 bg-[color:var(--bg-subtle)] border border-[color:var(--border-color)] rounded-lg">
              <a href="#" class="block text-sm py-1.5 px-3 rounded hover:bg-[color:var(--bg-card)] transition">
                Ver proyectos en riesgo
              </a>
              <a href="#" class="block text-sm py-1.5 px-3 rounded hover:bg-[color:var(--bg-card)] transition">
                Gestionar planificaci√≥n
              </a>
              <a href="#" class="block text-sm py-1.5 px-3 rounded hover:bg-[color:var(--bg-card)] transition">
                Asignar recursos
              </a>
              <a href="#" class="block text-sm py-1.5 px-3 rounded hover:bg-[color:var(--bg-card)] transition">
                Actualizar estado
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Financieros conectados y mejorados -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Proyecci√≥n cash-in conectada con aging buckets -->
    <div class="bg-[color:var(--bg-card)] p-5 rounded-xl border border-[color:var(--border-color)] shadow-lg relative">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-bold">Cash-In Forecast</h2>
        <div class="flex space-x-1">
          <span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 rounded-md">30-60-90d</span>
          <button class="text-[color:var(--text-secondary)] hover:text-[color:var(--text-primary)]" title="Ver metodolog√≠a de c√°lculo" data-tooltip="Basado en fechas de conformidad estimadas y probabilidad hist√≥rica de cumplimiento por cliente">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
            </svg>
          </button>
        </div>
      </div>
      <div class="h-60">
        <canvas id="cashInForecastChart"></canvas>
      </div>
      <div class="mt-4 pt-4 border-t border-[color:var(--border-color-subtle)]">
        <div class="grid grid-cols-3 gap-2 text-center text-xs">
          <div>
            <p class="text-[color:var(--text-secondary)]">30 d√≠as</p>
            <p id="forecast-30d" class="font-medium text-sm mt-1">${{ cash_forecast.total_30d|default('...') }}M</p>
            <p class="text-[color:var(--text-tertiary)] text-xs">{{ cash_forecast.prob_30d|default('...') }}% prob.</p>
          </div>
          <div>
            <p class="text-[color:var(--text-secondary)]">60 d√≠as</p>
            <p id="forecast-60d" class="font-medium text-sm mt-1">${{ cash_forecast.total_60d|default('...') }}M</p>
            <p class="text-[color:var(--text-tertiary)] text-xs">{{ cash_forecast.prob_60d|default('...') }}% prob.</p>
          </div>
          <div>
            <p class="text-[color:var(--text-secondary)]">90 d√≠as</p>
            <p id="forecast-90d" class="font-medium text-sm mt-1">${{ cash_forecast.total_90d|default('...') }}M</p>
            <p class="text-[color:var(--text-tertiary)] text-xs">{{ cash_forecast.prob_90d|default('...') }}% prob.</p>
          </div>
        </div>
        <div class="mt-3 text-center">
          <p class="text-[color:var(--text-secondary)] text-xs">Total ponderado:</p>
          <p id="forecast-weighted" class="font-semibold text-sm mt-1">${{ cash_forecast.total_ponderado|default('...') }}M</p>
          <div class="mt-2">
            <button class="text-xs text-[color:var(--accent-blue)] hover:underline flex items-center mx-auto">
              <svg class="w-3.5 h-3.5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
              </svg>
              Ajustar escenarios
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Rentabilidad por departamento - con benchmarks y contexto -->
    <div class="bg-[color:var(--bg-card)] p-5 rounded-xl border border-[color:var(--border-color)] shadow-lg relative">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-bold">Rentabilidad por Gestor</h2>
        <button class="text-xs px-2 py-1 rounded bg-[color:var(--bg-subtle)] text-[color:var(--text-secondary)] border border-[color:var(--border-color)] hover:bg-[color:var(--bg-card)]" title="Cambiar vista" id="toggle-profit-view">
          Vista %
        </button>
      </div>
      <div class="h-72">
        <canvas id="departmentProfitChart"></canvas>
      </div>
      
      <!-- Contexto de meta y benchmark -->
      <div class="mt-3 border-t border-[color:var(--border-color-subtle)] pt-3 flex justify-between items-center">
        <span class="text-xs text-[color:var(--text-secondary)]">Meta de rentabilidad: {{ kpis.meta_rentabilidad }}%</span>
        <button class="text-xs text-[color:var(--accent-blue)] hover:underline flex items-center">
          An√°lisis detallado
          <svg class="w-3 h-3 ml-1" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
          </svg>
        </button>
      </div>
    </div>
    
    <!-- Distribuci√≥n por Cliente - con an√°lisis de concentraci√≥n -->
    <div class="bg-[color:var(--bg-card)] p-5 rounded-xl border border-[color:var(--border-color)] shadow-lg relative">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-bold">Distribuci√≥n por Cliente</h2>
        <div class="text-xs px-2 py-1 rounded {% if kpis.concentracion_clientes > 70 %}bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200{% elif kpis.concentracion_clientes > 50 %}bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200{% else %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200{% endif %}">
          {{ kpis.concentracion_clientes }}% en Top 5
        </div>
      </div>
      <div class="h-72">
        <canvas id="budgetDistributionChart"></canvas>
      </div>
      <!-- An√°lisis de riesgo de concentraci√≥n -->
      <div class="mt-3 text-xs text-[color:var(--text-secondary)] border-t border-[color:var(--border-color-subtle)] pt-3">
        {% if kpis.concentracion_clientes > 70 %}
        <p class="flex items-center text-red-500 dark:text-red-400">
          <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
          </svg>
          Alta concentraci√≥n: riesgo de dependencia significativo
        </p>
        {% elif kpis.concentracion_clientes > 50 %}
        <p class="flex items-center text-amber-500 dark:text-amber-400">
          <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
          </svg>
          Concentraci√≥n moderada: diversificar cartera
        </p>
        {% else %}
        <p class="flex items-center text-green-500 dark:text-green-400">
          <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
          </svg>
          Buena diversificaci√≥n: riesgo controlado
        </p>
        {% endif %}
      </div>
    </div>
  </div>
  
  <!-- Tercera fila de gr√°ficos y alertas -->
  <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
    <!-- Aging Buckets conectados con la proyecci√≥n de cash -->
    <div class="bg-[color:var(--bg-card)] p-5 rounded-xl border border-[color:var(--border-color)] shadow-lg relative lg:col-span-2">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-bold">Distribuci√≥n por Antig√ºedad</h2>
        <div class="flex items-center">
          <!-- Benchmarks industry -->
          <span class="text-xs mr-2 text-[color:var(--text-secondary)]">DSO industria: 90d</span>
          <span class="h-4 border-l border-[color:var(--border-color-subtle)] mx-2"></span>
          <button class="text-xs px-2 py-1 rounded bg-[color:var(--bg-subtle)] text-[color:var(--text-secondary)] border border-[color:var(--border-color)] hover:bg-[color:var(--bg-card)]" id="toggle-aging-view">
            Ver tendencia
          </button>
        </div>
      </div>
      <div class="h-60">
        <canvas id="agingBucketsChart"></canvas>
      </div>
      
      <!-- Costo financiero acumulado -->
      <div class="mt-4 pt-3 border-t border-[color:var(--border-color-subtle)]">
        <div class="flex justify-between items-center">
          <span class="text-sm">Costo financiero acumulado:</span>
          <span class="text-sm font-medium text-red-500 dark:text-red-400">${{ kpis.costo_financiero_total }}M</span>
        </div>
        <!-- Acciones directas - Botones conectados con m√≥dulos espec√≠ficos -->
        <div class="mt-3 flex space-x-2">
          <button class="flex-1 text-xs py-1.5 bg-[color:var(--bg-subtle)] hover:bg-[color:var(--bg-card)] border border-[color:var(--border-color)] rounded transition-colors">
            Plan de acci√≥n 30d+
          </button>
          <button class="flex-1 text-xs py-1.5 bg-[color:var(--bg-subtle)] hover:bg-[color:var(--bg-card)] border border-[color:var(--border-color)] rounded transition-colors">
            Plan de acci√≥n 60d+
          </button>
          <button class="flex-1 text-xs py-1.5 bg-[color:var(--bg-subtle)] hover:bg-[color:var(--bg-card)] border border-[color:var(--border-color)] rounded transition-colors">
            Plan de acci√≥n 90d+
          </button>
        </div>
      </div>
    </div>
    
    <!-- Gr√°fico avanzado - Pareto de clientes con informaci√≥n de riesgo -->
    <div class="bg-[color:var(--bg-card)] p-5 rounded-xl border border-[color:var(--border-color)] shadow-lg relative lg:col-span-2 text[color:var(--text-primary)]">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-bold">Concentraci√≥n por Cliente</h2>
        <div class="flex space-x-1">
          <button class="text-xs px-2 py-1 rounded bg-[color:var(--accent-blue)] text-white" id="pareto-toggle-ingresos">Ingresos</button>
          <button class="text-xs px-2 py-1 rounded bg-[color:var(--bg-subtle)] text-[color:var(--text-secondary)] border border-[color:var(--border-color)]" id="pareto-toggle-pendiente">Pendiente</button>
        </div>
      </div>
      <div class="h-60">
        <canvas id="paretoClientChart"></canvas>
      </div>
      
      <!-- An√°lisis de riesgo por cliente principal -->
      <div class="mt-4 pt-3 border-t border-[color:var(--border-color-subtle)]">
        <p class="text-sm font-medium mb-2">Cliente principal: {{ kpis.cliente_principal }}</p>
        <div class="flex space-x-4 text-xs">
          <div>
            <p class="text-[color:var(--text-secondary)]">% Ingresos</p>
            <p class="font-medium">{{ kpis.pct_ingresos_principal }}%</p>
          </div>
          <div>
            <p class="text-[color:var(--text-secondary)]">DSO promedio</p>
            <p class="font-medium">{{ kpis.dso_cliente_principal }}d</p>
          </div>
                            <div>
                    <p class="text-[color:var(--text-secondary)]">Riesgo pago</p>
                    <p class="font-medium {% if kpis.riesgo_pago_principal > 70 %}text-red-500 dark:text-red-400{% elif kpis.riesgo_pago_principal > 40 %}text-amber-500 dark:text-amber-400{% else %}text-green-500 dark:text-green-400{% endif %}">
                      {{ kpis.riesgo_pago_principal }}%
                    </p>
                  </div>
                  <div>
                    <p class="text-[color:var(--text-secondary)]">Hist√≥rico</p>
                    <p class="font-medium">
                      {% if kpis.tendencia_pago_principal == 'mejora' %}
                      <span class="text-green-500 dark:text-green-400 flex items-center">
                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        Mejora
                      </span>
                      {% elif kpis.tendencia_pago_principal == 'estable' %}
                      <span class="text-blue-500 dark:text-blue-400 flex items-center">
                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M8 4a1 1 0 100 2h8a1 1 0 100-2H8zM8 10a1 1 0 100 2h8a1 1 0 100-2H8zM8 16a1 1 0 100 2h8a1 1 0 100-2H8z" clip-rule="evenodd"></path>
                        </svg>
                        Estable
                      </span>
                      {% else %}
                      <span class="text-red-500 dark:text-red-400 flex items-center">
                        <svg class="w-3 h-3 mr-1 rotate-180" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        Deterioro
                      </span>
                      {% endif %}
                    </p>
                  </div>
                </div>
                
                <!-- Acciones para mitigar riesgo de cliente -->
                <div class="mt-3 flex justify-between items-center">
                  {% if kpis.riesgo_pago_principal > 50 %}
                    <span class="text-xs text-red-500 dark:text-red-400 flex items-center">
                      <svg class="w-3.5 h-3.5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                      </svg>
                      Revisar exposici√≥n financiera
                    </span>
                  {% endif %}
                  <button class="text-xs text-[color:var(--accent-blue)] hover:underline ml-auto">
                    Estrategia de diversificaci√≥n
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Alertas cr√≠ticas y panel de acciones -->
            <div class="bg-[color:var(--bg-card)] p-5 rounded-xl border border-[color:var(--border-color)] shadow-lg relative lg:col-span-2">
              <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold flex items-center">
                  Alertas Cr√≠ticas
                  {% if alertas|length > 3 %}
                  <span class="ml-2 flex h-5 w-5 items-center justify-center rounded-full bg-red-100 dark:bg-red-900">
                    <span class="text-xs font-medium text-red-800 dark:text-red-200">{{ alertas|length }}</span>
                  </span>
                  {% endif %}
                </h2>
                <button class="text-xs px-2 py-1 rounded bg-[color:var(--bg-subtle)] text-[color:var(--text-secondary)] border border-[color:var(--border-color)] hover:bg-[color:var(--bg-card)]">
                  Filtrar
                </button>
              </div>
              <div class="space-y-3 max-h-[280px] overflow-y-auto pr-1">
                {% for alerta in alertas[:5] %}
                <div class="p-3 rounded-lg bg-[color:var(--bg-subtle)] border-l-4 {% if alerta.tipo == 'critico' %}border-red-500{% elif alerta.tipo == 'alto' %}border-amber-500{% else %}border-blue-500{% endif %}">
                  <div class="flex justify-between items-start">
                    <h3 class="font-medium text-sm">{{ alerta.titulo }}</h3>
                    <span class="text-xs px-1.5 py-0.5 rounded {% if alerta.tipo == 'critico' %}bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200{% elif alerta.tipo == 'alto' %}bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200{% else %}bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200{% endif %}">
                      {{ alerta.tipo|title }}
                    </span>
                  </div>
                  <p class="text-sm mt-1 text-[color:var(--text-secondary)]">{{ alerta.descripcion }}</p>
                  
                  <!-- Acciones inmediatas para cada alerta -->
                  <div class="flex justify-between items-center mt-2 pt-2 border-t border-[color:var(--border-color-subtle)]">
                    <span class="text-xs text-[color:var(--text-tertiary)]">{{ alerta.fecha }}</span>
                    <div class="flex space-x-2">
                      <button class="text-xs py-0.5 px-2 bg-[color:var(--bg-card)] rounded border border-[color:var(--border-color)] hover:bg-[color:var(--bg-subtle)]">
                        Asignar
                      </button>
                      <button class="text-xs py-0.5 px-2 bg-[color:var(--accent-blue)] text-white rounded hover:bg-blue-600">
                        {{ alerta.accion_principal }}
                      </button>
                    </div>
                  </div>
                </div>
                {% else %}
                <div class="text-center py-8">
                  <svg class="w-12 h-12 mx-auto text-[color:var(--text-tertiary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <p class="mt-2 text-sm text-[color:var(--text-secondary)]">No hay alertas cr√≠ticas en este momento</p>
                </div>
                {% endfor %}
              </div>
              
              <!-- Resumen y acciones para todas las alertas -->
              {% if alertas|length > 0 %}
              <div class="mt-4 pt-3 border-t border-[color:var(--border-color-subtle)] flex justify-between items-center">
                <span class="text-sm">
                  <strong>{{ alertas|length }}</strong> alertas requieren atenci√≥n
                </span>
                <button class="text-xs flex items-center text-[color:var(--accent-blue)] hover:underline">
                  Ver todas
                  <svg class="w-3.5 h-3.5 ml-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                  </svg>
                </button>
              </div>
              {% endif %}
            </div>
            
            <!-- Widget de m√©tricas de eficiencia operativa -->
            <div class="bg-[color:var(--bg-card)] p-5 rounded-xl border border-[color:var(--border-color)] shadow-lg relative lg:col-span-2">
              <h2 class="text-lg font-bold mb-4">Indicadores de Eficiencia</h2>
              
              <div class="space-y-4">
                <!-- Tiempo promedio ciclo completo -->
                <div>
                  <div class="flex justify-between items-center mb-1">
                    <div class="flex items-center">
                      <span class="text-sm">Tiempo medio ciclo EDP</span>
                      <button class="ml-1 text-[color:var(--text-tertiary)]" title="Tiempo desde emisi√≥n hasta pago final">
                        <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                      </button>
                    </div>
                    <span class="text-xs font-medium">{{ kpis.tiempo_medio_ciclo }} d√≠as</span>
                  </div>
                  <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                    <div class="bg-blue-600 h-2 rounded-full" style="width: {{ kpis.tiempo_medio_ciclo_pct }}%"></div>
                  </div>
                  <div class="flex justify-between text-xs mt-1">
                    <span>Meta: {{ kpis.meta_tiempo_ciclo }}d</span>
                    <span>Benchmark: {{ kpis.benchmark_tiempo_ciclo }}d</span>
                  </div>
                </div>
                
                <!-- Desglose de tiempos por etapa -->
                <div class="mt-6">
                  <p class="text-sm font-medium mb-3">Desglose por etapa (d√≠as)</p>
                  <div class="grid grid-cols-4 gap-2">
                    <div class="text-center">
                      <div class="h-20 flex items-end justify-center">
                        <div class="w-full bg-blue-200 dark:bg-blue-900/40 rounded-t-md" style="height: {{ kpis.etapa_emision_pct }}%"></div>
                      </div>
                      <p class="text-xs mt-1">Emisi√≥n</p>
                      <p class="text-xs font-medium">{{ kpis.tiempo_emision }}d</p>
                    </div>
                    <div class="text-center">
                      <div class="h-20 flex items-end justify-center">
                        <div class="w-full bg-green-200 dark:bg-green-900/40 rounded-t-md" style="height: {{ kpis.etapa_gestion_pct }}%"></div>
                      </div>
                      <p class="text-xs mt-1">Gesti√≥n</p>
                      <p class="text-xs font-medium">{{ kpis.tiempo_gestion }}d</p>
                    </div>
                    <div class="text-center">
                      <div class="h-20 flex items-end justify-center">
                        <div class="w-full bg-purple-200 dark:bg-purple-900/40 rounded-t-md" style="height: {{ kpis.etapa_conformidad_pct }}%"></div>
                      </div>
                      <p class="text-xs mt-1">Conformidad</p>
                      <p class="text-xs font-medium">{{ kpis.tiempo_conformidad }}d</p>
                    </div>
                    <div class="text-center">
                      <div class="h-20 flex items-end justify-center">
                        <div class="w-full bg-amber-200 dark:bg-amber-900/40 rounded-t-md" style="height: {{ kpis.etapa_pago_pct }}%"></div>
                      </div>
                      <p class="text-xs mt-1">Pago</p>
                      <p class="text-xs font-medium">{{ kpis.tiempo_pago }}d</p>
                    </div>
                  </div>
                </div>
                
                <!-- Oportunidad de mejora -->
                <div class="mt-4 pt-3 border-t border-[color:var(--border-color-subtle)]">
                  <p class="text-sm font-medium flex items-center">
                    <svg class="w-4 h-4 mr-1 text-amber-500 dark:text-amber-400" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"></path>
                    </svg>
                    Principal oportunidad de mejora:
                  </p>
                  <div class="flex justify-between items-center mt-2">
                    <span class="text-sm">{{ kpis.oportunidad_mejora }}</span>
                    <button class="text-xs text-[color:var(--accent-blue)] hover:underline">
                      Plan de acci√≥n
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Top EDPs por valor -->
          <div class="bg-[color:var(--bg-card)] p-5 rounded-xl border border-[color:var(--border-color)] shadow-lg relative">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-lg font-bold">Top 10 EDPs por Valor Pendiente</h2>
              <div class="flex items-center space-x-2">
                <div class="relative">
                  <input type="text" placeholder="Buscar EDP..." class="py-1 px-3 pr-8 text-sm border border-[color:var(--border-color)] rounded-md bg-[color:var(--bg-card)]">
                  <svg class="w-4 h-4 absolute right-2.5 top-1/2 -translate-y-1/2 text-[color:var(--text-tertiary)]" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                  </svg>
                </div>
                <select class="py-1 px-3 text-sm border border-[color:var(--border-color)] rounded-md bg-[color:var(--bg-card)]">
                  <option value="todos">Todos los estados</option>
                  <option value="pendiente">Pendiente</option>
                  <option value="riesgo">En riesgo</option>
                  <option value="critico">Cr√≠tico</option>
                </select>
              </div>
            </div>
            
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-[color:var(--border-color)]">
                <thead>
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-[color:var(--text-secondary)] uppercase tracking-wider">EDP</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-[color:var(--text-secondary)] uppercase tracking-wider">Proyecto</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-[color:var(--text-secondary)] uppercase tracking-wider">Cliente</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-[color:var(--text-secondary)] uppercase tracking-wider">Monto</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-[color:var(--text-secondary)] uppercase tracking-wider">D√≠as</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-[color:var(--text-secondary)] uppercase tracking-wider">Pr√≥xima fecha</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-[color:var(--text-secondary)] uppercase tracking-wider">Encargado</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-[color:var(--text-secondary)] uppercase tracking-wider">Acciones</th>
                  </tr>
                </thead>
                <tbody class="bg-[color:var(--bg-card)] divide-y divide-[color:var(--border-color-subtle)]">
                  {% for edp in top_edps %}
                  <tr class="hover:bg-[color:var(--bg-subtle)] transition-colors">
                    <td class="px-4 py-3 whitespace-nowrap">
                      <span class="font-medium">{{ edp.edp }}</span>
                    </td>
                    <td class="px-4 py-3 max-w-xs truncate">{{ edp.proyecto }}</td>
                    <td class="px-4 py-3">{{ edp.cliente }}</td>
                    <td class="px-4 py-3 font-medium">${{ edp.monto|round(1) }}M</td>
                    <td class="px-4 py-3">
                      <span class="{% if edp.dias > 90 %}text-red-500 dark:text-red-400{% elif edp.dias > 60 %}text-amber-500 dark:text-amber-400{% elif edp.dias > 30 %}text-blue-500 dark:text-blue-400{% else %}text-green-500 dark:text-green-400{% endif %} font-medium">
                        {{ edp.dias }}d
                      </span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">
                      <span class="{% if edp.dias_prox_fecha < 0 %}text-red-500 dark:text-red-400{% endif %}">
                        {{ edp.prox_fecha|default("-") }}
                        {% if edp.dias_prox_fecha < 0 %}({{ edp.dias_prox_fecha|abs }}d atraso){% endif %}
                      </span>
                    </td>
                    <td class="px-4 py-3">{{ edp.encargado }}</td>
                    <td class="px-4 py-3 text-right text-sm space-x-2">
                      <button class="text-[color:var(--accent-blue)] hover:underline">Ver</button>
                      <button class="text-[color:var(--accent-blue)] hover:underline">Gestionar</button>
                    </td>
                  </tr>
                  {% else %}
                  <tr>
                    <td colspan="8" class="px-4 py-8 text-center text-[color:var(--text-secondary)]">
                      No se encontraron EDPs con los filtros actuales
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            
            <!-- Paginaci√≥n -->
            <div class="mt-4 flex justify-between items-center">
              <span class="text-sm text-[color:var(--text-secondary)]">
                Mostrando <span class="font-medium">1</span> a <span class="font-medium">10</span> de <span class="font-medium">{{ total_edps }}</span> EDPs
              </span>
              <div class="flex space-x-1">
                <button class="px-3 py-1 border border-[color:var(--border-color)] rounded-md text-sm bg-[color:var(--bg-subtle)] text-[color:var(--text-secondary)]">
                  Anterior
                </button>
                <button class="px-3 py-1 border border-[color:var(--border-color)] rounded-md text-sm bg-[color:var(--accent-blue)] text-white">
                  Siguiente
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Scripts para funcionalidad interactiva -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script src="{{ url_for('static', filename='js/manager-charts.js') }}"></script>
<script src="{{ url_for('static', filename='js/critical-projects-modal.js') }}"></script>
<script src="{{ url_for('static', filename='js/utils-dashboard-manager.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggleFiltersBtn = document.getElementById('toggle-filters-btn');
    const filtersSection = document.getElementById('filters-section');
    const filterText = document.getElementById('filter-text');
    const filterChevron = document.getElementById('filter-chevron');
    
    let filtersVisible = false;
    
    // Funci√≥n para mostrar/ocultar filtros
    function toggleFilters() {
        filtersVisible = !filtersVisible;
        
        if (filtersVisible) {
            // Mostrar filtros
            filtersSection.classList.remove('hidden');
            filtersSection.style.opacity = '0';
            filtersSection.style.transform = 'translateY(-10px)';
            
            // Animaci√≥n de entrada
            setTimeout(() => {
                filtersSection.style.transition = 'all 0.3s ease-out';
                filtersSection.style.opacity = '1';
                filtersSection.style.transform = 'translateY(0)';
            }, 10);
            
            // Actualizar bot√≥n
            filterText.textContent = 'Ocultar filtros';
            filterChevron.style.transform = 'rotate(180deg)';
            toggleFiltersBtn.classList.add('bg-blue-700');
            
        } else {
            // Ocultar filtros
            filtersSection.style.transition = 'all 0.3s ease-in';
            filtersSection.style.opacity = '0';
            filtersSection.style.transform = 'translateY(-10px)';
            
            setTimeout(() => {
                filtersSection.classList.add('hidden');
            }, 300);
            
            // Actualizar bot√≥n
            filterText.textContent = 'Mostrar filtros';
            filterChevron.style.transform = 'rotate(0deg)';
            toggleFiltersBtn.classList.remove('bg-blue-700');
        }
    }
    
    // Event listener para el bot√≥n
    toggleFiltersBtn.addEventListener('click', toggleFilters);
    
    // Auto-mostrar filtros si hay filtros activos aplicados
    {% if filtros_activos %}
        // Si hay filtros aplicados, mostrar autom√°ticamente
        setTimeout(toggleFilters, 100);
    {% endif %}
    
    // Funcionalidad para filtros avanzados (ya existente)
    const toggleAdvanced = document.getElementById('toggle-advanced');
    const advancedFilters = document.getElementById('advanced-filters');
    const advancedText = document.getElementById('advanced-text');
    
    if (toggleAdvanced && advancedFilters) {
        toggleAdvanced.addEventListener('click', function() {
            const isHidden = advancedFilters.classList.contains('hidden');
            
            if (isHidden) {
                advancedFilters.classList.remove('hidden');
                advancedText.textContent = 'Ocultar filtros avanzados';
            } else {
                advancedFilters.classList.add('hidden');
                advancedText.textContent = 'Filtros avanzados';
            }
        });
    }
});
</script>

<!-- CSS adicional para mejores transiciones -->
<style>
#filters-section {
    transition: all 0.3s ease-out;
}

#filter-chevron {
    transition: transform 0.3s ease;
}

.btn-primary {
    @apply bg-[color:var(--accent-blue)] hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center;
}
</style>
{% endblock %}