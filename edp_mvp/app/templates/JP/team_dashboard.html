{% extends "base.html" %} {% block title %}Equipo | Jefe de Proyecto{% endblock
%} {% block head_extras %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  .team-member-card {
    transition: all 0.3s ease;
  }
  .team-member-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  }
  .efficiency-bar {
    transition: width 0.5s ease;
  }
  .performance-ring {
    transform: rotate(-90deg);
  }
  .cost-metric {
    transition: all 0.3s ease;
  }
  .cost-alert {
    animation: pulse 2s infinite;
  }
  @keyframes pulse {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.7;
    }
  }

  /* Mejoras para el gráfico */
  .chart-container {
    position: relative;
    overflow: hidden;
  }

  .chart-container canvas {
    max-width: 100% !important;
    height: auto !important;
  }

  /* Responsividad para móviles */
  @media (max-width: 768px) {
    .chart-container {
      height: 300px !important;
    }
  }

  @media (max-width: 640px) {
    .chart-container {
      height: 250px !important;
    }
  }
</style>
{% endblock %} {% block content %}
<!-- Header del equipo -->
<div
  class="bg-gradient-to-r from-[color:var(--bg-card)] to-[color:var(--bg-secondary)] border border-[color:var(--border-color)] rounded-xl p-6 mb-6 shadow-sm">
  <div class="flex flex-col md:flex-row justify-between items-start">
    <div class="flex items-center mb-4 md:mb-0">
      <a
        href="{{ url_for('project_manager.dashboard') }}"
        class="mr-4 p-2 bg-[color:var(--bg-card)] rounded-lg border border-[color:var(--border-color)] hover:bg-[color:var(--bg-hover)] transition-colors">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-5 w-5 text-[color:var(--text-primary)]"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
      </a>

      <div>
        <div class="flex items-center">
          <h1 class="text-2xl font-bold text-[color:var(--text-primary)]">
            Control de Costos del Equipo
          </h1>
          <span
            class="ml-3 px-3 py-1 bg-[color:var(--accent-purple)] bg-opacity-15 text-[color:var(--accent-white)] text-sm font-semibold rounded-md">
            {{ current_user.nombre_completo or current_user.username }}
          </span>
        </div>
        <div
          class="flex items-center mt-2 text-sm text-[color:var(--text-secondary)]">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4 mr-1"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
          {{ team_metrics.total_members }} miembros
          <span class="mx-2">•</span>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4 mr-1"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1" />
          </svg>
          ROI del equipo: {{ cost_analysis.team_roi or 0 }}%
        </div>
      </div>
    </div>

    <div class="flex flex-col sm:flex-row gap-3">
      <button class="btn btn-outline" onclick="exportCostReport()">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4 mr-2"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
        </svg>
        Exportar Análisis de Costos
      </button>
      <button class="btn btn-primary" onclick="refreshTeamData()">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4 mr-2"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        Actualizar
      </button>
    </div>
  </div>
</div>

<!-- Métricas Financieras del Equipo -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
  <!-- Total Miembros -->
  <div
    class="bg-[color:var(--bg-card)] border border-[color:var(--border-color)] rounded-xl p-6 text-center">
    <div
      class="w-16 h-16 bg-[color:var(--accent-blue)] bg-opacity-15 rounded-full flex items-center justify-center mx-auto mb-4">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-8 w-8 text-[color:var(--accent-blue)]"
        fill="none"
        viewBox="0 0 24 24"
        stroke="white">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
      </svg>
    </div>
    <div class="text-2xl font-bold text-[color:var(--accent-blue)] mb-1">
      {{ team_metrics.total_members }}
    </div>
    <div class="text-sm text-[color:var(--text-secondary)]">
      Miembros del Equipo
    </div>
  </div>

  <!-- Costo Total del Equipo -->
  <div
    class="bg-[color:var(--bg-card)] border border-[color:var(--border-color)] rounded-xl p-6 text-center">
    <div
      class="w-16 h-16 bg-[color:var(--accent-red)] bg-opacity-15 rounded-full flex items-center justify-center mx-auto mb-4">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-8 w-8 text-[color:var(--accent-red)]"
        fill="none"
        viewBox="0 0 24 24"
        stroke="white">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1" />
      </svg>
    </div>
    <div class="text-2xl font-bold text-[color:var(--accent-red)] mb-1">
      {{ format_currency(cost_analysis.total_salary_cost or 0) }}
    </div>
    <div class="text-sm text-[color:var(--text-secondary)]">
      Costo Mensual del Equipo
    </div>
  </div>

  <!-- ROI del Equipo -->
  <div
    class="bg-gradient-to-br from-[color:var(--accent-green)] to-[color:var(--accent-blue)] text-white rounded-xl p-6 text-center">
    <div
      class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-8 w-8 text-white"
        fill="none"
        viewBox="0 0 24 24"
        stroke="white">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
      </svg>
    </div>
    <div class="text-2xl font-bold mb-1">
      {{ cost_analysis.team_roi or 0 }}%
    </div>
    <div class="text-sm opacity-90">ROI del Equipo</div>
  </div>

  <!-- Ingresos Generados -->
  <div
    class="bg-[color:var(--bg-card)] border border-[color:var(--border-color)] rounded-xl p-6 text-center">
    <div
      class="w-16 h-16 bg-[color:var(--accent-green)] bg-opacity-15 rounded-full flex items-center justify-center mx-auto mb-4">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-8 w-8 text-[color:var(--accent-green)]"
        fill="none"
        viewBox="0 0 24 24"
        stroke="white">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M9 8h6m-5 0a3 3 0 110 6H9l3 3m-3-6h6m6 1a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    </div>
    <div class="text-2xl font-bold text-[color:var(--accent-green)] mb-1">
      {{ format_currency(cost_analysis.total_revenue or 0) }}
    </div>
    <div class="text-sm text-[color:var(--text-secondary)]">
      Ingresos Generados
    </div>
  </div>

  <!-- Eficiencia de Costos -->
  <div
    class="bg-[color:var(--bg-card)] border border-[color:var(--border-color)] rounded-xl p-6 text-center">
    <div class="relative w-16 h-16 mx-auto mb-4">
      <svg class="w-16 h-16 performance-ring">
        <circle
          cx="32"
          cy="32"
          r="28"
          stroke="currentColor"
          stroke-width="4"
          fill="transparent"
          class="text-[color:var(--bg-subtle)]" />
        <circle
          cx="32"
          cy="32"
          r="28"
          stroke="currentColor"
          stroke-width="4"
          fill="transparent"
          class="text-[color:var(--accent-purple)]"
          stroke-dasharray="{{ (cost_analysis.cost_efficiency_ratio or 0) * 50 }} 175.93" />
      </svg>
      <div class="absolute inset-0 flex items-center justify-center">
        <span class="text-lg font-bold text-[color:var(--accent-purple)]"
          >{{ "%.1f"|format(cost_analysis.cost_efficiency_ratio or 0) }}</span
        >
      </div>
    </div>
    <div class="text-sm text-[color:var(--text-secondary)]">
      Ratio Eficiencia de Costos
    </div>
  </div>
</div>

<!-- Alertas de Costos y Gráfico ROI -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
  <!-- Gráfico de ROI por Miembro -->
  <div class="lg:col-span-2">
    <div
      class="bg-[color:var(--bg-card)] border border-[color:var(--border-color)] rounded-xl p-6">
      <h2 class="text-xl font-semibold mb-6 flex items-center">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-5 w-5 mr-2 text-[color:var(--accent-green)]"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
        </svg>
        ROI y Eficiencia por Miembro
      </h2>
      <div class="relative w-full h-80">
        <canvas id="roiChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Alertas de Costos -->
  <div class="space-y-4">
    <div
      class="bg-[color:var(--bg-card)] border border-[color:var(--border-color)] rounded-xl p-6">
      <h3 class="font-semibold mb-4 flex items-center">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4 mr-2 text-[color:var(--accent-amber)]"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 13.5c-.77.833.192 2.5 1.732 2.5z" />
        </svg>
        Alertas de Costos
      </h3>
      {% if cost_analysis.cost_alerts and cost_analysis.cost_alerts|length > 0
      %}
      <div class="space-y-3">
        {% for alert in cost_analysis.cost_alerts %}
        <div
          class="flex items-start p-3 {% if alert.type == 'danger' %}bg-[color:var(--state-danger-bg)] border border-[color:var(--accent-red)]{% elif alert.type == 'warning' %}bg-[color:var(--state-warning-bg)] border border-[color:var(--accent-amber)]{% else %}bg-[color:var(--state-info-bg)] border border-[color:var(--accent-blue)]{% endif %} rounded-lg">
          <div class="flex-shrink-0 mt-1">
            {% if alert.type == 'danger' %}
            <svg
              class="h-4 w-4 text-[color:var(--accent-red)]"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 13.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
            {% elif alert.type == 'warning' %}
            <svg
              class="h-4 w-4 text-[color:var(--accent-amber)]"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 13.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
            {% else %}
            <svg
              class="h-4 w-4 text-[color:var(--accent-blue)]"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            {% endif %}
          </div>
          <div class="ml-3">
            <div class="font-medium text-[color:var(--text-primary)]">
              {{ alert.title }}
            </div>
            <div class="text-sm text-[color:var(--text-secondary)] mt-1">
              {{ alert.message }}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="text-center py-8">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-12 w-12 mx-auto text-[color:var(--accent-green)] mb-3"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <div class="text-sm text-[color:var(--text-secondary)]">
          Todos los costos están<br />bajo control
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Lista de Miembros del Equipo -->
<div
  class="bg-[color:var(--bg-card)] border border-[color:var(--border-color)] rounded-xl p-6">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-xl font-semibold flex items-center">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-5 w-5 mr-2 text-[color:var(--accent-blue)]"
        fill="none"
        viewBox="0 0 24 24"
        stroke="white">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
      </svg>
      Miembros del Equipo
      <span class="ml-2 text-sm text-[color:var(--text-secondary)]"
        >({{ team_performance|length if team_performance else 0 }})</span
      >
    </h2>
  </div>

  {% if team_performance and team_performance|length > 0 %}
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for member_name, member_data in team_performance.items() %} {% set
    member_cost = cost_analysis.team_cost_metrics.get(member_name, {}) %}
    <div
      class="team-member-card bg-[color:var(--bg-secondary)] border border-[color:var(--border-color)] rounded-xl p-6 hover:shadow-lg transition-all duration-300">
      <!-- Avatar y información básica -->
      <div class="flex items-center mb-4">
        <div
          class="w-12 h-12 bg-gradient-to-br from-[color:var(--accent-blue)] to-[color:var(--accent-purple)] rounded-full flex items-center justify-center mr-3">
          <span class="text-white font-bold text-lg"
            >{{ member_name[0].upper() }}</span
          >
        </div>
        <div class="flex-1">
          <div class="font-semibold text-[color:var(--text-primary)]">
            {{ member_name }}
          </div>
          <div class="text-sm text-[color:var(--text-secondary)]">
            {{ member_cost.role or 'Miembro del equipo' }}
          </div>
        </div>
        <!-- Indicator de costo -->
        <div class="text-right">
          <div class="text-xs text-[color:var(--text-secondary)]">Salario</div>
          <div class="font-semibold text-[color:var(--accent-red)] text-sm">
            {{ format_currency(member_cost.monthly_salary or 0) }}
          </div>
        </div>
      </div>

      <!-- Métricas de rendimiento y costos -->
      <div class="space-y-3 mb-4">
        <div class="flex justify-between items-center">
          <span class="text-sm text-[color:var(--text-secondary)]"
            >EDPs Manejados</span
          >
          <span class="font-semibold text-[color:var(--text-primary)]"
            >{{ member_data.total_edps }}</span
          >
        </div>
        <div class="flex justify-between items-center">
          <span class="text-sm text-[color:var(--text-secondary)]"
            >Ingresos Generados</span
          >
          <span class="font-semibold text-[color:var(--accent-green)]"
            >{{ format_currency(member_data.total_amount) }}</span
          >
        </div>
        <div class="flex justify-between items-center">
          <span class="text-sm text-[color:var(--text-secondary)]"
            >ROI Individual</span
          >
          <span
            class="font-semibold {% if member_cost.roi_percentage and member_cost.roi_percentage >= 200 %}text-[color:var(--accent-green)]{% elif member_cost.roi_percentage and member_cost.roi_percentage >= 150 %}text-[color:var(--accent-amber)]{% else %}text-[color:var(--accent-red)]{% endif %}">
            {{ "%.1f"|format(member_cost.roi_percentage or 0) }}%
          </span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-sm text-[color:var(--text-secondary)]"
            >Costo por EDP</span
          >
          <span class="font-semibold text-[color:var(--text-primary)]">
            {{ format_currency(member_cost.cost_per_edp or 0) }}
          </span>
        </div>
      </div>

      <!-- Indicador de eficiencia de costos -->
      <div class="mb-4">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm font-medium text-[color:var(--text-primary)]"
            >Eficiencia de Costos</span
          >
          <span
            class="text-sm font-bold {% if member_cost.cost_efficiency_score and member_cost.cost_efficiency_score >= 80 %}text-[color:var(--accent-green)]{% elif member_cost.cost_efficiency_score and member_cost.cost_efficiency_score >= 60 %}text-[color:var(--accent-amber)]{% else %}text-[color:var(--accent-red)]{% endif %}">
            {{ "%.1f"|format(member_cost.cost_efficiency_score or 0) }}
          </span>
        </div>
        <div class="w-full bg-[color:var(--bg-subtle)] rounded-full h-2">
          <div
            class="cost-metric h-2 rounded-full transition-all duration-500 {% if member_cost.cost_efficiency_score and member_cost.cost_efficiency_score >= 80 %}bg-[color:var(--accent-green)]{% elif member_cost.cost_efficiency_score and member_cost.cost_efficiency_score >= 60 %}bg-[color:var(--accent-amber)]{% else %}bg-[color:var(--accent-red)]{% endif %}"
            style="width: {{ member_cost.cost_efficiency_score or 0 }}%"></div>
        </div>
      </div>

      <!-- Badge de rendimiento basado en ROI -->
      <div class="flex justify-center">
        {% if member_cost.roi_percentage and member_cost.roi_percentage >= 250
        %}
        <span
          class="px-3 py-1 bg-[color:var(--state-success-bg)] text-[color:var(--accent-green)] text-xs font-semibold rounded-full border border-[color:var(--accent-green)]">
          🏆 ROI Excelente
        </span>
        {% elif member_cost.roi_percentage and member_cost.roi_percentage >= 200
        %}
        <span
          class="px-3 py-1 bg-[color:var(--state-success-bg)] text-[color:var(--accent-green)] text-xs font-semibold rounded-full">
          💰 Muy Rentable
        </span>
        {% elif member_cost.roi_percentage and member_cost.roi_percentage >= 150
        %}
        <span
          class="px-3 py-1 bg-[color:var(--state-warning-bg)] text-[color:var(--accent-amber)] text-xs font-semibold rounded-full">
          📊 Rentable
        </span>
        {% else %}
        <span
          class="px-3 py-1 bg-[color:var(--state-danger-bg)] text-[color:var(--accent-red)] text-xs font-semibold rounded-full">
          ⚠️ Revisar Costos
        </span>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="text-center py-12">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-16 w-16 mx-auto text-[color:var(--text-secondary)] mb-4"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor">
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
    </svg>
    <h3 class="text-lg font-semibold text-[color:var(--text-primary)] mb-2">
      No hay miembros del equipo
    </h3>
    <p class="text-[color:var(--text-secondary)]">
      Aún no se han asignado miembros a este jefe de proyecto.
    </p>
  </div>
  {% endif %}
</div>

<!-- Desglose de Costos por Rol -->
<div
  class="mt-8 bg-[color:var(--bg-card)] border border-[color:var(--border-color)] rounded-xl p-6">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-xl font-semibold flex items-center">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-5 w-5 mr-2 text-[color:var(--accent-purple)]"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
      </svg>
      Desglose de Costos por Rol
    </h2>
    <button class="btn btn-outline text-sm" onclick="downloadCostBreakdown()">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-4 w-4 mr-1"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 10v6m0 0l-4-4m4 4l4-4m3 8H9a2 2 0 01-2-2V6a2 2 0 012-2h6l4 4v12a2 2 0 01-2 2z" />
      </svg>
      Descargar
    </button>
  </div>

  {% if cost_analysis.salary_breakdown and cost_analysis.salary_breakdown|length
  > 0 %}
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
    {% for role, role_data in cost_analysis.salary_breakdown.items() %}
    <div
      class="bg-[color:var(--bg-secondary)] border border-[color:var(--border-color)] rounded-lg p-4">
      <!-- Encabezado del rol -->
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center">
          <div
            class="w-8 h-8 bg-[color:var(--accent-blue)] bg-opacity-15 rounded-full flex items-center justify-center mr-2">
            {% if 'inspector' in role %}
            <svg
              class="h-4 w-4 text-[color:var(--accent-blue)]"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
            </svg>
            {% elif 'administrativo' in role %}
            <svg
              class="h-4 w-4 text-[color:var(--accent-purple)]"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
            </svg>
            {% else %}
            <svg
              class="h-4 w-4 text-[color:var(--accent-green)]"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            {% endif %}
          </div>
          <div>
            <div
              class="text-sm font-semibold text-[color:var(--text-primary)] capitalize">
              {{ role.replace('_', ' ') }}
            </div>
          </div>
        </div>
        <span
          class="text-xs bg-[color:var(--accent-blue)] bg-opacity-15 text-[color:var(--accent-blue)] px-2 py-1 rounded-full">
          {{ role_data.count or 0 }}
        </span>
      </div>

      <!-- Métricas del rol -->
      <div class="space-y-2">
        <div class="flex justify-between items-center">
          <span class="text-xs text-[color:var(--text-secondary)]"
            >Salario/mes</span
          >
          <span class="text-sm font-semibold text-[color:var(--accent-red)]">
            {{ format_currency(role_data.total_cost / role_data.count if
            role_data.count > 0 else 0) }}
          </span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-xs text-[color:var(--text-secondary)]"
            >Total/mes</span
          >
          <span class="text-sm font-bold text-[color:var(--text-primary)]">
            {{ format_currency(role_data.total_cost or 0) }}
          </span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-xs text-[color:var(--text-secondary)]"
            >% del Total</span
          >
          <span class="text-sm font-semibold text-[color:var(--accent-purple)]">
            {{ "%.1f"|format((role_data.total_cost or 0) /
            (cost_analysis.total_salary_cost or 1) * 100) }}%
          </span>
        </div>
      </div>

      <!-- Barra de proporción -->
      <div class="mt-3">
        <div class="w-full bg-[color:var(--bg-subtle)] rounded-full h-2">
          <div
            class="h-2 rounded-full bg-gradient-to-r from-[color:var(--accent-blue)] to-[color:var(--accent-purple)] transition-all duration-500"
            style="width: {{ role_data.percentage or 0 }}%"></div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Resumen de costos totales -->
  <div
    class="mt-6 p-4 bg-gradient-to-r from-[color:var(--bg-subtle)] to-[color:var(--bg-secondary)] rounded-lg border border-[color:var(--border-color)]">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
      <div>
        <div class="text-2xl font-bold text-[color:var(--accent-red)]">
          {{ format_currency(cost_analysis.total_salary_cost or 0) }}
        </div>
        <div class="text-sm text-[color:var(--text-secondary)]">
          Costo Total Mensual
        </div>
      </div>
      <div>
        <div class="text-2xl font-bold text-[color:var(--accent-green)]">
          {{ format_currency(cost_analysis.total_revenue or 0) }}
        </div>
        <div class="text-sm text-[color:var(--text-secondary)]">
          Ingresos Generados
        </div>
      </div>
      <div>
        <div class="text-2xl font-bold text-[color:var(--accent-blue)]">
          {{ cost_analysis.team_roi or 0 }}%
        </div>
        <div class="text-sm text-[color:var(--text-secondary)]">
          ROI General del Equipo
        </div>
      </div>
    </div>
  </div>
  {% else %}
  <div class="text-center py-8">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-16 w-16 mx-auto text-[color:var(--text-secondary)] mb-4"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor">
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
    </svg>
    <h3 class="text-lg font-semibold text-[color:var(--text-primary)] mb-2">
      No hay datos de costos disponibles
    </h3>
    <p class="text-[color:var(--text-secondary)]">
      Los datos de desglose de costos se generarán automáticamente cuando haya
      miembros del equipo asignados.
    </p>
  </div>
  {% endif %}
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Gráfico de ROI y Eficiencia por Miembro
    const ctx = document.getElementById('roiChart').getContext('2d');

    const teamData = {{ team_performance | tojson | safe }};
    const costData = {{ cost_analysis.team_cost_metrics | default({}) | tojson | safe }};
    const memberNames = Object.keys(teamData || {});

    // Truncate long names for display
    const displayNames = memberNames.map(name => {
      return name.length > 10 ? name.substring(0, 8) + '...' : name;
    });

    // Preparar datos para el gráfico de doble eje
    const roiData = memberNames.map(name => {
      const memberCost = costData[name] || {};
      return memberCost.roi_percentage || 0;
    });

    const efficiencyData = memberNames.map(name => {
      const memberCost = costData[name] || {};
      return memberCost.cost_efficiency_score || 0;
    });

    // Crear gráfico de doble eje
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: displayNames,
        datasets: [
          {
            label: 'ROI (%)',
            data: roiData,
            backgroundColor: roiData.map(roi => {
              if (roi >= 250) return '#10b981'; // green
              if (roi >= 200) return '#3b82f6'; // blue
              if (roi >= 150) return '#f59e0b'; // amber
              return '#ef4444'; // red
            }),
            borderColor: roiData.map(roi => {
              if (roi >= 250) return '#059669';
              if (roi >= 200) return '#2563eb';
              if (roi >= 150) return '#d97706';
              return '#dc2626';
            }),
            borderWidth: 1,
            yAxisID: 'y'
          },
          {
            label: 'Eficiencia de Costos',
            data: efficiencyData,
            type: 'line',
            fill: false,
            borderColor: '#8b5cf6',
            backgroundColor: '#8b5cf6',
            tension: 0.4,
            pointBackgroundColor: '#8b5cf6',
            pointBorderColor: '#7c3aed',
            pointRadius: 6,
            pointHoverRadius: 8,
            yAxisID: 'y1'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: {
          padding: {
            top: 10,
            bottom: 10,
            left: 10,
            right: 10
          }
        },
        interaction: {
          mode: 'index',
          intersect: false,
        },
        scales: {
          x: {
            display: true,
            title: {
              display: true,
              text: 'Miembros del Equipo',
              font: {
                size: 12
              }
            },
            ticks: {
              maxRotation: 45,
              minRotation: 0,
              font: {
                size: 10
              },
              callback: function(value, index) {
                // Show full name on hover, truncated on display
                return displayNames[index];
              }
            }
          },
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            title: {
              display: true,
              text: 'ROI (%)',
              color: '#374151',
              font: {
                size: 11
              }
            },
            ticks: {
              font: {
                size: 10
              },
              callback: function(value) {
                return value + '%';
              }
            },
            grid: {
              color: 'rgba(0, 0, 0, 0.1)'
            }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            title: {
              display: true,
              text: 'Eficiencia de Costos',
              color: '#8b5cf6',
              font: {
                size: 11
              }
            },
            grid: {
              drawOnChartArea: false,
            },
            ticks: {
              font: {
                size: 10
              },
              callback: function(value) {
                return value.toFixed(1);
              }
            }
          }
        },
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              usePointStyle: true,
              padding: 15,
              font: {
                size: 11
              }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: 'white',
            bodyColor: 'white',
            borderColor: '#374151',
            borderWidth: 1,
            cornerRadius: 6,
            displayColors: true,
            callbacks: {
              title: function(tooltipItems) {
                // Show full name in tooltip
                const index = tooltipItems[0].dataIndex;
                return 'Análisis de ' + memberNames[index];
              },
              label: function(context) {
                const memberName = memberNames[context.dataIndex];
                const member = teamData[memberName] || {};
                const memberCost = costData[memberName] || {};

                if (context.dataset.label.includes('ROI')) {
                  return [
                    `ROI: ${context.parsed.y.toFixed(1)}%`,
                    `Salario: $${(memberCost.monthly_salary || 0).toLocaleString()}`,
                    `Ingresos: $${(member.total_amount || 0).toLocaleString()}`
                  ];
                } else {
                  return [
                    `Eficiencia: ${context.parsed.y.toFixed(1)}`,
                    `Costo por EDP: $${(memberCost.cost_per_edp || 0).toLocaleString()}`,
                    `EDPs procesados: ${member.total_edps || 0}`
                  ];
                }
              }
            }
          }
        }
      }
    });
  });

  function exportCostReport() {
    try {
      // Datos para el reporte de costos
      const teamData = {{ team_performance | tojson }};
      const costData = {{ cost_analysis | tojson }};

      // Crear contenido CSV
      let csvContent = "data:text/csv;charset=utf-8,";
      csvContent += "Miembro,Rol,Salario Mensual,EDPs Manejados,Ingresos Generados,ROI,Eficiencia de Costos,Costo por EDP\n";

      Object.keys(teamData).forEach(memberName => {
        const member = teamData[memberName];
        const memberCost = costData.team_cost_metrics[memberName] || {};

        csvContent += [
          memberName,
          memberCost.role || 'N/A',
          memberCost.monthly_salary || 0,
          member.total_edps || 0,
          member.total_amount || 0,
          (memberCost.roi_percentage || 0).toFixed(1) + '%',
          (memberCost.cost_efficiency_score || 0).toFixed(1),
          memberCost.cost_per_edp || 0
        ].join(",") + "\n";
      });

      // Crear y descargar archivo
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `reporte_costos_equipo_${new Date().toISOString().split('T')[0]}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      // Mostrar notificación
      showNotification('Reporte de costos exportado exitosamente', 'success');
    } catch (error) {
      console.error('Error al exportar reporte:', error);
      showNotification('Error al exportar el reporte de costos', 'error');
    }
  }

  function downloadCostBreakdown() {
    try {
      const costData = {{ cost_analysis | tojson }};

      // Crear contenido CSV para desglose por roles
      let csvContent = "data:text/csv;charset=utf-8,";
      csvContent += "Rol,Cantidad,Salario Individual,Costo Total,Porcentaje del Total\n";

      Object.keys(costData.salary_breakdown || {}).forEach(role => {
        const roleData = costData.salary_breakdown[role];
        csvContent += [
          role.replace('_', ' '),
          roleData.count || 0,
          roleData.monthly_salary || 0,
          roleData.total_cost || 0,
          (roleData.percentage || 0).toFixed(1) + '%'
        ].join(",") + "\n";
      });

      // Agregar resumen
      csvContent += "\nRESUMEN\n";
      csvContent += "Concepto,Valor\n";
      csvContent += `Costo Total Mensual,${costData.total_salary_cost || 0}\n`;
      csvContent += `Ingresos Generados,${costData.total_revenue || 0}\n`;
      csvContent += `ROI General del Equipo,${(costData.team_roi || 0).toFixed(1)}%\n`;

      // Crear y descargar archivo
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `desglose_costos_roles_${new Date().toISOString().split('T')[0]}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      showNotification('Desglose de costos descargado exitosamente', 'success');
    } catch (error) {
      console.error('Error al descargar desglose:', error);
      showNotification('Error al descargar el desglose de costos', 'error');
    }
  }

  function refreshTeamData() {
    showNotification('Actualizando datos del equipo...', 'info');
    window.location.reload();
  }

  function showNotification(message, type = 'info') {
    // Crear elemento de notificación
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full`;

    // Configurar estilos según el tipo
    switch(type) {
      case 'success':
        notification.className += ' bg-green-100 border border-green-400 text-green-700';
        break;
      case 'error':
        notification.className += ' bg-red-100 border border-red-400 text-red-700';
        break;
      case 'warning':
        notification.className += ' bg-yellow-100 border border-yellow-400 text-yellow-700';
        break;
      default:
        notification.className += ' bg-blue-100 border border-blue-400 text-blue-700';
    }

    notification.innerHTML = `
      <div class="flex items-center">
        <span class="mr-2">${message}</span>
        <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-gray-500 hover:text-gray-700">
          ×
        </button>
      </div>
    `;

    document.body.appendChild(notification);

    // Animar entrada
    setTimeout(() => {
      notification.classList.remove('translate-x-full');
    }, 100);

    // Auto-remover después de 5 segundos
    setTimeout(() => {
      notification.classList.add('translate-x-full');
      setTimeout(() => notification.remove(), 300);
    }, 5000);
  }
</script>
{% endblock %}
