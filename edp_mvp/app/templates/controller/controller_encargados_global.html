{% extends "base.html" %} {% block content %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/controller/controller_encargados_global.css') }}" />

<div class="dashboard-container" style="padding: 24px">
  <div class="container mx-auto" style="max-width: 1600px">
    <!-- HEADER CON MÉTRICAS EJECUTIVAS -->
    <div class="command-header">
      <h1 class="header-title">
        <svg
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="currentColor"
          style="margin-right: 8px">
          <path
            d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" />
        </svg>
        Centro de Comando JP - Analytics
      </h1>

      <div class="kpi-grid">
        {% set criticos_count = encargados|selectattr('dso', '>',
        60)|list|length if encargados else 0 %} {% set promedio_dso =
        managers_data.promedio_dso|default(0) %} {% set total_pendiente =
        managers_data.total_pendiente|default(0) %} {% set eficiencia_global =
        managers_data.avance_global|default(0) %}

        <div
          class="kpi-card {% if criticos_count > 0 %}critical{% else %}good{% endif %}">
          <div>
            <div class="kpi-label">JP Críticos</div>
            <div class="kpi-value">{{ criticos_count }}</div>
          </div>
          <div
            class="kpi-change {% if criticos_count > 0 %}up{% else %}neutral{% endif %}">
            {% if criticos_count > 0 %}+{{ criticos_count }} vs mes ant.{% else
            %}Bajo control{% endif %}
          </div>
        </div>

        <div
          class="kpi-card {% if promedio_dso < 45 %}good{% elif promedio_dso < 60 %}warning{% else %}critical{% endif %}">
          <div>
            <div class="kpi-label">DSO Promedio</div>
            <div class="kpi-value">{{ promedio_dso }}d</div>
          </div>
          <div class="kpi-change neutral">Target: 45d</div>
        </div>

        <div class="kpi-card neutral">
          <div>
            <div class="kpi-label">Total Pendiente</div>
            <div class="kpi-value">
              ${{ "{:,.0f}".format(total_pendiente/1000000).replace(",",".") }}M
            </div>
          </div>
          {% set evol_data = evolucion_mensual|default({}) %} {% if
          evol_data.crecimiento_mensual and evol_data.crecimiento_mensual|length
          > 0 %} {% set ultimo_cambio = evol_data.crecimiento_mensual[-1] %}
          <div
            class="kpi-change {% if ultimo_cambio > 0 %}up{% elif ultimo_cambio < 0 %}down{% else %}neutral{% endif %}">
            {% if ultimo_cambio > 0 %}+{{ ultimo_cambio }}%{% elif ultimo_cambio
            < 0 %}{{ ultimo_cambio }}%{% else %}Sin cambio{% endif %} vs mes
            ant.
          </div>
          {% else %}
          <div class="kpi-change neutral">Datos históricos N/A</div>
          {% endif %}
        </div>

        <div
          class="kpi-card {% if eficiencia_global >= 80 %}good{% elif eficiencia_global >= 60 %}warning{% else %}critical{% endif %}">
          <div>
            <div class="kpi-label">Eficiencia Global</div>
            <div class="kpi-value">{{ eficiencia_global }}%</div>
          </div>
          {% if evol_data.tendencia_general %}
          <div
            class="kpi-change {% if evol_data.tendencia_general == 'creciente' %}up{% elif evol_data.tendencia_general == 'decreciente' %}down{% else %}neutral{% endif %}">
            {% if evol_data.tendencia_general == 'creciente' %}Mejorando{% elif
            evol_data.tendencia_general == 'decreciente' %}Deteriorando{% else
            %}Estable{% endif %}
          </div>
          {% else %}
          <div class="kpi-change neutral">En análisis</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- ALERTAS CRÍTICAS -->
    {% set jp_criticos = encargados|selectattr('dso', '>=', 60)|list if
    encargados else [] %} {% if jp_criticos|length > 0 %}
    <div class="alerts-section">
      <div class="alert-banner">
        <div class="alert-title">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="currentColor"
            style="margin-right: 8px; vertical-align: middle">
            <path d="M13,14H11V10H13M13,18H11V16H13M1,21H23L12,2L1,21Z" />
          </svg>
          {{ jp_criticos|length }} JP requieren acción inmediata
        </div>
        <div class="alert-subtitle">
          ${{
          "{:,.0f}".format(jp_criticos|map(attribute='monto_pendiente')|sum/1000000).replace(",",".")
          }}M en riesgo alto • DSO promedio críticos: {{
          (jp_criticos|map(attribute='dso')|sum / jp_criticos|length)|round }}d
        </div>
      </div>
    </div>
    {% endif %}

    <!-- DASHBOARD PRINCIPAL CON CHARTS -->
    <div class="dashboard-grid">
      <!-- DISTRIBUCIÓN DSO -->
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="currentColor"
              style="margin-right: 8px; vertical-align: middle">
              <path d="M22,21H2V3H4V19H6V10H10V19H12V6H16V19H18V14H22V21Z" />
            </svg>
            Distribución DSO por JP
          </div>
          <div class="chart-subtitle">Análisis de días de venta pendientes</div>
        </div>
        <div class="chart-container">
          <canvas id="dsoDistributionChart"></canvas>
        </div>
      </div>

      <!-- ANÁLISIS DE RIESGO POR JP -->
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="currentColor"
              style="margin-right: 8px; vertical-align: middle">
              <path
                d="M12,2L13.09,8.26L22,9L13.09,9.74L12,16L10.91,9.74L2,9L10.91,8.26L12,2Z" />
            </svg>
            Análisis de Riesgo por JP
          </div>
          <div class="chart-subtitle">JP clasificados por nivel de riesgo</div>
        </div>
        <div class="chart-container">
          <canvas id="riskAnalysisChart"></canvas>
        </div>
      </div>

      <!-- CORRELACIÓN DSO-MONTO -->
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="currentColor"
              style="margin-right: 8px; vertical-align: middle">
              <path
                d="M7,15H9C9,16.08 10.37,17 12,17C13.63,17 15,16.08 15,15C15,13.9 13.96,13.5 11.76,12.97C9.64,12.44 7,11.78 7,9C7,7.21 8.47,5.69 10.5,5.18V3H13.5V5.18C15.53,5.69 17,7.21 17,9H15C15,7.92 13.63,7 12,7C10.37,7 9,7.92 9,9C9,10.1 10.04,10.5 12.24,11.03C14.36,11.56 17,12.22 17,15C17,16.79 15.53,18.31 13.5,18.82V21H10.5V18.82C8.47,18.31 7,16.79 7,15Z" />
            </svg>
            DSO vs Monto Pendiente
          </div>
          <div class="chart-subtitle">Identificación de casos críticos</div>
        </div>
        <div class="chart-container">
          <canvas id="scatterChart"></canvas>
        </div>
      </div>

      <!-- EVOLUCIÓN TEMPORAL -->
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="currentColor"
              style="margin-right: 8px; vertical-align: middle">
              <path
                d="M9,10V12H7V10H9M13,10V12H11V10H13M17,10V12H15V10H17M19,3A2,2 0 0,1 21,5V19A2,2 0 0,1 19,21H5C3.89,21 3,20.1 3,19V5A2,2 0 0,1 5,3H6V1H8V3H16V1H18V3H19M19,19V8H5V19H19M9,14V16H7V14H9M13,14V16H11V14H13M17,14V16H15V14H17Z" />
            </svg>
            Evolución Últimos 6 Meses
          </div>
          <div class="chart-subtitle">Tendencia de cobros y DSO</div>
        </div>
        <div class="chart-container">
          <canvas id="trendChart"></canvas>
        </div>
      </div>
    </div>

    <!-- RANKINGS VISUALES -->
    <div class="ranking-section">
      <div style="margin-bottom: 20px">
        <h2
          style="
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
          ">
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="currentColor"
            style="margin-right: 8px">
            <path
              d="M5,16L3,5H5.5L7,13L8.5,5H11L9,16H5M15,16L13,5H15.5L17,13L18.5,5H21L19,16H15M12,1L14.5,6L20.5,6.75L16.25,11L17.25,17L12,14.25L6.75,17L7.75,11L3.5,6.75L9.5,6L12,1Z" />
          </svg>
          Rankings de Rendimiento
        </h2>
        <p style="color: var(--text-secondary); margin: 0; font-size: 14px">
          Comparativa de JP por diferentes métricas clave
        </p>
      </div>

      <div class="ranking-grid">
        <!-- TOP PERFORMERS -->
        <div class="ranking-card">
          <div class="chart-header">
            <div
              class="chart-title"
              title="DSO = Days Sales Outstanding. Mide cuántos días en promedio tarda en cobrarse una factura. Menor es mejor.">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="currentColor"
                style="margin-right: 6px; vertical-align: middle">
                <path
                  d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.46,13.97L5.82,21L12,17.27Z" />
              </svg>
              Mejores DSO
              <svg
                width="12"
                height="12"
                viewBox="0 0 24 24"
                fill="var(--text-tertiary)"
                style="margin-left: 6px; cursor: help; vertical-align: middle">
                <path
                  d="M11,9H13V7H11M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M11,17H13V11H11V17Z" />
              </svg>
            </div>
            <div class="chart-subtitle">
              Menor tiempo de cobro (mejor performance)
            </div>
          </div>
          {% set sorted_by_dso = encargados|sort(attribute='dso') if encargados
          else [] %} {% for jp in sorted_by_dso[:5] %}
          <div class="ranking-item">
            <div
              class="ranking-position {% if loop.index == 1 %}first{% elif loop.index == 2 %}second{% elif loop.index == 3 %}third{% else %}other{% endif %}">
              {{ loop.index }}
            </div>
            <div class="ranking-info">
              <div class="ranking-name">
                {{ jp.nombre|default('Sin Nombre') }}
              </div>
              <div class="ranking-metric">Días promedio de cobro</div>
            </div>
            <div
              class="ranking-value {% if jp.dso < 45 %}good{% elif jp.dso < 60 %}warning{% else %}critical{% endif %}">
              {{ jp.dso|default(0) }}d
            </div>
          </div>
          {% endfor %}
        </div>

        <!-- MAYORES MONTOS -->
        <div class="ranking-card">
          <div class="chart-header">
            <div
              class="chart-title"
              title="Ranking por montos pendientes de cobro. Identifica carteras de mayor volumen que requieren seguimiento prioritario.">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="currentColor"
                style="margin-right: 6px; vertical-align: middle">
                <path
                  d="M7,15H9C9,16.08 10.37,17 12,17C13.63,17 15,16.08 15,15C15,13.9 13.96,13.5 11.76,12.97C9.64,12.44 7,11.78 7,9C7,7.21 8.47,5.69 10.5,5.18V3H13.5V5.18C15.53,5.69 17,7.21 17,9H15C15,7.92 13.63,7 12,7C10.37,7 9,7.92 9,9C9,10.1 10.04,10.5 12.24,11.03C14.36,11.56 17,12.22 17,15C17,16.79 15.53,18.31 13.5,18.82V21H10.5V18.82C8.47,18.31 7,16.79 7,15Z" />
              </svg>
              Mayores Pendientes
              <svg
                width="12"
                height="12"
                viewBox="0 0 24 24"
                fill="var(--text-tertiary)"
                style="margin-left: 6px; cursor: help; vertical-align: middle">
                <path
                  d="M11,9H13V7H11M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M11,17H13V11H11V17Z" />
              </svg>
            </div>
            <div class="chart-subtitle">
              Carteras de mayor volumen pendiente
            </div>
          </div>
          {% set sorted_by_amount = encargados|sort(attribute='monto_pendiente',
          reverse=true) if encargados else [] %} {% for jp in
          sorted_by_amount[:5] %}
          <div class="ranking-item">
            <div
              class="ranking-position {% if loop.index == 1 %}first{% elif loop.index == 2 %}second{% elif loop.index == 3 %}third{% else %}other{% endif %}">
              {{ loop.index }}
            </div>
            <div class="ranking-info">
              <div class="ranking-name">
                {{ jp.nombre|default('Sin Nombre') }}
              </div>
              <div class="ranking-metric">Millones pendientes</div>
            </div>
            <div
              class="ranking-value {% if jp.monto_pendiente > 50000000 %}critical{% elif jp.monto_pendiente > 25000000 %}warning{% else %}good{% endif %}">
              ${{
              "{:,.0f}".format(jp.monto_pendiente|default(0)/1000000).replace(",",".")
              }}M
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- TABLA COMPARATIVA DETALLADA -->
    <div class="comparison-section">
      <div class="comparison-table">
        <div class="table-header">
          <div class="table-title">
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="currentColor"
              style="margin-right: 8px; vertical-align: middle">
              <path
                d="M3,3H21V5H3V3M3,7H21V9H3V7M3,11H21V13H3V11M3,15H21V17H3V15M3,19H21V21H3V19Z" />
            </svg>
            Análisis Comparativo Detallado
          </div>
          <div class="table-controls">
            <button class="filter-btn active" onclick="sortTable('dso')">
              <svg
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="currentColor"
                style="margin-right: 4px">
                <path
                  d="M12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22C6.47,22 2,17.5 2,12A10,10 0 0,1 12,2M12.5,7V12.25L17,14.92L16.25,16.15L11,13V7H12.5Z" />
              </svg>
              Por DSO
            </button>
            <button class="filter-btn" onclick="sortTable('amount')">
              <svg
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="currentColor"
                style="margin-right: 4px">
                <path
                  d="M7,15H9C9,16.08 10.37,17 12,17C13.63,17 15,16.08 15,15C15,13.9 13.96,13.5 11.76,12.97C9.64,12.44 7,11.78 7,9C7,7.21 8.47,5.69 10.5,5.18V3H13.5V5.18C15.53,5.69 17,7.21 17,9H15C15,7.92 13.63,7 12,7C10.37,7 9,7.92 9,9C9,10.1 10.04,10.5 12.24,11.03C14.36,11.56 17,12.22 17,15C17,16.79 15.53,18.31 13.5,18.82V21H10.5V18.82C8.47,18.31 7,16.79 7,15Z" />
              </svg>
              Por Monto
            </button>
            <button class="filter-btn" onclick="sortTable('progress')">
              <svg
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="currentColor"
                style="margin-right: 4px">
                <path
                  d="M16,6L18.29,8.29L13.41,13.17L9.41,9.17L2,16.59L3.41,18L9.41,12L13.41,16L19.71,9.71L22,12V6H16Z" />
              </svg>
              Por Avance
            </button>
            <button class="filter-btn" onclick="sortTable('critical')">
              <svg
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="currentColor"
                style="margin-right: 4px">
                <path
                  d="M12,2L13.09,8.26L22,9L13.09,9.74L12,16L10.91,9.74L2,9L10.91,8.26L12,2Z" />
              </svg>
              Críticos
            </button>
          </div>
        </div>

        <div id="comparisonTable">
          {% for jp in encargados|default([]) %}
          <div
            class="comparison-row"
            data-dso="{{ jp.dso|default(0) }}"
            data-amount="{{ jp.monto_pendiente|default(0) }}"
            data-progress="{{ jp.avance|default(0) }}">
            <div class="row-name">
              <div
                class="status-indicator"
                style="background: {% if jp.dso < 45 %}var(--success){% elif jp.dso < 60 %}var(--warning){% else %}var(--danger){% endif %};"></div>
              {{ jp.nombre|default('Sin Nombre') }}
            </div>
            <div style="text-align: center">
              <div style="font-weight: 600; margin-bottom: 4px">
                {{ jp.dso|default(0) }}d
              </div>
              <div class="progress-bar">
                <div
                  class="progress-fill {% if jp.dso < 45 %}excellent{% elif jp.dso < 60 %}good{% else %}critical{% endif %}"
                  style="width: {% set dso_percent = jp.dso|default(0) %}{% if dso_percent > 100 %}100{% else %}{{ dso_percent }}{% endif %}%;"></div>
              </div>
            </div>
            <div
              style="
                text-align: center;
                font-family: 'JetBrains Mono', monospace;
              ">
              ${{
              "{:,.0f}".format(jp.monto_pendiente|default(0)/1000000).replace(",",".")
              }}M
            </div>
            <div style="text-align: center">
              <div style="font-weight: 600; margin-bottom: 4px">
                {{ jp.avance|default(0) }}%
              </div>
              <div class="progress-bar">
                <div
                  class="progress-fill {% if jp.avance >= 80 %}excellent{% elif jp.avance >= 60 %}good{% else %}warning{% endif %}"
                  style="width: {{ jp.avance|default(0) }}%;"></div>
              </div>
            </div>
            <div style="text-align: center">
              {% if jp.edps_criticos|default(0) > 0 %}
              <span
                style="
                  background: var(--danger-bg);
                  color: var(--danger);
                  padding: 4px 8px;
                  border-radius: 12px;
                  font-size: 12px;
                  font-weight: 600;
                ">
                {{ jp.edps_criticos|default(0) }} críticos
              </span>
              {% else %}
              <span style="color: var(--success); font-weight: 600">✓ OK</span>
              {% endif %}
            </div>
            <div style="text-align: center">
              <button
                onclick="window.open('/dashboard/encargado/{{ jp.nombre|default('') }}', '_blank')"
                class="btn btn-sm btn-primary">
                Ver Detalle
              </button>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Pasar datos del servidor al JavaScript
  window.encargadosData = {{ encargados|default([])|tojson }};
  window.evolucionMensual = {{ evolucion_mensual|default({})|tojson }};
  window.managersData = {{ managers_data|default({})|tojson }};
</script>
<script src="{{ url_for('static', filename='js/controller/controller_encargados_global.js') }}"></script>

{% endblock %}
