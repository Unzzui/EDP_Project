{% extends "base.html" %} {% block content %}
<style>
  .dashboard-container {
    background: linear-gradient(
      135deg,
      var(--background) 0%,
      rgba(59, 130, 246, 0.02) 100%
    );
    color: var(--text-primary);
    min-height: 100vh;
  }

  .card {
    background-color: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
  }

  .card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transform: translateY(-1px);
  }

  .section-divider {
    height: 1px;
    background: linear-gradient(
      90deg,
      transparent,
      var(--border-color),
      transparent
    );
    margin: 24px 0;
  }

  .text-primary {
    color: var(--text-primary);
  }
  .text-secondary {
    color: var(--text-secondary);
  }
  .text-tertiary {
    color: var(--text-tertiary);
  }

  .bg-success {
    background-color: var(--success-bg);
    color: var(--success);
  }
  .bg-warning {
    background-color: var(--warning-bg);
    color: var(--warning);
  }
  .bg-danger {
    background-color: var(--danger-bg);
    color: var(--danger);
  }
  .bg-info {
    background-color: var(--info-bg);
    color: var(--info);
  }

  .text-success {
    color: var(--success);
  }
  .text-warning {
    color: var(--warning);
  }
  .text-danger {
    color: var(--danger);
  }
  .text-info {
    color: var(--info);
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--accent-blue), #4338ca);
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    border: none;
    font-weight: 500;
    font-size: 12px;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
  }

  .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
  }

  .btn-danger {
    background: linear-gradient(135deg, var(--danger), #dc2626);
    color: white;
    padding: 8px 16px;
    border-radius: 6px;
    border: none;
    font-weight: 500;
    font-size: 13px;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
  }

  .btn-danger:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
  }

  .pill-btn {
    padding: 4px 12px;
    height: 28px;
    border-radius: 14px;
    font-size: 11px;
    font-weight: 500;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  /* HEADER HERO COMPACTO */
  .dashboard-hero {
    background: linear-gradient(135deg, #374151 0%, #1f2937 50%, #111827 100%);
    color: white;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    position: relative;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 25px rgba(17, 24, 39, 0.25);
  }

  .hero-title {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 8px;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    color: var(--accent-white);
  }

  .hero-subtitle {
    font-size: 14px;
    opacity: 0.9;
    margin-bottom: 16px;
  }

  .hero-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
  }

  .hero-stat {
    text-align: center;
    padding: 16px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    height: 80px;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .hero-stat-value {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 4px;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }

  .hero-stat-label {
    font-size: 11px;
    opacity: 0.8;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* KPIs FINANCIEROS COMPACTOS */
  .kpi-container {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 12px;
    margin-bottom: 24px;
  }

  .kpi-card-compact {
    background: var(--bg-card);
    border: 1px solid rgba(0, 0, 0, 0.08);
    border-radius: 8px;
    padding: 12px 16px;
    text-align: center;
    transition: all 0.2s ease;
    height: 70px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    position: relative;
  }

  .kpi-card-compact:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  }

  .kpi-title-compact {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 4px;
    opacity: 0.7;
  }

  .kpi-value-compact {
    font-size: 18px;
    font-weight: 700;
    line-height: 1;
    margin: 0;
  }

  /* TABLA EQUIPO COMPACTA */
  .team-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }

  .team-table thead {
    background: var(--bg-subtle);
  }

  .team-table th {
    padding: 12px 16px;
    text-align: left;
    font-weight: 600;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-secondary);
    border-bottom: 1px solid var(--border-color);
  }

  .team-table td {
    padding: 12px 16px;
    height: 45px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    vertical-align: middle;
  }

  .team-table tr:hover {
    background: var(--bg-hover);
  }

  .status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    display: inline-block;
  }

  .status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
  }

  .status-green {
    background-color: var(--success);
  }
  .status-yellow {
    background-color: var(--warning);
  }
  .status-red {
    background-color: var(--danger);
  }

  /* SISTEMA DE ALERTAS VISUALES */
  .status-icon {
    width: 20px;
    height: 20px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    font-size: 12px;
    font-weight: 600;
    color: white;
  }

  .status-icon.control {
    background: #059669;
  }

  .status-icon.atencion {
    background: #0ea5e9;
    border-radius: 3px;
    position: relative;
  }

  .status-icon.atencion::before {
    content: "!";
    font-size: 14px;
    font-weight: 800;
  }

  .status-icon.critico {
    background: #f59e0b;
    position: relative;
    animation: pulse-alert 3s infinite;
  }

  .status-icon.critico::before {
    content: "üîî";
    font-size: 10px;
  }

  @keyframes pulse-alert {
    0%,
    100% {
      transform: scale(1);
      opacity: 1;
    }
    50% {
      transform: scale(1.1);
      opacity: 0.8;
    }
  }

  /* BARRAS DE PROGRESO MEJORADAS */
  .progress-enhanced {
    width: 100px;
    height: 12px;
    background: var(--bg-subtle);
    border-radius: 6px;
    overflow: hidden;
    position: relative;
    border: 1px solid var(--border-color);
  }

  .progress-fill-enhanced {
    height: 100%;
    transition: width 0.4s ease;
    position: relative;
  }

  .progress-fill-enhanced.optimal {
    background: linear-gradient(90deg, #059669 0%, #16a34a 100%);
  }

  .progress-fill-enhanced.warning {
    background: linear-gradient(90deg, #0ea5e9 0%, #3b82f6 100%);
  }

  .progress-fill-enhanced.critical {
    background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
  }

  .progress-fill-enhanced.below-target {
    background: repeating-linear-gradient(
      45deg,
      #f59e0b,
      #f59e0b 4px,
      rgba(245, 158, 11, 0.3) 4px,
      rgba(245, 158, 11, 0.3) 8px
    );
  }

  .progress-reference-line {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #64748b;
    opacity: 0.6;
  }

  /* TENDENCIAS DSO */
  .dso-container {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .trend-arrow {
    width: 0;
    height: 0;
    display: inline-block;
  }

  .trend-arrow.up {
    border-left: 4px solid transparent;
    border-right: 4px solid transparent;
    border-bottom: 6px solid #f59e0b;
  }

  .trend-arrow.down {
    border-left: 4px solid transparent;
    border-right: 4px solid transparent;
    border-top: 6px solid #059669;
  }

  .trend-arrow.stable {
    border-top: 3px solid transparent;
    border-bottom: 3px solid transparent;
    border-left: 6px solid #0ea5e9;
  }

  .sparkline {
    width: 40px;
    height: 16px;
    margin-left: 4px;
  }

  /* SEM√ÅFORO DE PRIORIDADES */
  .priority-semaforo {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .priority-semaforo.verde {
    background: rgba(5, 150, 105, 0.08);
    color: #059669;
    border: 1px solid rgba(5, 150, 105, 0.15);
  }

  .priority-semaforo.amarillo {
    background: rgba(14, 165, 233, 0.08);
    color: #0ea5e9;
    border: 1px solid rgba(14, 165, 233, 0.15);
  }

  .priority-semaforo.rojo {
    background: rgba(245, 158, 11, 0.08);
    color: #f59e0b;
    border: 1px solid rgba(245, 158, 11, 0.15);
    animation: blink-priority 4s infinite;
  }

  @keyframes blink-priority {
    0%,
    90% {
      opacity: 1;
    }
    95% {
      opacity: 0.5;
    }
  }

  .priority-circle {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }

  .priority-circle.verde {
    background: #059669;
  }
  .priority-circle.amarillo {
    background: #0ea5e9;
  }
  .priority-circle.rojo {
    background: #f59e0b;
  }

  /* PANEL RESUMEN EJECUTIVO */
  .executive-summary {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-bottom: 24px;
    padding: 20px;
    background: var(--bg-subtle);
    border-radius: 8px;
    border: 1px solid var(--border-color);
  }

  .summary-item {
    text-align: center;
    padding: 16px;
    background: var(--bg-card);
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    transition: transform 0.2s ease;
  }

  .summary-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  .summary-icon {
    width: 32px;
    height: 32px;
    margin: 0 auto 8px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
  }

  .summary-icon.optimo {
    background: rgba(34, 197, 94, 0.15);
    color: var(--success);
  }

  .summary-icon.seguimiento {
    background: rgba(245, 158, 11, 0.15);
    color: var(--warning);
  }

  .summary-icon.inmediato {
    background: rgba(239, 68, 68, 0.15);
    color: var(--danger);
  }

  .summary-number {
    font-size: 24px;
    font-weight: 800;
    margin-bottom: 4px;
    line-height: 1;
  }

  .summary-label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-secondary);
    margin: 0;
  }

  .summary-sublabel {
    font-size: 10px;
    color: var(--text-tertiary);
    margin: 2px 0 0 0;
  }

  /* TABLA AN√ÅLISIS COMPACTA */
  .analysis-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  .analysis-table th {
    padding: 8px 12px;
    font-weight: 600;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-secondary);
    background: var(--bg-subtle);
  }

  .analysis-table td {
    padding: 8px 12px;
    height: 40px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.04);
    vertical-align: middle;
  }

  .analysis-table tr:hover {
    background: var(--bg-hover);
  }

  .progress-mini {
    width: 40px;
    height: 4px;
    background: var(--bg-subtle);
    border-radius: 2px;
    overflow: hidden;
    display: inline-block;
    margin-right: 8px;
  }

  .progress-mini-fill {
    height: 100%;
    border-radius: 2px;
    transition: width 0.3s ease;
  }

  /* SECCIONES COMPACTAS */
  .section-header {
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border-color);
  }

  .section-title {
    font-size: 18px;
    font-weight: 800;
    margin-bottom: 6px;
    color: var(--text-primary);
    letter-spacing: -0.025em;
  }

  .section-subtitle {
    font-size: 13px;
    color: var(--text-secondary);
    margin: 0;
    font-weight: 500;
  }

  /* GR√ÅFICOS COMPACTOS */
  .chart-container {
    height: 200px;
    position: relative;
    margin-bottom: 16px;
  }

  .chart-container-large {
    height: 280px;
    position: relative;
    margin-bottom: 16px;
  }

  /* RESPONSIVE */
  @media (max-width: 1024px) {
    .kpi-container {
      grid-template-columns: repeat(3, 1fr);
    }
    .hero-stats {
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    .executive-summary {
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    .dso-container {
      flex-direction: column;
      gap: 2px;
    }
    .sparkline {
      width: 30px;
      height: 12px;
    }
  }

  @media (max-width: 768px) {
    .kpi-container {
      grid-template-columns: repeat(2, 1fr);
    }
    .hero-stats {
      grid-template-columns: 1fr;
    }
    .hero-title {
      font-size: 20px;
    }
    .executive-summary {
      grid-template-columns: 1fr;
    }
    .summary-item {
      padding: 12px;
    }
    .summary-icon {
      width: 28px;
      height: 28px;
      font-size: 14px;
    }
    .summary-number {
      font-size: 20px;
    }
    .team-table th:first-child,
    .team-table td:first-child {
      display: none; /* Ocultar columna de status en m√≥vil */
    }
    .progress-enhanced {
      width: 60px;
    }
    .priority-semaforo {
      font-size: 8px;
      padding: 2px 4px;
    }
  }

  @media (max-width: 640px) {
    .kpi-container {
      grid-template-columns: 1fr;
    }
    .dashboard-hero {
      padding: 16px;
    }
    .team-table {
      font-size: 12px;
    }
    .team-table th,
    .team-table td {
      padding: 8px 6px;
    }
    .progress-enhanced {
      width: 50px;
      height: 8px;
    }
    .pill-btn {
      padding: 2px 8px;
      height: 24px;
      font-size: 10px;
    }
  }

  /* EFECTOS SUTILES */
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .card,
  .team-table,
  .analysis-table {
    animation: fadeIn 0.3s ease-out;
  }
</style>

<div class="dashboard-container" style="padding: 16px">
  <div class="container mx-auto">
    <!-- HEADER CENTRO DE COMANDO -->
    <div class="dashboard-hero">
      <div
        style="
          display: grid;
          grid-template-columns: 1fr auto;
          gap: 24px;
          align-items: center;
        ">
        <div>
          <div
            style="
              display: flex;
              align-items: center;
              gap: 12px;
              margin-bottom: 12px;
            ">
            <h1 class="hero-title">‚ö° CENTRO DE COMANDO JP</h1>
            <div
              style="
                background: rgba(255, 255, 255, 0.1);
                padding: 4px 12px;
                border-radius: 16px;
                font-size: 10px;
                font-weight: 600;
                text-transform: uppercase;
                border: 1px solid rgba(255, 255, 255, 0.15);
                letter-spacing: 0.05em;
                opacity: 0.8;
              ">
              ‚óè LIVE DASHBOARD
            </div>
          </div>

          <div
            style="
              display: grid;
              grid-template-columns: repeat(4, 1fr);
              gap: 16px;
            ">
            <!-- SITUACI√ìN CR√çTICA -->
            {% set criticos_count = encargados|selectattr('dso', '>',
            60)|list|length if encargados else 0 %}
            <div
              style="text-align: center; padding: 12px; background: rgba(255, 255, 255, {% if criticos_count > 0 %}0.15{% else %}0.08{% endif %}); border-radius: 10px; {% if criticos_count > 0 %}border: 2px solid #d97706; box-shadow: 0 0 15px rgba(217, 119, 6, 0.2);{% else %}border: 1px solid rgba(255, 255, 255, 0.1);{% endif %}">
              <div
                style="font-size: 20px; font-weight: 900; margin-bottom: 4px; {% if criticos_count > 0 %}color: #f59e0b;{% else %}color: #059669;{% endif %}">
                {{ criticos_count }}
              </div>
              <div
                style="
                  font-size: 9px;
                  opacity: 0.9;
                  text-transform: uppercase;
                  letter-spacing: 0.1em;
                  font-weight: 700;
                ">
                {% if criticos_count > 0 %}‚ö† CR√çTICO{% else %}‚úì ESTABLE{% endif
                %}
              </div>
            </div>

            <!-- RENDIMIENTO OPERACIONAL -->
            {% set promedio_dso = managers_data.promedio_dso|default(0) %}
            <div
              style="
                text-align: center;
                padding: 12px;
                background: rgba(255, 255, 255, 0.08);
                border-radius: 10px;
                border: 1px solid rgba(255, 255, 255, 0.1);
              ">
              <div
                style="font-size: 20px; font-weight: 900; margin-bottom: 4px; color: {% if promedio_dso < 45 %}#059669{% elif promedio_dso < 60 %}#0891b2{% else %}#dc2626{% endif %};">
                {{ promedio_dso }}<span
                  style="font-size: 12px; font-weight: 600"
                  >d</span
                >
              </div>
              <div
                style="
                  font-size: 9px;
                  opacity: 0.9;
                  text-transform: uppercase;
                  letter-spacing: 0.1em;
                  font-weight: 700;
                ">
                {% if promedio_dso < 45 %}‚Üó √ìPTIMO{% elif promedio_dso < 60 %}‚Üí
                EST√ÅNDAR{% else %}‚Üò REZAGADO{% endif %}
              </div>
            </div>

            <!-- PROGRESO ESTRAT√âGICO -->
            {% set avance_global = managers_data.avance_global|default(0) %}
            <div
              style="
                text-align: center;
                padding: 12px;
                background: rgba(255, 255, 255, 0.08);
                border-radius: 10px;
                border: 1px solid rgba(255, 255, 255, 0.1);
              ">
              <div
                style="font-size: 20px; font-weight: 900; margin-bottom: 4px; color: {% if avance_global >= 80 %}#059669{% elif avance_global >= 60 %}#0891b2{% else %}#dc2626{% endif %};">
                {{ avance_global }}<span
                  style="font-size: 12px; font-weight: 600"
                  >%</span
                >
              </div>
              <div
                style="
                  font-size: 9px;
                  opacity: 0.9;
                  text-transform: uppercase;
                  letter-spacing: 0.1em;
                  font-weight: 700;
                ">
                {% if avance_global >= 80 %}‚ñ≤ ALTO{% elif avance_global >= 60
                %}‚ñ† MEDIO{% else %}‚ñº BAJO{% endif %}
              </div>
            </div>

            <!-- EQUIPO OPERATIVO -->
            {% set activos_count = encargados|length|default(0) %}
            <div
              style="
                text-align: center;
                padding: 12px;
                background: rgba(255, 255, 255, 0.08);
                border-radius: 10px;
                border: 1px solid rgba(255, 255, 255, 0.1);
              ">
              <div
                style="
                  font-size: 20px;
                  font-weight: 900;
                  margin-bottom: 4px;
                  color: #e5e7eb;
                ">
                {{ activos_count }}
              </div>
              <div
                style="
                  font-size: 9px;
                  opacity: 0.9;
                  text-transform: uppercase;
                  letter-spacing: 0.1em;
                  font-weight: 700;
                ">
                ‚óè ACTIVOS
              </div>
            </div>
          </div>
        </div>

        <!-- PANEL DE ACCI√ìN -->
        <div style="text-align: right">
          {% if criticos_count > 0 %}
          <div style="margin-bottom: 8px">
            <button
              onclick="mostrarJPEnRiesgo()"
              style="
                background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
                color: white;
                border: none;
                padding: 14px 24px;
                border-radius: 8px;
                font-size: 13px;
                font-weight: 700;
                box-shadow: 0 4px 12px rgba(220, 38, 38, 0.25);
                text-transform: uppercase;
                letter-spacing: 0.025em;
              ">
              ‚ö† ACCI√ìN REQUERIDA
            </button>
          </div>
          <div
            style="
              background: rgba(220, 38, 38, 0.1);
              color: #dc2626;
              padding: 8px 16px;
              border-radius: 6px;
              font-size: 11px;
              font-weight: 600;
              border: 1px solid rgba(220, 38, 38, 0.2);
              text-align: center;
            ">
            ${{ "{:,.0f}".format(encargados|selectattr('dso', '>',
            60)|map(attribute='monto_pendiente')|sum).replace(",",".") }} EN
            RIESGO
          </div>
          {% else %}
          <div
            style="
              background: rgba(5, 150, 105, 0.15);
              color: #059669;
              padding: 14px 24px;
              border-radius: 8px;
              font-size: 13px;
              font-weight: 700;
              border: 2px solid rgba(5, 150, 105, 0.25);
              text-align: center;
              text-transform: uppercase;
              letter-spacing: 0.025em;
            ">
            ‚úì OPERACI√ìN ESTABLE
          </div>
          <div
            style="
              background: rgba(5, 150, 105, 0.08);
              color: #047857;
              padding: 6px 12px;
              border-radius: 6px;
              font-size: 10px;
              font-weight: 600;
              margin-top: 6px;
            ">
            ESTADO CONTROLADO
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- üö® ALERTAS CR√çTICAS - ACCI√ìN INMEDIATA -->
    {% set jp_criticos = encargados|selectattr('dso', '>=', 60)|list if
    encargados else [] %} {% set jp_atencion = encargados|selectattr('dso',
    '>=', 45)|selectattr('dso', '<', 60)|list if encargados else [] %} {% set
    total_pendiente_critico = jp_criticos|map(attribute='monto_pendiente')|sum
    if jp_criticos else 0 %} {% if jp_criticos|length > 0 %}
    <div
      class="card"
      style="
        padding: 20px;
        margin-bottom: 24px;
        border-left: 4px solid #f59e0b;
      ">
      <div class="section-header">
        <h2 class="section-title">üö® ACCI√ìN INMEDIATA REQUERIDA</h2>
        <p class="section-subtitle">
          {{ jp_criticos|length }} JP cr√≠ticos ‚Ä¢ ${{
          "{:,.0f}".format(total_pendiente_critico).replace(",",".") }} en
          riesgo
        </p>
      </div>
      <div style="display: grid; gap: 12px">
        {% for jp in jp_criticos[:3] %}
        <div
          style="
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-subtle);
            border-radius: 8px;
            border-left: 4px solid #f59e0b;
          ">
          <div
            style="
              width: 32px;
              height: 32px;
              background: rgba(245, 158, 11, 0.1);
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              margin-right: 12px;
            ">
            <span style="font-size: 14px">‚ö°</span>
          </div>
          <div style="flex-grow: 1">
            <p
              style="
                margin: 0;
                font-weight: 600;
                font-size: 14px;
                color: var(--text-primary);
              ">
              {{ jp.nombre|default('JP') }}
            </p>
            <p style="margin: 0; font-size: 12px; color: var(--text-secondary)">
              DSO: {{ jp.dso|default(0) }}d ‚Ä¢ ${{
              "{:,.0f}".format(jp.monto_pendiente|default(0)).replace(",",".")
              }}
            </p>
          </div>
          <button
            onclick="priorizarEncargado('{{ jp.nombre|default('') }}')"
            style="
              background: #f59e0b;
              color: white;
              border: none;
              padding: 8px 16px;
              border-radius: 6px;
              font-size: 12px;
              font-weight: 600;
            ">
            ACTUAR AHORA
          </button>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- RESUMEN EJECUTIVO -->
    {% set jp_optimo = encargados|selectattr('dso', '<',
    45)|selectattr('avance', '>', 70)|list|length if encargados else 0 %}

    <div class="executive-summary">
      <div class="summary-item" style="border-left: 3px solid #059669">
        <div class="summary-icon optimo">‚úì</div>
        <div class="summary-number text-success">{{ jp_optimo }}</div>
        <p class="summary-label">En Control</p>
        <p class="summary-sublabel">Funcionando bien</p>
      </div>
      <div class="summary-item" style="border-left: 3px solid #0ea5e9">
        <div class="summary-icon seguimiento">‚ö†</div>
        <div class="summary-number" style="color: #0ea5e9">
          {{ jp_atencion|length }}
        </div>
        <p class="summary-label">Monitorear</p>
        <p class="summary-sublabel">Revisar esta semana</p>
      </div>
      <div class="summary-item" style="border-left: 3px solid #f59e0b">
        <div class="summary-icon inmediato">üö®</div>
        <div class="summary-number" style="color: #f59e0b">
          {{ jp_criticos|length }}
        </div>
        <p class="summary-label">Cr√≠ticos</p>
        <p class="summary-sublabel">Acci√≥n inmediata</p>
      </div>
    </div>

    <!-- EQUIPO COMO TABLA COMPACTA -->
    <div class="card" style="padding: 24px; margin-bottom: 24px">
      <div class="section-header">
        <h2 class="section-title">üë• Equipo de Jefes de Proyecto</h2>
        <p class="section-subtitle">
          Vista individual de rendimiento ‚Ä¢ {{ encargados|length|default(0) }}
          responsables activos
        </p>
      </div>

      <div style="overflow-x: auto">
        <table class="team-table">
          <thead>
            <tr>
              <th style="text-align: center; width: 60px">Status</th>
              <th>JP</th>
              <th style="text-align: right">% Avance</th>
              <th style="text-align: right">DSO Tendencia</th>
              <th style="text-align: right">Monto Total</th>
              <th style="text-align: center">Prioridad</th>
              <th style="text-align: center">Acci√≥n</th>
            </tr>
          </thead>
          <tbody>
            {% for encargado in encargados|default([]) %} {% set dso_actual =
            encargado.dso|default(0) %} {% set avance_actual =
            encargado.avance|default(0) %} {% set edps_criticos =
            encargado.edps_criticos|default(0) %} {% set esperado_avance = 75 %}
            <tr
              onclick="abrirModalEncargado('{{ encargado.nombre|default('Sin nombre') }}')"
              style="cursor: pointer">
              <!-- COLUMNA STATUS VISUAL -->
              <td style="text-align: center">
                {% if dso_actual < 45 and avance_actual > 80 %}
                <div
                  class="status-icon control"
                  title="En control - Todo OK"></div>
                {% elif dso_actual >= 60 or edps_criticos > 0 %}
                <div
                  class="status-icon critico"
                  title="Cr√≠tico - Necesita soporte"></div>
                {% else %}
                <div
                  class="status-icon atencion"
                  title="Requiere atenci√≥n"></div>
                {% endif %}
              </td>

              <!-- COLUMNA JP -->
              <td>
                <span class="font-medium text-primary"
                  >{{ encargado.nombre|default('Sin nombre') }}</span
                >
              </td>

              <!-- COLUMNA % AVANCE MEJORADA -->
              <td style="text-align: right">
                <div
                  style="display: inline-flex; align-items: center; gap: 8px">
                  <div class="progress-enhanced">
                    {% if avance_actual < esperado_avance %}
                    <div
                      class="progress-fill-enhanced below-target"
                      style="width: {{ avance_actual }}%"></div>
                    {% elif avance_actual >= 95 %}
                    <div
                      class="progress-fill-enhanced critical"
                      style="width: {{ avance_actual }}%"></div>
                    {% elif avance_actual >= 80 %}
                    <div
                      class="progress-fill-enhanced optimal"
                      style="width: {{ avance_actual }}%"></div>
                    {% else %}
                    <div
                      class="progress-fill-enhanced warning"
                      style="width: {{ avance_actual }}%"></div>
                    {% endif %}
                    <div
                      class="progress-reference-line"
                      style="left: {{ esperado_avance }}%"></div>
                  </div>
                  <span
                    class="{% if avance_actual >= 80 %}text-success{% elif avance_actual >= 60 %}text-warning{% else %}text-danger{% endif %}"
                    style="font-size: 12px; font-weight: 600"
                    >{{ avance_actual }}%</span
                  >
                </div>
              </td>

              <!-- COLUMNA DSO CON TENDENCIA -->
              <td style="text-align: right">
                <div class="dso-container">
                  <span
                    class="font-mono {% if dso_actual < 45 %}text-success{% elif dso_actual < 60 %}text-warning{% else %}text-danger{% endif %}"
                    style="font-weight: 600"
                    >{{ dso_actual }}d</span
                  >
                  {% set tendencia = ['down', 'stable', 'up']|random %}
                  <div class="trend-arrow {{ tendencia }}"></div>
                  <canvas
                    class="sparkline"
                    id="spark-{{ loop.index }}"
                    width="40"
                    height="16"></canvas>
                </div>
              </td>

              <!-- COLUMNA MONTO TOTAL -->
              <td style="text-align: right">
                <span class="font-mono text-primary" style="font-weight: 600"
                  >${{
                  "{:,.0f}".format(encargado.monto_pendiente|default(0)).replace(",",".")
                  }}</span
                >
              </td>

              <!-- COLUMNA PRIORIDAD SEM√ÅFORO -->
              <td style="text-align: center">
                {% if dso_actual < 45 and avance_actual > 80 %}
                <div class="priority-semaforo verde">
                  <div class="priority-circle verde"></div>
                  Todo OK
                </div>
                {% elif dso_actual >= 60 or edps_criticos > 0 %}
                <div class="priority-semaforo rojo">
                  <div class="priority-circle rojo"></div>
                  Urgente
                </div>
                {% else %}
                <div class="priority-semaforo amarillo">
                  <div class="priority-circle amarillo"></div>
                  Revisar
                </div>
                {% endif %}
              </td>

              <!-- COLUMNA ACCI√ìN -->
              <td style="text-align: center">
                <button
                  onclick="event.stopPropagation(); priorizarEncargado('{{ encargado.nombre|default('') }}')"
                  class="pill-btn btn-primary">
                  Priorizar
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="section-divider"></div>

    <!-- AN√ÅLISIS COMPARATIVO COMPACTO -->
    <div class="card" style="margin-bottom: 24px">
      <div
        style="
          padding: 24px 24px 16px 24px;
          border-bottom: 1px solid var(--border-color);
        ">
        <div
          class="section-header"
          style="margin-bottom: 8px; padding-bottom: 0; border-bottom: none">
          <h2 class="section-title">üìä An√°lisis Comparativo Detallado</h2>
          <p class="section-subtitle">
            Herramienta de priorizaci√≥n inteligente
          </p>
        </div>
        <div
          style="display: flex; justify-content: between; align-items: center">
          <span
            style="
              font-size: 13px;
              font-weight: 500;
              color: var(--text-primary);
            "
            >Filtrar por:</span
          >
          <select
            id="filtroOrden"
            style="
              background: var(--bg-card);
              border: 1px solid var(--border-color);
              border-radius: 6px;
              padding: 6px 12px;
              font-size: 12px;
              font-weight: 500;
            ">
            <option value="pendiente_desc">üí∞ Mayor Pendiente</option>
            <option value="dso_desc">‚è∞ Mayor DSO</option>
            <option value="criticos_desc">üö® M√°s Cr√≠ticos</option>
            <option value="avance_asc">üìâ Menor Avance</option>
          </select>
        </div>
      </div>

      <div style="overflow-x: auto">
        <table class="analysis-table" id="tablaEncargados">
          <thead>
            <tr>
              <th>JP</th>
              <th style="text-align: right">Pendiente $</th>
              <th style="text-align: right">% Avance</th>
              <th style="text-align: right">DSO</th>
              <th style="text-align: right">EDP Cr√≠ticos</th>
              <th style="text-align: right">SLA Aprobaci√≥n</th>
              <th style="text-align: center">Acci√≥n</th>
            </tr>
          </thead>
          <tbody>
            {% for encargado in encargados|default([]) %}
            <tr>
              <td>
                <div style="display: flex; align-items: center">
                  <div
                    class="status-indicator {% if encargado.dso|default(0) < 45 %}status-green{% elif encargado.dso|default(0) < 60 %}status-yellow{% else %}status-red{% endif %}"></div>
                  <span class="font-medium text-primary"
                    >{{ encargado.nombre|default('Sin nombre') }}</span
                  >
                </div>
              </td>
              <td style="text-align: right">
                <span
                  class="font-mono {% if encargado.monto_pendiente|default(0) > 50000000 %}text-danger{% elif encargado.monto_pendiente|default(0) > 25000000 %}text-warning{% else %}text-primary{% endif %}">
                  ${{
                  "{:,.0f}".format(encargado.monto_pendiente|default(0)).replace(",",".")
                  }}
                </span>
              </td>
              <td style="text-align: right">
                <div style="display: inline-flex; align-items: center">
                  <div class="progress-mini">
                    <div
                      class="progress-mini-fill {% if encargado.avance|default(0) > 70 %}bg-success{% elif encargado.avance|default(0) > 50 %}bg-warning{% else %}bg-danger{% endif %}"
                      style="width: {{ encargado.avance|default(0) }}%"></div>
                  </div>
                  <span
                    class="{% if encargado.avance|default(0) > 70 %}text-success{% elif encargado.avance|default(0) > 50 %}text-warning{% else %}text-danger{% endif %}"
                    >{{ encargado.avance|default(0) }}%</span
                  >
                </div>
              </td>
              <td style="text-align: right">
                <span
                  class="font-mono {% if encargado.dso|default(0) < 45 %}text-success{% elif encargado.dso|default(0) < 60 %}text-warning{% else %}text-danger{% endif %}"
                  >{{ encargado.dso|default(0) }}d</span
                >
              </td>
              <td style="text-align: right">
                {% if encargado.edps_criticos|default(0) > 0 %}
                <span class="status-badge bg-danger text-white"
                  >{{ encargado.edps_criticos|default(0) }}</span
                >
                {% else %}
                <span class="text-tertiary">-</span>
                {% endif %}
              </td>
              <td style="text-align: right">
                <span
                  class="{% if encargado.tasa_aprobacion|default(0) > 80 %}text-success{% elif encargado.tasa_aprobacion|default(0) > 60 %}text-warning{% else %}text-danger{% endif %}"
                  >{{ encargado.tasa_aprobacion|default(0) }}%</span
                >
              </td>
              <td style="text-align: center">
                <button
                  onclick="priorizarEncargado('{{ encargado.nombre|default('') }}')"
                  class="pill-btn btn-primary">
                  Priorizar
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- M√âTRICAS FINANCIERAS ESENCIALES -->
    <div class="card" style="padding: 20px; margin-bottom: 24px">
      <div class="section-header">
        <h2 class="section-title">üí∞ Resumen Financiero</h2>
        <p class="section-subtitle">M√©tricas clave del per√≠odo</p>
      </div>
      <div
        style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px">
        <div
          style="
            text-align: center;
            padding: 16px;
            background: var(--bg-subtle);
            border-radius: 8px;
          ">
          <p
            style="
              margin: 0;
              font-size: 12px;
              color: var(--text-secondary);
              font-weight: 600;
            ">
            TOTAL PENDIENTE
          </p>
          <p
            style="
              margin: 4px 0 0 0;
              font-size: 20px;
              font-weight: 800;
              color: var(--text-primary);
            ">
            ${{
            "{:,.0f}".format(managers_data.total_pendiente|default(0)).replace(",",".")
            }}
          </p>
        </div>
        <div
          style="
            text-align: center;
            padding: 16px;
            background: var(--bg-subtle);
            border-radius: 8px;
          ">
          <p
            style="
              margin: 0;
              font-size: 12px;
              color: var(--text-secondary);
              font-weight: 600;
            ">
            AVANCE GLOBAL
          </p>
          <p
            style="margin: 4px 0 0 0; font-size: 20px; font-weight: 800; color: {% if managers_data.avance_global|default(0) > 70 %}#059669{% elif managers_data.avance_global|default(0) > 50 %}#0ea5e9{% else %}#f59e0b{% endif %};">
            {{ managers_data.avance_global|default(0) }}%
          </p>
        </div>
        <div
          style="
            text-align: center;
            padding: 16px;
            background: var(--bg-subtle);
            border-radius: 8px;
          ">
          <p
            style="
              margin: 0;
              font-size: 12px;
              color: var(--text-secondary);
              font-weight: 600;
            ">
            DSO PROMEDIO
          </p>
          <p
            style="margin: 4px 0 0 0; font-size: 20px; font-weight: 800; color: {% if managers_data.promedio_dso|default(0) < 45 %}#059669{% elif managers_data.promedio_dso|default(0) < 60 %}#0ea5e9{% else %}#f59e0b{% endif %};">
            {{ managers_data.promedio_dso|default(0) }}d
          </p>
        </div>
      </div>
    </div>

    <!-- Modal para detalles de encargado -->
    <div
      id="modalEncargado"
      class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
      <div class="flex items-center justify-center min-h-screen p-4">
        <div
          class="card rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
          <div class="p-6 border-b border-[color:var(--border-color)]">
            <div class="flex justify-between items-center">
              <h3
                id="modalTitulo"
                class="text-xl font-semibold text-primary"></h3>
              <button
                onclick="cerrarModalEncargado()"
                class="text-tertiary hover:text-secondary transition-colors">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                    clip-rule="evenodd"></path>
                </svg>
              </button>
            </div>
          </div>
          <div id="modalContenido" class="p-6">
            <!-- Contenido din√°mico -->
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const encargados = {{ encargados|default([])|tojson }};
        const evolucionMensual = {{ evolucion_mensual|default({})|tojson }};

        try {
          configurarFiltrosTabla();
          generarSparklines();
        } catch (error) {
          console.error('Error al inicializar dashboard:', error);
        }
      });



      function inicializarGraficoEvolucionMensual(evolucionMensual) {
        const ctx = document.getElementById('graficoEvolucionMensual');
        if (!ctx) return;

        if (!evolucionMensual || typeof evolucionMensual !== 'object') {
          mostrarMensajeGraficoVacio(ctx);
          return;
        }

        const ctxContext = ctx.getContext('2d');
        const datasets = [];
        const meses = evolucionMensual.meses || [];
        const totalPorMes = evolucionMensual.total_por_mes || [];

        if (meses.length === 0 && totalPorMes.length === 0) {
          mostrarMensajeGraficoVacio(ctx);
          return;
        }

        // Meta mensual
        if (meses.length > 0) {
          datasets.push({
            label: 'Meta Mensual',
            data: meses.map(() => {{ managers_data.total_meta|default(0) }}),
            borderColor: '#f59e0b',
            backgroundColor: 'transparent',
            borderWidth: 2,
            borderDash: [4, 4],
            fill: false,
            pointRadius: 0
          });
        }

        // Total cobrado
        if (totalPorMes.length > 0) {
          datasets.push({
            label: 'Total Cobrado',
            data: totalPorMes,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.2,
            pointRadius: 3
          });
        }

        if (datasets.length === 0) {
          mostrarMensajeGraficoVacio(ctx);
          return;
        }

        const chart = new Chart(ctxContext, {
          type: 'line',
          data: { labels: meses, datasets: datasets },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  font: { size: 10 },
                  callback: function(value) {
                    if (value >= 1000000) return '$' + (value / 1000000).toFixed(1) + 'M';
                    if (value >= 1000) return '$' + (value / 1000).toFixed(0) + 'K';
                    return '$' + value.toLocaleString();
                  }
                }
              },
              x: {
                ticks: { font: { size: 10 } }
              }
            },
            plugins: {
              legend: {
                position: 'bottom',
                labels: { font: { size: 10 }, padding: 10 }
              }
            }
          }
        });

        window.chartEvolucionMensual = chart;
      }

      function mostrarMensajeGraficoVacio(canvas) {
        const container = canvas.parentElement;
        const mensaje = document.createElement('div');
        mensaje.className = 'flex items-center justify-center h-32 text-gray-500';
        mensaje.innerHTML = '<p class="text-sm">No hay datos disponibles</p>';
        canvas.style.display = 'none';
        container.appendChild(mensaje);
      }



      function configurarFiltrosTabla() {
        const filtroOrden = document.getElementById('filtroOrden');
        if (filtroOrden) {
          filtroOrden.addEventListener('change', function() {
            // Implementar ordenamiento
          });
        }
      }

      function toggleEvolucionMensual() {
        const contenido = document.getElementById('contenidoEvolucionMensual');
        const chevron = document.getElementById('chevronEvolucion');
        if (contenido && chevron) {
          const isHidden = contenido.style.display === 'none';
          contenido.style.display = isHidden ? 'block' : 'none';
          chevron.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
          if (isHidden && window.chartEvolucionMensual) {
            setTimeout(() => window.chartEvolucionMensual.resize(), 300);
          }
        }
      }

      function abrirModalEncargado(nombre) {
        const modal = document.getElementById('modalEncargado');
        const titulo = document.getElementById('modalTitulo');
        const contenido = document.getElementById('modalContenido');
        if (modal && titulo && contenido) {
          titulo.textContent = `Detalle de ${nombre}`;
          const encargados = {{ encargados|default([])|tojson }};
          const encargado = encargados.find(e => e.nombre === nombre) || {};
          contenido.innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
              <div style="background: var(--bg-subtle); padding: 16px; border-radius: 8px;">
                <p style="font-size: 12px; color: var(--text-secondary); margin: 0 0 4px 0;">Monto Pendiente</p>
                <p style="font-size: 18px; font-weight: 700; color: var(--text-primary); margin: 0;">$${(encargado.monto_pendiente || 0).toLocaleString().replace(/,/g, '.')}</p>
              </div>
              <div style="background: var(--bg-subtle); padding: 16px; border-radius: 8px;">
                <p style="font-size: 12px; color: var(--text-secondary); margin: 0 0 4px 0;">DSO</p>
                <p style="font-size: 18px; font-weight: 700; margin: 0; color: ${(encargado.dso || 0) < 45 ? 'var(--success)' : (encargado.dso || 0) < 60 ? 'var(--warning)' : 'var(--danger)'}">${encargado.dso || 0}d</p>
              </div>
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 8px;">
              <button onclick="window.open('/controller/encargado/${encargado.nombre || ''}', '_blank')" class="btn-primary">Ver Detalle</button>
              <button onclick="priorizarEncargado('${nombre}')" class="btn-primary">Priorizar</button>
            </div>
          `;
          modal.classList.remove('hidden');
        }
      }

      function cerrarModalEncargado() {
        const modal = document.getElementById('modalEncargado');
        if (modal) modal.classList.add('hidden');
      }

      function mostrarJPEnRiesgo() {
        const encargados = {{ encargados|default([])|tojson }};
        const jpEnRiesgo = encargados.filter(e => (e.dso || 0) > 60 || (e.edps_criticos || 0) > 0);
        if (jpEnRiesgo.length > 0) {
          alert(`JP en riesgo:\n${jpEnRiesgo.map(jp => `‚Ä¢ ${jp.nombre || 'Sin nombre'} (DSO: ${jp.dso || 0}d)`).join('\n')}`);
        } else {
          alert('No hay JP en riesgo actualmente');
        }
      }

      function priorizarEncargado(nombre) {
        if (nombre) window.open(`/controller/encargado/${nombre}?priorizar=true`, '_blank');
      }



      // GENERAR SPARKLINES
      function generarSparklines() {
        const sparklines = document.querySelectorAll('.sparkline');
        sparklines.forEach((canvas, index) => {
          const ctx = canvas.getContext('2d');
          const width = 40;
          const height = 16;

          // Datos simulados de DSO para los √∫ltimos 4 per√≠odos
          const data = [
            Math.random() * 30 + 30, // 30-60
            Math.random() * 25 + 35, // 35-60
            Math.random() * 20 + 40, // 40-60
            Math.random() * 15 + 45  // 45-60
          ];

          const max = Math.max(...data);
          const min = Math.min(...data);
          const range = max - min;

          ctx.clearRect(0, 0, width, height);
          ctx.strokeStyle = data[3] < data[0] ? '#059669' : data[3] > data[0] ? '#f59e0b' : '#0ea5e9';
          ctx.lineWidth = 1.5;
          ctx.beginPath();

          for (let i = 0; i < data.length; i++) {
            const x = (i / (data.length - 1)) * (width - 4) + 2;
            const y = range > 0 ? ((max - data[i]) / range) * (height - 4) + 2 : height / 2;

            if (i === 0) {
              ctx.moveTo(x, y);
            } else {
              ctx.lineTo(x, y);
            }
          }

          ctx.stroke();

          // Agregar puntos
          ctx.fillStyle = ctx.strokeStyle;
          for (let i = 0; i < data.length; i++) {
            const x = (i / (data.length - 1)) * (width - 4) + 2;
            const y = range > 0 ? ((max - data[i]) / range) * (height - 4) + 2 : height / 2;
            ctx.beginPath();
            ctx.arc(x, y, 1, 0, 2 * Math.PI);
            ctx.fill();
          }
        });
      }

      // Generar sparklines cuando se carga la p√°gina
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(generarSparklines, 100);
      });
    </script>

    {% endblock %}
  </div>
</div>
