{% extends "base.html" %} {% block content %}
<style>
  .dashboard-container {
    background-color: var(--background);
    color: var(--text-primary);
    min-height: 100vh;
  }

  .card {
    background-color: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    box-shadow: var(--shadow-sm);
    transition: all 0.3s ease;
  }

  .card:hover {
    box-shadow: var(--shadow-md);
  }

  .text-primary {
    color: var(--text-primary);
  }
  .text-secondary {
    color: var(--text-secondary);
  }
  .text-tertiary {
    color: var(--text-tertiary);
  }

  .bg-success {
    background-color: var(--success-bg);
    color: var(--success);
  }
  .bg-warning {
    background-color: var(--warning-bg);
    color: var(--warning);
  }
  .bg-danger {
    background-color: var(--danger-bg);
    color: var(--danger);
  }
  .bg-info {
    background-color: var(--info-bg);
    color: var(--info);
  }

  .text-success {
    color: var(--success);
  }
  .text-warning {
    color: var(--warning);
  }
  .text-danger {
    color: var(--danger);
  }
  .text-info {
    color: var(--info);
  }

  .btn-primary {
    background-color: var(--accent-blue);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    border: none;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .btn-primary:hover {
    opacity: 0.9;
    transform: translateY(-1px);
  }

  .btn-danger {
    background-color: var(--danger);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    border: none;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .progress-bar {
    background-color: var(--bg-subtle);
    border-radius: 9999px;
    overflow: hidden;
    height: 8px;
  }

  .progress-fill {
    height: 100%;
    transition: width 0.5s ease;
    border-radius: 9999px;
  }

  .status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
  }

  .status-green {
    background-color: var(--success);
  }
  .status-yellow {
    background-color: var(--warning);
  }
  .status-red {
    background-color: var(--danger);
  }

  .scroll-container {
    scrollbar-width: thin;
    scrollbar-color: var(--border-color) transparent;
  }

  .scroll-container::-webkit-scrollbar {
    height: 8px;
  }

  .scroll-container::-webkit-scrollbar-track {
    background: var(--bg-subtle);
    border-radius: 4px;
  }

  .scroll-container::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 4px;
  }

  .grid-cols-5 {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 1rem;
  }

  @media (max-width: 1024px) {
    .grid-cols-5 {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (max-width: 768px) {
    .grid-cols-5 {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 640px) {
    .grid-cols-5 {
      grid-template-columns: 1fr;
    }
  }
</style>

<div class="dashboard-container" style="padding: 1.5rem">
  <div class="container mx-auto">
    <!-- 1. ENCABEZADO GLOBAL - Meta vs Pagado vs Pendiente -->
    <div class="card" style="padding: 2rem; margin-bottom: 2rem">
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 1.5rem;
        ">
        <div>
          <h1
            class="text-primary"
            style="
              font-size: 2rem;
              font-weight: bold;
              margin-bottom: 0.5rem;
              display: flex;
              align-items: center;
            ">
            <svg
              style="
                width: 2rem;
                height: 2rem;
                margin-right: 0.75rem;
                color: var(--accent-blue);
              "
              viewBox="0 0 20 20"
              fill="currentColor">
              <path
                d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v1h8v-1zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-1a3 3 0 00-3-3h-2a3 3 0 00-3 3v1h8z" />
            </svg>
            Dashboard Global de Jefes de Proyecto
          </h1>
          <p class="text-secondary" style="margin: 0">
            ¿Estamos en ruta para la meta mensual?
          </p>
        </div>

        <!-- Botón de acción crítica -->
        {% set criticos_count = encargados|selectattr('dso', '>',
        60)|list|length if encargados else 0 %} {% if criticos_count > 2 %}
        <button
          onclick="mostrarJPEnRiesgo()"
          class="btn-danger"
          style="display: flex; align-items: center">
          <svg
            style="width: 1rem; height: 1rem; margin-right: 0.5rem"
            fill="currentColor"
            viewBox="0 0 20 20">
            <path
              fill-rule="evenodd"
              d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
              clip-rule="evenodd"></path>
          </svg>
          Ver JP en Riesgo
        </button>
        {% endif %}
      </div>

      <!-- KPIs Globales en Grid -->
      <div class="grid-cols-5" style="margin-bottom: 1.5rem">
        <div class="card" style="padding: 1rem">
          <p
            class="text-tertiary"
            style="
              font-size: 0.75rem;
              font-weight: 500;
              margin-bottom: 0.25rem;
            ">
            Meta Global
          </p>
          <p
            class="text-primary"
            style="font-size: 1.5rem; font-weight: bold; margin: 0">
            ${{
            "{:,.0f}".format(managers_data.total_meta|default(0)).replace(",",".")
            }}
          </p>
        </div>

        <div class="card" style="padding: 1rem">
          <p
            class="text-tertiary"
            style="
              font-size: 0.75rem;
              font-weight: 500;
              margin-bottom: 0.25rem;
            ">
            Total Pagado
          </p>
          <p
            class="text-success"
            style="font-size: 1.5rem; font-weight: bold; margin: 0">
            ${{
            "{:,.0f}".format(managers_data.total_pagado|default(0)).replace(",",".")
            }}
          </p>
        </div>

        <div class="card" style="padding: 1rem">
          <p
            class="text-tertiary"
            style="
              font-size: 0.75rem;
              font-weight: 500;
              margin-bottom: 0.25rem;
            ">
            Pendiente Total
          </p>
          <p
            class="text-warning"
            style="font-size: 1.5rem; font-weight: bold; margin: 0">
            ${{
            "{:,.0f}".format(managers_data.total_pendiente|default(0)).replace(",",".")
            }}
          </p>
        </div>

        <div class="card" style="padding: 1rem">
          <p
            class="text-tertiary"
            style="
              font-size: 0.75rem;
              font-weight: 500;
              margin-bottom: 0.25rem;
            ">
            Avance Global
          </p>
          <div style="display: flex; align-items: center">
            <p
              style="font-size: 1.5rem; font-weight: bold; margin: 0; color: {% if managers_data.avance_global|default(0) > 70 %}var(--success){% elif managers_data.avance_global|default(0) > 50 %}var(--warning){% else %}var(--danger){% endif %};">
              {{ managers_data.avance_global|default(0) }}%
            </p>
            <div
              style="margin-left: 0.5rem; width: 2rem; height: 2rem; border-radius: 50%; border: 2px solid {% if managers_data.avance_global|default(0) > 70 %}var(--success){% elif managers_data.avance_global|default(0) > 50 %}var(--warning){% else %}var(--danger){% endif %}; display: flex; align-items: center; justify-content: center;">
              <div
                class="status-dot {% if managers_data.avance_global|default(0) > 70 %}status-green{% elif managers_data.avance_global|default(0) > 50 %}status-yellow{% else %}status-red{% endif %}"></div>
            </div>
          </div>
        </div>

        <div class="card" style="padding: 1rem">
          <p
            class="text-tertiary"
            style="
              font-size: 0.75rem;
              font-weight: 500;
              margin-bottom: 0.25rem;
            ">
            DSO Promedio
          </p>
          <p
            style="font-size: 1.5rem; font-weight: bold; margin: 0; color: {% if managers_data.promedio_dso|default(0) < 45 %}var(--success){% elif managers_data.promedio_dso|default(0) < 60 %}var(--warning){% else %}var(--danger){% endif %};">
            {{ managers_data.promedio_dso|default(0) }}d
          </p>
          <p
            class="text-tertiary"
            style="font-size: 0.75rem; margin: 0.25rem 0 0 0">
            {% set criticos_count = encargados|selectattr('dso', '>',
            60)|list|length %} {{ criticos_count }} JP > 60d
          </p>
        </div>
      </div>

      <!-- Barra de progreso global -->
      <div style="margin-top: 1.5rem">
        <div
          style="
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
          ">
          <span class="text-secondary" style="font-size: 0.875rem"
            >Progreso hacia meta mensual</span
          >
          <span class="text-secondary" style="font-size: 0.875rem"
            >{{ managers_data.avance_global|default(0) }}% completado</span
          >
        </div>
        <div class="progress-bar">
          <div
            class="progress-fill"
            style="width: {{ managers_data.avance_global|default(0) }}%; background-color: {% if managers_data.avance_global|default(0) > 70 %}var(--success){% elif managers_data.avance_global|default(0) > 50 %}var(--warning){% else %}var(--danger){% endif %};"></div>
        </div>
      </div>
    </div>

    <!-- 2. TARJETAS KPI POR JP - Scroll Horizontal -->
    <div class="mb-8">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-primary">
          Vista Rápida por Jefe de Proyecto
        </h2>
        <p class="text-sm text-secondary">
          ¿Qué JP está retrasando la cobranza?
        </p>
      </div>

      <div class="flex overflow-x-auto space-x-4 pb-4 scroll-container">
        {% for encargado in encargados|default([]) %}
        <div
          class="flex-shrink-0 w-64 card p-4 hover:shadow-md transition-shadow cursor-pointer"
          onclick="abrirModalEncargado('{{ encargado.nombre|default('Sin nombre') }}')">
          <div class="flex justify-between items-start mb-3">
            <h3 class="font-semibold text-primary truncate">
              {{ encargado.nombre|default('Sin nombre') }}
            </h3>
            <div
              class="w-3 h-3 rounded-full status-dot {% if encargado.dso|default(0) < 45 %}status-green{% elif encargado.dso|default(0) < 60 %}status-yellow{% else %}status-red{% endif %}"></div>
          </div>

          <div class="space-y-2">
            <div class="flex justify-between">
              <span class="text-xs text-secondary">% Avance</span>
              <span
                class="text-sm font-medium {% if encargado.avance|default(0) > 70 %}text-success{% elif encargado.avance|default(0) > 50 %}text-warning{% else %}text-danger{% endif %}">
                {{ encargado.avance|default(0) }}%
              </span>
            </div>

            <div class="flex justify-between">
              <span class="text-xs text-secondary">Pendiente</span>
              <span class="text-sm font-medium text-primary">
                ${{
                "{:,.0f}".format(encargado.monto_pendiente|default(0)).replace(",",".")
                }}
              </span>
            </div>

            <div class="flex justify-between">
              <span class="text-xs text-secondary">DSO</span>
              <span
                class="text-sm font-medium {% if encargado.dso|default(0) < 45 %}text-success{% elif encargado.dso|default(0) < 60 %}text-warning{% else %}text-danger{% endif %}">
                {{ encargado.dso|default(0) }}d
              </span>
            </div>

            {% if encargado.edps_criticos|default(0) > 0 %}
            <div class="flex justify-between">
              <span class="text-xs text-secondary">Críticos</span>
              <span class="text-sm font-medium text-danger"
                >{{ encargado.edps_criticos|default(0) }} EDPs</span
              >
            </div>
            {% endif %}
          </div>

          <!-- Mini progress bar -->
          <div
            class="mt-3 h-1.5 bg-[color:var(--bg-subtle)] rounded-full overflow-hidden">
            <div
              class="h-full {% if encargado.avance|default(0) > 70 %}bg-success{% elif encargado.avance|default(0) > 50 %}bg-warning{% else %}bg-danger{% endif %} transition-all duration-300"
              style="width: {{ encargado.avance|default(0) }}%"></div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- 3. TABLA COMPARATIVA DETALLADA -->
    <div class="card overflow-hidden mb-8">
      <div class="p-6 border-b border-[color:var(--border-color)]">
        <div class="flex justify-between items-center">
          <div>
            <h2 class="text-xl font-semibold text-primary">
              Comparativa Detallada
            </h2>
            <p class="text-sm text-secondary">¿Dónde priorizo?</p>
          </div>

          <!-- Filtros rápidos -->
          <div class="flex space-x-2">
            <select
              id="filtroOrden"
              class="text-sm rounded-lg border border-[color:var(--border-color)] bg-[color:var(--bg-card)] text-[color:var(--text-primary)] px-3 py-1.5">
              <option value="pendiente_desc">Mayor Pendiente</option>
              <option value="dso_desc">Mayor DSO</option>
              <option value="criticos_desc">Más Críticos</option>
              <option value="avance_asc">Menor Avance</option>
            </select>
          </div>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-sm" id="tablaEncargados">
          <thead class="bg-[color:var(--bg-subtle)]">
            <tr>
              <th
                class="px-6 py-3 text-left font-medium text-secondary uppercase tracking-wider">
                JP
              </th>
              <th
                class="px-6 py-3 text-right font-medium text-secondary uppercase tracking-wider">
                Pendiente $
              </th>
              <th
                class="px-6 py-3 text-right font-medium text-secondary uppercase tracking-wider">
                % Avance
              </th>
              <th
                class="px-6 py-3 text-right font-medium text-secondary uppercase tracking-wider">
                DSO
              </th>
              <th
                class="px-6 py-3 text-right font-medium text-secondary uppercase tracking-wider">
                EDP Críticos
              </th>
              <th
                class="px-6 py-3 text-right font-medium text-secondary uppercase tracking-wider">
                SLA Aprobación
              </th>
              <th
                class="px-6 py-3 text-center font-medium text-secondary uppercase tracking-wider">
                Acción
              </th>
            </tr>
          </thead>
          <tbody
            class="bg-[color:var(--bg-card)] divide-y divide-[color:var(--border-color)]">
            {% for encargado in encargados|default([]) %}
            <tr class="hover:bg-[color:var(--bg-hover)] transition-colors">
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div
                    class="w-3 h-3 rounded-full mr-3 {% if encargado.dso|default(0) < 45 %}status-green{% elif encargado.dso|default(0) < 60 %}status-yellow{% else %}status-red{% endif %}"></div>
                  <span class="font-medium text-primary"
                    >{{ encargado.nombre|default('Sin nombre') }}</span
                  >
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right">
                <span
                  class="font-mono text-lg {% if encargado.monto_pendiente|default(0) > 50000000 %}text-danger{% elif encargado.monto_pendiente|default(0) > 25000000 %}text-warning{% else %}text-primary{% endif %}">
                  ${{
                  "{:,.0f}".format(encargado.monto_pendiente|default(0)).replace(",",".")
                  }}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right">
                <div class="flex items-center justify-end">
                  <div
                    class="w-16 h-2 bg-[color:var(--bg-subtle)] rounded-full overflow-hidden mr-2">
                    <div
                      class="h-full {% if encargado.avance|default(0) > 70 %}bg-success{% elif encargado.avance|default(0) > 50 %}bg-warning{% else %}bg-danger{% endif %} transition-all duration-300"
                      style="width: {{ encargado.avance|default(0) }}%"></div>
                  </div>
                  <span
                    class="font-medium {% if encargado.avance|default(0) > 70 %}text-success{% elif encargado.avance|default(0) > 50 %}text-warning{% else %}text-danger{% endif %}">
                    {{ encargado.avance|default(0) }}%
                  </span>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right">
                <span
                  class="font-mono {% if encargado.dso|default(0) < 45 %}text-success{% elif encargado.dso|default(0) < 60 %}text-warning{% else %}text-danger{% endif %}">
                  {{ encargado.dso|default(0) }}d
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right">
                {% if encargado.edps_criticos|default(0) > 0 %}
                <span
                  class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-danger text-white">
                  {{ encargado.edps_criticos|default(0) }}
                </span>
                {% else %}
                <span class="text-tertiary">-</span>
                {% endif %}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right">
                <span
                  class="{% if encargado.tasa_aprobacion|default(0) > 80 %}text-success{% elif encargado.tasa_aprobacion|default(0) > 60 %}text-warning{% else %}text-danger{% endif %}">
                  {{ encargado.tasa_aprobacion|default(0) }}%
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-center">
                <button
                  onclick="priorizarEncargado('{{ encargado.nombre|default('') }}')"
                  class="btn-primary text-xs">
                  Priorizar
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- 4. GRÁFICO TOP N JP CON MAYOR PENDIENTE -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <div class="card p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold text-primary">
            Top JP con Mayor Pendiente
          </h2>
          <button
            onclick="enviarRecordatorioMasivo()"
            class="text-warning hover:text-warning transition-colors">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path
                d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"></path>
            </svg>
          </button>
        </div>
        <div class="space-y-3">
          {% set sorted_encargados =
          encargados|sort(attribute='monto_pendiente', reverse=true)|list if
          encargados else [] %} {% for encargado in sorted_encargados[:5] %}
          <div
            class="flex items-center justify-between p-3 bg-[color:var(--bg-subtle)] rounded-lg">
            <div class="flex items-center">
              <div
                class="w-8 h-8 bg-[color:var(--bg-card)] rounded-full flex items-center justify-center mr-3 border border-[color:var(--border-color)]">
                <span class="text-sm font-medium text-primary"
                  >{{ loop.index }}</span
                >
              </div>
              <div>
                <p class="font-medium text-primary">
                  {{ encargado.nombre|default('Sin nombre') }}
                </p>
                <p class="text-xs text-secondary">
                  {{ encargado.dso|default(0) }}d promedio
                </p>
              </div>
            </div>
            <div class="text-right">
              <p class="font-mono text-lg text-primary">
                ${{
                "{:,.0f}".format(encargado.monto_pendiente|default(0)).replace(",",".")
                }}
              </p>
              {% if encargado.edps_criticos|default(0) > 0 %}
              <span
                class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-danger text-white">
                {{ encargado.edps_criticos|default(0) }} críticos
              </span>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- 5. DISTRIBUCIÓN DE PENDIENTES POR ANTIGÜEDAD -->
      <div class="card p-6">
        <h2 class="text-lg font-semibold text-primary mb-4">
          Distribución por Antigüedad
        </h2>
        <div class="h-64">
          <canvas id="graficoAntiguedad"></canvas>
        </div>
        <div class="mt-4 text-xs text-tertiary text-center">
          Hover para ver lista de EDPs • Clic para drill-down
        </div>
      </div>
    </div>

    <!-- 6. EVOLUCIÓN MENSUAL (COLAPSABLE) -->
    <div class="card" style="margin-bottom: 2rem">
      <div
        style="padding: 1.5rem; border-bottom: 1px solid var(--border-color)">
        <button
          onclick="toggleEvolucionMensual()"
          style="
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: left;
            background: none;
            border: none;
            color: var(--text-primary);
          ">
          <div>
            <h2
              class="text-primary"
              style="
                font-size: 1.125rem;
                font-weight: 600;
                margin-bottom: 0.25rem;
              ">
              Evolución Mensual de Montos
            </h2>
            <p class="text-secondary" style="font-size: 0.875rem; margin: 0">
              Tendencia histórica • Más valor para análisis que para acción
              diaria
            </p>
          </div>
          <svg
            id="chevronEvolucion"
            style="
              width: 1.25rem;
              height: 1.25rem;
              color: var(--text-tertiary);
              transform: rotate(0deg);
              transition: transform 0.3s ease;
            "
            fill="currentColor"
            viewBox="0 0 20 20">
            <path
              fill-rule="evenodd"
              d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
              clip-rule="evenodd"></path>
          </svg>
        </button>
      </div>

      <div
        id="contenidoEvolucionMensual"
        style="display: none; padding: 1.5rem">
        <!-- Controles de visualización -->
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
          ">
          <div>
            <h3
              class="text-primary"
              style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem">
              Análisis de Tendencias
            </h3>
            <p class="text-secondary" style="font-size: 0.875rem; margin: 0">
              Evolución de cobros vs meta mensual
            </p>
          </div>
          <div style="display: flex; gap: 0.5rem">
            <button
              id="toggleTotalBtn"
              class="btn-primary"
              style="font-size: 0.75rem; padding: 0.25rem 0.75rem">
              Total Global
            </button>
            <button
              id="toggleEncargadosBtn"
              class="btn-primary"
              style="
                font-size: 0.75rem;
                padding: 0.25rem 0.75rem;
                background-color: var(--success);
              ">
              Por Encargado
            </button>
            <button
              id="toggleMetaBtn"
              class="btn-primary"
              style="
                font-size: 0.75rem;
                padding: 0.25rem 0.75rem;
                background-color: var(--warning);
              ">
              Meta Mensual
            </button>
          </div>
        </div>

        <!-- Métricas resumen de la evolución -->
        <div
          style="
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
          ">
          <div class="card" style="padding: 1rem; text-align: center">
            <p
              class="text-tertiary"
              style="font-size: 0.75rem; margin-bottom: 0.25rem">
              Mejor Mes
            </p>
            <p
              class="text-success"
              style="font-size: 1.25rem; font-weight: bold; margin: 0">
              {{ evolucion_mensual.mejor_mes.mes|default('N/A') }}
            </p>
            <p
              class="text-tertiary"
              style="font-size: 0.75rem; margin: 0.25rem 0 0 0">
              ${{
              "{:,.0f}".format(evolucion_mensual.mejor_mes.monto|default(0)).replace(",",".")
              }}
            </p>
          </div>

          <div class="card" style="padding: 1rem; text-align: center">
            <p
              class="text-tertiary"
              style="font-size: 0.75rem; margin-bottom: 0.25rem">
              Crecimiento
            </p>
            <p
              style="font-size: 1.25rem; font-weight: bold; margin: 0; color: {% if evolucion_mensual.tendencia_general == 'creciente' %}var(--success){% elif evolucion_mensual.tendencia_general == 'decreciente' %}var(--danger){% else %}var(--warning){% endif %};">
              {% if evolucion_mensual.tendencia_general == 'creciente' %}↗{%
              elif evolucion_mensual.tendencia_general == 'decreciente' %}↘{%
              else %}→{% endif %} {{
              evolucion_mensual.tendencia_general|default('Estable')|title }}
            </p>
            <p
              class="text-tertiary"
              style="font-size: 0.75rem; margin: 0.25rem 0 0 0">
              {% if evolucion_mensual.crecimiento_mensual|length > 0 %} {{
              evolucion_mensual.crecimiento_mensual[-1] }}% últ. mes {% else %}
              Sin datos {% endif %}
            </p>
          </div>

          <div class="card" style="padding: 1rem; text-align: center">
            <p
              class="text-tertiary"
              style="font-size: 0.75rem; margin-bottom: 0.25rem">
              Promedio/Mes
            </p>
            <p
              class="text-primary"
              style="font-size: 1.25rem; font-weight: bold; margin: 0">
              {% if evolucion_mensual.total_por_mes|length > 0 %} ${{
              "{:,.0f}".format((evolucion_mensual.total_por_mes|sum /
              evolucion_mensual.total_por_mes|length)|int).replace(",",".") }}
              {% else %} $0 {% endif %}
            </p>
            <p
              class="text-tertiary"
              style="font-size: 0.75rem; margin: 0.25rem 0 0 0">
              {{ evolucion_mensual.meses|length|default(0) }} meses
            </p>
          </div>

          <div class="card" style="padding: 1rem; text-align: center">
            <p
              class="text-tertiary"
              style="font-size: 0.75rem; margin-bottom: 0.25rem">
              Proyección
            </p>
            <p
              class="text-info"
              style="font-size: 1.25rem; font-weight: bold; margin: 0">
              {% if evolucion_mensual.total_por_mes|length >= 2 %} {% set ultimo
              = evolucion_mensual.total_por_mes[-1] %} {% set penultimo =
              evolucion_mensual.total_por_mes[-2] %} {% set proyeccion = ultimo
              + (ultimo - penultimo) %} ${{
              "{:,.0f}".format(proyeccion|abs|int).replace(",",".") }} {% else
              %} $0 {% endif %}
            </p>
            <p
              class="text-tertiary"
              style="font-size: 0.75rem; margin: 0.25rem 0 0 0">
              Próximo mes
            </p>
          </div>
        </div>

        <!-- Gráfico -->
        <div style="height: 20rem; position: relative">
          <canvas id="graficoEvolucionMensual"></canvas>
        </div>

        <!-- Tabla de detalles por encargado -->
        <div style="margin-top: 1.5rem">
          <h4
            class="text-primary"
            style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem">
            Evolución por Encargado
          </h4>
          <div style="overflow-x: auto">
            <table style="width: 100%; border-collapse: collapse">
              <thead>
                <tr style="background-color: var(--bg-subtle)">
                  <th
                    class="text-secondary"
                    style="
                      padding: 0.75rem;
                      text-align: left;
                      font-size: 0.875rem;
                      font-weight: 500;
                    ">
                    Encargado
                  </th>
                  {% for mes in evolucion_mensual.meses|default([]) %}
                  <th
                    class="text-secondary"
                    style="
                      padding: 0.75rem;
                      text-align: right;
                      font-size: 0.875rem;
                      font-weight: 500;
                    ">
                    {{ mes }}
                  </th>
                  {% endfor %}
                  <th
                    class="text-secondary"
                    style="
                      padding: 0.75rem;
                      text-align: right;
                      font-size: 0.875rem;
                      font-weight: 500;
                    ">
                    Tendencia
                  </th>
                </tr>
              </thead>
              <tbody>
                {% for encargado_data in
                evolucion_mensual.encargados|default([]) %}
                <tr style="border-bottom: 1px solid var(--border-color)">
                  <td
                    class="text-primary"
                    style="padding: 0.75rem; font-weight: 500">
                    {{ encargado_data.nombre }}
                  </td>
                  {% for monto in encargado_data.montos_por_mes %}
                  <td
                    class="text-primary"
                    style="
                      padding: 0.75rem;
                      text-align: right;
                      font-size: 0.875rem;
                    ">
                    ${{ "{:,.0f}".format(monto).replace(",",".") }}
                  </td>
                  {% endfor %}
                  <td style="padding: 0.75rem; text-align: right">
                    <span
                      class="{% if encargado_data.tendencia == 'creciente' %}text-success{% elif encargado_data.tendencia == 'decreciente' %}text-danger{% else %}text-warning{% endif %}"
                      style="font-size: 0.875rem; font-weight: 500">
                      {% if encargado_data.tendencia == 'creciente' %}↗
                      Creciente{% elif encargado_data.tendencia == 'decreciente'
                      %}↘ Decreciente{% else %}→ Estable{% endif %}
                    </span>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para detalles de encargado -->
  <div
    id="modalEncargado"
    class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div
        class="card rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-[color:var(--border-color)]">
          <div class="flex justify-between items-center">
            <h3
              id="modalTitulo"
              class="text-xl font-semibold text-primary"></h3>
            <button
              onclick="cerrarModalEncargado()"
              class="text-tertiary hover:text-secondary transition-colors">
              <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                <path
                  fill-rule="evenodd"
                  d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                  clip-rule="evenodd"></path>
              </svg>
            </button>
          </div>
        </div>
        <div id="modalContenido" class="p-6">
          <!-- Contenido dinámico -->
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Datos para los gráficos con validaciones
      const encargados = {{ encargados|default([])|tojson }};
      const evolucionMensual = {{ evolucion_mensual|default({})|tojson }};

      // Validar que evolucionMensual tenga la estructura correcta
      console.log('Datos evolucionMensual:', evolucionMensual);
      console.log('Datos encargados:', encargados);

      try {
        // Inicializar gráficos solo si hay datos
        if (encargados && Array.isArray(encargados) && encargados.length > 0) {
          inicializarGraficoAntiguedad(encargados);
        } else {
          console.warn('No hay datos de encargados disponibles para el gráfico de antigüedad');
        }

        // Verificar estructura de evolucionMensual más detalladamente
        const tieneEstructuraValida = evolucionMensual &&
          typeof evolucionMensual === 'object' &&
          (evolucionMensual.meses || evolucionMensual.total_por_mes || evolucionMensual.encargados);

        if (tieneEstructuraValida) {
          inicializarGraficoEvolucionMensual(evolucionMensual);
        } else {
          console.warn('No hay datos de evolución mensual con estructura válida disponibles');
          // Intentar mostrar mensaje de gráfico vacío si el canvas existe
          const canvas = document.getElementById('graficoEvolucionMensual');
          if (canvas) {
            mostrarMensajeGraficoVacio(canvas);
          }
        }

        // Configurar filtros de tabla
        configurarFiltrosTabla();
      } catch (error) {
        console.error('Error al inicializar gráficos:', error);
        // Mostrar mensaje de error al usuario si es necesario
        const errorDiv = document.createElement('div');
        errorDiv.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4';
        errorDiv.innerHTML = `
          <strong>Error:</strong> Hubo un problema al cargar los gráficos.
          Por favor, recarga la página o contacta al administrador.
        `;
        const container = document.querySelector('.dashboard-container');
        if (container) {
          container.insertBefore(errorDiv, container.firstChild);
        }
      }
    });

    function inicializarGraficoAntiguedad(encargados) {
      const ctx = document.getElementById('graficoAntiguedad').getContext('2d');

      // Calcular distribución por antigüedad
      const distribucion = calcularDistribucionAntiguedad(encargados);

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: encargados.map(e => e.nombre || 'Sin nombre'),
          datasets: [
            {
              label: '0-30 días',
              data: distribucion.reciente,
              backgroundColor: 'rgba(34, 197, 94, 0.8)',
              borderColor: 'rgba(34, 197, 94, 1)',
              borderWidth: 1
            },
            {
              label: '31-60 días',
              data: distribucion.medio,
              backgroundColor: 'rgba(245, 158, 11, 0.8)',
              borderColor: 'rgba(245, 158, 11, 1)',
              borderWidth: 1
            },
            {
              label: '> 60 días',
              data: distribucion.critico,
              backgroundColor: 'rgba(239, 68, 68, 0.8)',
              borderColor: 'rgba(239, 68, 68, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              stacked: true,
              ticks: {
                maxRotation: 45
              }
            },
            y: {
              stacked: true,
              beginAtZero: true
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                afterBody: function(context) {
                  return 'Clic para ver EDPs detallados';
                }
              }
            },
            legend: {
              position: 'bottom'
            }
          },
          onClick: function(event, elements) {
            if (elements.length > 0) {
              const encargado = encargados[elements[0].index];
              drillDownAntiguedad(encargado.nombre || 'Sin nombre');
            }
          }
        }
      });
    }

    function inicializarGraficoEvolucionMensual(evolucionMensual) {
      const ctx = document.getElementById('graficoEvolucionMensual');
      if (!ctx) {
        console.error('Canvas element graficoEvolucionMensual not found');
        return;
      }

      // Validar estructura de datos
      if (!evolucionMensual || typeof evolucionMensual !== 'object') {
        console.warn('evolucionMensual data is not available or invalid');
        mostrarMensajeGraficoVacio(ctx);
        return;
      }

      const ctxContext = ctx.getContext('2d');

      // Preparar datasets dinámicos con validaciones
      const datasets = [];
      const meses = evolucionMensual.meses || [];
      const totalPorMes = evolucionMensual.total_por_mes || [];

      // Validar que tengamos datos mínimos
      if (meses.length === 0 && totalPorMes.length === 0) {
        console.warn('No hay datos de meses ni totales disponibles');
        mostrarMensajeGraficoVacio(ctx);
        return;
      }

      // Meta mensual (línea punteada) - solo si tenemos meses
      if (meses.length > 0) {
        datasets.push({
          label: 'Meta Mensual',
          data: meses.map(() => {{ managers_data.total_meta|default(0) }}),
          borderColor: getComputedStyle(document.documentElement).getPropertyValue('--warning'),
          backgroundColor: 'transparent',
          borderWidth: 2,
          borderDash: [6, 6],
          fill: false,
          tension: 0,
          pointRadius: 0
        });
      }

      // Total global por mes - solo si tenemos datos
      if (totalPorMes.length > 0) {
        datasets.push({
          label: 'Total Cobrado',
          data: totalPorMes,
          borderColor: getComputedStyle(document.documentElement).getPropertyValue('--accent-blue'),
          backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--accent-blue') + '20',
          borderWidth: 3,
          fill: true,
          tension: 0.3,
          pointBackgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--accent-blue'),
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointRadius: 6
        });
      }

      // Añadir líneas por encargado (inicialmente ocultas)
      const encargados = evolucionMensual.encargados || [];
      if (Array.isArray(encargados)) {
        encargados.forEach((encargado, index) => {
          if (!encargado || !encargado.nombre) {
            console.warn(`Encargado en índice ${index} no tiene datos válidos`);
            return;
          }

          const colors = [
            getComputedStyle(document.documentElement).getPropertyValue('--success'),
            getComputedStyle(document.documentElement).getPropertyValue('--danger'),
            getComputedStyle(document.documentElement).getPropertyValue('--accent-purple'),
            getComputedStyle(document.documentElement).getPropertyValue('--accent-orange'),
            getComputedStyle(document.documentElement).getPropertyValue('--info')
          ];

          datasets.push({
            label: encargado.nombre,
            data: encargado.montos_por_mes || [],
            borderColor: colors[index % colors.length],
            backgroundColor: 'transparent',
            borderWidth: 2,
            fill: false,
            tension: 0.3,
            pointRadius: 4,
            hidden: true // Inicialmente oculto
          });
        });
      }

      // Si no hay datasets, mostrar mensaje vacío
      if (datasets.length === 0) {
        console.warn('No hay datasets para mostrar en el gráfico');
        mostrarMensajeGraficoVacio(ctx);
        return;
      }

      // Configuración del gráfico
      const chart = new Chart(ctxContext, {
        type: 'line',
        data: {
          labels: meses,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          scales: {
            x: {
              grid: {
                color: getComputedStyle(document.documentElement).getPropertyValue('--border-color-subtle')
              },
              ticks: {
                color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary')
              }
            },
            y: {
              beginAtZero: true,
              grid: {
                color: getComputedStyle(document.documentElement).getPropertyValue('--border-color-subtle')
              },
              ticks: {
                color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary'),
                callback: function(value) {
                  if (value >= 1000000) {
                    return '$' + (value / 1000000).toFixed(1) + 'M';
                  } else if (value >= 1000) {
                    return '$' + (value / 1000).toFixed(0) + 'K';
                  }
                  return '$' + value.toLocaleString();
                }
              }
            }
          },
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary'),
                font: {
                  size: 12
                },
                usePointStyle: true,
                padding: 20
              }
            },
            tooltip: {
              backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-card'),
              titleColor: getComputedStyle(document.documentElement).getPropertyValue('--text-primary'),
              bodyColor: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary'),
              borderColor: getComputedStyle(document.documentElement).getPropertyValue('--border-color'),
              borderWidth: 1,
              callbacks: {
                label: function(context) {
                  const value = context.parsed.y;
                  return context.dataset.label + ': $' + value.toLocaleString();
                },
                afterBody: function(tooltipItems) {
                  const month = tooltipItems[0].label;
                  return [`Mes: ${month}`, 'Clic para más detalles'];
                }
              }
            }
          },
          animation: {
            duration: 1000,
            easing: 'easeInOutQuart'
          }
        }
      });

      // Guardar referencia global para controles
      window.chartEvolucionMensual = chart;

      // Configurar botones de toggle
      setupToggleButtons(chart);
    }

    function mostrarMensajeGraficoVacio(canvas) {
      // Mostrar mensaje cuando no hay datos
      const container = canvas.parentElement;
      const mensaje = document.createElement('div');
      mensaje.className = 'flex items-center justify-center h-64 text-gray-500';
      mensaje.innerHTML = `
        <div class="text-center">
          <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
          <h3 class="text-lg font-medium text-gray-900 mb-2">No hay datos disponibles</h3>
          <p class="text-gray-500">No se encontraron datos de evolución mensual para mostrar en el gráfico.</p>
        </div>
      `;

      // Ocultar canvas y mostrar mensaje
      canvas.style.display = 'none';
      container.appendChild(mensaje);
    }

    function calcularDistribucionAntiguedad(encargados) {
      // Simulación de datos de antigüedad por encargado
      if (!encargados || !Array.isArray(encargados)) {
        return {
          reciente: [],
          medio: [],
          critico: []
        };
      }

      return {
        reciente: encargados.map(e => Math.floor(Math.random() * 10) + 5),
        medio: encargados.map(e => Math.floor(Math.random() * 8) + 2),
        critico: encargados.map(e => e.edps_criticos || 0)
      };
    }

    function configurarFiltrosTabla() {
      const filtroOrden = document.getElementById('filtroOrden');

      if (filtroOrden) {
        filtroOrden.addEventListener('change', function() {
          ordenarTabla(this.value);
        });
      }
    }

    function ordenarTabla(criterio) {
      // Implementar ordenamiento de tabla
      console.log('Ordenando por:', criterio);
    }

    function setupToggleButtons(chart) {
      const toggleTotalBtn = document.getElementById('toggleTotalBtn');
      const toggleEncargadosBtn = document.getElementById('toggleEncargadosBtn');
      const toggleMetaBtn = document.getElementById('toggleMetaBtn');

      if (toggleTotalBtn) {
        toggleTotalBtn.addEventListener('click', function() {
          const dataset = chart.data.datasets.find(d => d.label === 'Total Cobrado');
          if (dataset) {
            dataset.hidden = !dataset.hidden;
            chart.update();
            this.style.opacity = dataset.hidden ? '0.5' : '1';
          }
        });
      }

      if (toggleEncargadosBtn) {
        toggleEncargadosBtn.addEventListener('click', function() {
          const encargadoDatasets = chart.data.datasets.filter(d =>
            d.label !== 'Meta Mensual' && d.label !== 'Total Cobrado'
          );

          const anyVisible = encargadoDatasets.some(d => !d.hidden);

          encargadoDatasets.forEach(dataset => {
            dataset.hidden = anyVisible;
          });

          chart.update();
          this.style.opacity = anyVisible ? '0.5' : '1';
        });
      }

      if (toggleMetaBtn) {
        toggleMetaBtn.addEventListener('click', function() {
          const dataset = chart.data.datasets.find(d => d.label === 'Meta Mensual');
          if (dataset) {
            dataset.hidden = !dataset.hidden;
            chart.update();
            this.style.opacity = dataset.hidden ? '0.5' : '1';
          }
        });
      }
    }

    function toggleEvolucionMensual() {
      const contenido = document.getElementById('contenidoEvolucionMensual');
      const chevron = document.getElementById('chevronEvolucion');

      if (contenido && chevron) {
        const isHidden = contenido.style.display === 'none';
        contenido.style.display = isHidden ? 'block' : 'none';
        chevron.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';

        // Si se está mostrando el contenido y hay datos, renderizar el gráfico
        if (isHidden && window.chartEvolucionMensual) {
          setTimeout(() => {
            window.chartEvolucionMensual.resize();
          }, 300);
        }
      }
    }

    function abrirModalEncargado(nombre) {
      const modal = document.getElementById('modalEncargado');
      const titulo = document.getElementById('modalTitulo');
      const contenido = document.getElementById('modalContenido');

      if (modal && titulo && contenido) {
        titulo.textContent = `Detalle de ${nombre}`;

        // Buscar datos del encargado
        const encargados = {{ encargados|default([])|tojson }};
        const encargado = encargados.find(e => e.nombre === nombre) || {};

        contenido.innerHTML = `
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
              <p class="text-sm text-gray-500 dark:text-gray-400">Monto Pendiente</p>
              <p class="text-xl font-bold text-gray-900 dark:text-white">$${(encargado.monto_pendiente || 0).toLocaleString()}</p>
            </div>
            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
              <p class="text-sm text-gray-500 dark:text-gray-400">DSO</p>
              <p class="text-xl font-bold ${(encargado.dso || 0) < 45 ? 'text-green-600' : (encargado.dso || 0) < 60 ? 'text-yellow-600' : 'text-red-600'}">${encargado.dso || 0}d</p>
            </div>
          </div>
          <div class="flex justify-end space-x-2">
            <button onclick="window.open('/controller/encargado/${encargado.nombre || ''}', '_blank')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
              Ver Detalle Completo
            </button>
            <button onclick="priorizarEncargado('${nombre}')" class="btn-primary">
              Priorizar EDPs
            </button>
          </div>
        `;

        modal.classList.remove('hidden');
      }
    }

    function cerrarModalEncargado() {
      const modal = document.getElementById('modalEncargado');
      if (modal) {
        modal.classList.add('hidden');
      }
    }

    function mostrarJPEnRiesgo() {
      const encargados = {{ encargados|default([])|tojson }};
      const jpEnRiesgo = encargados.filter(e => (e.dso || 0) > 60 || (e.edps_criticos || 0) > 0);

      if (jpEnRiesgo.length > 0) {
        alert(`JP en riesgo:\n${jpEnRiesgo.map(jp => `• ${jp.nombre || 'Sin nombre'} (DSO: ${jp.dso || 0}d, Críticos: ${jp.edps_criticos || 0})`).join('\n')}`);
      } else {
        alert('No hay JP en riesgo actualmente');
      }
    }

    function priorizarEncargado(nombre) {
      // Redirigir a vista de priorización
      if (nombre) {
        window.open(`/controller/encargado/${nombre}?priorizar=true`, '_blank');
      }
    }

    function enviarRecordatorioMasivo() {
      if (confirm('¿Enviar recordatorio a todos los JP con pendientes críticos?')) {
        // Implementar envío de recordatorios
        alert('Recordatorios enviados exitosamente');
      }
    }

    function drillDownAntiguedad(encargado) {
      // Implementar drill-down para ver EDPs específicos
      console.log('Drill-down para:', encargado);
    }
  </script>

  {% endblock %}
</div>
