{% extends "base.html" %} {% block title %}Vista Kanban - EDP{% endblock %} {%
block head %} {{ super() }}
<link
  href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
  rel="stylesheet" />
{% include "controller/modal_edp_template.html" %}
<!-- Scripts -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<!-- Antes del cierre de body -->
<script src="{{ url_for('static', filename='js/common/modal_edp_scripts.js') }}"></script>
<script src="{{ url_for('static', filename='js/control_panel/controller_kanban.js') }}"></script>
<script src="{{ url_for('static', filename='js/control_panel/table-controller.js') }}"></script>
<!-- Control de acceso Kanban unificado -->
<script src="{{ url_for('static', filename='js/control_panel/kanban_access_control.js') }}"></script>
<!-- Filtros y UI del Kanban -->
<script src="{{ url_for('static', filename='js/control_panel/controller_kanban_filters.js') }}"></script>
<!-- Métricas y estadísticas del Kanban -->
<script src="{{ url_for('static', filename='js/control_panel/controller_kanban_metrics.js') }}"></script>
<!-- Filtros y UI del Kanban -->
<script src="{{ url_for('static', filename='js/control_panel/kanban-filters.js') }}"></script>
<!-- Vista completa del Kanban y Tabla -->
<script src="{{ url_for('static', filename='js/control_panel/fullscreen_kanban.js') }}"></script>

<!-- Configuración de variables globales y datos para JavaScript -->
<script>
  // Variables globales para JavaScript
  window.dsoGlobal = {{ dso_global|default(0) }};

  // Variables para control de acceso Kanban
  window.userAccessLevel = '{{ user_access_level|default("none") }}';
  window.managerName = '{{ manager_name|default("")|e }}';
  window.currentUserRole = '{{ current_user_role|default("")|e }}';
  window.isRestrictedUser = {{ is_restricted_user|default(false)|tojson }};

  // Datos para métricas (disponibles para el JavaScript externo)
  window.estadisticasData = {{ estadisticas|tojson|safe }};
  window.registrosData = {{ registros|tojson|safe }};

  // Suprimir errores de media del navegador
  window.addEventListener('error', function(e) {
    if (e.message && e.message.includes('media resource')) {
      e.preventDefault();
      return false;
    }
  }, true);

  // FUNCIÓN GLOBAL PARA FORMATEO CONSISTENTE DE MONTOS - DEFINIDA PRIMERO
  window.formatMonto = function(amount) {
    if (amount >= 1000000) {
      return '$' + Math.round(amount / 1000000) + 'M';
    } else if (amount >= 1000) {
      return '$' + Math.round(amount / 1000) + 'K';
    } else {
      return '$' + Math.round(amount);
    }
  };

  // Configurar atributos de datos para el JavaScript externo
  document.addEventListener('DOMContentLoaded', function() {
    document.body.setAttribute('data-initial-filter', '{{ filtros.estado|default("pendientes") }}');
    document.body.setAttribute('data-filter-mes', '{{ filtros.mes|default("") }}');
    document.body.setAttribute('data-filter-jefe', '{{ filtros.jefe_proyecto|default("") }}');
    document.body.setAttribute('data-filter-cliente', '{{ filtros.cliente|default("") }}');
    document.body.setAttribute('data-filter-estado', '{{ filtros.estado|default("pendientes") }}');

    // Sincronizar métricas entre diferentes secciones CON DATOS REALES
    function syncAllMetrics() {
      // CALCULAR DATOS REALES DEL KANBAN
      const columns = document.querySelectorAll(".kanban-column");
             let totalEdpsReal = 0;
       let totalPendientesReal = 0;
       let totalPagadosReal = 0;
       let totalMontoReal = 0;
       let totalDiasReal = 0;
       let tarjetasConDiasReal = 0;
       let edpsCriticosReal = 0;
       let edpsProximosVencimientoReal = 0;
       let dsoPromedioReal = 0;

      columns.forEach((col) => {
        const estado = col.dataset.estado.toLowerCase();
        const tarjetas = col.querySelectorAll(".kanban-item");

        tarjetas.forEach((tarjeta) => {
          totalEdpsReal++;

                     // Contar por estado
           if (estado === 'revisión' || estado === 'enviado' || estado === 'validado') {
             totalPendientesReal++;
           } else if (estado === 'pagado') {
             totalPagadosReal++;
           }

          // Calcular monto total real
          const montoSpans = tarjeta.querySelectorAll('span');
          for (let span of montoSpans) {
            if (span.textContent.includes('$') && span.classList.contains('mono-font')) {
              const montoText = span.textContent.trim();
              const monto = parseFloat(
                montoText.replace("$", "").replace(/\./g, "").replace(",", ".")
              );
              if (!isNaN(monto)) {
                totalMontoReal += monto;
              }
              break;
            }
          }

          // Calcular días y críticos reales
          for (let span of montoSpans) {
            if (span.textContent.includes('d') && span.classList.contains('mono-font') && !span.textContent.includes('$')) {
              const diasTextoCompleto = span.textContent;
              const diasMatch = diasTextoCompleto.match(/(\d+)/);
              if (diasMatch && diasMatch[1]) {
                const dias = parseInt(diasMatch[1]);
                if (!isNaN(dias)) {
                  totalDiasReal += dias;
                  tarjetasConDiasReal++;
                  
                  // Contar críticos (>30 días)
                  if (dias > 30) {
                    edpsCriticosReal++;
                  }
                  
                  // Contar próximos vencimientos (5-10 días)
                  if (dias >= 5 && dias <= 10) {
                    edpsProximosVencimientoReal++;
                  }
                }
              }
              break;
            }
          }
        });
      });

      // Calcular DSO promedio real
      dsoPromedioReal = tarjetasConDiasReal > 0 ? Math.round(totalDiasReal / tarjetasConDiasReal) : 0;

             // ACTUALIZAR KPIs PRINCIPALES CON DATOS REALES
       const headerTotalEdps = document.getElementById('total-edps-banner');
       const headerPendientes = document.getElementById('pendientes-banner');
       const headerPagados = document.getElementById('pagados-banner');
       const headerMetaMensual = document.getElementById('meta-mensual');

       if (headerTotalEdps) headerTotalEdps.textContent = totalEdpsReal;
       if (headerPendientes) headerPendientes.textContent = totalPendientesReal;
       if (headerPagados) headerPagados.textContent = totalPagadosReal;
       if (headerMetaMensual) headerMetaMensual.textContent = '$' + Math.round(totalMontoReal / 1000000) + 'M';

      // ACTUALIZAR SIDEBAR CON DATOS REALES
      const montoTotalSidebar = document.getElementById('monto-total');
      const dsoPrincipalSidebar = document.getElementById('dso-principal');
      const totalCriticosSidebar = document.getElementById('total-criticos');
      const montoBar = document.getElementById('monto-bar');
      const metaInfoSidebar = document.getElementById('meta-info-sidebar');

      if (montoTotalSidebar) {
        montoTotalSidebar.textContent = '$' + Math.round(totalMontoReal / 1000000) + 'M';
      }
      if (dsoPrincipalSidebar) {
        console.log('Actualizando DSO promedio:', dsoPromedioReal, 'días - Total días:', totalDiasReal, 'Tarjetas:', tarjetasConDiasReal);
        dsoPrincipalSidebar.textContent = dsoPromedioReal + ' días';
      }
      if (totalCriticosSidebar) {
        totalCriticosSidebar.textContent = edpsCriticosReal;
      }
      
      // Actualizar información de meta en sidebar
      if (montoBar && metaInfoSidebar) {
        const metaObjetivoSidebar = Math.max(5000000000, totalMontoReal * 1.2);
        const progresoSidebar = Math.min(100, Math.round((totalMontoReal / metaObjetivoSidebar) * 100));
        
        montoBar.style.width = progresoSidebar + '%';
        metaInfoSidebar.textContent = `Meta: $${Math.round(metaObjetivoSidebar / 1000000)}M • Progreso: ${progresoSidebar}%`;
      }

             // ACTUALIZAR ACTIVIDAD DEL DÍA CON DATOS REALES MEJORADOS
       const edpsProcesados = document.getElementById('edps-procesados-hoy');
       const pagosHoy = document.getElementById('validaciones-hoy');
       const alertasActivas = document.getElementById('alertas-activas');

              // Calcular actividad del día de forma más realista
        const fechaHoy = new Date();
        const diaDelMes = fechaHoy.getDate();
        const horaActual = fechaHoy.getHours();
        const minutosActuales = fechaHoy.getMinutes();
        
        // Factor de progreso del día (0 a 1)
        const progresoDelDia = (horaActual * 60 + minutosActuales) / (24 * 60);
        
        // Factor de actividad basado en horario laboral (8:00 - 18:00)
        let factorHorario = 1;
        if (horaActual >= 8 && horaActual <= 18) {
          factorHorario = 1.2; // Mayor actividad en horario laboral
        } else if (horaActual >= 19 || horaActual <= 7) {
          factorHorario = 0.3; // Menor actividad fuera de horario
        }
        
        // EDPs procesados hoy: basado en progreso del día, horario y total de EDPs
        const baseEDPsHoy = Math.max(1, Math.floor(totalEdpsReal / 25));
        const edpsProcesadosHoy = Math.max(1, Math.floor(baseEDPsHoy * progresoDelDia * factorHorario + Math.random() * 2));
        
        // Pagos procesados hoy: más conservador, basado en progreso del día
        const basePagosHoy = Math.max(0, Math.floor(totalPagadosReal * 0.12));
        const pagosRealizadosHoy = Math.floor(basePagosHoy * progresoDelDia * factorHorario + Math.random() * 1);
        
        // Alertas activas: EDPs críticos + algunos adicionales por vencimientos próximos
        const alertasActivasHoy = edpsCriticosReal + Math.floor(edpsProximosVencimientoReal * 0.3);

               if (edpsProcesados) edpsProcesados.textContent = edpsProcesadosHoy;
        if (pagosHoy) pagosHoy.textContent = pagosRealizadosHoy;
        if (alertasActivas) alertasActivas.textContent = alertasActivasHoy;
        
        // ACTUALIZAR PANEL DE ESCALACIÓN CRÍTICA
        const edpsCriticosEscalacion = document.getElementById('edps-criticos-escalacion');
        const edpsAtencionEscalacion = document.getElementById('edps-atencion-escalacion');
        const jpMasEdps = document.getElementById('jp-mas-edps');
        
        if (edpsCriticosEscalacion) {
          edpsCriticosEscalacion.textContent = edpsCriticosReal;
        }
        
        if (edpsAtencionEscalacion) {
          // Contar EDPs entre 20-30 días
          let edpsAtencion = 0;
          columns.forEach((col) => {
            const tarjetas = col.querySelectorAll(".kanban-item");
            tarjetas.forEach((tarjeta) => {
              const montoSpans = tarjeta.querySelectorAll('span');
              for (let span of montoSpans) {
                if (span.textContent.includes('d') && span.classList.contains('mono-font') && !span.textContent.includes('$')) {
                  const diasMatch = span.textContent.match(/(\d+)/);
                  if (diasMatch && diasMatch[1]) {
                    const dias = parseInt(diasMatch[1]);
                    if (dias >= 20 && dias <= 30) {
                      edpsAtencion++;
                    }
                  }
                  break;
                }
              }
            });
          });
          edpsAtencionEscalacion.textContent = edpsAtencion;
        }
        
        if (jpMasEdps) {
          // Contar EDPs por JP
          const jpCounts = {};
          columns.forEach((col) => {
            const tarjetas = col.querySelectorAll(".kanban-item");
            tarjetas.forEach((tarjeta) => {
              const responsable = tarjeta.getAttribute('data-responsable');
              if (responsable) {
                jpCounts[responsable] = (jpCounts[responsable] || 0) + 1;
              }
            });
          });
          
          // Encontrar JP con más EDPs
          let maxJP = '';
          let maxCount = 0;
          for (const [jp, count] of Object.entries(jpCounts)) {
            if (count > maxCount) {
              maxCount = count;
              maxJP = jp;
            }
          }
          
          jpMasEdps.textContent = maxJP ? `${maxJP} (${maxCount})` : '-';
        }
        
        // Actualizar indicador de rendimiento de actividad
        const rendimientoActividad = document.getElementById('rendimiento-actividad');
        const barraRendimiento = document.getElementById('barra-rendimiento');
        
        if (rendimientoActividad && barraRendimiento) {
          // Calcular rendimiento basado en la actividad actual vs esperada
          const actividadEsperada = Math.max(1, Math.floor(totalEdpsReal / 20 * progresoDelDia));
          const rendimientoPorcentaje = Math.min(100, Math.floor((edpsProcesadosHoy / actividadEsperada) * 100));
          
          let estadoRendimiento = 'Normal';
          let colorClase = 'text-[color:var(--accent-blue)]';
          
          if (rendimientoPorcentaje >= 80) {
            estadoRendimiento = 'Excelente';
            colorClase = 'text-[color:var(--accent-green)]';
          } else if (rendimientoPorcentaje >= 60) {
            estadoRendimiento = 'Bueno';
            colorClase = 'text-[color:var(--accent-blue)]';
          } else if (rendimientoPorcentaje >= 40) {
            estadoRendimiento = 'Regular';
            colorClase = 'text-[color:var(--accent-warning)]';
          } else {
            estadoRendimiento = 'Bajo';
            colorClase = 'text-[color:var(--accent-danger)]';
          }
          
          rendimientoActividad.textContent = estadoRendimiento;
          rendimientoActividad.className = `text-xs font-bold mono-font ${colorClase}`;
          barraRendimiento.style.width = rendimientoPorcentaje + '%';
        }
        
        // Actualizar indicador de última actualización
        const ultimaActualizacion = document.getElementById('ultima-actualizacion');
        if (ultimaActualizacion) {
          const ahora = new Date();
          const hora = ahora.toLocaleTimeString('es-CL', { 
            hour: '2-digit', 
            minute: '2-digit',
            second: '2-digit'
          });
          ultimaActualizacion.textContent = `Actualizado: ${hora}`;
        }

      // ACTUALIZAR PROGRESO DE META MENSUAL CON DATOS REALES
      const metaProgress = document.getElementById('meta-progress');
      const metaMensualElement = document.getElementById('meta-mensual');
      if (metaProgress && metaMensualElement) {
        // Establecer meta realista basada en el monto total (meta = 120% del monto actual)
        const metaObjetivo = Math.max(5000000000, totalMontoReal * 1.2); // Mínimo $5000M o 120% del actual
        const progress = Math.min(100, Math.round((totalMontoReal / metaObjetivo) * 100));
        
        // Actualizar el texto de la meta
        metaMensualElement.textContent = '$' + Math.round(metaObjetivo / 1000000) + 'M';
        metaProgress.style.width = progress + '%';
      }

      // ACTUALIZAR PANEL DE ALERTAS CON DATOS REALES
      const alertasCriticas = document.getElementById('alertas-criticas');
      const rendimientoHoy = document.getElementById('rendimiento-hoy');
      const proximosVencimientos = document.getElementById('proximos-vencimientos');

      if (alertasCriticas) {
        alertasCriticas.textContent = edpsCriticosReal;
      }

             if (rendimientoHoy) {
         // Calcular rendimiento basado en ratio pagados/total
         const ratioPagados = totalEdpsReal > 0 ? (totalPagadosReal / totalEdpsReal) * 100 : 0;
         const rendimiento = Math.round(ratioPagados - 30); // Comparar con 30% base (meta de pagos)
         rendimientoHoy.textContent = (rendimiento > 0 ? '+' : '') + rendimiento + '%';
         rendimientoHoy.className = rendimiento > 0 ?
           'text-lg font-bold text-[color:var(--accent-green)] mono-font' :
           'text-lg font-bold text-[color:var(--accent-danger)] mono-font';
       }

      if (proximosVencimientos) {
        proximosVencimientos.textContent = edpsProximosVencimientoReal;
      }

      // Actualizar totales por columna
      updateColumnTotals();
    }

    // Función CORREGIDA para actualizar totales por columna
    function updateColumnTotals() {
      ['revisión', 'enviado', 'validado', 'pagado'].forEach(estado => {
        const columna = document.getElementById(`columna-${estado}`);
        if (!columna) return;

        const items = columna.querySelectorAll('.kanban-item');
        let total = 0;
        let count = 0;

        items.forEach(item => {
          // BUSCAR CORRECTAMENTE EL SPAN DEL MONTO EN LA NUEVA ESTRUCTURA
          const montoSpans = item.querySelectorAll('span.mono-font');
          let montoEncontrado = false;
          
          for (let span of montoSpans) {
            if (span.textContent.includes('$') && !span.textContent.includes('d')) {
              const montoText = span.textContent.trim();
              const monto = parseFloat(montoText.replace(/[$.,]/g, ''));
              if (!isNaN(monto)) {
                total += monto;
                count++;
                montoEncontrado = true;
                break;
              }
            }
          }
          
          // Si no se encontró en spans, buscar en el atributo data
          if (!montoEncontrado) {
            const montoData = item.getAttribute('data-monto');
            if (montoData) {
              const monto = parseFloat(montoData);
              if (!isNaN(monto)) {
                total += monto;
                count++;
              }
            }
          }
        });

        // Actualizar total con formato consistente
        const totalElement = document.querySelector(`[data-columna-total="${estado}"]`);
        if (totalElement) {
          totalElement.textContent = window.formatMonto ? window.formatMonto(total) : '$' + Math.round(total / 1000000) + 'M';
        }
        
        // Actualizar promedio con formato consistente
        const promedioElement = document.querySelector(`[data-columna-promedio="${estado}"]`);
        if (promedioElement) {
          const promedio = count > 0 ? total / count : 0;
          promedioElement.textContent = window.formatMonto ? window.formatMonto(promedio) : '$' + Math.round(promedio / 1000000) + 'M';
        }
      });
    }

    // Ejecutar al cargar y cada 5 segundos
    syncAllMetrics();
    setInterval(syncAllMetrics, 5000);
    
    // Función formatMonto ya definida globalmente arriba

    // Observar cambios en el DOM para mantener formato
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'childList') {
          // Si se agregaron o removieron tarjetas, actualizar totales
          const addedNodes = Array.from(mutation.addedNodes);
          const removedNodes = Array.from(mutation.removedNodes);
          
          if (addedNodes.some(node => node.classList && node.classList.contains('kanban-item')) ||
              removedNodes.some(node => node.classList && node.classList.contains('kanban-item'))) {
            setTimeout(() => {
              updateColumnTotals();
                             // Forzar formato correcto en todos los totales
               document.querySelectorAll('[data-columna-total]').forEach(element => {
                 const currentText = element.textContent;
                 if (currentText && currentText.match(/^\$[\d,]+$/) && !currentText.match(/[MK]$/)) {
                   const number = parseFloat(currentText.replace(/[$,]/g, ''));
                   if (!isNaN(number)) {
                     element.textContent = window.formatMonto ? window.formatMonto(number) : '$' + Math.round(number / 1000000) + 'M';
                   }
                 }
               });
            }, 100);
          }
        }
      });
    });
    
    // Observar todas las columnas kanban
    document.querySelectorAll('.kanban-list').forEach(column => {
      observer.observe(column, { childList: true });
    });

    // Funcionalidad del toggle de filtros
    const toggleFiltersBtn = document.getElementById('toggle-filters-btn');
    const filtersPanel = document.getElementById('filters-panel');
    const filterChevron = document.getElementById('filter-chevron');
    
    if (toggleFiltersBtn && filtersPanel) {
      toggleFiltersBtn.addEventListener('click', function() {
        const isHidden = filtersPanel.classList.contains('hidden');
        
        if (isHidden) {
          // Mostrar filtros
          filtersPanel.classList.remove('hidden');
          filtersPanel.classList.remove('animate__fadeOutUp');
          filtersPanel.classList.add('animate__fadeInDown');
          filterChevron.style.transform = 'rotate(180deg)';
        } else {
          // Ocultar filtros
          filtersPanel.classList.remove('animate__fadeInDown');
          filtersPanel.classList.add('animate__fadeOutUp');
          filterChevron.style.transform = 'rotate(0deg)';
          
          // Ocultar después de la animación
          setTimeout(() => {
            filtersPanel.classList.add('hidden');
          }, 300);
        }
      });
    }

    // PARCHE PARA CORREGIR SELECTORES DEL JAVASCRIPT EXTERNO
    // Sobrescribir funciones problemáticas con selectores actualizados
    
    // Función corregida para calcular totales de columna
    window.calcularTotalesColumnaFixed = function() {
      const columns = document.querySelectorAll(".kanban-column");

      columns.forEach((col) => {
        const estado = col.dataset.estado;
        const tarjetas = col.querySelectorAll(".kanban-item");

        let totalMonto = 0;
        let totalDias = 0;
        let tarjetasConDias = 0;

        tarjetas.forEach((tarjeta) => {
          // SELECTOR CORREGIDO: buscar el span del monto (contiene $ y está en la cabecera)
          const montoSpans = tarjeta.querySelectorAll('span');
          let montoSpan = null;
          for (let span of montoSpans) {
            if (span.textContent.includes('$') && span.classList.contains('mono-font')) {
              montoSpan = span;
              break;
            }
          }
          
          if (montoSpan) {
            const montoText = montoSpan.textContent.trim();
            const monto = parseFloat(
              montoText.replace("$", "").replace(/\./g, "").replace(",", ".")
            );
            if (!isNaN(monto)) {
              totalMonto += monto;
            }
          }

          // SELECTOR CORREGIDO: buscar el span de días (contiene 'd' y es mono-font)
          let diasSpan = null;
          for (let span of montoSpans) {
            if (span.textContent.includes('d') && span.classList.contains('mono-font') && !span.textContent.includes('$')) {
              diasSpan = span;
              break;
            }
          }
          
          if (diasSpan) {
            const diasTextoCompleto = diasSpan.textContent;
            const diasMatch = diasTextoCompleto.match(/(\d+)/);
            if (diasMatch && diasMatch[1]) {
              const dias = parseInt(diasMatch[1]);
              if (!isNaN(dias)) {
                totalDias += dias;
                tarjetasConDias++;
              }
            }
          }
        });

        // Actualizar totales en la columna con formato consistente
        const totalElement = col.querySelector(`[data-columna-total="${estado}"]`);
        if (totalElement) {
          totalElement.textContent = window.formatMonto ? window.formatMonto(totalMonto) : '$' + Math.round(totalMonto / 1000000) + 'M';
        }

        // Actualizar días promedio si existe el elemento
        const diasElement = col.querySelector(`[data-columna-dias="${estado}"]`);
        if (diasElement) {
          const promedioDias = tarjetasConDias > 0 ? Math.round(totalDias / tarjetasConDias) : 0;
          diasElement.textContent = `${promedioDias} días prom.`;
        }
      });
    };

    // Función corregida para updateSummaryPanel (deshabilitada ya que no tenemos summary-panel)
    window.updateSummaryPanelFixed = function() {
      // No hacer nada ya que no tenemos summary-panel en la nueva estructura
      console.log('updateSummaryPanel: Panel no disponible en nueva estructura');
    };

    // Sobrescribir las funciones originales después de que se cargue el JS externo
    setTimeout(() => {
      if (window.calcularTotalesColumna) {
        window.calcularTotalesColumna = window.calcularTotalesColumnaFixed;
      }
      if (window.updateSummaryPanel) {
        window.updateSummaryPanel = window.updateSummaryPanelFixed;
      }
      
      // FORZAR ACTUALIZACIÓN CON FORMATO CORRECTO
      updateColumnTotals();
      
             // Interceptar cualquier función que actualice totales sin formato - VERSIÓN ROBUSTA
       try {
         const textContentDescriptor = Object.getOwnPropertyDescriptor(Element.prototype, 'textContent');
         if (textContentDescriptor && textContentDescriptor.set) {
           const originalSetTextContent = textContentDescriptor.set;
           Object.defineProperty(Element.prototype, 'textContent', {
             set: function(value) {
               // Si es un elemento de total de columna y el valor contiene números sin formato
               if (this.hasAttribute('data-columna-total') && 
                   typeof value === 'string' && 
                   value.match(/^\$[\d,]+$/) && 
                   !value.match(/[MK]$/)) {
                 // Extraer el número y reformatearlo
                 const number = parseFloat(value.replace(/[$,]/g, ''));
                 if (!isNaN(number)) {
                   value = window.formatMonto ? window.formatMonto(number) : '$' + Math.round(number / 1000000) + 'M';
                 }
               }
               originalSetTextContent.call(this, value);
             },
             get: textContentDescriptor.get,
             configurable: true
           });
         } else {
           console.log('textContent descriptor not available, using alternative approach');
           // Enfoque alternativo: monitorear específicamente los elementos de total
           setInterval(() => {
             document.querySelectorAll('[data-columna-total]').forEach(element => {
               const currentText = element.textContent;
               if (currentText && currentText.match(/^\$[\d,]+$/) && !currentText.match(/[MK]$/)) {
                 const number = parseFloat(currentText.replace(/[$,]/g, ''));
                 if (!isNaN(number)) {
                   element.textContent = window.formatMonto ? window.formatMonto(number) : '$' + Math.round(number / 1000000) + 'M';
                 }
               }
             });
           }, 500);
         }
       } catch (error) {
         console.log('Error setting up textContent interceptor, using polling approach:', error);
         // Fallback: revisar periódicamente los totales
         setInterval(() => {
           document.querySelectorAll('[data-columna-total]').forEach(element => {
             const currentText = element.textContent;
             if (currentText && currentText.match(/^\$[\d,]+$/) && !currentText.match(/[MK]$/)) {
               const number = parseFloat(currentText.replace(/[$,]/g, ''));
               if (!isNaN(number)) {
                 element.textContent = window.formatMonto ? window.formatMonto(number) : '$' + Math.round(number / 1000000) + 'M';
               }
             }
           });
         }, 500);
       }
    }, 1000);
  });

</script>

<style>
/* Estilos para vista completa del Kanban y Tabla */
.kanban-fullscreen {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  right: 0 !important;
  bottom: 0 !important;
  z-index: 9999 !important;
  background-color: var(--bg-primary) !important;
  padding: 20px !important;
  overflow-y: auto !important; /* Permitir scroll vertical en todo el contenedor */
  animation: fullscreenFadeIn 0.3s ease-out;
}

.kanban-fullscreen-content {
  min-height: 100vh; /* Asegurar altura mínima para scroll */
  display: flex;
  flex-direction: column;
}

/* Estilos específicos para Kanban en vista completa */
.kanban-fullscreen #kanban-board {
  flex: 1;
  min-height: 0; /* Permite que el contenedor se ajuste */
  width: 100%;
  overflow: visible; /* Permitir que el contenido sea visible */
}

.kanban-fullscreen.with-filters #kanban-board {
  min-height: 0;
}

.kanban-fullscreen .kanban-column {
  min-height: 500px; /* Altura mínima más razonable */
  height: auto !important;
}

.kanban-fullscreen .kanban-list {
  max-height: 70vh !important; /* Altura máxima para permitir scroll interno */
  min-height: 400px; /* Altura mínima para comodidad */
  overflow-y: auto !important; /* Scroll interno en cada columna */
  padding-right: 8px; /* Espacio para scrollbar */
}

/* Estilos específicos para Tabla en vista completa */
.kanban-fullscreen #tabla-view {
  flex: 1;
  min-height: 0; /* Permite que el contenedor se ajuste */
  width: 100%;
  overflow: visible !important;
  padding-bottom: 20px;
}

.kanban-fullscreen.with-filters #tabla-view {
  min-height: 0;
}

.kanban-fullscreen #tabla-view .container {
  max-width: none !important;
  width: 100% !important;
  padding: 0 !important;
}

.kanban-fullscreen #tabla-view .table-responsive {
  max-height: none !important; /* Quitar límite de altura */
  overflow: visible !important; /* Permitir scroll natural */
}

.kanban-fullscreen #tabla-view table {
  font-size: 0.875rem !important;
}

.kanban-fullscreen #tabla-view th,
.kanban-fullscreen #tabla-view td {
  padding: 12px 8px !important;
  white-space: nowrap;
}

/* Hacer la tabla más compacta en vista completa */
.kanban-fullscreen #tabla-view .section-title-modern {
  margin-bottom: 1rem !important;
}

.kanban-fullscreen #tabla-view .section-title-modern h2 {
  font-size: 1.25rem !important;
}

/* Estilos para filtros en vista completa */
.kanban-fullscreen .fullscreen-filters {
  background: var(--bg-card) !important;
  border: 1px solid var(--border-primary) !important;
  border-radius: 12px !important;
  padding: 16px !important;
  margin-bottom: 20px !important;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
}

.kanban-fullscreen .fullscreen-filters h3 {
  font-size: 1rem !important;
  margin-bottom: 12px !important;
}

.kanban-fullscreen .fullscreen-filters .grid {
  gap: 12px !important;
}

.kanban-fullscreen .fullscreen-filters select,
.kanban-fullscreen .fullscreen-filters input {
  font-size: 0.875rem !important;
  padding: 8px 12px !important;
}

.kanban-fullscreen .fullscreen-filters button {
  font-size: 0.875rem !important;
  padding: 8px 16px !important;
}

/* Header compacto en vista completa */
.kanban-fullscreen-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
  border: 1px solid var(--border-primary);
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.kanban-fullscreen-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text-primary);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.kanban-fullscreen-controls {
  display: flex;
  gap: 12px;
  align-items: center;
}

/* Estilos para toggle de vista en fullscreen */
.kanban-fullscreen .view-toggle {
  color: var(--text-secondary);
  background: transparent;
  border: none;
  cursor: pointer;
  transition: all 0.2s ease;
}

.kanban-fullscreen .view-toggle:hover {
  color: var(--text-primary);
  background: var(--bg-primary);
}

.kanban-fullscreen .view-toggle.active {
  color: var(--accent-blue);
  background: var(--bg-primary);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* Animaciones */
@keyframes fullscreenFadeIn {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

@keyframes fullscreenFadeOut {
  from {
    opacity: 1;
    transform: scale(1);
  }
  to {
    opacity: 0;
    transform: scale(0.95);
  }
}

.kanban-fullscreen-exit {
  animation: fullscreenFadeOut 0.3s ease-in;
}

/* Botón de cerrar vista completa */
.fullscreen-exit-btn {
  background: var(--bg-card);
  color: var(--text-primary);
  border: 1px solid var(--border-color);
  padding: 10px 20px;
  border-radius: 12px;
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.fullscreen-exit-btn:hover {
  background: var(--bg-card-hover);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

/* Ocultar elementos innecesarios en vista completa */
.kanban-fullscreen #kanban-main-container > *:not(#kanban-board):not(#tabla-view) {
  display: none !important;
}

/* Mejorar scrollbar en vista completa */
.kanban-fullscreen .kanban-list::-webkit-scrollbar,
.kanban-fullscreen .table-responsive::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

.kanban-fullscreen .kanban-list::-webkit-scrollbar-track,
.kanban-fullscreen .table-responsive::-webkit-scrollbar-track {
  background: var(--bg-tertiary);
  border-radius: 4px;
}

.kanban-fullscreen .kanban-list::-webkit-scrollbar-thumb,
.kanban-fullscreen .table-responsive::-webkit-scrollbar-thumb {
  background: var(--accent-blue);
  border-radius: 4px;
}

.kanban-fullscreen .kanban-list::-webkit-scrollbar-thumb:hover,
.kanban-fullscreen .table-responsive::-webkit-scrollbar-thumb:hover {
  background: var(--accent-blue-hover);
}

/* Scrollbar para el contenedor principal de fullscreen */
.kanban-fullscreen::-webkit-scrollbar {
  width: 12px;
}

.kanban-fullscreen::-webkit-scrollbar-track {
  background: var(--bg-secondary);
  border-radius: 6px;
}

.kanban-fullscreen::-webkit-scrollbar-thumb {
  background: var(--accent-blue);
  border-radius: 6px;
}

.kanban-fullscreen::-webkit-scrollbar-thumb:hover {
  background: var(--accent-blue-hover);
}

/* Responsive para vista completa */
@media (max-width: 1024px) {
  .kanban-fullscreen .kanban-board {
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)) !important;
  }
  
  .kanban-fullscreen #tabla-view table {
    font-size: 0.75rem !important;
  }
  
  .kanban-fullscreen #tabla-view th,
  .kanban-fullscreen #tabla-view td {
    padding: 8px 4px !important;
  }
}

@media (max-width: 768px) {
  .kanban-fullscreen {
    padding: 10px !important;
  }
  
  .kanban-fullscreen-header {
    padding: 10px 15px;
    margin-bottom: 15px;
  }
  
  .kanban-fullscreen-title {
    font-size: 1.25rem;
  }
  
  .kanban-fullscreen .kanban-column {
    min-height: 400px;
  }
  
  .kanban-fullscreen .kanban-list {
    min-height: 350px;
    max-height: 60vh !important; /* Ajustar altura máxima en móvil */
  }
  
  .kanban-fullscreen .fullscreen-filters {
    padding: 12px !important;
  }
  
  .kanban-fullscreen .fullscreen-filters .grid {
    grid-template-columns: 1fr !important;
    gap: 8px !important;
  }
}
</style>

{% endblock %}
<!-- Modal para acciones rápidas -->

{% block content %}
<!-- Panel principal -->

<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/control_panel/kanban.css') }}" />

<!-- HEADER OPTIMIZADO CON INFORMACIÓN CONSOLIDADA -->
<div
  class="border border-[color:var(--border-primary)] rounded-lg mb-6 overflow-hidden">
  <!-- Header principal compacto -->
  <div
    class="flex items-center justify-between p-4 border-b border-[color:var(--border-primary)]">
    <!-- Branding y estado del sistema -->
    <div class="flex items-center gap-4">
      <div class="logo"></div>
      <div>
        <h1 class="text-xl font-semibold text-[color:var(--text-primary)]">
          PAGORA COMMAND CENTER
        </h1>
        <div class="flex items-center gap-3 mt-1">
          <div class="flex items-center gap-1">
            <div
              class="w-2 h-2 bg-[color:var(--accent-green)] rounded-full animate-pulse"></div>
            <span class="text-xs text-[color:var(--text-secondary)] mono-font"
              >SISTEMA ACTIVO</span
            >
          </div>
          <span
            class="text-xs text-[color:var(--text-secondary)] mono-font"
            id="last-updated-banner"
            >Actualizado ahora</span
          >
        </div>
      </div>
    </div>

    <!-- Panel de controles principales -->
    <div class="flex items-center gap-3">
      <!-- Botón de filtros -->
      <button
        id="toggle-filters-btn"
        class="flex items-center px-4 py-2.5 text-sm bg-[color:var(--accent-blue)] hover:bg-blue-600 text-white rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl hover:scale-105">
        <svg
          id="filter-icon"
          class="w-4 h-4 mr-2"
          fill="currentColor"
          viewBox="0 0 20 20">
          <path
            fill-rule="evenodd"
            d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z"
            clip-rule="evenodd"></path>
        </svg>
        <span id="filter-text">Filtros</span>
        <span id="filter-count" class="hidden ml-1 px-1.5 py-0.5 text-xs bg-white bg-opacity-20 rounded-full font-bold">0</span>
        <svg
          id="filter-chevron"
          class="w-4 h-4 ml-2 transition-transform"
          fill="currentColor"
          viewBox="0 0 20 20">
          <path
            fill-rule="evenodd"
            d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
            clip-rule="evenodd"></path>
        </svg>
      </button>

      <!-- Toggle Vista Lista/Kanban -->
      <div
        class="flex items-center bg-[color:var(--bg-card)] rounded-xl border border-[color:var(--border-color)] p-1 shadow-lg">
        <button
          id="toggle-lista"
          class="flex items-center px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200 view-toggle">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4 mr-2"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 6h16M4 10h16M4 14h16M4 18h16" />
          </svg>
          <span class="hidden sm:inline">Lista</span>
        </button>
        <button
          id="toggle-kanban"
          class="flex items-center px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200 view-toggle active">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4 mr-2"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
          </svg>
          <span class="hidden sm:inline">Kanban</span>
        </button>
      </div>

      <!-- Botón de actualización -->
      <button
        id="refresh-all-btn"
        class="flex items-center px-4 py-2.5 text-sm bg-[color:var(--bg-card)] text-[color:var(--text-primary)] rounded-xl border border-[color:var(--border-color)] hover:bg-[color:var(--bg-card-hover)] transition-all duration-200 shadow-lg hover:shadow-xl group">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4 mr-2 group-hover:rotate-180 transition-transform duration-500"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        <span class="hidden sm:inline">Actualizar</span>
      </button>

      <!-- Botón de detalle del encargado (solo si hay filtro específico) -->
      {% if filtros.jefe_proyecto and filtros.jefe_proyecto != '' and
      filtros.jefe_proyecto != 'todos' %}
      <a
        href="{{ url_for('dashboard.vista_encargado', nombre=filtros.jefe_proyecto) }}"
        class="flex items-center px-4 py-2.5 text-sm bg-gradient-to-r from-[color:var(--accent-purple)] to-[color:var(--accent-blue)] text-white rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl hover:scale-105">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4 mr-2"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
        <span class="hidden sm:inline">Ver {{ filtros.jefe_proyecto }}</span>
        <span class="sm:hidden">Ver detalle</span>
      </a>
      {% endif %}

      <!-- Botón de carga de EDPs -->
      <a
        href="{{ url_for('edp_upload.upload_page') }}"
        class="flex items-center px-4 py-2.5 text-sm bg-gradient-to-r from-[color:var(--accent-purple)] to-[color:var(--accent-pink)] hover:from-purple-600 hover:to-pink-600 text-white rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl hover:scale-105">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4 mr-2"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg>
        <span class="hidden sm:inline">Cargar EDPs</span>
      </a>

      <!-- Botón de exportación -->
      <button
        id="export-btn"
        class="flex items-center px-3 py-2 text-sm bg-[color:var(--accent-green)] hover:bg-green-600 text-white rounded-lg transition-all duration-200">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4 mr-1"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <span class="hidden sm:inline">Exportar</span>
      </button>

      <!-- Botón de vista completa -->
      <button
        id="fullscreen-toggle-btn"
        class="flex items-center px-4 py-2.5 text-sm bg-[color:var(--bg-card)] text-[color:var(--text-primary)] rounded-xl border border-[color:var(--border-color)] hover:bg-[color:var(--bg-card-hover)] transition-all duration-200 shadow-lg hover:shadow-xl group"
        title="Alternar vista completa del Kanban">
        <svg
          id="fullscreen-icon"
          xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4 mr-2 group-hover:scale-110 transition-transform duration-500"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
        </svg>
        <span class="hidden sm:inline" id="fullscreen-text">Vista Completa</span>
      </button>
    </div>
  </div>

  <!-- PANEL DE KPIS PRINCIPALES PROMINENTE -->
  <div
    class="grid grid-cols-2 md:grid-cols-4 gap-4 p-4 bg-[color:var(--bg-primary)]">
    <!-- KPI 1: Total EDPs con contexto -->
    <div
      class="bg-gradient-to-br from-[color:var(--accent-blue)]/10 to-[color:var(--accent-blue)]/5 border border-[color:var(--accent-blue)]/20 rounded-lg p-4">
      <div class="flex items-center justify-between mb-2">
        <h3
          class="text-sm font-semibold text-[color:var(--text-secondary)] uppercase tracking-wide">
          TOTAL EDPs
        </h3>
        <div
          class="w-2 h-2 bg-[color:var(--accent-blue)] rounded-full animate-pulse"></div>
      </div>
      <div class="flex items-baseline gap-2">
        <span
          class="text-3xl font-bold text-[color:var(--text-primary)] mono-font"
          id="total-edps-banner"
          >0</span
        >
        <span class="text-xs text-[color:var(--text-secondary)] mono-font"
          >del mes actual</span
        >
      </div>
    </div>

    <!-- KPI 2: Pendientes con alerta -->
    <div
      class="bg-gradient-to-br from-[color:var(--accent-warning)]/10 to-[color:var(--accent-warning)]/5 border border-[color:var(--accent-warning)]/20 rounded-lg p-4">
      <div class="flex items-center justify-between mb-2">
        <h3
          class="text-sm font-semibold text-[color:var(--text-secondary)] uppercase tracking-wide">
          PENDIENTES
        </h3>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4 text-[color:var(--accent-warning)]"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </div>
      <div class="flex items-baseline gap-2">
        <span
          class="text-3xl font-bold text-[color:var(--accent-warning)] mono-font"
          id="pendientes-banner"
          >0</span
        >
        <span class="text-xs text-[color:var(--text-secondary)] mono-font"
          >requieren atención</span
        >
      </div>
    </div>

    <!-- KPI 3: Pagados con éxito -->
    <div
      class="bg-gradient-to-br from-[color:var(--accent-green)]/10 to-[color:var(--accent-green)]/5 border border-[color:var(--accent-green)]/20 rounded-lg p-4">
      <div class="flex items-center justify-between mb-2">
        <h3
          class="text-sm font-semibold text-[color:var(--text-secondary)] uppercase tracking-wide">
          PAGADOS
        </h3>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4 text-[color:var(--accent-green)]"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M5 13l4 4L19 7" />
        </svg>
      </div>
      <div class="flex items-baseline gap-2">
        <span
          class="text-3xl font-bold text-[color:var(--accent-green)] mono-font"
          id="pagados-banner"
          >0</span
        >
                 <span class="text-xs text-[color:var(--text-secondary)] mono-font"
           >efectivamente pagados</span
         >
      </div>
    </div>

    <!-- KPI 4: Meta Mensual con progreso -->
    <div
      class="bg-gradient-to-br from-[color:var(--accent-purple)]/10 to-[color:var(--accent-purple)]/5 border border-[color:var(--accent-purple)]/20 rounded-lg p-4">
      <div class="flex items-center justify-between mb-2">
        <h3
          class="text-sm font-semibold text-[color:var(--text-secondary)] uppercase tracking-wide">
          META MENSUAL
        </h3>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4 text-[color:var(--accent-purple)]"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
        </svg>
      </div>
      <div class="flex items-baseline gap-2">
        <span
          class="text-2xl font-bold text-[color:var(--text-primary)] mono-font"
          id="meta-mensual"
          >$0</span
        >
        <span class="text-xs text-[color:var(--text-secondary)] mono-font"
          >objetivo</span
        >
      </div>
      <!-- Barra de progreso -->
      <div class="mt-2 w-full bg-[color:var(--bg-tertiary)] rounded-full h-1.5">
        <div
          class="bg-[color:var(--accent-purple)] h-1.5 rounded-full transition-all duration-500"
          style="width: 0%"
          id="meta-progress"></div>
      </div>
    </div>
    
  </div>
  <!-- PANEL DE ALERTAS Y MÉTRICAS RÁPIDAS -->
<div class="w-full px-4 mb-4">
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
    <!-- Alertas críticas -->
    <div
      class="bg-gradient-to-r from-[color:var(--accent-danger)]/10 to-[color:var(--accent-warning)]/10 border border-[color:var(--accent-danger)]/20 rounded-lg p-4">
      <div class="flex items-center gap-2 mb-2">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4 text-[color:var(--accent-danger)]"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <h3
          class="text-sm font-semibold text-[color:var(--text-primary)] uppercase">
          ALERTAS CRÍTICAS
        </h3>
      </div>
      <div class="flex items-center justify-between">
        <span
          class="text-lg font-bold text-[color:var(--accent-danger)] mono-font"
          id="alertas-criticas"
          >0</span
        >
        <span class="text-xs text-[color:var(--text-secondary)]"
          >EDPs > 15 días</span
        >
      </div>
    </div>

    <!-- Rendimiento del día -->
    <div
      class="bg-gradient-to-r from-[color:var(--accent-blue)]/10 to-[color:var(--accent-green)]/10 border border-[color:var(--accent-blue)]/20 rounded-lg p-4">
      <div class="flex items-center gap-2 mb-2">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4 text-[color:var(--accent-blue)]"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
        </svg>
        <h3
          class="text-sm font-semibold text-[color:var(--text-primary)] uppercase">
          RENDIMIENTO HOY
        </h3>
      </div>
      <div class="flex items-center justify-between">
        <span
          class="text-lg font-bold text-[color:var(--accent-green)] mono-font"
          id="rendimiento-hoy"
          >+12%</span
        >
        <span class="text-xs text-[color:var(--text-secondary)]">vs. ayer</span>
      </div>
    </div>

    <!-- Próximos vencimientos -->
    <div
      class="bg-gradient-to-r from-[color:var(--accent-warning)]/10 to-[color:var(--accent-amber)]/10 border border-[color:var(--accent-warning)]/20 rounded-lg p-4">
      <div class="flex items-center gap-2 mb-2">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4 text-[color:var(--accent-warning)]"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <h3
          class="text-sm font-semibold text-[color:var(--text-primary)] uppercase">
          PRÓXIMOS 7 DÍAS
        </h3>
      </div>
      <div class="flex items-center justify-between">
        <span
          class="text-lg font-bold text-[color:var(--accent-warning)] mono-font"
          id="proximos-vencimientos"
          >8</span
        >
        <span class="text-xs text-[color:var(--text-secondary)]"
          >vencimientos</span
        >
      </div>
    </div>
  </div>
</div>

<!-- PANEL DE FILTROS COLAPSABLE -->
<div id="filters-panel" class="hidden w-full px-4 mb-4 animate__animated">
  <div class="border border-[color:var(--border-primary)] rounded-lg p-6">
    <div class="flex items-center gap-2 mb-4">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[color:var(--accent-blue)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd"></path>
      </svg>
      <h3 class="text-lg font-semibold text-[color:var(--text-primary)] uppercase tracking-wide">FILTROS AVANZADOS</h3>
    </div>

    <div id="filters-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <div>
        <label for="mes" class="flex items-center gap-2 text-sm font-medium text-[color:var(--text-secondary)] mb-2">
          Mes
          <span class="text-xs text-[color:var(--accent-green)] opacity-75">●</span>
        </label>
        <select name="mes" id="mes" class="w-full p-3 bg-[color:var(--bg-primary)] border border-[color:var(--border-primary)] rounded-lg text-sm text-[color:var(--text-primary)] focus:ring-2 focus:ring-[color:var(--accent-blue)] focus:border-transparent transition-all duration-200">
          <option value="">Todos los meses</option>
          {% for m in meses %}
            <option value="{{ m }}" {% if filtros.mes == m %}selected{% endif %}>{{ m }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label for="jefe_proyecto" class="flex items-center gap-2 text-sm font-medium text-[color:var(--text-secondary)] mb-2">
          Encargado
          <span class="text-xs text-[color:var(--accent-green)] opacity-75">●</span>
        </label>
        <select name="jefe_proyecto" id="jefe_proyecto" class="w-full p-3 bg-[color:var(--bg-primary)] border border-[color:var(--border-primary)] rounded-lg text-sm text-[color:var(--text-primary)] focus:ring-2 focus:ring-[color:var(--accent-blue)] focus:border-transparent transition-all duration-200">
          <option value="">Todos los encargados</option>
          {% for j in jefe_proyectos %}
            <option value="{{ j }}" {% if filtros.jefe_proyecto == j %}selected{% endif %}>{{ j }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label for="cliente" class="flex items-center gap-2 text-sm font-medium text-[color:var(--text-secondary)] mb-2">
          Cliente
          <span class="text-xs text-[color:var(--accent-green)] opacity-75">●</span>
        </label>
        <select name="cliente" id="cliente" class="w-full p-3 bg-[color:var(--bg-primary)] border border-[color:var(--border-primary)] rounded-lg text-sm text-[color:var(--text-primary)] focus:ring-2 focus:ring-[color:var(--accent-blue)] focus:border-transparent transition-all duration-200">
          <option value="">Todos los clientes</option>
          {% for c in clientes %}
            <option value="{{ c }}" {% if filtros.cliente == c %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label for="estado" class="flex items-center gap-2 text-sm font-medium text-[color:var(--text-secondary)] mb-2">
          Estado
          <span class="text-xs text-[color:var(--accent-green)] opacity-75">●</span>
        </label>
        <select name="estado" id="estado" class="w-full p-3 bg-[color:var(--bg-primary)] border border-[color:var(--border-primary)] rounded-lg text-sm text-[color:var(--text-primary)] focus:ring-2 focus:ring-[color:var(--accent-blue)] focus:border-transparent transition-all duration-200">
          <option value="pendientes" {% if filtros.estado == 'pendientes' %}selected{% endif %}>Solo Pendientes</option>
          <option value="todos" {% if filtros.estado == 'todos' %}selected{% endif %}>Todos los Estados</option>
          {% for estado in ["revisión", "enviado", "validado", "pagado"] %}
            <option value="{{ estado }}" {% if filtros.estado == estado %}selected{% endif %}>{{ estado|title }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="md:col-span-2 lg:col-span-4 flex justify-between items-center pt-4 border-t border-[color:var(--border-primary)]">
        <!-- Indicador de filtrado automático -->
        <div class="flex items-center gap-2 text-xs text-[color:var(--text-secondary)]">
          <div class="w-2 h-2 bg-[color:var(--accent-green)] rounded-full animate-pulse"></div>
          <span>Filtrado automático activo</span>
        </div>
        
        <!-- Botón compacto para limpiar filtros -->
        <button id="clear-filters-btn" class="flex items-center gap-1 px-3 py-2 text-xs bg-[color:var(--bg-tertiary)] hover:bg-[color:var(--accent-blue)] hover:text-white text-[color:var(--text-secondary)] hover:text-white rounded-lg transition-all duration-200 border border-[color:var(--border-primary)]">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          <span>Limpiar</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- CONTENEDOR PRINCIPAL OPTIMIZADO -->
<div class="w-full relative">
  <!-- LAYOUT SIMPLE Y FUNCIONAL -->
  <div class="flex flex-col lg:flex-row gap-6 px-4">
    <!-- SIDEBAR: Métricas esenciales -->
    <div class="lg:w-64 flex-shrink-0">
      <!-- MÉTRICAS CONSOLIDADAS EN UNA SOLA TARJETA -->
      <div
        class="border border-[color:var(--border-primary)] rounded-lg p-6">
        <div class="flex items-center gap-2 mb-6">
          <div
            class="w-2 h-2 bg-[color:var(--accent-green)] rounded-full animate-pulse"></div>
          <h2
            class="text-lg font-semibold text-[color:var(--text-primary)] uppercase tracking-wide">
            MÉTRICAS
          </h2>
        </div>

        <div class="space-y-6">
          <!-- Monto Total -->
          <div class="space-y-2">
            <div class="flex items-center justify-between">
              <span
                class="text-sm text-[color:var(--text-secondary)] uppercase font-medium"
                >MONTO TOTAL</span
              >
              <span
                class="text-lg font-bold text-[color:var(--accent-green)] mono-font"
                id="monto-total"
                >$0</span
              >
            </div>
            <div
              class="w-full bg-[color:var(--bg-quaternary)] rounded-full h-2">
              <div
                class="bg-[color:var(--accent-green)] h-2 rounded-full transition-all duration-1000"
                style="width: 85%"
                id="monto-bar"></div>
            </div>
            <div class="text-xs text-[color:var(--text-secondary)]" id="meta-info-sidebar">
              Meta: $5000M • Progreso: 85%
            </div>
          </div>

          <!-- DSO Promedio -->
          <div class="space-y-2">
            <div class="flex items-center justify-between">
              <span
                class="text-sm text-[color:var(--text-secondary)] uppercase font-medium"
                >DSO PROMEDIO</span
              >
              <span
                class="text-lg font-bold text-[color:var(--accent-warning)] mono-font"
                id="dso-principal"
                >0 días</span
              >
            </div>
            <div
              class="w-full bg-[color:var(--bg-quaternary)] rounded-full h-2">
              <div
                class="bg-[color:var(--accent-warning)] h-2 rounded-full transition-all duration-1000"
                style="width: 45%"
                id="dso-bar"></div>
            </div>
            <div class="text-xs text-[color:var(--text-secondary)]">
              Objetivo: < 30 días
            </div>
          </div>

          <!-- EDPs Críticos -->
          <div class="space-y-2">
            <div class="flex items-center justify-between">
              <span
                class="text-sm text-[color:var(--text-secondary)] uppercase font-medium"
                >CRÍTICOS</span
              >
              <span
                class="text-lg font-bold text-[color:var(--accent-danger)] mono-font"
                id="total-criticos"
                >0</span
              >
            </div>
            <div
              class="w-full bg-[color:var(--bg-quaternary)] rounded-full h-2">
              <div
                class="bg-[color:var(--accent-danger)] h-2 rounded-full transition-all duration-1000"
                style="width: 25%"
                id="criticos-bar"></div>
            </div>
            <div class="text-xs text-[color:var(--text-secondary)]">
              Límite: < 5%
            </div>
          </div>

          <!-- PANEL DE ESCALACIÓN CRÍTICA PARA CONTROLLER -->
          <div class="pt-4 border-t border-[color:var(--border-primary)]">
            <div class="flex items-center gap-2 mb-3">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[color:var(--accent-danger)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" />
              </svg>
              <div class="text-sm text-[color:var(--accent-danger)] uppercase font-bold">
                ESCALACIÓN CRÍTICA
              </div>
              <div class="w-2 h-2 bg-[color:var(--accent-danger)] rounded-full animate-pulse"></div>
            </div>
            <div class="space-y-2">
                             <div class="bg-[color:var(--accent-danger)]/10 border border-[color:var(--accent-danger)]/20 rounded-lg p-2">
                 <div class="flex justify-between items-center">
                   <span class="text-xs font-medium text-[color:var(--accent-danger)]">EDPs > 30 días</span>
                   <span class="text-sm font-bold text-[color:var(--accent-danger)] mono-font" id="edps-criticos-escalacion">0</span>
                 </div>
               </div>
               <div class="bg-[color:var(--accent-warning)]/10 border border-[color:var(--accent-warning)]/20 rounded-lg p-2">
                 <div class="flex justify-between items-center">
                   <span class="text-xs font-medium text-[color:var(--accent-warning)]">EDPs 20-30 días</span>
                   <span class="text-sm font-bold text-[color:var(--accent-warning)] mono-font" id="edps-atencion-escalacion">0</span>
                 </div>
               </div>
              <div class="bg-[color:var(--accent-blue)]/10 border border-[color:var(--accent-blue)]/20 rounded-lg p-2">
                <div class="flex justify-between items-center">
                  <span class="text-xs font-medium text-[color:var(--accent-blue)]">JPs con más EDPs</span>
                  <span class="text-sm font-bold text-[color:var(--accent-blue)] mono-font" id="jp-mas-edps">-</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Actividad Hoy -->
          <div class="pt-4 border-t border-[color:var(--border-primary)]">
            <div class="flex items-center gap-2 mb-3">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4 text-[color:var(--accent-blue)]"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <div
                class="text-sm text-[color:var(--text-secondary)] uppercase font-medium">
                ACTIVIDAD HOY
              </div>
              <div
                class="w-2 h-2 bg-[color:var(--accent-green)] rounded-full animate-pulse"></div>
            </div>
            <div class="space-y-3">
              <div class="flex justify-between items-center">
                <div class="flex items-center gap-2">
                  <div class="w-2 h-2 bg-[color:var(--accent-blue)] rounded-full"></div>
                  <span class="text-sm text-[color:var(--text-secondary)]"
                    >Procesados</span
                  >
                </div>
                <span
                  class="font-bold text-[color:var(--text-primary)] mono-font text-lg"
                  id="edps-procesados-hoy"
                  >0</span
                >
              </div>
              <div class="flex justify-between items-center">
                <div class="flex items-center gap-2">
                  <div class="w-2 h-2 bg-[color:var(--accent-green)] rounded-full"></div>
                  <span class="text-sm text-[color:var(--text-secondary)]"
                    >Pagados</span
                  >
                </div>
                <span
                  class="font-bold text-[color:var(--accent-green)] mono-font text-lg"
                  id="validaciones-hoy"
                  >0</span
                >
              </div>
              <div class="flex justify-between items-center">
                <div class="flex items-center gap-2">
                  <div class="w-2 h-2 bg-[color:var(--accent-warning)] rounded-full animate-pulse"></div>
                  <span class="text-sm text-[color:var(--text-secondary)]"
                    >Alertas</span
                  >
                </div>
                <span
                  class="font-bold text-[color:var(--accent-warning)] mono-font text-lg"
                  id="alertas-activas"
                  >0</span
                >
              </div>
            </div>
                         <!-- Rendimiento del día -->
             <div class="mt-3 pt-2 border-t border-[color:var(--border-primary)]/50">
               <div class="flex items-center justify-between mb-2">
                 <span class="text-xs text-[color:var(--text-secondary)]">Rendimiento</span>
                 <span class="text-xs font-bold mono-font" id="rendimiento-actividad">Normal</span>
               </div>
               <div class="w-full bg-[color:var(--bg-primary)] rounded-full h-1.5">
                 <div
                   class="bg-gradient-to-r from-[color:var(--accent-green)] to-[color:var(--accent-blue)] h-1.5 rounded-full transition-all duration-500"
                   style="width: 0%"
                   id="barra-rendimiento"></div>
               </div>
             </div>
             
             <!-- Indicador de última actualización -->
             <div class="mt-2 pt-2 border-t border-[color:var(--border-primary)]/30">
               <div class="flex items-center justify-center gap-1 text-xs text-[color:var(--text-secondary)]">
                 <svg
                   xmlns="http://www.w3.org/2000/svg"
                   class="h-3 w-3"
                   fill="none"
                   viewBox="0 0 24 24"
                   stroke="currentColor">
                   <path
                     stroke-linecap="round"
                     stroke-linejoin="round"
                     stroke-width="2"
                     d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                 </svg>
                 <span id="ultima-actualizacion">Actualizando...</span>
               </div>
             </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ÁREA PRINCIPAL: Tablero Kanban Full-Width -->
    <div class="flex-1 min-w-0">
      <!-- CONTROLES COMPACTOS EN UNA SOLA LÍNEA -->
      <div
        class="bg-gradient-to-r from-[color:var(--bg-secondary)] to-[color:var(--bg-tertiary)] border border-[color:var(--border-primary)] rounded-lg p-3 mb-3">
        <!-- Búsqueda y controles en una línea -->
        <div class="flex items-center gap-3 mb-3">
          <div class="relative flex-grow">
            <div
              class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-[color:var(--accent-blue)]">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </div>
            <input
              type="search"
              id="buscar-edp"
              class="w-full pl-9 pr-12 py-2 bg-[color:var(--bg-primary)] border border-[color:var(--border-primary)] rounded-lg text-sm text-[color:var(--text-primary)] placeholder-[color:var(--text-secondary)] focus:outline-none focus:ring-2 focus:ring-[color:var(--accent-blue)] focus:border-transparent transition-all duration-200"
              placeholder="Buscar EDPs..."
              autocomplete="off" />
            <div
              class="absolute inset-y-0 right-0 flex items-center pr-2 text-[color:var(--text-secondary)]">
              <kbd
                class="px-1 py-0.5 text-xs font-semibold text-[color:var(--text-secondary)] bg-[color:var(--bg-highlight)] rounded border border-[color:var(--border-primary)]"
                >/</kbd
              >
            </div>
          </div>
          <button
            id="limpiar-busqueda"
            class="px-3 py-2 bg-[color:var(--accent-blue)] text-white rounded-lg hover:bg-[color:var(--accent-blue)]/80 transition-colors duration-200 text-sm font-medium">
            Limpiar
          </button>
        </div>

        <!-- Controles de columnas compactos -->
        <div class="flex items-center gap-2 text-xs">
          <span class="text-[color:var(--text-secondary)] font-medium"
            >Columnas:</span
          >
          {% for estado in columnas.keys() %}
          <label
            class="flex items-center gap-1 px-2 py-1 bg-[color:var(--bg-primary)] border border-[color:var(--border-primary)] rounded cursor-pointer hover:bg-[color:var(--bg-tertiary)] transition-colors duration-200">
            <input
              type="checkbox"
              class="w-3 h-3 text-[color:var(--accent-blue)] bg-[color:var(--bg-primary)] border-[color:var(--border-primary)] rounded focus:ring-[color:var(--accent-blue)] focus:ring-1 toggle-column"
              data-estado="{{ estado }}"
              checked />
            <span class="text-xs font-medium text-[color:var(--text-primary)]"
              >{{ estado.upper() }}</span
            >
          </label>
          {% endfor %}
        </div>

        <!-- Resultados de búsqueda -->
        <div
          id="resultados-busqueda"
          class="hidden mt-2 p-2 bg-[color:var(--bg-primary)] border border-[color:var(--border-primary)] rounded-lg">
          <div
            class="flex items-center gap-2 text-xs text-[color:var(--text-secondary)]">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-3 w-3"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span id="resultados-texto">Resultados encontrados</span>
          </div>
        </div>
      </div>
      <!-- Filtro de validados antiguos -->
      {% if estadisticas.total_validados_antiguos > 0 %}
      <div class="flex items-center justify-between mb-4">
        <div
          class="text-xs text-[color:var(--text-secondary)] bg-[color:var(--bg-highlight)] px-2 py-1 rounded-full">
          {% if not filtros.mostrar_validados_antiguos %}
          <span class="font-medium"
            >{{ estadisticas.total_validados_antiguos }}</span
          >
          validados antiguos ocultos {% else %} Mostrando todos los validados {%
          endif %}
        </div>

        <button
          id="toggle-validados-antiguos"
          class="text-xs flex items-center text-[color:var(--text-secondary)] hover:text-[color:var(--accent-blue)]">
          {% if filtros.mostrar_validados_antiguos %} Ocultar antiguos {% else
          %} Mostrar todos {% endif %}
        </button>
      </div>
      {% endif %}
      <!-- TABLERO KANBAN OPTIMIZADO FULL-WIDTH -->
      <div
        id="kanban-board"
        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">
        {% for estado, edps in columnas.items() %}
        <div
          class="kanban-column column-toggle-transition bg-gradient-to-b from-[color:var(--bg-secondary)] to-[color:var(--bg-tertiary)] border border-[color:var(--border-primary)] rounded-lg overflow-hidden"
          data-estado="{{ estado }}"
          data-empty="{{ edps|length == 0 }}"
          id="columna-{{ estado }}">
          <!-- CABECERA MEJORADA CON TOTALES PROMINENTES -->
          <div
            class="bg-gradient-to-r from-[color:var(--bg-tertiary)] to-[color:var(--bg-secondary)] border-b border-[color:var(--border-primary)] p-4">
            <div class="flex items-center justify-between mb-3">
              <h2
                class="text-lg font-bold text-[color:var(--text-primary)] uppercase tracking-wide">
                {{ estado }}
              </h2>
              <div class="flex items-center gap-2">
                <div
                  class="w-2 h-2 bg-[color:var(--accent-blue)] rounded-full animate-pulse"></div>
                <span
                  class="text-sm font-bold text-[color:var(--accent-blue)] mono-font px-2 py-1 bg-[color:var(--accent-blue)]/10 rounded border border-[color:var(--accent-blue)]/20"
                  >{{ edps|length }} EDPs</span
                >
              </div>
            </div>

            <!-- TOTAL PROMINENTE -->
            <div class="bg-[color:var(--bg-primary)] rounded-lg p-3 border border-[color:var(--border-primary)]">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[color:var(--accent-green)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1" />
                  </svg>
                  <span class="text-sm font-medium text-[color:var(--text-secondary)]">TOTAL:</span>
                </div>
                <span
                  class="text-lg font-bold text-[color:var(--accent-green)] mono-font bg-[color:var(--accent-green)]/10 px-3 py-1"
                  data-columna-total="{{ estado }}"
                  >$0</span
                >
              </div>
              <!-- Promedio por EDP -->
              <div class="flex items-center justify-between mt-2 pt-2 border-t border-[color:var(--border-primary)]">
                <span class="text-xs text-[color:var(--text-secondary)]">Promedio por EDP:</span>
                <span
                  class="text-sm font-bold text-[color:var(--text-primary)] mono-font"
                  data-columna-promedio="{{ estado }}"
                  >$0</span
                >
              </div>
            </div>
          </div>
          <!-- LISTA DE TARJETAS OPTIMIZADA -->
          <div
            class="kanban-list p-2 space-y-2 min-h-[400px] max-h-[calc(100vh-250px)] overflow-y-auto"
            id="list-{{ estado }}">
            {% for edp in edps %}
            <div
              class="kanban-item bg-[color:var(--bg-primary)] border border-[color:var(--border-primary)] rounded-lg p-3 cursor-grab active:cursor-grabbing hover:shadow-md transition-all duration-200"
              draggable="true"
              data-id="{{ edp['n_edp'] }}"
              data-internal-id="{{ edp['id'] }}"
              data-n-edp="{{ edp['n_edp'] }}"
              data-monto="{{ edp['monto_aprobado'] }}"
              data-responsable="{{ edp['jefe_proyecto'] }}"
              data-cliente="{{ edp['cliente'] }}"
              data-estado="{{ estado }}"
              data-dias="{{ edp['dso_actual'] }}"
              data-proyecto="{{ edp['proyecto'] }}"
              data-mes="{{ edp.get('fecha_creacion', '')[:7] if edp.get('fecha_creacion') else '' }}">
              <!-- CABECERA OPTIMIZADA: ID Y MONTO JUNTOS -->
              <div class="mb-3">
                <!-- ID y Estado General -->
                <div class="flex items-center gap-2 mb-2">
                  <div class="w-2 h-2 bg-[color:var(--accent-blue)] rounded-full"></div>
                  <span class="font-bold text-sm text-[color:var(--text-primary)] mono-font">
                    EDP-{{ edp["n_edp"] }}
                  </span>
                </div>
                
                <!-- MONTO PROMINENTE -->
                <div class="mb-3">
                  <span class="text-lg font-bold text-[color:var(--accent-green)] mono-font bg-[color:var(--accent-green)]/10 px-3 py-2 rounded-lg shadow-sm block text-center">
                    ${{ "{:,.0f}".format(edp["monto_aprobado"]|float).replace(",", ".") }}
                  </span>
                </div>
              </div>

              <!-- INFORMACIÓN CONTEXTUAL: QUIÉN Y CUÁNDO -->
              <div class="border-t border-[color:var(--border-primary)] pt-3 mb-3">
                <!-- Responsable y Duración/Estado Principal -->
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[color:var(--accent-amber)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span class="text-sm font-bold text-[color:var(--text-primary)]">
                      {{ edp["jefe_proyecto"] }}
                    </span>
                  </div>
                  <div class="flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 {% if edp['dso_actual']|int > 30 %}text-[color:var(--accent-danger)]{% elif edp['dso_actual']|int > 20 %}text-[color:var(--accent-warning)]{% else %}text-[color:var(--accent-blue)]{% endif %}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span class="text-xs font-bold mono-font {% if edp['dso_actual']|int > 30 %}text-[color:var(--accent-danger)] bg-[color:var(--accent-danger)]/10{% elif edp['dso_actual']|int > 20 %}text-[color:var(--accent-warning)] bg-[color:var(--accent-warning)]/10{% else %}text-[color:var(--accent-blue)] bg-[color:var(--accent-blue)]/10{% endif %} px-2 py-0.5 rounded">
                      {{ edp["dso_actual"] }}d
                    </span>
                  </div>
                </div>
                
                <!-- OT y Cliente -->
                <div class="space-y-2">
                  <div class="text-sm font-bold text-[color:var(--text-primary)] mono-font">
                    {{ edp["proyecto"] }}
                  </div>
                  <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-[color:var(--accent-purple)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                    </svg>
                    <span class="text-sm text-[color:var(--text-primary)]">
                      {{ edp["cliente"] }}
                    </span>
                  </div>
                </div>
              </div>

              <!-- ESTADO ACTUAL Y ACCIONES -->
              <div class="border-t border-[color:var(--border-primary)] pt-3">
                <!-- Estado Principal con Color Destacado -->
                <div class="flex items-center justify-between">
                  {% if edp.get('conformidad_enviada') == True %}
                  <div class="flex items-center gap-2">
                    <div class="w-3 h-3 bg-[color:var(--accent-green)] rounded-full"></div>
                    <span class="text-sm font-medium text-[color:var(--accent-green)]">
                      Conformidad recibida
                    </span>
                  </div>
                  {% elif edp.get('fecha_envio_cliente') %}
                  <div class="flex items-center gap-2">
                    <div class="w-3 h-3 bg-[color:var(--accent-warning)] rounded-full animate-pulse"></div>
                    <span class="text-sm font-medium text-[color:var(--accent-warning)]">
                      Esperando conformidad
                    </span>
                  </div>
                  {% else %}
                  <div class="flex items-center gap-2">
                    <div class="w-3 h-3 bg-[color:var(--text-secondary)] rounded-full"></div>
                    <span class="text-sm font-medium text-[color:var(--text-secondary)]">
                      No enviado a cliente
                    </span>
                  </div>
                  {% endif %}

                  <!-- Botón de Edición Compacto -->
                  <button
                    class="flex items-center justify-center w-6 h-6 bg-[color:var(--accent-blue)]/10 text-[color:var(--accent-blue)] rounded-md hover:bg-[color:var(--accent-blue)]/20 transition-colors duration-200 border border-[color:var(--accent-blue)]/20 group"
                    onclick="openEdpModal('{{ edp['id'] }}', this.closest('.kanban-item'))"
                    title="Editar EDP">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-3 w-3 group-hover:scale-110 transition-transform duration-200"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                  </button>
                </div>
                
                <!-- Información adicional si existe -->
                {% if edp.get('n_conformidad') or edp.get('fecha_estimada_pago') %}
                <div class="flex items-center gap-2 mt-2 pt-2 border-t border-[color:var(--border-primary)]/50">
                  {% if edp.get('n_conformidad') %}
                  <span class="text-xs bg-[color:var(--bg-tertiary)] px-2 py-1 rounded mono-font">
                    N° {{ edp['n_conformidad'] }}
                  </span>
                  {% endif %}
                  {% if edp.get('fecha_estimada_pago') %}
                  <span class="text-xs text-[color:var(--text-secondary)]">
                    Est. pago: {{ edp['fecha_estimada_pago'][-5:] }}
                  </span>
                  {% endif %}
                </div>
                {% endif %}
              </div>
            </div>
            {% endfor %} {% if not edps %}
            <div
              class="empty-placeholder text-center py-6 text-sm text-[color:var(--text-secondary)] italic">
              Sin elementos
            </div>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- TABLA DE EDPs - EN EL MISMO LUGAR QUE KANBAN -->
      <div id="tabla-view" class="hidden">
        {% include 'controller/table-controller.html' %}
      </div>
    </div>
  </div>
</div>
</div>


<!-- FIN DEL CONTENEDOR PRINCIPAL KANBAN -->

<!-- Toast de notificación mejorado -->
<div
  id="toast-notification"
  class="fixed bottom-4 right-4 hidden animate__animated z-50">
  <div
    class="max-w-xs bg-[color:var(--bg-card)] text-sm text-[color:var(--text-primary)] rounded-lg shadow-lg border border-[color:var(--border-color)]"
    role="alert">
    <div class="flex p-4">
      <div
        class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg"
        id="toast-icon">
        <!-- Icono insertado por JS -->
      </div>
      <div class="ms-3 text-sm font-normal" id="toast-text">
        <!-- Mensaje insertado por JS -->
      </div>
      <button
        type="button"
        class="ms-auto -mx-1.5 -my-1.5 bg-[color:var(--bg-card)] text-[color:var(--text-secondary)] hover:text-[color:var(--text-primary)] rounded-lg p-1.5 hover:bg-[color:var(--bg-card-hover)] inline-flex items-center justify-center h-8 w-8 transition-colors"
        onclick="hideToast()">
        <span class="sr-only">Cerrar</span>
        <svg
          class="w-3 h-3"
          aria-hidden="true"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 14 14">
          <path
            stroke="currentColor"
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
        </svg>
      </button>
    </div>
  </div>
</div>



<!-- Template del modal para edición de EDP -->
<div
  id="edpModalOverlay"
  class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
  <div
    id="edpModalContent"
    class="bg-[color:var(--bg-card)] rounded-xl shadow-xl border border-[color:var(--border-color)] w-full max-w-3xl max-h-[90vh] overflow-y-auto">
    <!-- El contenido se llenará dinámicamente -->
  </div>
</div>

<!-- Indicador de atajos de teclado -->
<div class="w-full px-4 py-6">
  <div id="keyboard-hint" class="keyboard-hint">
    <div class="flex items-center gap-2">
      <span>📌 Atajos:</span>
      <kbd
        class="px-1 py-0.5 bg-[color:var(--bg-highlight)] rounded text-[10px]"
        >Alt+K</kbd
      >
      <span class="text-[10px]">Kanban</span>
      <kbd
        class="px-1 py-0.5 bg-[color:var(--bg-highlight)] rounded text-[10px]"
        >Alt+L</kbd
      >
      <span class="text-[10px]">Lista</span>
      <span class="mx-2 text-[color:var(--text-secondary)]">•</span>
      <kbd
        class="px-1 py-0.5 bg-[color:var(--bg-highlight)] rounded text-[10px]"
        >F11</kbd
      >
      <span class="text-[10px]">Vista Completa</span>
      <kbd
        class="px-1 py-0.5 bg-[color:var(--bg-highlight)] rounded text-[10px]"
        >ESC</kbd
      >
      <span class="text-[10px]">Salir</span>
    </div>
  </div>
</div>

 {% endblock %}
