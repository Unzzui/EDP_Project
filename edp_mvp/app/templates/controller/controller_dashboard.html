{% extends "base.html" %}
{% block title %}Dashboard Controller{% endblock %}

<!-- Add these styles to your head block -->

{% block head %}
{{ super() }}
<style>
  /* Estilos para cabeceras ordenables */
  .sortable {
    cursor: pointer;
    position: relative;
    user-select: none;
  }
  .sortable:hover {
    background-color: var(--bg-highlight);
  }
  .sortable::after {
    content: '‚Üï';
    font-size: 0.75rem;
    margin-left: 0.25rem;
    opacity: 0.5;
  }
  .sortable.sort-asc::after {
    content: '‚Üë';
    opacity: 1;
  }
  .sortable.sort-desc::after {
    content: '‚Üì';
    opacity: 1;
  }
  
  /* Estilos para tarjetas de m√©tricas */
  .metric-card {
    border-radius: 0.75rem;
    border: 1px solid var(--border-color-subtle);
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    transition: all 0.2s;
  }
  
  .metric-card:hover {
    border-color: var(--border-color);
    transform: translateY(-2px);
  }
  
  .metric-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
  }
  
  .metric-value {
    font-weight: bold;
    font-size: 1.5rem;
  }
  
  /* Estilos para tabla mejorada */
  .data-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
  }
  
  .data-table th {
    background-color: var(--background);
    font-weight: 600;
    text-align: left;
    padding: 0.75rem 1rem;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  
  .data-table td {
    padding: 0.75rem 1rem;
    border-top: 1px solid var(--border-color-subtle);
  }
  
  .data-table tr:hover td {
    background-color: var(--bg-highlight);
  }
  
  .data-table-row-critical td {
    background-color: var(--state-error-bg);
  }
  
  .data-table-row-validated td {
    background-color: var(--state-success-bg);
  }
  
  /* Efecto de transici√≥n para filas */
  .data-table tbody tr {
    transition: background-color 0.15s, opacity 0.15s, transform 0.15s, box-shadow 0.15s;
  }
   
  .data-table tbody tr:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  
  /* Visual indication that EDP number is clickable */
  .data-table td.edp-number {
    color: var(--accent-blue);
    font-weight: 500;
    text-decoration: none;
  }
  
  .data-table tr:hover td.edp-number {
    text-decoration: underline;
  }
  /* Estilos para estados */
  .estado-pill {
    display: inline-flex;
    padding: 0.25rem 0.5rem;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: capitalize;
  }
  
  .estado-pendiente {
    background-color: var(--state-warning-bg);
    color: var(--accent-amber);
  }
  
  .estado-revisi√≥n {
    background-color: var(--state-info-bg);
    color: var(--accent-blue);
  }
  
  .estado-enviado {
    background-color: var(--state-progress-bg);
    color: var(--accent-purple);
  }
  
  .estado-pagado {
    background-color: var(--state-success-bg);
    color: var(--accent-green);
  }
  
  .estado-validado {
    background-color: var(--state-success-bg);
    color: var(--accent-green);
  }
  
  /* Estilos para tabla responsive */
  .table-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  /* Animaciones para elementos */
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }
  
  .animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
  
  /* Animaciones sutiles para la secci√≥n de atenci√≥n inmediata */
  @keyframes gentlePulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }
  
  @keyframes fadeInSoft {
    0% { opacity: 0; }
    100% { opacity: 1; }
  }
  
  .urgent-indicator {
    animation: gentlePulse 3s ease-in-out infinite;
  }
  
  .critical-edp-card {
    animation: fadeInSoft 0.3s ease-out;
  }
  
  #critical-alert-section {
    animation: fadeInSoft 0.5s ease-out;
  }
</style>
{% endblock %}

{% block content %}
<!-- Panel principal con encabezado mejorado -->
 
<div class="bg-[color:var(--background)] border border-[color:var(--border-color)] rounded-2xl p-6 shadow-lg mb-6 animate__animated animate__fadeIn">
  <!-- Encabezado con acciones principales -->
  <div class="flex flex-col md:flex-row md:items-end md:justify-between mb-6 pb-5 border-b border-[color:var(--border-color-subtle)]">
    <div class="mb-4 md:mb-0">
      <div class="flex items-center">
        <div class="mr-3 p-2 bg-[color:var(--bg-card)] rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-[color:var(--accent-blue)]" viewBox="0 0 20 20" fill="currentColor">
            <path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z" />
            <path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z" />
          </svg>
        </div>
        <div>
          <h1 class="text-2xl font-bold tracking-tight">Dashboard Controller</h1>
          <p class="text-[color:var(--text-secondary)] max-w-2xl">
            Gesti√≥n y seguimiento de EDPs, con m√©tricas y estado actualizado de proyectos.
          </p>
        </div>
      </div>
    </div>
    <div class="flex space-x-3">
      <button id="restore-alert-btn" class="hidden flex items-center px-2 py-1.5 text-xs md:text-sm bg-[color:var(--accent-amber)] hover:bg-amber-600 text-white rounded-md transition-colors shadow-sm mr-2" title="Mostrar alertas de EDPs cr√≠ticos">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 md:w-4 md:h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" />
        </svg>
        <span class="hidden sm:inline">Mostrar alertas</span>
        <span class="sm:hidden">Alertas</span>
      </button>
      <button id="toggle-filters-btn" class="flex items-center px-2.5 py-1.5 text-sm bg-[color:var(--accent-blue)] hover:bg-blue-600 text-white rounded-md transition-colors shadow-sm">
        <svg id="filter-icon" class="w-4 h-4 mr-1.5" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd"></path>
        </svg>
        <span id="filter-text">Mostrar filtros</span>
        <svg id="filter-chevron" class="w-3.5 h-3.5 ml-1 transition-transform" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
        </svg>
      </button>
      <a href="{{ url_for('controller.vista_kanban') }}"
         class="flex items-center bg-[color:var(--bg-card)] text-[color:var(--text-primary)] px-4 py-2 rounded-xl text-sm border border-[color:var(--border-color)] hover:bg-[color:var(--bg-card-hover)] transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-[color:var(--accent-blue)]" viewBox="0 0 20 20" fill="currentColor">
          <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
        </svg>
        Vista Kanban
      </a>
      <button type="button" class="btn-primary">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
        </svg>
        Nuevo EDP
      </button>
    </div>
  </div>

  <!-- SECCI√ìN DE ATENCI√ìN INMEDIATA - OPTIMIZADA PARA MOBILE -->
  <div id="critical-alert-section" class="bg-[color:var(--bg-card)] border-l-4 border-[color:var(--accent-red)] rounded-lg p-3 md:p-4 mb-6 shadow-sm">
    <!-- Layout responsivo para mobile -->
    <div class="flex flex-col space-y-3 md:flex-row md:items-center md:justify-between md:space-y-0">
      <div class="flex flex-col space-y-2 md:flex-row md:items-center md:space-y-0">
        <div class="flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 md:h-5 md:w-5 text-[color:var(--accent-red)] urgent-indicator mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" />
          </svg>
          <span class="text-[color:var(--accent-red)] font-semibold text-sm">Alerta:</span>
          <span class="text-[color:var(--text-primary)] ml-2 text-sm" id="alert-summary">-</span>
        </div>
        
        <!-- Mini badges de estado - Stack en mobile -->
        <div class="flex items-center space-x-1 md:space-x-2 md:ml-4" id="quick-stats">
          <!-- Se llenar√°n din√°micamente -->
        </div>
      </div>
      
      <div class="flex items-center justify-end space-x-2">
        <button id="expand-critical-alert" class="text-[color:var(--accent-blue)] hover:text-[color:var(--accent-blue-dark)] text-xs md:text-sm font-medium transition-colors">
          Ver detalles
        </button>
        <button id="hide-critical-alert" class="text-[color:var(--text-secondary)] hover:text-[color:var(--text-primary)] p-1 transition-colors" title="Ocultar alerta">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>
    
    <!-- Detalle expandible -->
    <div id="critical-details" class="hidden mt-4 pt-4 border-t border-[color:var(--border-color-subtle)]">
      <!-- Grid simplificado de EDPs cr√≠ticos - Solo 1 columna en mobile -->
      <div class="grid grid-cols-1 gap-2 mb-4" id="critical-edps-container">
        <!-- Se llenar√° din√°micamente con JavaScript -->
      </div>
      
      <div class="text-center">
        <button id="show-all-pending" class="text-[color:var(--accent-blue)] hover:text-[color:var(--accent-blue-dark)] text-sm font-medium transition-colors">
          Ver todos en la tabla ‚Üí
        </button>
      </div>
    </div>
  </div>

  <!-- Secci√≥n de filtros - OCULTA POR DEFECTO -->
  <div id="filters-section" class="hidden">
    <!-- Animaci√≥n suave al mostrar -->
    <div class="section-title-modern mb-5">
      <h2 class="text-xl font-semibold">üîç Filtros de B√∫squeda</h2>
      <div class="section-line"></div>
    </div>

    <form method="GET" class="bg-[color:var(--bg-card)] border border-[color:var(--border-color-subtle)] rounded-xl p-5 mb-6 shadow-sm">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="form-group">
          <label for="mes" class="text-xs font-medium text-[color:var(--text-secondary)] mb-1.5">Mes</label>
          <div class="relative">
            <select name="mes" id="mes" class="form-select w-full pl-9">
              <option value="">Todos</option>
              {% for m in meses %}
                <option value="{{ m }}" {% if filtros.mes == m %}selected{% endif %}>{{ m }}</option>
              {% endfor %}
            </select>
            <div class="absolute left-0 top-0 bottom-0 flex items-center justify-center w-9 text-[color:var(--accent-blue)]">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
              </svg>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="jefe_proyecto" class="text-xs font-medium text-[color:var(--text-secondary)] mb-1.5">Encargado de Proyecto</label>
          <div class="relative">
            <select name="jefe_proyecto" id="jefe_proyecto" class="form-select w-full pl-9">
              <option value="">Todos</option>
              {% for j in jefes_proyectos %}
                <option value="{{ j }}" {% if filtros.jefe_proyecto == j %}selected{% endif %}>{{ j }}</option>
              {% endfor %}
            </select>
            <div class="absolute left-0 top-0 bottom-0 flex items-center justify-center w-9 text-[color:var(--accent-blue)]">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
              </svg>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="cliente" class="text-xs font-medium text-[color:var(--text-secondary)] mb-1.5">Cliente</label>
          <div class="relative">
            <select name="cliente" id="cliente" class="form-select w-full pl-9">
              <option value="">Todos</option>
              {% for c in clientes %}
                <option value="{{ c }}" {% if filtros.cliente == c %}selected{% endif %}>{{ c }}</option>
              {% endfor %}
            </select>
            <div class="absolute left-0 top-0 bottom-0 flex items-center justify-center w-9 text-[color:var(--accent-blue)]">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 01-1.581.814l-4.419-3.996-4.419 3.996A1 1 0 014 16V4z" clip-rule="evenodd" />
              </svg>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="estado" class="text-xs font-medium text-[color:var(--text-secondary)] mb-1.5">Estado</label>
          <div class="relative">
       <select name="estado" id="estado" class="form-select w-full pl-9">
    <option value="pendientes" {% if filtros.estado == 'pendientes' %}selected{% endif %}>Pendientes</option>
    <option value="todos" {% if filtros.estado == 'todos' %}selected{% endif %}>Todos</option>
    {% for estado in ["revisi√≥n", "enviado", "pagado", "validado"] %}
      <option value="{{ estado }}" {% if filtros.estado == estado %}selected{% endif %}>{{ estado }}</option>
    {% endfor %}
  </select>
            <div class="absolute left-0 top-0 bottom-0 flex items-center justify-center w-9 text-[color:var(--accent-blue)]">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
              </svg>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-4 flex items-center justify-end">
        <a href="{{ url_for('controller.dashboard_controller') }}" class="text-sm text-[color:var(--accent-blue)] hover:text-[color:var(--accent-blue-light)] mr-4 transition-colors">
          Limpiar filtros
        </a>
        <button type="submit" class="btn-primary">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
          </svg>
          Aplicar filtros
        </button>
      </div>
    </form>
  </div>

  <!-- Bot√≥n de acceso r√°pido a gesti√≥n por encargado -->
  {% if filtros.jefe_proyecto and filtros.jefe_proyecto != 'todos' and filtros.jefe_proyecto != '' %}
    <div class="mb-6">
      <a href="{{ url_for('controller.vista_encargado', nombre=filtros.jefe_proyecto) }}"
         class="inline-flex items-center px-4 py-2 bg-[color:var(--accent-blue-dark)] bg-opacity-15 text-[color:var(--text-primary)] hover:bg-opacity-25 transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
          <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
          <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
        </svg>
        Ver gesti√≥n detallada de {{ filtros.jefe_proyecto }}
      </a>
    </div>
  {% endif %}


 <div class="section-title-modern mb-5">
  <h2 class="text-xl font-semibold">üìä KPIs Globales</h2>
  <div class="section-line"></div>
</div>

<!-- CONTENEDOR PRINCIPAL CON FONDO -->
<div class="bg-gradient-to-br from-[color:var(--bg-card)] to-[color:var(--bg-highlight)] rounded-2xl shadow-lg border border-[color:var(--border-color)] overflow-hidden mb-8">
  <!-- Grid de m√©tricas principales -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-0">
    <!-- KPI 1: Total EDP -->
    <div class="p-5 border-r border-[color:var(--border-color-subtle)] last:border-r-0">
      <div class="flex items-center justify-between mb-3">
        <p class="metric-label font-medium text-[color:var(--text-secondary)]">Total EDP</p>
        <span class="text-xs bg-[color:var(--bg-highlight)] px-2 py-1 rounded-full text-[color:var(--text-secondary)]">Global</span>
      </div>
      <p class="metric-value text-3xl font-bold text-[color:var(--accent-blue)] mb-3">{{ total_edp_global }}</p>
      <div class="h-2 w-full bg-[color:var(--bg-input)] rounded-full">
        <div class="h-full bg-[color:var(--accent-blue)] rounded-full" style="width: 100%"></div>
      </div>
    </div>
    
    <!-- KPI 2: Validados -->
    <div class="p-5 border-r border-[color:var(--border-color-subtle)] last:border-r-0">
      <div class="flex items-center justify-between mb-3">
        <p class="metric-label font-medium text-[color:var(--text-secondary)]">Validados</p>
        <span class="text-xs bg-[color:var(--bg-highlight)] px-2 py-1 rounded-full text-[color:var(--text-secondary)]">{{ (total_validados_global / total_edp_global * 100)|round|int if total_edp_global > 0 else 0 }}%</span>
      </div>
      <p class="metric-value text-3xl font-bold text-[color:var(--accent-green)] mb-3">{{ total_validados_global }}</p>
      <div class="h-2 w-full bg-[color:var(--bg-input)] rounded-full">
        <div class="h-full bg-[color:var(--accent-green)] rounded-full" style="width: {{ (total_validados_global / total_edp_global * 100) if total_edp_global > 0 else 0 }}%"></div>
      </div>
    </div>
    
    <!-- KPI 3: Validados ‚â§30 d√≠as -->
    <div class="p-5 border-r border-[color:var(--border-color-subtle)] last:border-r-0">
      <div class="flex items-center justify-between mb-3">
        <p class="metric-label font-medium text-[color:var(--text-secondary)]">Validados ‚â§30 d√≠as</p>
        <span class="text-xs bg-[color:var(--bg-highlight)] px-2 py-1 rounded-full text-[color:var(--text-secondary)]">Meta: 80%</span>
      </div>
      <p class="metric-value text-3xl font-bold text-[color:var(--accent-green)] mb-3">{{ porcentaje_validacion_rapida_global }}%</p>
      <div class="h-2 w-full bg-[color:var(--bg-input)] rounded-full">
        <div class="h-full bg-[color:var(--accent-green)] rounded-full" style="width: {{ porcentaje_validacion_rapida_global }}%"></div>
      </div>
    </div>
    
    <!-- KPI 4: Promedio d√≠as espera -->
    <div class="p-5">
      <div class="flex items-center justify-between mb-3">
        <p class="metric-label font-medium text-[color:var(--text-secondary)]">Prom. d√≠as espera</p>
        <span class="text-xs bg-[color:var(--bg-highlight)] px-2 py-1 rounded-full text-[color:var(--text-secondary)]">Meta: ‚â§20</span>
      </div>
      <p class="metric-value text-3xl font-bold mb-3 {% if dias_espera_promedio_global > 30 %}text-[color:var(--accent-red)]{% elif dias_espera_promedio_global <= 20 %}text-[color:var(--accent-green)]{% else %}text-[color:var(--accent-amber)]{% endif %}">
        {{ dias_espera_promedio_global }}
      </p>
      <div class="h-2 w-full bg-[color:var(--bg-input)] rounded-full">
        <div class="h-full {% if dias_espera_promedio_global > 30 %}bg-[color:var(--accent-red)]{% elif dias_espera_promedio_global <= 20 %}bg-[color:var(--accent-green)]{% else %}bg-[color:var(--accent-amber)]{% endif %} rounded-full" 
             style="width: {{ (dias_espera_promedio_global / 45 * 100) if dias_espera_promedio_global < 45 else 100 }}%"></div>
      </div>
    </div>
  </div>
<!-- Secci√≥n inferior con m√©tricas adicionales -->
  <div class="border-t border-[color:var(--border-color-subtle)] bg-[color:var(--bg-subtle)] px-5 py-4 grid grid-cols-2 sm:grid-cols-4 gap-8">
    <div class="flex flex-col items-center">
      <span class="text-xs text-[color:var(--text-secondary)] mb-1">EDPs Cr√≠ticos</span>
      <span class="text-lg font-bold text-[color:var(--accent-red)]">{{ total_edps_criticos_global | default ('0') }}</span>
    </div>
    <div class="flex flex-col items-center">
      <span class="text-xs text-[color:var(--text-secondary)] mb-1">D√≠as Promedio</span>
      <span class="text-lg font-bold">{{ dias_espera_promedio_global }}</span>
    </div>
    <div class="flex flex-col items-center">
      <span class="text-xs text-[color:var(--text-secondary)] mb-1">Meta Mensual</span>
      <span class="text-lg font-bold">${{ "{:,.0f}".format(meta_global/1000000).replace(",",".") }}M</span>
    </div>
    <div class="flex flex-col items-center">
      <span class="text-xs text-[color:var(--text-secondary)] mb-1">Proyecci√≥n</span>
      <div class="flex items-center gap-1">
        <span class="text-lg font-bold text-[color:var(--accent-green)]">+{{ avance_global|round|int }}%</span>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[color:var(--accent-white)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
        </svg>
      </div>
    </div>
  </div>
</div>


<!-- PANEL DE FINANZAS CONSOLIDADO -->
<div class="bg-[color:var(--bg-card)] border border-[color:var(--border-color-subtle)] rounded-xl p-5 mb-8">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-lg font-semibold">Financieros</h3>
    <div class="flex items-center space-x-2 text-xs text-[color:var(--text-secondary)]">
      <span class="flex items-center">
        <span class="h-2 w-2 rounded-full bg-[color:var(--accent-green)] mr-1"></span>
        ‚â§ 30 d√≠as
      </span>
      <span class="flex items-center">
        <span class="h-2 w-2 rounded-full bg-[color:var(--accent-amber)] mr-1"></span>
        30-60 d√≠as
      </span>
      <span class="flex items-center">
        <span class="h-2 w-2 rounded-full bg-[color:var(--accent-red)] mr-1"></span>
        ‚â• 60 d√≠as
      </span>
    </div>
  </div>

  <!-- DSO, Pagado y Pendiente en una sola fila con estructura mejorada-->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-4">
    
    <!-- DSO - D√≠as de Venta Pendientes de Cobro -->
  <div class="bg-[color:var(--background)] bg-opacity-40 p-4 rounded-xl border-l-4 border-red-500 shadow-lg">  <div class="flex justify-between items-center mb-3">
        <div class="flex items-center">
          <div class="w-8 h-8 flex items-center justify-center rounded-full bg-opacity-15 {% if dso_global > 60 %}bg-[color:var(--accent-red)]{% elif dso_global > 45 %}bg-[color:var(--accent-amber)]{% else %}bg-[color:var(--accent-green)]{% endif %} mr-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 {% if dso_global > 60 %}text-[color:var(--accent-white)]{% elif dso_global > 45 %}text-[color:var(--accent-amber)]{% else %}text-[color:var(--accent-green)]{% endif %}" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
            </svg>
          </div>
          <div>
            <h4 class="font-medium text-sm">DSO (D√≠as de Cobro)</h4>
            <p class="text-xs text-[color:var(--text-secondary)]">Meta: ‚â§ 45 d√≠as</p>
          </div>
        </div>
        <p class="text-2xl font-bold {% if dso_global > 60 %}text-[color:var(--accent-red)]{% elif dso_global > 45 %}text-[color:var(--accent-amber)]{% else %}text-[color:var(--accent-green)]{% endif %}">
          {{ dso_global|round(1) }}d
        </p>
      </div>
      
      <!-- Barra de progreso combinada con desgloses -->
      <div class="relative h-3 bg-[color:var(--bg-input)] rounded-full overflow-hidden mb-3">
        <div class="absolute top-0 bottom-0 left-0 w-1/3 border-r border-[color:var(--bg-card)]"></div>
        <div class="absolute top-0 bottom-0 left-1/3 w-1/3 border-r border-[color:var(--bg-card)]"></div>
        
        <!-- Indicador -->
        <div class="absolute top-0 bottom-0 left-0 h-full {% if dso_global > 60 %}bg-[color:var(--accent-red)]{% elif dso_global > 45 %}bg-[color:var(--accent-amber)]{% else %}bg-[color:var(--accent-green)]{% endif %}" 
             style="width: {{ (dso_global / 90 * 100) if dso_global < 90 else 100 }}%"></div>
      </div>
      
      <!-- Variaci√≥n vs mes anterior -->
      <div class="flex items-center mb-4">
        {% if dso_var > 0 %}
          <span class="flex items-center text-[color:var(--accent-red)] font-medium text-xs">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 mr-1" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
            </svg>
            +{{ dso_var|round(1) }}d vs anterior
          </span>
        {% elif dso_var < 0 %}
          <span class="flex items-center text-[color:var(--accent-green)] font-medium text-xs">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 mr-1" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M14.707 10.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 12.586V5a1 1 0 012 0v7.586l2.293-2.293a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            {{ dso_var|abs|round(1) }}d menos
          </span>
        {% else %}
          <span class="flex items-center text-[color:var(--text-secondary)] text-xs">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 mr-1" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" />
            </svg>
            Sin cambios
          </span>
        {% endif %}
      </div>
      
      <!-- Proyectos cr√≠ticos compactos -->
      {% if top_dso_proyectos %}
        <div class="border-t border-[color:var(--border-color-subtle)] pt-3">
          <h5 class="text-xs font-medium text-[color:var(--text-secondary)] mb-2">Top 3 cr√≠ticos</h5>
          <div class="space-y-1.5">
            {% for proyecto in top_dso_proyectos %}
              <a href="{{ url_for('controller.vista_proyecto_de_encargado', nombre=proyecto.jefe_proyecto, proyecto=proyecto.nombre) }}"
                 class="flex items-center justify-between py-1 px-2 rounded hover:bg-[color:var(--bg-highlight)] transition-colors text-xs">
                <div class="flex items-center space-x-1 min-w-0">
                  <span class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-opacity-20 {% if proyecto.dias > 60 %}bg-[color:var(--accent-red)] text-[color:var(--accent-red)]{% elif proyecto.dias > 45 %}bg-[color:var(--accent-amber)] text-[color:var(--accent-amber)]{% else %}bg-[color:var(--accent-green)] text-[color:var(--accent-green)]{% endif %} flex-shrink-0">
                    {{ loop.index }}
                  </span>
                  <span class="truncate max-w-[80px] text-[color:var(--accent-blue)]" title="{{ proyecto.nombre }}">{{ proyecto.nombre|truncate(10) }}</span>
                  <span class="text-[color:var(--text-tertiary)]" title="{{ proyecto.jefe_proyecto }}">{{ proyecto.jefe_proyecto }}</span>
                </div>
                <div class="flex items-center">
                  <span class="font-medium {% if proyecto.dias > 60 %}text-[color:var(--accent-red)]{% elif proyecto.dias > 45 %}text-[color:var(--accent-amber)]{% else %}text-[color:var(--accent-green)]{% endif %} mr-2">{{ proyecto.dias }}d</span>
                  <span>${{ "{:,.0f}".format(proyecto.monto|float/1000).replace(',','.') }}M</span>
                </div>
              </a>
            {% endfor %}
          </div>
        </div>
      {% endif %}
    </div>
    
    <!-- Pagado/Conformado -->
<div class="bg-[color:var(--background)] bg-opacity-40 p-4 rounded-xl border-l-4 border-emerald-500 shadow-lg">   <div class="flex justify-between items-center mb-3">
        <div class="flex items-center">
          <div class="w-8 h-8 flex items-center justify-center rounded-full bg-[color:var(--accent-green)] bg-opacity-15 mr-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[color:var(--accent-white)]" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
            </svg>
          </div>
          <div>
            <h4 class="font-medium text-sm">Pagado/Conformado</h4>
            <p class="text-xs text-[color:var(--text-secondary)]">Meta: ${{ "{:,.0f}".format(meta_global/1000000).replace(",",".") }}M</p>
          </div>
        </div>
        <p class="text-2xl font-bold text-[color:var(--accent-green)]">${{ "{:,.1f}".format(total_pagado_global_kpi/1000000).replace(",",".") }}M</p>
      </div>
      
      <!-- Barra de progreso -->
      <div class="h-3 bg-[color:var(--bg-input)] rounded-full overflow-hidden mb-3">
        <div class="h-full bg-[color:var(--accent-green)]" 
             style="width: {{ (total_pagado_global_kpi / meta_global * 100) if meta_global > 0 else 0 }}%"></div>
      </div>
      
      <!-- Cumplimiento de meta -->
      <div class="flex items-center justify-between mb-4">
        <span class="text-xs text-[color:var(--text-secondary)]">% de Meta</span>
        <span class="text-xs font-medium">{{ (total_pagado_global_kpi / meta_global * 100)|round(1) if meta_global > 0 else 0 }}%</span>
      </div>
      
      <!-- Desglose por antig√ºedad en display horizontal -->
      <div class="border-t border-[color:var(--border-color-subtle)] pt-3">
        <div class="flex justify-between mb-1">
          <h5 class="text-xs font-medium text-[color:var(--text-secondary)]">Por antig√ºedad</h5>
          <span class="text-xs text-[color:var(--text-secondary)]">{{ total_edp_pagados_conformados }} EDPs</span>
        </div>
        
        <div class="grid grid-cols-3 gap-2 mt-2">
          <div class="text-center py-1.5 bg-[color:var(--background)] bg-opacity-50 rounded">
            <p class="text-[10px] text-[color:var(--text-secondary)]">‚â§30d</p>
            <p class="text-xs font-medium">${{ "{:,.1f}".format(pagado_reciente/1000000).replace(",",".") }}M</p>
          </div>
          <div class="text-center py-1.5 bg-[color:var(--background)] bg-opacity-50 rounded">
            <p class="text-[10px] text-[color:var(--text-secondary)]">30-60d</p>
            <p class="text-xs font-medium text-[color:var(--accent-amber)]">${{ "{:,.1f}".format(pagado_medio/1000000).replace(",",".") }}M</p>
          </div>
          <div class="text-center py-1.5 bg-[color:var(--background)] bg-opacity-50 rounded">
            <p class="text-[10px] text-[color:var(--text-secondary)]">‚â•60d</p>
            <p class="text-xs font-medium text-[color:var(--accent-red)]">${{ "{:,.1f}".format(pagado_critico/1000000).replace(",",".") }}M</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Pendiente por cobrar -->
<div class="bg-[color:var(--background)] bg-opacity-40 p-4 rounded-xl border-l-4 border-yellow-500 shadow-lg">  <div class="flex justify-between items-center mb-3">
        <div class="flex items-center">
          <div class="w-8 h-8 flex items-center justify-center rounded-full bg-[color:var(--accent-amber)] bg-opacity-15 mr-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[color:var(--accent-white)]" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 2a4 4 0 00-4 4v1H5a1 1 0 00-.994.89l-1 9A1 1 0 004 18h12a1 1 0 00.994-1.11l-1-9A1 1 0 0015 7h-1V6a4 4 0 00-4-4zm2 5V6a2 2 0 10-4 0v1h4zm-6 3a1 1 0 112 0 1 1 0 01-2 0zm7-1a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd" />
            </svg>
          </div>
          <div>
            <h4 class="font-medium text-sm">Pendiente por cobrar</h4>
            <p class="text-xs text-[color:var(--text-secondary)]">{{ total_edps_por_cobrar }} EDPs pendientes</p>
          </div>
        </div>
        <p class="text-2xl font-bold text-[color:var(--accent-amber)]">${{ "{:,.1f}".format(total_pendiente_por_cobrar/1000000).replace(",",".") }}M</p>
      </div>
      
      <!-- Impacto en liquidez -->
      <div class="mb-1">
        <div class="flex justify-between text-xs mb-1">
          <span class="text-[color:var(--text-secondary)]">Impacto en liquidez</span>
          {% if (total_pendiente_por_cobrar / meta_global) > 0.5 %}
            <span class="text-[color:var(--accent-red)]">Alto</span>
          {% elif (total_pendiente_por_cobrar / meta_global) > 0.25 %}
            <span class="text-[color:var(--accent-amber)]">Medio</span>
          {% else %}
            <span class="text-[color:var(--accent-green)]">Bajo</span>
          {% endif %}
        </div>
        <div class="h-3 w-full bg-[color:var(--bg-input)] rounded-full overflow-hidden mb-3">
          <div class="h-full {% if (total_pendiente_por_cobrar / meta_global) > 0.5 %}bg-[color:var(--accent-red)]{% elif (total_pendiente_por_cobrar / meta_global) > 0.25 %}bg-[color:var(--accent-amber)]{% else %}bg-[color:var(--accent-green)]{% endif %}" 
               style="width: {{ (total_pendiente_por_cobrar / meta_global * 100) if meta_global > 0 else 0 }}%"></div>
        </div>
      </div>
      
      <!-- Porcentaje del total -->
      <div class="flex items-center justify-between mb-4">
        <span class="text-xs text-[color:var(--text-secondary)]">% del total</span>
        <span class="text-xs font-medium">{{ (total_pendiente_por_cobrar / meta_global * 100)|round(1) if meta_global > 0 else 0 }}%</span>
      </div>
      
      <!-- Desglose por antig√ºedad en display horizontal -->
      <div class="border-t border-[color:var(--border-color-subtle)] pt-3">
        <h5 class="text-xs font-medium text-[color:var(--text-secondary)] mb-2">Por antig√ºedad</h5>
        <div class="grid grid-cols-3 gap-2 mt-2">
          <div class="text-center py-1.5 bg-[color:var(--background)] bg-opacity-50 rounded">
            <p class="text-[10px] text-[color:var(--text-secondary)]">‚â§30d</p>
            <p class="text-xs font-medium">${{ "{:,.1f}".format(pendiente_reciente/1000000).replace(",",".") }}M</p>
          </div>
          <div class="text-center py-1.5 bg-[color:var(--background)] bg-opacity-50 rounded">
            <p class="text-[10px] text-[color:var(--text-secondary)]">30-60d</p>
            <p class="text-xs font-medium text-[color:var(--accent-amber)]">${{ "{:,.1f}".format(pendiente_medio/1000000).replace(",",".") }}M</p>
          </div>
          <div class="text-center py-1.5 bg-[color:var(--background)] bg-opacity-50 rounded">
            <p class="text-[10px] text-[color:var(--text-secondary)]">‚â•60d</p>
            <p class="text-xs font-medium text-[color:var(--accent-red)]">${{ "{:,.1f}".format(pendiente_critico/1000000).replace(",",".") }}M</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- BARRA DE PROGRESO INTEGRADA -->
  <div class="mt-4 pt-4 border-t border-[color:var(--border-color-subtle)]">
    <div class="flex items-center justify-between mb-1">
      <div class="flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-[color:var(--accent-blue)]" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd" />
        </svg>
        <span class="font-medium text-sm">Avance general: {{ avance_global if avance_global else 0 }}%</span>
      </div>
      
      {% if avance_global < 100 and avance_global > 0 %}
        <div class="text-xs text-[color:var(--text-primary)]">
          <span class="bg-[color:var(--accent-blue)] bg-opacity-10 px-2 py-1 rounded-full">
            Proyecci√≥n: {{ ((30 - ((avance_global/100)*30)))|round|int }} d√≠as restantes
          </span>
        </div>
      {% endif %}
    </div>
    
    <!-- Barra de progreso simplificada -->
    <div class="relative h-4 bg-[color:var(--bg-input)] rounded-full overflow-hidden">
      <!-- Marcadores de porcentaje -->
      <div class="absolute inset-0 flex w-full pointer-events-none">
        <div class="flex-1 border-r border-[color:var(--bg-card)] border-opacity-30"></div>
        <div class="flex-1 border-r border-[color:var(--bg-card)] border-opacity-30"></div>
        <div class="flex-1 border-r border-[color:var(--bg-card)] border-opacity-30"></div>
        <div class="flex-1"></div>
      </div>
      
      <!-- Barra de progreso principal -->
      <div class="absolute top-0 left-0 bottom-0 bg-gradient-to-r from-[color:var(--accent-green)] to-[color:var(--accent-blue)]"
           style="width: {% if avance_global <= 100 %}{{avance_global}}{% else %}100{% endif %}%">
        {% if avance_global > 10 %}
          <span class="absolute top-0 bottom-0 right-1 flex items-center text-white text-xs font-bold">
            {{ avance_global|round|int }}%
          </span>
        {% endif %}
      </div>
    </div>
    
    <!-- Etiquetas de porcentaje -->
    <div class="flex justify-between text-xs text-[color:var(--text-tertiary)] mt-1">
      <span>0%</span>
      <span>25%</span>
      <span>50%</span>
      <span>75%</span>
      <span>100%</span>
    </div>
    
    <!-- Comparativa con mes anterior -->
    <div class="flex justify-end mt-2">
      {% if avance_var_porcentaje > 0 %}
        <span class="flex items-center text-[color:var(--accent-green)] text-xs">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M12 7a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0V8.414l-4.293 4.293a1 1 0 01-1.414 0L8 10.414l-4.293 4.293a1 1 0 01-1.414-1.414l5-5a1 1 0 011.414 0L11 10.586 14.586 7H12z" clip-rule="evenodd" />
          </svg>
          +{{ avance_var_porcentaje }}% vs mes anterior
        </span>
      {% elif avance_var_porcentaje < 0 %}
        <span class="flex items-center text-[color:var(--accent-red)] text-xs">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M12 13a1 1 0 100 2h5a1 1 0 001-1v-5a1 1 0 10-2 0v2.586l-4.293-4.293a1 1 0 00-1.414 0L8 9.586 3.707 5.293a1 1 0 00-1.414 1.414l5 5a1 1 0 001.414 0L11 9.414 14.586 13H12z" clip-rule="evenodd" />
          </svg>
          {{ avance_var_porcentaje }}% vs mes anterior
        </span>
      {% else %}
        <span class="flex items-center text-[color:var(--text-tertiary)] text-xs">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" />
          </svg>
          Sin cambios vs mes anterior
        </span>
      {% endif %}
    </div>
  </div>
</div>
<!-- KPIs financieros del filtro -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-8 mt-5">
  <!-- DSO Filtrado -->
  <div class="metric-card bg-[color:var(--bg-card)] border border-[color:var(--border-color-subtle)] rounded-xl overflow-hidden group hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
    <div class="h-2 bg-[color:{% if dso_filtrado > 60 %}var(--accent-red){% elif dso_filtrado > 45 %}var(--accent-amber){% else %}var(--accent-green){% endif %}]"></div>
    <div class="p-5 relative">
      <div class="absolute top-0 right-0 w-24 h-24 -mr-8 -mt-8 opacity-10 group-hover:opacity-20 transition-opacity">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-full w-full text-[color:var(--accent-amber)]" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
        </svg>
      </div>
      <div class="flex items-center mb-3">
        <p class="metric-label font-medium text-[color:var(--text-secondary)]">DSO filtrado</p>
        <span class="ml-auto px-1.5 py-0.5 rounded text-xs font-medium 
               bg-[color:{% if dso_filtrado > 60 %}var(--accent-red){% elif dso_filtrado > 45 %}var(--accent-amber){% else %}var(--accent-green){% endif %}] 
               bg-opacity-15 
               text-[color:var(--text-on-accent)]">
          {% if dso_filtrado > 60 %}CR√çTICO
          {% elif dso_filtrado > 45 %}ALERTA
          {% else %}√ìPTIMO{% endif %}
        </span>
      </div>
      <div class="flex items-end">
        <p class="metric-value text-3xl font-bold {% if dso_filtrado > 60 %}text-[color:var(--accent-red)]{% elif dso_filtrado > 45 %}text-[color:var(--accent-amber)]{% else %}text-[color:var(--accent-green)]{% endif %} animate__animated animate__fadeIn">
          {{ dso_filtrado|round(1) }}
        </p>
        <span class="text-xs text-[color:var(--text-secondary)] mb-1.5 ml-2">d√≠as promedio</span>
      </div>
      <div class="relative mt-3">
        <div class="flex items-center">
          <div class="h-2 flex-1 bg-[color:var(--bg-input)] rounded-full overflow-hidden">
            <div class="h-full {% if dso_filtrado > 60 %}bg-[color:var(--accent-red)]{% elif dso_filtrado > 45 %}bg-[color:var(--accent-amber)]{% else %}bg-[color:var(--accent-green)]{% endif %} animate__animated animate__slideInLeft" 
                 style="width: {{ (dso_filtrado / 90 * 100) if dso_filtrado < 90 else 100 }}%"></div>
          </div>
        </div>
        <div class="flex justify-between text-xs text-[color:var(--text-secondary)] mt-1.5">
          <span>Meta: ‚â§45 d√≠as</span>
          <span class="{% if dso_filtrado < dso_global %}text-[color:var(--accent-green)] font-medium{% endif %}">
            {% if dso_filtrado < dso_global %}{{ (dso_global - dso_filtrado)|round(1) }}d mejor que global{% endif %}
          </span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Monto pendiente filtrado -->
  <div class="metric-card bg-[color:var(--bg-card)] border border-[color:var(--border-color-subtle)] rounded-xl overflow-hidden group hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
    <div class="h-2 bg-[color:var(--accent-amber)]"></div>
    <div class="p-5 relative">
      <div class="absolute top-0 right-0 w-24 h-24 -mr-8 -mt-8 opacity-10 group-hover:opacity-20 transition-opacity">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-full w-full text-[color:var(--accent-amber)]" viewBox="0 0 20 20" fill="currentColor">
          <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z" />
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd" />
        </svg>
      </div>
      <div class="flex items-center mb-3">
        <p class="metric-label font-medium text-[color:var(--text-secondary)]">Monto pendiente</p>
      </div>
      <div class="flex items-end">
        <p class="metric-value text-3xl font-bold text-[color:var(--accent-amber)] animate__animated animate__fadeIn">
          ${{ "{:,.1f}".format(total_pendiente_filtrado/1000000).replace(",",".") }}M
        </p>
        <span class="text-xs text-[color:var(--text-secondary)] mb-1.5 ml-2">por cobrar</span>
      </div>
      <div class="relative mt-3">
        <div class="flex items-center">
          <div class="h-2 flex-1 bg-[color:var(--bg-input)] rounded-full overflow-hidden">
            <div class="h-full bg-[color:var(--accent-amber)] animate__animated animate__slideInLeft" 
                 style="width: {{ (total_pendiente_filtrado / total_pendiente_por_cobrar * 100) if total_pendiente_por_cobrar > 0 else 0 }}%"></div>
          </div>
        </div>
        <p class="text-xs text-[color:var(--text-secondary)] mt-2">{{ (total_pendiente_filtrado / total_pendiente_por_cobrar * 100)|round(1) if total_pendiente_por_cobrar > 0 else 0 }}% del total pendiente</p>
      </div>
    </div>
  </div>
  
  <!-- Monto pagado/conformado filtrado -->
  <div class="metric-card bg-[color:var(--bg-card)] border border-[color:var(--border-color-subtle)] rounded-xl overflow-hidden group hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
    <div class="h-2 bg-[color:var(--accent-green)]"></div>
    <div class="p-5 relative">
      <div class="absolute top-0 right-0 w-24 h-24 -mr-8 -mt-8 opacity-10 group-hover:opacity-20 transition-opacity">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-full w-full text-[color:var(--accent-green)]" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
        </svg>
      </div>
      <div class="flex items-center mb-3">
        <p class="metric-label font-medium text-[color:var(--text-secondary)]">Monto pagado</p>
      </div>
      <div class="flex items-end">
        <p class="metric-value text-3xl font-bold text-[color:var(--accent-green)] animate__animated animate__fadeIn">
          ${{ "{:,.1f}".format(total_pagado_filtrado/1000000).replace(",",".") }}M
        </p>
        <span class="text-xs text-[color:var(--text-secondary)] mb-1.5 ml-2">conformado</span>
      </div>
      <div class="relative mt-3">
        <div class="flex items-center">
          <div class="h-2 flex-1 bg-[color:var(--bg-input)] rounded-full overflow-hidden">
            <div class="h-full bg-[color:var(--accent-green)] animate__animated animate__slideInLeft" 
                 style="width: {{ (total_pagado_filtrado / total_pagado_global_kpi * 100) if total_pagado_global_kpi > 0 else 0 }}%"></div>
          </div>
        </div>
        <p class="text-xs text-[color:var(--text-secondary)] mt-2">{{ (total_pagado_filtrado / total_pagado_global_kpi * 100)|round(1) if total_pagado_global_kpi > 0 else 0 }}% del total pagado</p>
      </div>
    </div>
  </div>
</div>
</div>
  
  <!-- Tabla de EDPs Mejorada -->
  <div class="section-title-modern mb-5">
    <h2 class="text-xl font-semibold flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-[color:var(--accent-blue)]" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M5 4a3 3 0 00-3 3v6a3 3 0 003 3h10a3 3 0 003-3V7a3 3 0 00-3-3H5zm-1 9v-1h5v2H5a1 1 0 01-1-1zm7 1h4a1 1 0 001-1v-1h-5v2zm0-4h5V8h-5v2zM9 8H4v2h5V8z" clip-rule="evenodd" />
      </svg>
      Listado de EDPs
    </h2>
    <div class="section-line"></div>
  </div>
  
  <!-- Opciones de tabla y Quick Filters -->
  <div class="flex flex-col md:flex-row justify-between mb-4 bg-[color:var(--bg-card)] border border-[color:var(--border-color-subtle)] rounded-xl p-3">
    <div class="flex flex-wrap gap-2 mb-3 md:mb-0">
      <button id="filter-all" class="px-3 py-1 text-sm rounded-full bg-[color:var(--accent-blue)] text-white hover:bg-[color:var(--accent-blue-dark)] transition-colors">
        Todos
      </button>
      <button id="filter-criticos" class="px-3 py-1 text-sm rounded-full bg-[color:var(--bg-card-hover)] text-[color:var(--text-primary)] hover:bg-[color:var(--bg-highlight)] transition-colors">
        Cr√≠ticos
      </button>
      <button id="filter-recientes" class="px-3 py-1 text-sm rounded-full bg-[color:var(--bg-card-hover)] text-[color:var(--text-primary)] hover:bg-[color:var(--bg-highlight)] transition-colors">
        √öltimos 30 d√≠as
      </button>
      <button id="filter-pendientes" class="px-3 py-1 text-sm rounded-full bg-[color:var(--bg-card-hover)] text-[color:var(--text-primary)] hover:bg-[color:var(--bg-highlight)] transition-colors">
        Pendientes
      </button>
       <button id="filter-validados" class="px-3 py-1 text-sm rounded-full bg-[color:var(--bg-card-hover)] text-[color:var(--text-primary)] hover:bg-[color:var(--bg-highlight)] transition-colors">
        Validados
      </button>
    </div>
    
    <div class="flex gap-2">
      <div class="relative">
        <input id="table-search" type="text" placeholder="Buscar en tabla" class="form-input pl-8 py-1 text-sm" />
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[color:var(--text-secondary)] absolute left-2.5 top-1/2 transform -translate-y-1/2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
      </div>
      
      <button id="toggle-columns" class="px-3 py-1 text-sm bg-[color:var(--bg-card-hover)] text-[color:var(--text-primary)] rounded hover:bg-[color:var(--bg-highlight)] transition-colors flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
        </svg>
        Columnas
      </button>
    </div>
  </div>
  
  <!-- Dropdown menu para selecci√≥n de columnas (oculto por defecto) -->
  <div id="columns-dropdown" class="hidden bg-[color:var(--bg-card)] border border-[color:var(--border-color)] rounded-xl p-3 shadow-lg mb-4">
    <div class="grid grid-cols-3 gap-3">
      <label class="flex items-center">
        <input type="checkbox" checked data-column="proyecto" class="mr-2">
        Proyecto
      </label>
      <label class="flex items-center">
        <input type="checkbox" checked data-column="jefe" class="mr-2">
        Jefe Proyecto
      </label>
      <label class="flex items-center">
        <input type="checkbox" checked data-column="cliente" class="mr-2">
        Cliente
      </label>
      <label class="flex items-center">
        <input type="checkbox" checked data-column="mes" class="mr-2">
        Mes
      </label>
      <label class="flex items-center">
        <input type="checkbox" checked data-column="edp" class="mr-2">
        N¬∞ EDP
      </label>
      <label class="flex items-center">
        <input type="checkbox" checked data-column="conformidad" class="mr-2">
        N¬∞ Conf.
      </label>
      <label class="flex items-center">
        <input type="checkbox" checked data-column="estado" class="mr-2">
        Estado
      </label>
      <label class="flex items-center">
        <input type="checkbox" checked data-column="dias" class="mr-2">
        D√≠as
      </label>
      <label class="flex items-center">
        <input type="checkbox" checked data-column="diashabiles" class="mr-2">
        D√≠as H√°biles
      </label>
      <label class="flex items-center">
        <input type="checkbox" checked data-column="montopropuesto" class="mr-2">
        M. Propuesto
      </label>
      <label class="flex items-center">
        <input type="checkbox" checked data-column="montoaprobado" class="mr-2">
        M. Aprobado
      </label>
      <label class="flex items-center">
        <input type="checkbox" checked data-column="critico" class="mr-2">
        Cr√≠tico
      </label>
    </div>
  </div>
  
  <!-- Tabla con mejor interactividad -->
  <div class="table-responsive shadow-md rounded-xl overflow-hidden border border-[color:var(--border-color)]">
    <table id="edp-table" class="data-table w-full">
      <thead>
        <tr class="bg-[color:var(--background)]">
          <th class="sortable p-3" data-sort="proyecto">Proyecto</th>
          <th class="sortable" data-sort="jefe">Jefe de Proyecto</th>
          <th class="sortable" data-sort="cliente">Cliente</th>
          <th class="sortable" data-sort="mes">Mes</th>
          <th class="sortable" data-sort="edp">N¬∞ EDP</th>
          <th class="sortable" data-sort="n-conformidad">N¬∞ Conf.</th>
          <th class="sortable" data-sort="estado">Estado</th>
          <th class="sortable sort-desc text-center" data-sort="dias">D√≠as</th>
          <th class="sortable text-center" data-sort="dias-habiles">D√≠as H√°biles</th>
          <th class="sortable text-right" data-sort="monto-propuesto">M. Propuesto</th>
          <th class="sortable text-right" data-sort="monto-aprobado">M. Aprobado</th>
          <th class="sortable text-center" data-sort="critico">Cr√≠tico</th>
          <th>Observaciones</th>
          <th></th>
        </tr>
      </thead>
         <!-- Replace the table row content with this fixed version -->
    
     
     <tbody>
  {% for registro in registros %}
    <tr 
      data-proyecto="{{ registro.get('proyecto', '') }}"
      data-jefe="{{ registro.get('jefe_proyecto', '') }}"
      data-cliente="{{ registro.get('cliente', '') }}"
      data-mes="{{ registro.get('mes', '') }}"
      data-edp="{{ registro.get('n_edp', '') }}"
      data-n-conformidad="{{ registro.get('n_conformidad', '') }}"
      data-estado="{{ registro.get('estado', '') }}"
      data-dias="{{ registro.get('dias_espera', 0) }}"
      data-dias-habiles="{{ registro.get('dias_habiles', 0) }}"
      data-monto-propuesto="{{ registro.get('monto_propuesto', 0)|default(0) }}"
      data-monto-aprobado="{{ registro.get('monto_aprobado', 0)|default(0) }}"
      data-critico="{{ 1 if registro.get('critico', False) else 0 }}"
      class="{% if registro.get('critico', False) %}data-table-row-critical{% endif %}{% if registro.get('estado', '') == 'validado' %}data-table-row-validated{% endif %}"
    >
      <td class="font-medium">{{ registro.get('proyecto', '-') }}</td>
      <td>{{ registro.get('jefe_proyecto', '-') }}</td>
      <td>{{ registro.get('cliente', '-') }}</td>
      <td>{{ registro.get('mes', '-') }}</td>
      <td>{{ registro.get('n_edp', '-') }}</td>      
      <td>{{ registro.get('n_conformidad', '-') }}</td>
      <td>
        <span class="estado-pill estado-{{ registro.get('estado', 'pendiente') }}">
          {{ registro.get('estado', 'pendiente') }}
        </span>
      </td>
      
      {% set dias = registro.get('dias_espera', 0)|int %}
      <td class="text-center {% if dias > 30 %}text-[color:var(--accent-red)] font-medium{% elif dias > 20 %}text-[color:var(--accent-amber)]{% else %}text-[color:var(--accent-green)]{% endif %}">
        {{ dias }}
      </td>
      
      <td class="text-center">{{ registro.get('dias_habiles', 0) }}</td>
      <td class="text-right">${{ "{:,.0f}".format(registro.get('monto_propuesto', 0)|default(0)).replace(",",".") }}</td>
      <td class="text-right">${{ "{:,.0f}".format(registro.get('monto_aprobado', 0)|default(0)).replace(",",".") }}</td>
      <td class="text-center">
        {% if registro.get('critico', False) %}
          <span class="text-[color:var(--accent-red)]">‚óè</span>
        {% else %}
          <span class="text-[color:var(--text-secondary)]">‚óã</span>
        {% endif %}
 <td class="max-w-xs truncate" title="{{ registro.get('observaciones', '') }}">
  {{ registro.get('observaciones', '-')[:15] ~ ('...' if registro.get('observaciones') and registro.get('observaciones')|length > 50 else '') }}
</td>

    <td>
<a href="{{ url_for('controller.detalle_edp', n_edp=registro.get('id', '')) }}" 
     class="flex items-center justify-center text-[color:var(--accent-blue)] hover:text-[color:var(--accent-blue-dark)] bg-[color:var(--bg-card-hover)] hover:bg-[color:var(--bg-highlight)] p-1.5 rounded-full transition-colors"
     title="Ver detalles del EDP">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
      <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
      <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
    </svg>
  </a>
</td>

    </tr>
  {% endfor %}
  
  {% if not registros %}
    <tr>
      <td colspan="14" class="py-8 text-center text-[color:var(--text-secondary)]">
        <div class="flex flex-col items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-3 text-[color:var(--text-secondary)] opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <p class="text-base font-medium">No se encontraron registros</p>
          <p class="text-sm mt-1">Prueba con diferentes criterios de b√∫squeda</p>
        </div>
      </td>
    </tr>
  {% endif %}
</tbody>
    </table>
  </div>
  
  <!-- Informaci√≥n de la tabla y controles de paginaci√≥n -->
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center mt-4 space-y-4 md:space-y-0">
    <!-- Informaci√≥n de registros -->
    <div class="flex flex-col space-y-2">
      <div class="text-sm text-[color:var(--text-secondary)]">
        Mostrando <span id="showing-from">1</span> - <span id="showing-to">10</span> de <span id="total-count">{{ registros|length }}</span> EDPs
        <span id="filtered-info" class="hidden">(filtrado de <span id="original-count">{{ registros|length }}</span> total)</span>
      </div>
      <div class="flex items-center space-x-2">
        <label for="page-size" class="text-xs text-[color:var(--text-secondary)]">Mostrar:</label>
        <select id="page-size" class="form-select text-xs py-1 px-2 w-20">
          <option value="10">10</option>
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
        <span class="text-xs text-[color:var(--text-secondary)]">por p√°gina</span>
      </div>
    </div>

    <!-- Controles de paginaci√≥n -->
    <div class="flex items-center space-x-4">
      <!-- Exportar -->
      <button id="exportar-excel" class="flex items-center text-[color:var(--accent-green)] hover:text-[color:var(--accent-green-dark)] transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg>
        Exportar a CSV
      </button>
      
      <!-- Navegaci√≥n de p√°ginas -->
      <div class="flex items-center space-x-2">
        <button id="prev-page" class="px-3 py-1 text-sm bg-[color:var(--bg-card)] border border-[color:var(--border-color)] rounded hover:bg-[color:var(--bg-highlight)] transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
        </button>
        
        <div class="flex items-center space-x-1" id="page-numbers">
          <!-- Los n√∫meros de p√°gina se generar√°n din√°micamente -->
        </div>
        
        <button id="next-page" class="px-3 py-1 text-sm bg-[color:var(--bg-card)] border border-[color:var(--border-color)] rounded hover:bg-[color:var(--bg-highlight)] transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </button>
      </div>
      
      <!-- Ir a p√°gina espec√≠fica -->
      <div class="flex items-center space-x-2">
        <span class="text-xs text-[color:var(--text-secondary)]">Ir a:</span>
        <input id="goto-page" type="number" min="1" class="form-input text-xs py-1 px-2 w-16 text-center" placeholder="1">
        <button id="goto-page-btn" class="px-2 py-1 text-xs bg-[color:var(--accent-blue)] text-white rounded hover:bg-blue-600 transition-colors">
          Ir
        </button>
      </div>
    </div>
  </div>
  
  <!-- Incluir el modal -->
<!-- Incluir el modal -->
{% include "controller/modal_edp_template.html" %}
<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
<script src="{{ url_for('static', filename='js/modal_edp_scripts.js') }}"></script>
  
<script>
  document.addEventListener('DOMContentLoaded', function() {
    
    // === FUNCIONES DE ATENCI√ìN INMEDIATA SIMPLIFICADAS ===
    function initializeCriticalPendingSection() {
      const allRows = Array.from(document.querySelectorAll('#edp-table tbody tr'));
      
      // Filtrar EDPs pendientes (revisi√≥n y enviado)
      const pendingRows = allRows.filter(row => {
        const estado = (row.getAttribute('data-estado') || '').toLowerCase();
        return estado === 'revisi√≥n' || estado === 'enviado';
      });
      
      // Estad√≠sticas
      const criticalCount = pendingRows.filter(row => {
        const dias = parseInt(row.getAttribute('data-dias')) || 0;
        return dias > 30;
      }).length;
      
      const revisionCount = pendingRows.filter(row => 
        (row.getAttribute('data-estado') || '').toLowerCase() === 'revisi√≥n'
      ).length;
      
      const sentCount = pendingRows.filter(row => 
        (row.getAttribute('data-estado') || '').toLowerCase() === 'enviado'
      ).length;
      
      // Si no hay EDPs cr√≠ticos, ocultar la secci√≥n
      if (criticalCount === 0 && pendingRows.length === 0) {
        document.getElementById('critical-alert-section').style.display = 'none';
        return;
      }
      
      // Actualizar resumen de alerta
      const alertSummary = document.getElementById('alert-summary');
      if (criticalCount > 0) {
        alertSummary.textContent = `${criticalCount} EDPs con +30 d√≠as de espera`;
        alertSummary.className = 'text-[color:var(--accent-red)] ml-2 font-medium';
      } else {
        alertSummary.textContent = `${pendingRows.length} EDPs pendientes de atenci√≥n`;
        alertSummary.className = 'text-[color:var(--accent-amber)] ml-2 font-medium';
      }
      
      // Generar mini badges
      generateQuickStats(revisionCount, sentCount, criticalCount);
      
      // EDPs m√°s cr√≠ticos (tomar solo los primeros 4 para el detalle)
      const criticalEdps = pendingRows
        .sort((a, b) => {
          const diasA = parseInt(a.getAttribute('data-dias')) || 0;
          const diasB = parseInt(b.getAttribute('data-dias')) || 0;
          return diasB - diasA;
        })
        .slice(0, 4);
      
      // Generar cards simplificadas
      generateSimpleCriticalCards(criticalEdps);
      
      // Event listeners
      setupCriticalAlertEvents();
    }
    
    function generateQuickStats(revisionCount, sentCount, criticalCount) {
      const container = document.getElementById('quick-stats');
      container.innerHTML = '';
      
      const stats = [
        { count: revisionCount, label: 'Revisi√≥n', color: 'bg-[color:var(--accent-blue)]' },
        { count: sentCount, label: 'Enviado', color: 'bg-[color:var(--accent-purple)]' },
        { count: criticalCount, label: '+30d', color: 'bg-[color:var(--accent-red)]' }
      ];
      
      stats.forEach(stat => {
        if (stat.count > 0) {
          const badge = document.createElement('span');
          badge.className = `inline-flex items-center px-1.5 py-0.5 md:px-2 md:py-1 rounded-full text-xs font-medium text-white ${stat.color} whitespace-nowrap`;
          badge.textContent = `${stat.count} ${stat.label}`;
          container.appendChild(badge);
        }
      });
    }
    
    function setupCriticalAlertEvents() {
      // Toggle para expandir detalles
      document.getElementById('expand-critical-alert').addEventListener('click', () => {
        const details = document.getElementById('critical-details');
        const button = document.getElementById('expand-critical-alert');
        
        if (details.classList.contains('hidden')) {
          details.classList.remove('hidden');
          button.textContent = 'Ocultar detalles';
        } else {
          details.classList.add('hidden');
          button.textContent = 'Ver detalles';
        }
      });
      
      // Bot√≥n para ocultar toda la alerta
      document.getElementById('hide-critical-alert').addEventListener('click', () => {
        document.getElementById('critical-alert-section').style.display = 'none';
        // Guardar preferencia en localStorage
        localStorage.setItem('hideCriticalAlert', 'true');
      });
      
      // Event listener para el bot√≥n "Ver todos los pendientes"
      document.getElementById('show-all-pending').addEventListener('click', () => {
        const btnPendientes = document.getElementById('filter-pendientes');
        if (btnPendientes) {
          btnPendientes.click();
        }
        
        // Scroll suave hacia la tabla
        document.getElementById('edp-table').scrollIntoView({ 
          behavior: 'smooth',
          block: 'start'
        });
      });
      
      // Verificar si el usuario hab√≠a ocultado la alerta anteriormente
      if (localStorage.getItem('hideCriticalAlert') === 'true') {
        document.getElementById('critical-alert-section').style.display = 'none';
        document.getElementById('restore-alert-btn').classList.remove('hidden');
      }
      
      // Bot√≥n para restaurar la alerta
      document.getElementById('restore-alert-btn').addEventListener('click', () => {
        document.getElementById('critical-alert-section').style.display = 'block';
        document.getElementById('restore-alert-btn').classList.add('hidden');
        localStorage.removeItem('hideCriticalAlert');
      });
    }
    
    function generateSimpleCriticalCards(criticalEdps) {
      const container = document.getElementById('critical-edps-container');
      container.innerHTML = '';
      
      if (criticalEdps.length === 0) {
        container.innerHTML = `
          <div class="col-span-full text-center py-4">
            <span class="text-[color:var(--text-secondary)] text-sm">No hay EDPs cr√≠ticos para mostrar</span>
          </div>
        `;
        return;
      }
      
      criticalEdps.forEach(row => {
        const proyecto = row.getAttribute('data-proyecto') || '-';
        const edpNumber = row.getAttribute('data-edp') || '-';
        const jefe_proyecto = row.getAttribute('data-jefe') || '-';
        const estado = row.getAttribute('data-estado') || '-';
        const dias = parseInt(row.getAttribute('data-dias')) || 0;
        const monto = parseFloat(row.getAttribute('data-monto-aprobado')) || 0;
        
        // Determinar color seg√∫n d√≠as
        let indicatorColor = 'bg-[color:var(--accent-amber)]';
        if (dias > 45) {
          indicatorColor = 'bg-[color:var(--accent-red)]';
        } else if (dias > 30) {
          indicatorColor = 'bg-[color:var(--accent-orange)]';
        }
        
        const card = document.createElement('div');
        card.className = `critical-edp-card bg-[color:var(--bg-card-hover)] border border-[color:var(--border-color-subtle)] rounded-lg p-3 hover:shadow-md transition-all cursor-pointer`;
        
        card.innerHTML = `
          <div class="flex items-start space-x-3">
            <div class="w-3 h-3 rounded-full ${indicatorColor} mt-1 flex-shrink-0"></div>
            <div class="min-w-0 flex-1">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-[color:var(--text-primary)] truncate pr-2">EDP #${edpNumber}</span>
                <span class="text-xs text-[color:var(--accent-red)] font-bold whitespace-nowrap">${dias}d</span>
              </div>
              <div class="flex items-start justify-between">
                <div class="flex flex-col space-y-1 min-w-0 flex-1 pr-2">
                  <span class="text-xs text-[color:var(--text-secondary)] truncate" title="${proyecto}">üìÅ ${proyecto}</span>
                  <span class="text-xs text-[color:var(--text-secondary)] truncate" title="${jefe_proyecto}">üë§ ${jefe_proyecto}</span>
                </div>
                <span class="text-xs px-2 py-1 rounded flex-shrink-0 ${estado === 'revisi√≥n' ? 'bg-[color:var(--accent-blue)] text-white' : 'bg-[color:var(--accent-purple)] text-white'} whitespace-nowrap">
                  ${estado}
                </span>
              </div>
            </div>
          </div>
        `;
        
        // Hacer la card clickeable para ver detalles
        card.addEventListener('click', () => {
          // Buscar la fila correspondiente en la tabla y hacer clic en ella
          const tableRow = document.querySelector(`#edp-table tbody tr[data-edp="${edpNumber}"]`);
          if (tableRow) {
            tableRow.click();
          }
        });
        
        container.appendChild(card);
      });
    }
    
    // Funci√≥n para mostrar notificaciones toast
function showToast(message, type = 'info') {
  // Crear elemento toast
  const toast = document.createElement('div');
  toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg text-white z-50 animate__animated animate__fadeInUp`;
  
  // Estilos seg√∫n el tipo
  if (type === 'success') {
    toast.classList.add('bg-green-600');
    message = `‚úÖ ${message}`;
  } else if (type === 'error') {
    toast.classList.add('bg-red-600');
    message = `‚ùå ${message}`;
  } else if (type === 'warning') {
    toast.classList.add('bg-amber-500');
    message = `‚ö†Ô∏è ${message}`;
  } else {
    toast.classList.add('bg-blue-600');
    message = `‚ÑπÔ∏è ${message}`;
  }
  
  // Contenido y estructura
  toast.innerHTML = `
    <div class="flex items-center">
      <span class="flex-grow">${message}</span>
      <button class="ml-4 hover:text-gray-300 focus:outline-none" onclick="this.parentElement.parentElement.remove()">
        &times;
      </button>
    </div>
  `;
  
  // A√±adir al DOM
  document.body.appendChild(toast);
  
  // Auto-eliminar despu√©s de 5 segundos
  setTimeout(() => {
    toast.classList.replace('animate__fadeInUp', 'animate__fadeOutDown');
    setTimeout(() => {
      if (document.body.contains(toast)) {
        document.body.removeChild(toast);
      }
    }, 500);
  }, 5000);
}


window.addEventListener("DOMContentLoaded", () => {
  // Aplicamos el filtro correspondiente seg√∫n el estado seleccionado en el backend
  // IMPORTANTE: No mostramos los filtros autom√°ticamente aqu√≠
  let filterApplied = false;
  const rows = Array.from(document.querySelectorAll('#edp-table tbody tr'));
  
  // IMPORTANTE: Primero limpiamos los estilos de TODOS los botones de filtro para evitar duplicados
  const allFilterButtons = document.querySelectorAll('#filter-all, #filter-criticos, #filter-recientes, #filter-pendientes, #filter-validados');
  allFilterButtons.forEach(btn => {
    btn.classList.remove('bg-[color:var(--accent-blue)]', 'text-white');
    btn.classList.add('bg-[color:var(--bg-card-hover)]', 'text-[color:var(--text-primary)]');
  });
  
  // Intentamos encontrar y activar el bot√≥n de filtro correspondiente pero sin expandir los filtros
  {% if filtros.estado == 'pendientes' %}
    const btnPendientes = document.getElementById("filter-pendientes");
    if (btnPendientes) {
      // Simulamos el comportamiento del clic sin ejecutar el evento real
      // para evitar que se muestren los filtros
      btnPendientes.classList.remove('bg-[color:var(--bg-card-hover)]', 'text-[color:var(--text-primary)]');
      btnPendientes.classList.add('bg-[color:var(--accent-blue)]', 'text-white');
      
      // Aplicar el filtro directamente a las filas
      rows.forEach(row => {
        const estado = row.getAttribute('data-estado') || '';
        row.classList.toggle('hidden', estado === 'validado' || estado === 'pagado');
      });
      
      filterApplied = true;
    }
  {% elif filtros.estado == 'validado' %}
    const btnValidados = document.getElementById("filter-validados");
    if (btnValidados) {
      // Aplicamos estilos sin clic real
      btnValidados.classList.remove('bg-[color:var(--bg-card-hover)]', 'text-[color:var(--text-primary)]');
      btnValidados.classList.add('bg-[color:var(--accent-blue)]', 'text-white');
      
      // Aplicar el filtro directamente a las filas
      rows.forEach(row => {
        const estado = (row.getAttribute('data-estado') || '').toLowerCase();
        row.classList.toggle('hidden', estado !== 'validado');
      });
      
      filterApplied = true;
    }
  {% elif filtros.estado == 'todos' or filtros.estado == 'enviado' or filtros.estado == 'pagado' or filtros.estado == 'revisi√≥n' %}
    // Filtros que no tienen un bot√≥n espec√≠fico, activamos "todos"
    const btnAll = document.getElementById("filter-all");
    if (btnAll) {
      // Aplicamos estilos sin clic real
      btnAll.classList.remove('bg-[color:var(--bg-card-hover)]', 'text-[color:var(--text-primary)]');
      btnAll.classList.add('bg-[color:var(--accent-blue)]', 'text-white');
      
      // Mostrar todas las filas
      rows.forEach(row => { row.classList.remove('hidden'); });
      
      filterApplied = true;
    }
  {% endif %}
  
  // Si no se aplic√≥ ning√∫n filtro espec√≠fico, usamos 'pendientes' como predeterminado
  // A menos que expl√≠citamente venga "todos" desde el backend
  if (!filterApplied) {
    {% if filtros.estado == 'todos' %}
      const btnAll = document.getElementById("filter-all");
      if (btnAll) {
        // Aplicamos estilos sin clic real para "todos"
        btnAll.classList.remove('bg-[color:var(--bg-card-hover)]', 'text-[color:var(--text-primary)]');
        btnAll.classList.add('bg-[color:var(--accent-blue)]', 'text-white');
        
        // Mostrar todas las filas
        rows.forEach(row => { row.classList.remove('hidden'); });
      }
    {% else %}
      const btnPendientes = document.getElementById("filter-pendientes");
      if (btnPendientes) {
        // Aplicamos estilos sin clic real para "pendientes" (predeterminado)
        btnPendientes.classList.remove('bg-[color:var(--bg-card-hover)]', 'text-[color:var(--text-primary)]');
        btnPendientes.classList.add('bg-[color:var(--accent-blue)]', 'text-white');
        
        // Aplicar el filtro de pendientes (ocultar validados y pagados)
        rows.forEach(row => {
          const estado = row.getAttribute('data-estado') || '';
          row.classList.toggle('hidden', estado === 'validado' || estado === 'pagado');
        });
      }
    {% endif %}
  }
  
  // Inicializar filas filtradas para la paginaci√≥n
  filteredRows = rows.filter(row => !row.classList.contains('hidden'));
  
  // Inicializar la secci√≥n de atenci√≥n inmediata
  initializeCriticalPendingSection();
  
  // Mostrar en consola el estado del filtro (para depuraci√≥n)
  console.log("Estado del filtro: {{ filtros.estado }}");
});
    // Define essential variables first
    const detailPagePrefix = '/controller/detalle/';
    const table        = document.getElementById('edp-table');
    const tableBody    = table.querySelector('tbody');          
    const headers      = table.querySelectorAll('th.sortable');
    const rows         = Array.from(tableBody.querySelectorAll('tr'));   
    const searchInput = document.getElementById('table-search');
    const toggleColumnsBtn = document.getElementById('toggle-columns');
    const columnsDropdown = document.getElementById('columns-dropdown');
    const columnCheckboxes = columnsDropdown.querySelectorAll('input[type="checkbox"]');
    const quickFilterButtons = document.querySelectorAll('#filter-all, #filter-criticos, #filter-recientes, #filter-pendientes, #filter-validados');
    const showingCount = document.getElementById('showing-count');
    const exportBtn = document.getElementById('exportar-excel');
      // Add these console logs for debugging

    // Toggle dropdown de columnas
    toggleColumnsBtn.addEventListener('click', () => {
      columnsDropdown.classList.toggle('hidden');
    });
    
    // Ocultar dropdown al hacer clic fuera de √©l
    document.addEventListener('click', (event) => {
      if (!toggleColumnsBtn.contains(event.target) && !columnsDropdown.contains(event.target)) {
        columnsDropdown.classList.add('hidden');
      }
    });
    
    // Manejo de visibilidad de columnas
    columnCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        const columnName = checkbox.getAttribute('data-column');
        const columnIndex = getColumnIndexByName(columnName);
        
        if (columnIndex > -1) {
          const cells = table.querySelectorAll(`tr > :nth-child(${columnIndex + 1})`);
          cells.forEach(cell => {
            cell.style.display = checkbox.checked ? '' : 'none';
          });
        }
      });
    });
    
    // Helper para obtener √≠ndice de columna por nombre
    function getColumnIndexByName(name) {
      const headers = Array.from(table.querySelectorAll('thead th'));
      return headers.findIndex(header => {
        const sortAttr = header.getAttribute('data-sort');
        return sortAttr && sortAttr.includes(name);
      });
    }
    
    // Funci√≥n de b√∫squeda en tabla
    searchInput.addEventListener('input', filterTable);
    
    // Variable global para controlar si los filtros deben permanecer visibles
    window.keepFiltersVisible = false;
    
    // Filtros r√°pidos
    quickFilterButtons.forEach(button => {
      button.addEventListener('click', () => {
        // Reiniciar estado de botones
        quickFilterButtons.forEach(btn => {
          btn.classList.remove('bg-[color:var(--accent-blue)]', 'text-white');
          btn.classList.add('bg-[color:var(--bg-card-hover)]', 'text-[color:var(--text-primary)]');
        });
        
        // Aplicar estilo al bot√≥n seleccionado
        button.classList.remove('bg-[color:var(--bg-card-hover)]', 'text-[color:var(--text-primary)]');
        button.classList.add('bg-[color:var(--accent-blue)]', 'text-white');
        
        // Verificar si la secci√≥n de filtros est√° visible antes de aplicar el filtro
        const filtersSection = document.getElementById('filters-section');
        const filtersWereVisible = !filtersSection.classList.contains('hidden');
        
        // Aplicar filtro seg√∫n el bot√≥n y guardar el estado actual
        if (button.id === 'filter-all') {
          // Para "Todos", mostramos todas las filas
          rows.forEach(row => { row.classList.remove('hidden'); });
          
          // Actualizar el select de estado en el formulario si existe
          const estadoSelect = document.getElementById('estado');
          if (estadoSelect) {
            estadoSelect.value = 'todos';
          }
        } else if (button.id === 'filter-criticos') {
          // Para "Cr√≠ticos", filtramos por el atributo data-critico
          rows.forEach(row => {
            const isCritical = row.getAttribute('data-critico') === '1';
            row.classList.toggle('hidden', !isCritical);
          });
        } else if (button.id === 'filter-recientes') {
          // Para "Recientes", filtramos por d√≠as menor a 30
          rows.forEach(row => {
            const dias = parseInt(row.getAttribute('data-dias')) || 0;
            row.classList.toggle('hidden', dias > 30);
          });
        } else if (button.id === 'filter-pendientes') {
          // Para "Pendientes", ocultamos estados validado o pagado
          rows.forEach(row => {
            const estado = row.getAttribute('data-estado') || '';
            row.classList.toggle('hidden', estado === 'validado' || estado === 'pagado');
          });
          
          // Actualizar el select de estado en el formulario si existe
          const estadoSelect = document.getElementById('estado');
          if (estadoSelect) {
            estadoSelect.value = 'pendientes';
          }
        } else if (button.id === 'filter-validados') {
          // Para "Validados", mostramos solo estado validado
          rows.forEach(row => {
            const estado = (row.getAttribute('data-estado') || '').toLowerCase();
            row.classList.toggle('hidden', estado !== 'validado');
          });
          
          // Actualizar el select de estado en el formulario si existe
          const estadoSelect = document.getElementById('estado');
          if (estadoSelect) {
            estadoSelect.value = 'validado';
          }
        }
        
        // Mantener los filtros visibles si ya estaban visibles
        if (filtersWereVisible) {
          // Asegurarnos de que los filtros permanezcan visibles
          if (filtersSection.classList.contains('hidden')) {
            // Si se ocultaron por alguna raz√≥n, mostrarlos de nuevo
            window.toggleFilters();
          }
        }
        
        updateShowingCount();
      });
    });
    
    function filterTable() {
      const searchTerm = searchInput.value.toLowerCase();
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const isMatch = text.includes(searchTerm);
        
        row.classList.toggle('hidden', !isMatch);
      });
      
      updateShowingCount();
    }
    
    // === PAGINACI√ìN ===
    let currentPage = 1;
    let pageSize = 10;
    let filteredRows = [...rows]; // Filas despu√©s de aplicar filtros
    
    // Elementos de paginaci√≥n
    const pageSizeSelect = document.getElementById('page-size');
    const prevPageBtn = document.getElementById('prev-page');
    const nextPageBtn = document.getElementById('next-page');
    const pageNumbersContainer = document.getElementById('page-numbers');
    const gotoPageInput = document.getElementById('goto-page');
    const gotoPageBtn = document.getElementById('goto-page-btn');
    const showingFrom = document.getElementById('showing-from');
    const showingTo = document.getElementById('showing-to');
    const totalCount = document.getElementById('total-count');
    const filteredInfo = document.getElementById('filtered-info');
    const originalCount = document.getElementById('original-count');
    
    function updatePagination() {
      // Calcular totales
      const totalPages = Math.ceil(filteredRows.length / pageSize);
      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = Math.min(startIndex + pageSize, filteredRows.length);
      
      // Ocultar todas las filas primero
      rows.forEach(row => row.style.display = 'none');
      
      // Mostrar solo las filas de la p√°gina actual
      for (let i = startIndex; i < endIndex; i++) {
        if (filteredRows[i]) {
          filteredRows[i].style.display = '';
        }
      }
      
      // Actualizar informaci√≥n de registros
      showingFrom.textContent = filteredRows.length > 0 ? startIndex + 1 : 0;
      showingTo.textContent = endIndex;
      totalCount.textContent = filteredRows.length;
      
      // Mostrar informaci√≥n de filtrado si es necesario
      if (filteredRows.length < rows.length) {
        filteredInfo.classList.remove('hidden');
        originalCount.textContent = rows.length;
      } else {
        filteredInfo.classList.add('hidden');
      }
      
      // Actualizar botones de navegaci√≥n
      prevPageBtn.disabled = currentPage <= 1;
      nextPageBtn.disabled = currentPage >= totalPages;
      
      // Actualizar n√∫meros de p√°gina
      updatePageNumbers(totalPages);
      
      // Actualizar input de ir a p√°gina
      gotoPageInput.max = totalPages;
      gotoPageInput.placeholder = currentPage.toString();
    }
    
    function updatePageNumbers(totalPages) {
      pageNumbersContainer.innerHTML = '';
      
      if (totalPages <= 1) return;
      
      const maxVisiblePages = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
      
      // Ajustar si estamos cerca del final
      if (endPage - startPage < maxVisiblePages - 1) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }
      
      // Bot√≥n primera p√°gina si es necesario
      if (startPage > 1) {
        const firstPageBtn = createPageButton(1, false);
        pageNumbersContainer.appendChild(firstPageBtn);
        
        if (startPage > 2) {
          const dots = document.createElement('span');
          dots.textContent = '...';
          dots.className = 'px-2 py-1 text-xs text-[color:var(--text-secondary)]';
          pageNumbersContainer.appendChild(dots);
        }
      }
      
      // N√∫meros de p√°gina visibles
      for (let i = startPage; i <= endPage; i++) {
        const pageBtn = createPageButton(i, i === currentPage);
        pageNumbersContainer.appendChild(pageBtn);
      }
      
      // Bot√≥n √∫ltima p√°gina si es necesario
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          const dots = document.createElement('span');
          dots.textContent = '...';
          dots.className = 'px-2 py-1 text-xs text-[color:var(--text-secondary)]';
          pageNumbersContainer.appendChild(dots);
        }
        
        const lastPageBtn = createPageButton(totalPages, false);
        pageNumbersContainer.appendChild(lastPageBtn);
      }
    }
    
    function createPageButton(pageNum, isActive) {
      const button = document.createElement('button');
      button.textContent = pageNum;
      button.className = `px-3 py-1 text-xs border rounded transition-colors ${
        isActive 
          ? 'bg-[color:var(--accent-blue)] text-white border-[color:var(--accent-blue)]'
          : 'bg-[color:var(--bg-card)] text-[color:var(--text-primary)] border-[color:var(--border-color)] hover:bg-[color:var(--bg-highlight)]'
      }`;
      
      button.addEventListener('click', () => goToPage(pageNum));
      return button;
    }
    
    function goToPage(pageNum) {
      const totalPages = Math.ceil(filteredRows.length / pageSize);
      if (pageNum >= 1 && pageNum <= totalPages) {
        currentPage = pageNum;
        updatePagination();
      }
    }
    
    function applyFiltersAndUpdatePagination() {
      // Recopilar filas visibles (no ocultas por filtros)
      filteredRows = rows.filter(row => !row.classList.contains('hidden'));
      
      // Resetear a la primera p√°gina
      currentPage = 1;
      
      // Actualizar paginaci√≥n
      updatePagination();
    }
    
    // Event listeners para paginaci√≥n
    pageSizeSelect.addEventListener('change', () => {
      pageSize = parseInt(pageSizeSelect.value);
      currentPage = 1;
      updatePagination();
    });
    
    prevPageBtn.addEventListener('click', () => {
      if (currentPage > 1) {
        goToPage(currentPage - 1);
      }
    });
    
    nextPageBtn.addEventListener('click', () => {
      const totalPages = Math.ceil(filteredRows.length / pageSize);
      if (currentPage < totalPages) {
        goToPage(currentPage + 1);
      }
    });
    
    gotoPageBtn.addEventListener('click', () => {
      const pageNum = parseInt(gotoPageInput.value);
      if (!isNaN(pageNum)) {
        goToPage(pageNum);
        gotoPageInput.value = '';
      }
    });
    
    gotoPageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        gotoPageBtn.click();
      }
    });
    
    function updateShowingCount() {
      // Esta funci√≥n ahora es manejada por updatePagination()
      applyFiltersAndUpdatePagination();
    }

    // Agregar eventos de clic a los encabezados para ordenar
  headers.forEach(header => {
    header.addEventListener('click', function () {
      const sortBy = this.dataset.sort;               // data-sort
      const asc    = !this.classList.contains('sort-asc');

      // reset clases
      headers.forEach(h => h.classList.remove('sort-asc','sort-desc'));
      this.classList.add(asc ? 'sort-asc' : 'sort-desc');

      sortTable(sortBy, asc);
    });
  });
    
    // Funci√≥n mejorada para ordenar la tabla
 // Funci√≥n mejorada para ordenar la tabla
function sortTable(sortBy, ascending) {
  console.log(`Sorting by ${sortBy}, ascending: ${ascending}`); // Debug line
  
  const rowsToSort = Array.from(tableBody.querySelectorAll('tr'));
  console.log(`Found ${rowsToSort.length} rows to sort`); // Debug line
  
  try {
    rowsToSort.sort((a, b) => {
      let valueA, valueB;
      
      // Correct indices for your table structure
      switch (sortBy) {
        case "proyecto":
          valueA = a.querySelector("td:nth-child(1)").textContent.toLowerCase().trim();
          valueB = b.querySelector("td:nth-child(1)").textContent.toLowerCase().trim();
          break;
          
        case "jefe":
          valueA = a.querySelector("td:nth-child(2)").textContent.toLowerCase().trim();
          valueB = b.querySelector("td:nth-child(2)").textContent.toLowerCase().trim();
          break;
          
        case "cliente":
          valueA = a.querySelector("td:nth-child(3)").textContent.toLowerCase().trim();
          valueB = b.querySelector("td:nth-child(3)").textContent.toLowerCase().trim();
          break;
          
        case "mes":
          valueA = a.querySelector("td:nth-child(4)").textContent.toLowerCase().trim();
          valueB = b.querySelector("td:nth-child(4)").textContent.toLowerCase().trim();
          break;
          
        case "edp":
          valueA = a.querySelector("td:nth-child(5)").textContent.trim();
          valueB = b.querySelector("td:nth-child(5)").textContent.trim();
          break;
          
        case "n-conformidad":
          valueA = a.querySelector("td:nth-child(6)").textContent.trim();
          valueB = b.querySelector("td:nth-child(6)").textContent.trim();
          break;
          
        case "estado":
          valueA = a.querySelector("td:nth-child(7)").textContent.toLowerCase().trim();
          valueB = b.querySelector("td:nth-child(7)").textContent.toLowerCase().trim();
          break;
          
        case "dias":
          valueA = parseInt(a.querySelector("td:nth-child(8)").textContent) || 0;
          valueB = parseInt(b.querySelector("td:nth-child(8)").textContent) || 0;
          break;
          
        case "dias-habiles":
          valueA = parseInt(a.querySelector("td:nth-child(9)").textContent) || 0;
          valueB = parseInt(b.querySelector("td:nth-child(9)").textContent) || 0;
          break;
          
        case "monto-propuesto":
          valueA = parseFloat(a.querySelector("td:nth-child(10)").textContent.replace(/[$,\.]/g, "")) || 0;
          valueB = parseFloat(b.querySelector("td:nth-child(10)").textContent.replace(/[$,\.]/g, "")) || 0;
          break;
          
        case "monto-aprobado":
          valueA = parseFloat(a.querySelector("td:nth-child(11)").textContent.replace(/[$,\.]/g, "")) || 0;
          valueB = parseFloat(b.querySelector("td:nth-child(11)").textContent.replace(/[$,\.]/g, "")) || 0;
          break;
          
        case "critico":
          // Look for the indicator in the Critical column
          valueA = a.querySelector("td:nth-child(12)").textContent.includes("‚óè") ? 1 : 0;
          valueB = b.querySelector("td:nth-child(12)").textContent.includes("‚óè") ? 1 : 0;
          break;
          
        default:
          valueA = a.querySelector("td:first-child").textContent.toLowerCase().trim();
          valueB = b.querySelector("td:first-child").textContent.toLowerCase().trim();
      }

      // Compare values
      if (valueA < valueB) {
        return ascending ? -1 : 1;
      }
      if (valueA > valueB) {
        return ascending ? 1 : -1;
      }
      return 0;
    });

    // Clear table body first
    while (tableBody.firstChild) {
      tableBody.removeChild(tableBody.firstChild);
    }
    
    // Append sorted rows
    rowsToSort.forEach((row) => {
      tableBody.appendChild(row);
    });
    
    // Actualizar las filas filtradas y la paginaci√≥n despu√©s del ordenamiento
    filteredRows = rows.filter(row => !row.classList.contains('hidden'));
    updatePagination();
    
    console.log("Sorting completed successfully");
  } catch (error) {
    console.error("Error during sorting:", error);
  }
}
    // Make rows clickable for detail view
    rows.forEach(row => {
      // Add visual indication that rows are clickable
      row.classList.add('cursor-pointer', 'hover:shadow-md', 'transition-all');
      
      // Get the EDP number for this row
      const edpNumber = row.getAttribute('data-edp');
      
      // Make the entire row clickable except for elements that already have click handlers
      // Make the entire row clickable except for elements that already have click handlers
row.addEventListener('click', function (e) {
  // Don't trigger if clicking on an element that's already a link or button
  if (e.target.closest('a, button')) {
    return;
  }

  // Show modal with loading state
  document.getElementById('edpModalOverlay').classList.remove('hidden');
  document.getElementById('edpModalContent').innerHTML = `
    <div class="flex justify-center items-center h-64">
      <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-[color:var(--accent-blue)]"></div>
    </div>
  `;

  // Load EDP details via AJAX
  fetch(`/controller/api/edp-details/${edpNumber}`)
    .then(response => response.json())
    .then(data => {
      renderEdpModalContent(data);
    })
    .catch(error => {
      document.getElementById('edpModalContent').innerHTML = `
        <div class="text-center p-8">
          <div class="text-[color:var(--accent-red)] text-5xl mb-4">‚ö†Ô∏è</div>
          <h3 class="text-xl font-bold mb-2">Error al cargar datos</h3>
          <p class="mb-4">${error.message || 'No se pudieron cargar los detalles del EDP'}</p>
          <button class="btn-primary" onclick="document.getElementById('edpModalOverlay').classList.add('hidden')">
            Cerrar
          </button>
        </div>
      `;
    });
});

// Tooltip para indicar que la fila es clickeable
row.setAttribute('title', 'Haz clic para ver detalles del EDP');

// Efecto visual en hover
row.addEventListener('mouseenter', function () {
  this.classList.add('bg-[color:var(--bg-highlight)]');
});
row.addEventListener('mouseleave', function () {
  if (
    !this.classList.contains('data-table-row-critical') &&
    !this.classList.contains('data-table-row-validated')
  ) {
    this.classList.remove('bg-[color:var(--bg-highlight)]');
  }
});

// Exportar a CSV - Soluci√≥n definitiva con modal de selecci√≥n
const exportBtn = document.getElementById('exportar-excel');

// Usamos una t√©cnica m√°s robusta: eliminamos el listener y lo a√±adimos como atributo
if (exportBtn) {
  // Eliminar todos los event listeners existentes
  exportBtn.replaceWith(exportBtn.cloneNode(true));
  
  // Obtener la nueva referencia despu√©s del clonado
  const newExportBtn = document.getElementById('exportar-excel');
  
  // Aplicar un solo event listener
  newExportBtn.addEventListener('click', function() {
    // Prevenir m√∫ltiples clics r√°pidos
    if (this.getAttribute('data-processing') === 'true') {
      return;
    }
    
    // Crear el modal de selecci√≥n
    const modalHTML = `
      <div id="export-modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center animate__animated animate__fadeIn">
        <div class="bg-[color:var(--bg-card)] rounded-xl shadow-lg p-6 w-full max-w-md animate__animated animate__zoomIn">
          <h3 class="text-lg font-bold mb-4">Exportar datos a CSV</h3>
          <p class="text-[color:var(--text-secondary)] mb-5">Seleccione qu√© datos desea exportar:</p>
          
          <div class="grid grid-cols-1 gap-3 mb-6">
            <button id="export-all" class="btn-outline flex items-center justify-between p-4 border border-[color:var(--border-color)] rounded-lg hover:bg-[color:var(--bg-highlight)] transition-colors">
              <div class="flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-[color:var(--accent-blue)]" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" />
                </svg>
                <div class="text-left">
                  <div class="font-medium">Todos los datos</div>
                  <div class="text-xs text-[color:var(--text-secondary)]">Exportar todos los registros</div>
                </div>
              </div>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[color:var(--text-secondary)]" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
              </svg>
            </button>
            
            <button id="export-filtered" class="btn-outline flex items-center justify-between p-4 border border-[color:var(--border-color)] rounded-lg hover:bg-[color:var(--bg-highlight)] transition-colors">
              <div class="flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-[color:var(--accent-green)]" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" />
                </svg>
                <div class="text-left">
                  <div class="font-medium">Datos filtrados</div>
                  <div class="text-xs text-[color:var(--text-secondary)]">Exportar registros visibles (${document.querySelectorAll('#edp-table tbody tr:not(.hidden)').length})</div>
                </div>
              </div>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[color:var(--text-secondary)]" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
              </svg>
            </button>
          </div>
          
          <div class="flex justify-end border-t border-[color:var(--border-color-subtle)] pt-4">
            <button id="cancel-export" class="px-4 py-2 text-[color:var(--text-secondary)] hover:text-[color:var(--text-primary)] transition-colors">
              Cancelar
            </button>
          </div>
        </div>
      </div>
    `;
    
    // Insertar el modal en el DOM
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Obtener referencias a los elementos del modal
    const modalOverlay = document.getElementById('export-modal-overlay');
    const exportAllBtn = document.getElementById('export-all');
    const exportFilteredBtn = document.getElementById('export-filtered');
    const cancelExportBtn = document.getElementById('cancel-export');
    
    // Funci√≥n para cerrar el modal
    function closeModal() {
      modalOverlay.classList.remove('animate__fadeIn');
      modalOverlay.classList.add('animate__fadeOut');
      modalOverlay.querySelector('div').classList.remove('animate__zoomIn');
      modalOverlay.querySelector('div').classList.add('animate__zoomOut');
      
      setTimeout(() => {
        modalOverlay.remove();
      }, 300);
    }
    
    // Manejar clic en Cancelar
    cancelExportBtn.addEventListener('click', closeModal);
    
    // Manejar clic fuera del modal
    modalOverlay.addEventListener('click', function(e) {
      if (e.target === modalOverlay) {
        closeModal();
      }
    });
    
// Funci√≥n para iniciar la exportaci√≥n
function startExport(exportAll = false) {
  // Cerrar el modal
  closeModal();
  
  // Marcar como en proceso
  newExportBtn.setAttribute('data-processing', 'true');
  newExportBtn.disabled = true;
  newExportBtn.innerHTML = `
    <svg class="animate-spin h-4 w-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    Exportando...
  `;
    // Funci√≥n para restaurar el bot√≥n a su estado original
  function restoreButton() {
    console.log("Restaurando bot√≥n de exportaci√≥n");
    setTimeout(() => {
      newExportBtn.disabled = false;
      newExportBtn.setAttribute('data-processing', 'false');
      newExportBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg>
        Exportar a CSV
      `;
    }, 500);
  }
  
    // Si exportamos todos los datos, hacemos una petici√≥n al servidor
  if (exportAll) {
    fetch('/controller/api/export-all-csv')
      .then(response => {
        if (!response.ok) {
          throw new Error('Error en la respuesta del servidor: ' + response.status);
        }
        return response.blob();
      })
      .then(blob => {
        try {
          // Crear y descargar archivo
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          
          // Nombre del archivo con timestamp
          const today = new Date().toISOString().slice(0, 10);
          link.download = `edp_export_completo_${today}.csv`;
          
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
          
          // Mostrar notificaci√≥n de √©xito
          showToast('Archivo CSV completo exportado correctamente', 'success');
        } catch (err) {
          console.error("Error procesando blob:", err);
          showToast('Error al procesar el archivo', 'error');
        } finally {
          // Siempre restaurar el bot√≥n
          restoreButton();
        }
      })
      .catch(error => {
        console.error('Error al exportar datos completos:', error);
        showToast('Error al exportar los datos: ' + error.message, 'error');
        restoreButton();
      });
  } else {
    // Exportar solo los datos filtrados (desde la interfaz)
    setTimeout(() => {
      try {
        // Generar contenido CSV
        let csvContent = "data:text/csv;charset=utf-8,";
        
        // Obtener cabeceras visibles
        const visibleHeaders = Array.from(table.querySelectorAll('thead th'))
          .filter(th => th.style.display !== 'none')
          .map(th => `"${th.textContent.trim().replace(/"/g, '""')}"`);
        
        csvContent += visibleHeaders.join(',') + '\r\n';
        
        // Exportar solo filas visibles (filtradas)
        const rowsToExport = Array.from(tableBody.querySelectorAll('tr:not(.hidden)'));
        
        // Agregar datos de filas
        rowsToExport.forEach(row => {
          const rowData = Array.from(row.querySelectorAll('td'))
            .filter((cell, index) => {
              const header = table.querySelector(`thead th:nth-child(${index + 1})`);
              return header && header.style.display !== 'none';
            })
            .map(cell => `"${cell.textContent.trim().replace(/"/g, '""')}"`);
          
          csvContent += rowData.join(',') + '\r\n';
        });
        
        // Usar Blob para mejor manejo de archivos grandes
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        
        // Crear enlace de descarga
        const link = document.createElement('a');
        link.setAttribute('href', url);
        
        // Nombre del archivo con fecha actual
        const today = new Date().toISOString().slice(0, 10);
        link.setAttribute('download', `edp_export_filtrado_${today}.csv`);
        
        // Descargar el archivo
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Liberar URL
        URL.revokeObjectURL(url);
        
        // Mostrar notificaci√≥n de √©xito
        showToast('Archivo CSV filtrado exportado correctamente', 'success');
      } catch (error) {
        console.error('Error al exportar datos filtrados:', error);
        showToast('Hubo un error al exportar los datos: ' + error.message, 'error');
      } finally {
        // Siempre restaurar el bot√≥n, incluso si hay un error
        restoreButton();
      }
    }, 300);
  }
}
    
    // Manejar clic en Exportar Todo
    exportAllBtn.addEventListener('click', () => startExport(true));
    
    // Manejar clic en Exportar Filtrado
    exportFilteredBtn.addEventListener('click', () => startExport(false));
  });
}
    
    // Initialize the table with sorting by days in descending order
  const diasHeader = table.querySelector('th[data-sort="dias"]');
  if (diasHeader) {
    diasHeader.classList.add('sort-desc');
    sortTable('dias', false);          // false ‚Üí descendente
  }
  
  // Inicializar paginaci√≥n
  updatePagination();
  
  
})
});
 // Cierre del addEventListener - NO MOVER ESTA L√çNEA

</script>

<!-- Script para el toggle de filtros -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggleFiltersBtn = document.getElementById('toggle-filters-btn');
    const filtersSection = document.getElementById('filters-section');
    const filterText = document.getElementById('filter-text');
    const filterChevron = document.getElementById('filter-chevron');
    
    // Variable para controlar la visibilidad de los filtros
    window.filtersVisible = false;
    
    // Funci√≥n para mostrar/ocultar filtros
    window.toggleFilters = function() {
        window.filtersVisible = !window.filtersVisible;
        window.keepFiltersVisible = window.filtersVisible;
        
        if (window.filtersVisible) {
            // Mostrar filtros
            filtersSection.classList.remove('hidden');
            filtersSection.style.opacity = '0';
            filtersSection.style.transform = 'translateY(-10px)';
            
            // Animaci√≥n de entrada
            setTimeout(() => {
                filtersSection.style.transition = 'all 0.3s ease-out';
                filtersSection.style.opacity = '1';
                filtersSection.style.transform = 'translateY(0)';
            }, 10);
            
            // Actualizar bot√≥n
            filterText.textContent = 'Ocultar filtros';
            filterChevron.style.transform = 'rotate(180deg)';
            toggleFiltersBtn.classList.add('bg-blue-700');
            
        } else {
            // Ocultar filtros
            filtersSection.style.transition = 'all 0.3s ease-in';
            filtersSection.style.opacity = '0';
            filtersSection.style.transform = 'translateY(-10px)';
            
            setTimeout(() => {
                filtersSection.classList.add('hidden');
            }, 300);
            
            // Actualizar bot√≥n
            filterText.textContent = 'Mostrar filtros';
            filterChevron.style.transform = 'rotate(0deg)';
            toggleFiltersBtn.classList.remove('bg-blue-700');
        }
    }
    
    // Event listener para el bot√≥n de filtros
    toggleFiltersBtn.addEventListener('click', window.toggleFilters);
    
    // NO auto-mostrar filtros por defecto al cargar la p√°gina
    // {% if filtros.mes or filtros.jefe_proyecto or filtros.cliente or (filtros.estado and filtros.estado != 'pendientes' and filtros.estado != 'todos') %}
    //     setTimeout(toggleFilters, 100);
    // {% endif %}
    
    // Manejar el env√≠o del formulario de filtros para mantener el estado
    const filterForm = document.querySelector('form[method="GET"]');
    if (filterForm) {
        filterForm.addEventListener('submit', function(e) {
            // Guardar el estado de visibilidad actual en localStorage antes de enviar el formulario
            localStorage.setItem('filtersVisible', window.filtersVisible);
        });
    }
    
    // Restaurar estado de visibilidad al cargar la p√°gina si hay filtros personalizados
    // Solo consideramos filtros personalizados si hay valores espec√≠ficos que no sean "todos", None, o valores por defecto
    const hasCustomFilters = {{ 1 if (filtros.mes and filtros.mes != '' and filtros.mes != 'todos') or 
                                    (filtros.jefe_proyecto and filtros.jefe_proyecto != '' and filtros.jefe_proyecto != 'todos') or 
                                    (filtros.cliente and filtros.cliente != '' and filtros.cliente != 'todos') or 
                                    (filtros.estado and filtros.estado != '' and filtros.estado != 'todos' and filtros.estado != 'pendientes') else 0 }};
    const savedVisibility = localStorage.getItem('filtersVisible');
    
    if (savedVisibility === 'true' && hasCustomFilters) {
        // Si hab√≠a filtros visibles en la sesi√≥n anterior y hay filtros personalizados, restaurar
        setTimeout(window.toggleFilters, 100);
    }
});
</script>

<!-- Estilos para animaciones -->
<style>
#filters-section {
    transition: all 0.3s ease-out;
}

#filter-chevron {
    transition: transform 0.3s ease;
}
.btn-primary {
  @apply bg-[color:var(--accent-blue)] hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center;
}
</style>
</div>
{% endblock %}