{% extends "base.html" %} {% block title %}Enterprise Manager Dashboard - EDP
Manager{% endblock %} {% block content %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/management/manager-dashboard.css') }}" />
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/management/email-buttons.css') }}" />
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/management/aging-modal.css') }}" />
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/management/critical-alerts-modal.css') }}" />

<!-- Include Chart.js and dashboard JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="{{ url_for('static', filename='js/management/dashboard-charts.js') }}"></script>
<script src="{{ url_for('static', filename='js/management/dashboard-modals.js') }}"></script>
<script src="{{ url_for('static', filename='js/management/dashboard-main.js') }}"></script>
<script src="{{ url_for('static', filename='js/management/critical-alerts-modal.js') }}"></script>

<!-- Pass data to JavaScript -->
<script>
  // Make data available to dashboard.js
  window.kpisData = {{ kpis.__dict__ | tojson if kpis else '{}' }};
  window.chartsData = {{ charts | tojson if charts else '{}' }};
  window.equipoData = {{ equipo_operacional | tojson if equipo_operacional else '[]' }};
  window.alertasData = {{ alertas | tojson if alertas else '[]' }};
</script>

<div class="dashboard-container">
  <!-- Analytics Header -->
  <header class="analytics-header">
    <div class="analytics-header-content">
      <div class="analytics-header-brand">
        <h1>Operations Visual Intelligence</h1>
        <div class="analytics-header-status">
          <div class="analytics-status-indicator">
            <div class="status-dot status-active"></div>
            <span class="status-text">Sistema Activo ‚Ä¢ √öltima actualizaci√≥n: <span id="last-update">{{ moment().format('HH:mm') if moment else 'Ahora' }}</span></span>
          </div>
          <div class="timestamp">
            {{ current_user.nombre if current_user else 'Manager' }} ‚Ä¢
            <span id="current-time">Loading...</span>
          </div>
        </div>
      </div>
      
      <!-- Real-time Management Metrics -->
      <div class="analytics-header-metrics">
        <div class="analytics-header-metric" data-tooltip="dso-tooltip">
          <div class="analytics-metric-value {{ 'critical' if kpis.dso_actual and kpis.dso_actual > 40 else 'warning' if kpis.dso_actual and kpis.dso_actual > 30 else 'positive' if kpis.dso_actual and kpis.dso_actual > 0 else 'neutral' }}">
            {% if kpis and kpis.dso_actual and kpis.dso_actual > 0 %}
              {{ "{:.1f}".format(kpis.dso_actual) }}
            {% else %}
              --
            {% endif %}
          </div>
          <div class="analytics-metric-label">DSO D√çAS</div>
          <!-- DSO Tooltip -->
          <div class="metric-tooltip" id="dso-tooltip">
            <div class="tooltip-header">
              <span class="tooltip-title">Days Sales Outstanding</span>
              <span class="tooltip-formula">Promedio d√≠as entre facturaci√≥n y cobro</span>
            </div>
            <div class="tooltip-content">
              <div class="tooltip-metric">
                <span class="tooltip-label">Target objetivo:</span>
                <span class="tooltip-value">‚â§ 35 d√≠as</span>
              </div>
              <div class="tooltip-metric">
                <span class="tooltip-label">Benchmark industria:</span>
                <span class="tooltip-value">30-45 d√≠as</span>
              </div>
              <div class="tooltip-metric">
                <span class="tooltip-label">Per√≠odo anterior:</span>
                <span class="tooltip-value">
                  {% if kpis and kpis.dso_anterior and kpis.dso_anterior > 0 %}
                    {{ "{:.1f}".format(kpis.dso_anterior) }} d√≠as
                  {% else %}
                    Sin datos
                  {% endif %}
                </span>
              </div>
              <div class="tooltip-impact">
                <span class="tooltip-impact-label">Impacto por d√≠a de retraso:</span>
                <span class="tooltip-impact-value">-35k CLP flujo diario</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="analytics-header-metric" data-tooltip="impact-tooltip">
          <div class="analytics-metric-value {{ 'positive' if kpis and kpis.dso_actual and kpis.dso_actual <= 35 else 'critical' if kpis and kpis.dso_actual and kpis.dso_actual > 35 else 'neutral' }}">
            {% if kpis and kpis.dso_actual and kpis.dso_actual > 0 %}
              {{ "{:+.0f}k".format((kpis.dso_actual - 35) * -35) }}
            {% else %}
              --
            {% endif %}
          </div>
          <div class="analytics-metric-label">CLP/D√≠a Impacto</div>
          <!-- Impact Tooltip -->
          <div class="metric-tooltip" id="impact-tooltip">
            <div class="tooltip-header">
              <span class="tooltip-title">Impacto Financiero Diario</span>
              <span class="tooltip-formula">P√©rdida/ganancia por desviaci√≥n DSO</span>
            </div>
            <div class="tooltip-content">
              <div class="tooltip-metric">
                <span class="tooltip-label">C√°lculo base:</span>
                <span class="tooltip-value">(DSO actual - 35d) √ó -35k CLP</span>
              </div>
              <div class="tooltip-metric">
                <span class="tooltip-label">Impacto mensual:</span>
                <span class="tooltip-value">
                  {% if kpis and kpis.dso_actual and kpis.dso_actual > 0 %}
                    {{ "{:+.0f}k".format((kpis.dso_actual - 35) * -35 * 30) }} CLP
                  {% else %}
                    Sin datos
                  {% endif %}
                </span>
              </div>
              <div class="tooltip-metric">
                <span class="tooltip-label">Costo oportunidad:</span>
                <span class="tooltip-value">Flujo de caja operacional</span>
              </div>
              <div class="tooltip-impact">
                <span class="tooltip-impact-label">Objetivo:</span>
                <span class="tooltip-impact-value">Mantener DSO ‚â§ 35 d√≠as</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="analytics-header-metric" data-tooltip="forecast-tooltip">
          <div class="analytics-metric-value {{ 'positive' if kpis and kpis.forecast_7_dias and kpis.forecast_7_dias > 0 else 'neutral' }}">
            {% if kpis and kpis.forecast_7_dias and kpis.forecast_7_dias > 0 %}
              {% set forecast_m = kpis.forecast_7_dias / 1000000 %}
              {{ "{:.1f}M".format(forecast_m) }}
            {% else %}
              --
            {% endif %}
          </div>
          <div class="analytics-metric-label">FORECAST 7D</div>
          <!-- Forecast Tooltip -->
          <div class="metric-tooltip" id="forecast-tooltip">
            <div class="tooltip-header">
              <span class="tooltip-title">Proyecci√≥n Ingresos 7 D√≠as</span>
              <span class="tooltip-formula">Suma EDPs con fecha cobro pr√≥xima</span>
            </div>
            <div class="tooltip-content">
              <div class="tooltip-metric">
                <span class="tooltip-label">Metodolog√≠a:</span>
                <span class="tooltip-value">EDPs con probabilidad >70%</span>
              </div>
              <div class="tooltip-metric">
                <span class="tooltip-label">Confianza promedio:</span>
                <span class="tooltip-value">
                  {% if kpis and kpis.forecast_confidence and kpis.forecast_confidence > 0 %}
                    {{ "{:.0f}".format(kpis.forecast_confidence) }}%
                  {% else %}
                    Sin datos
                  {% endif %}
                </span>
              </div>
              <div class="tooltip-metric">
                <span class="tooltip-label">Per√≠odo anterior:</span>
                <span class="tooltip-value">
                  {% if kpis and kpis.forecast_7_dias_anterior and kpis.forecast_7_dias_anterior > 0 %}
                    {% set forecast_anterior_m = kpis.forecast_7_dias_anterior / 1000000 %}
                    {{ "{:.1f}M".format(forecast_anterior_m) }} CLP
                  {% else %}
                    Sin datos
                  {% endif %}
                </span>
              </div>
              <div class="tooltip-impact">
                <span class="tooltip-impact-label">Actualizaci√≥n:</span>
                <span class="tooltip-impact-value">Tiempo real ‚Ä¢ Cada 15 min</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="analytics-header-metric" data-tooltip="meta-tooltip">
          <div class="analytics-metric-value {{ 'positive' if kpis and kpis.progreso_objetivo and kpis.progreso_objetivo > 70 else 'warning' if kpis and kpis.progreso_objetivo and kpis.progreso_objetivo > 50 else 'critical' if kpis and kpis.progreso_objetivo and kpis.progreso_objetivo > 0 else 'neutral' }}">
            {% if kpis and kpis.progreso_objetivo and kpis.progreso_objetivo > 0 %}
              {{ "{:.0f}%".format(kpis.progreso_objetivo) }}
            {% else %}
              --
            {% endif %}
          </div>
          <div class="analytics-metric-label">META MENSUAL</div>
          <!-- Meta Tooltip -->
          <div class="metric-tooltip" id="meta-tooltip">
            <div class="tooltip-header">
              <span class="tooltip-title">Progreso Meta Cobro Mensual</span>
              <span class="tooltip-formula">Cobrado vs objetivo mensual</span>
            </div>
            <div class="tooltip-content">
              <div class="tooltip-metric">
                <span class="tooltip-label">Meta mensual:</span>
                <span class="tooltip-value">
                  {% if kpis and kpis.objetivo_anual and kpis.objetivo_anual > 0 %}
                    {{ "{:.1f}M".format(kpis.objetivo_anual / 12) }} CLP
                  {% else %}
                    Sin definir
                  {% endif %}
                </span>
              </div>
              <div class="tooltip-metric">
                <span class="tooltip-label">Cobrado a la fecha:</span>
                <span class="tooltip-value">
                  {% if kpis and kpis.ingresos_totales and kpis.ingresos_totales > 0 %}
                    {{ "{:.1f}M".format(kpis.ingresos_totales) }} CLP
                  {% else %}
                    Sin datos
                  {% endif %}
                </span>
              </div>
              <div class="tooltip-metric">
                <span class="tooltip-label">D√≠as restantes:</span>
                <span class="tooltip-value">{{ kpis.days_remaining if kpis and kpis.days_remaining else 0 }} d√≠as</span>
              </div>
              <div class="tooltip-impact">
                <span class="tooltip-impact-label">Requerido diario:</span>
                <span class="tooltip-impact-value">
                  {% if kpis and kpis.meta_gap and kpis.meta_gap > 0 and kpis.days_remaining and kpis.days_remaining > 0 %}
                    {{ "{:.1f}M".format(kpis.meta_gap / kpis.days_remaining) }} CLP/d√≠a
                  {% else %}
                    Meta cumplida
                  {% endif %}
                </span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="analytics-header-metric">
          <div class="analytics-metric-value {{ 'positive' if kpis and kpis.forecast_confidence and kpis.forecast_confidence > 70 else 'warning' if kpis and kpis.forecast_confidence and kpis.forecast_confidence > 50 else 'neutral' }}">
            {% if kpis and kpis.forecast_confidence and kpis.forecast_confidence > 0 %}
              {{ "{:.0f}%".format(kpis.forecast_confidence) }}
            {% else %}
              --
            {% endif %}
          </div>
          <div class="analytics-metric-label">CONFIANZA</div>
        </div>
      </div>
    </div>
  </header>

  <!-- Executive KPIs Grid - Dashboard.tsx Style -->
  <section class="executive-kpis-grid">
    <!-- TOTAL RECEIVABLES -->
    <div class="executive-kpi-card primary" onclick="showTotalReceivablesModal()">
      <div class="kpi-header-executive">
        <div class="kpi-icon-container">
          <div class="kpi-icon primary">$</div>
          <div class="kpi-label-executive">TOTAL RECEIVABLES</div>
        </div>
        <div class="kpi-trend-executive {{ 'positive' if kpis and kpis.receivables_change and kpis.receivables_change > 0 else 'negative' if kpis and kpis.receivables_change and kpis.receivables_change < 0 else 'stable' }}">
          {% if kpis and kpis.receivables_change and kpis.receivables_change != 0 %}
            {{ "+{:.1f}%".format(kpis.receivables_change) if kpis.receivables_change > 0 else "{:.1f}%".format(kpis.receivables_change) }}
          {% else %}
            +0.0%
          {% endif %}
        </div>
      </div>
      <div class="kpi-main-value">
        {% set total_receivables = 0 %}
        {% if kpis and kpis.total_monto_propuesto %}
          {% set total_receivables = kpis.total_monto_propuesto / 1000000 %}
        {% endif %}
        ${{ "{:.1f}M".format(total_receivables) if total_receivables > 0 else "0.0M" }}
      </div>
      <div class="kpi-subtitle-executive">
        {% if kpis and kpis.receivables_change and kpis.receivables_change != 0 %}
          {{ "+{:.1f}%".format(kpis.receivables_change) if kpis.receivables_change > 0 else "{:.1f}%".format(kpis.receivables_change) }} vs LAST PERIOD
        {% else %}
          +0.0% vs LAST PERIOD
        {% endif %}
      </div>
    </div>

    <!-- CRITICAL (+90D) -->
    <div class="executive-kpi-card critical" onclick="showCriticalReceivablesModal()">
      <div class="kpi-header-executive">
        <div class="kpi-icon-container">
          <div class="kpi-icon critical">‚ö†</div>
          <div class="kpi-label-executive">CRITICAL (+90D)</div>
        </div>
        <div class="kpi-trend-executive critical">
          {% if kpis and kpis.critical_percentage and kpis.critical_percentage > 0 %}
            {{ "{:.1f}%".format(kpis.critical_percentage) }}
          {% else %}
            0.0%
          {% endif %}
        </div>
      </div>
      <div class="kpi-main-value critical">
        {% set critical_amount = 0 %}
        {% if kpis and kpis.critical_amount %}
          {% set critical_amount = kpis.critical_amount / 1000000 %}
        {% endif %}
        ${{ "{:.1f}M".format(critical_amount) if critical_amount > 0 else "0.0M" }}
      </div>
      <div class="kpi-subtitle-executive">
        {% if kpis and kpis.critical_percentage and kpis.critical_percentage > 0 %}
          {{ "{:.1f}%".format(kpis.critical_percentage) }} OF TOTAL
        {% else %}
          0.0% OF TOTAL
        {% endif %}
      </div>
    </div>

    <!-- ACTIVE ACCOUNTS -->
    <div class="executive-kpi-card info" onclick="showActiveAccountsModal()">
      <div class="kpi-header-executive">
        <div class="kpi-icon-container">
          <div class="kpi-icon info">‚óâ</div>
          <div class="kpi-label-executive">ACTIVE ACCOUNTS</div>
        </div>
        <div class="kpi-selector-executive">
          <select id="accountTypeSelector" onchange="switchAccountView(this.value)" class="account-type-selector">
            <option value="clientes">BY CLIENT</option>
            <option value="jefes" selected>BY PM</option>
            <option value="proyectos">BY PROJECT</option>
          </select>
        </div>
      </div>
      <div class="kpi-main-value info">
        <span id="activeAccountsCount">
          {% if equipo_operacional and equipo_operacional|length > 0 %}
            {{ equipo_operacional|length }}
          {% else %}
            0
          {% endif %}
        </span>
      </div>
      <div class="kpi-subtitle-executive">
        <span id="activeAccountsSubtitle">
          {% set total_edps = 0 %}
          {% if kpis and kpis.total_edps_activos %}
            {% set total_edps = kpis.total_edps_activos %}
          {% endif %}
          {{ total_edps }} OPEN INVOICES
        </span>
      </div>
    </div>

    <!-- AVG COLLECTION -->
    <div class="executive-kpi-card {{ 'warning' if kpis and kpis.dso_actual and kpis.dso_actual > 30 else 'success' if kpis and kpis.dso_actual and kpis.dso_actual > 0 else 'neutral' }}" onclick="showCollectionPerformanceModal()">
      <div class="kpi-header-executive">
        <div class="kpi-icon-container">
          <div class="kpi-icon {{ 'warning' if kpis and kpis.dso_actual and kpis.dso_actual > 30 else 'success' if kpis and kpis.dso_actual and kpis.dso_actual > 0 else 'neutral' }}">‚è±</div>
          <div class="kpi-label-executive">AVG COLLECTION</div>
        </div>
        <div class="kpi-trend-executive {{ 'negative' if kpis and kpis.dso_vs_target and kpis.dso_vs_target > 0 else 'positive' if kpis and kpis.dso_vs_target and kpis.dso_vs_target < 0 else 'stable' }}">
          {% if kpis and kpis.dso_vs_target and kpis.dso_vs_target != 0 %}
            {{ "+{:.0f}D".format(kpis.dso_vs_target) if kpis.dso_vs_target > 0 else "{:.0f}D".format(kpis.dso_vs_target) }}
          {% else %}
            +0D
          {% endif %}
        </div>
      </div>
      <div class="kpi-main-value">
        {% if kpis and kpis.dso_actual and kpis.dso_actual > 0 %}
          {{ "{:.0f}D".format(kpis.dso_actual) }}
        {% else %}
          --D
        {% endif %}
      </div>
      <div class="kpi-subtitle-executive">
        {% if kpis and kpis.dso_vs_target and kpis.dso_vs_target != 0 %}
          {{ "+{:.0f}D".format(kpis.dso_vs_target) if kpis.dso_vs_target > 0 else "{:.0f}D".format(kpis.dso_vs_target) }} vs TARGET
        {% else %}
          +0D vs TARGET
        {% endif %}
      </div>
    </div>
  </section>
    <!-- ALERTAS OPERACIONALES - M√ÅXIMO 3, JERARQUIZADAS -->
  <section class="alerts-priority-banner">
    <div class="alerts-header-clean">
      <h3 class="alerts-title-clean">Alertas Operacionales</h3>
      <button class="critical-alerts-manual-btn" onclick="showCriticalAlertsModal()" title="Ver Alertas Cr√≠ticas">
        <span class="btn-icon">ALERTAS</span>
        <span class="btn-text">CR√çTICAS</span>
      </button>
    </div>
    <div class="alerts-hierarchy">
      <!-- ALERTA 1: Solo si hay EDPs cr√≠ticos reales -->
      {% if kpis and kpis.critical_projects_count and kpis.critical_projects_count > 0 %}
      <div class="alert-primary critical" onclick="showCriticalEDPsModal()">
        <div class="alert-severity critical">CR√çTICO</div>
        <div class="alert-content-primary">
          <div class="alert-title-primary">{{ kpis.critical_projects_count }} EDPs Vencidos</div>
          <div class="alert-subtitle">
            {% if kpis.critical_amount and kpis.critical_amount > 0 %}
              {% set critical_amount_m = kpis.critical_amount / 1000000 %}
              ${{ "{:.1f}".format(critical_amount_m) }}M CLP en riesgo ‚Ä¢ >90 d√≠as
            {% else %}
              M√°s de 90 d√≠as pendientes
            {% endif %}
          </div>
        </div>
        <div class="alert-action-primary">REVISAR</div>
      </div>
      {% endif %}
      
      <!-- ALERTA 2: Solo si DSO est√° realmente elevado -->
      {% if kpis and kpis.dso_actual and kpis.dso_actual > 80 %}
      <div class="alert-primary warning" onclick="showDSOAlertModal()">
        <div class="alert-severity warning">ALTO</div>
        <div class="alert-content-primary">
          <div class="alert-title-primary">DSO Elevado: {{ "{:.0f}".format(kpis.dso_actual) }} d√≠as</div>
          <div class="alert-subtitle">
            {{ "{:.0f}".format(kpis.dso_actual - 60) }} d√≠as sobre target de 60d ‚Ä¢ Impacta flujo de caja
          </div>
        </div>
        <div class="alert-action-primary">ANALIZAR</div>
      </div>
      {% endif %}
      
      <!-- ALERTA 3: Solo si forecast est√° realmente bajo -->
      {% if kpis and kpis.forecast_7_dias and kpis.forecast_7_dias < 1.0 %}
      <div class="alert-primary info" onclick="showLowCashflowModal()">
        <div class="alert-severity info">MEDIO</div>
        <div class="alert-content-primary">
          <div class="alert-title-primary">Flujo Proyectado Bajo</div>
          <div class="alert-subtitle">
            {% if kpis.forecast_7_dias and kpis.forecast_7_dias > 0 %}
              {% set forecast_m = kpis.forecast_7_dias / 1000000 %}
              {{ "{:.1f}M".format(forecast_m) }} CLP pr√≥ximos 7 d√≠as ‚Ä¢ Revisar pipeline
            {% else %}
              0.0M CLP pr√≥ximos 7 d√≠as ‚Ä¢ Revisar pipeline
            {% endif %}
          </div>
        </div>
        <div class="alert-action-primary">PLANIFICAR</div>
      </div>
      {% endif %}
      
      <!-- ESTADO: Sin alertas cr√≠ticas -->
      {% if not ((kpis and kpis.critical_projects_count and kpis.critical_projects_count > 0) or 
                (kpis and kpis.dso_actual and kpis.dso_actual > 80) or 
                (kpis and kpis.forecast_7_dias and kpis.forecast_7_dias < 1.0)) %}
      <div class="alert-primary success">
        <div class="alert-severity success">NORMAL</div>
        <div class="alert-content-primary">
          <div class="alert-title-primary">Operaciones Estables</div>
          <div class="alert-subtitle">Sin alertas cr√≠ticas ‚Ä¢ Sistemas funcionando correctamente</div>
        </div>
        <div class="alert-status-ok">OK</div>
      </div>
      {% endif %}
    </div>
  </section>

  <!-- AGING DISTRIBUTION MATRIX - Dashboard.tsx Style -->
  <section class="aging-distribution-matrix">
    <div class="matrix-header">
      <div class="matrix-title">
        <h3>AGING DISTRIBUTION MATRIX</h3>
        <div class="matrix-subtitle">Risk-based receivables breakdown by aging periods</div>
      </div>
      <div class="matrix-controls">
        <button class="matrix-action primary" onclick="exportAgingReport()">EXPORT REPORT</button>
        <button class="matrix-action secondary" onclick="refreshAgingData()">REFRESH</button>
      </div>
    </div>
    
    <div class="aging-matrix-grid">
      <!-- 0-15 DAYS -->
      <div class="aging-cell safe" onclick="showAgingDetail('0-15')">
        <div class="aging-cell-header">
          <div class="aging-range">0-15D</div>
          <div class="aging-risk-badge safe">LOW RISK</div>
        </div>
        <div class="aging-cell-main">
          <div class="aging-amount">
            {% set aging_0_15_amount = 0 %}
            {% if kpis and kpis.aging_0_15_amount %}
              {% set aging_0_15_amount = kpis.aging_0_15_amount / 1000000 %}
            {% endif %}
            ${{ "{:.1f}M".format(aging_0_15_amount) if aging_0_15_amount > 0 else "0.0M" }}
          </div>
          <div class="aging-count">
            {% if kpis and kpis.aging_0_15_count %}
              {{ kpis.aging_0_15_count }} invoices
            {% else %}
              0 invoices
            {% endif %}
          </div>
        </div>
        <div class="aging-cell-footer">
          <div class="aging-percentage">
            {% if kpis and kpis.aging_0_15_percentage %}
              {{ "{:.1f}%".format(kpis.aging_0_15_percentage) }}
            {% else %}
              0.0%
            {% endif %}
          </div>
          <div class="aging-bar">
            <div class="aging-fill safe" style="width: {{ kpis.aging_0_15_percentage if kpis and kpis.aging_0_15_percentage else 0 }}%"></div>
          </div>
        </div>
      </div>

      <!-- 16-30 DAYS -->
      <div class="aging-cell good" onclick="showAgingDetail('16-30')">
        <div class="aging-cell-header">
          <div class="aging-range">16-30D</div>
          <div class="aging-risk-badge good">NORMAL</div>
        </div>
        <div class="aging-cell-main">
          <div class="aging-amount">
            {% set aging_16_30_amount = 0 %}
            {% if kpis and kpis.aging_16_30_amount %}
              {% set aging_16_30_amount = kpis.aging_16_30_amount / 1000000 %}
            {% endif %}
            ${{ "{:.1f}M".format(aging_16_30_amount) if aging_16_30_amount > 0 else "0.0M" }}
          </div>
          <div class="aging-count">
            {% if kpis and kpis.aging_16_30_count %}
              {{ kpis.aging_16_30_count }} invoices
            {% else %}
              0 invoices
            {% endif %}
          </div>
        </div>
        <div class="aging-cell-footer">
          <div class="aging-percentage">
            {% if kpis and kpis.aging_16_30_percentage %}
              {{ "{:.1f}%".format(kpis.aging_16_30_percentage) }}
            {% else %}
              0.0%
            {% endif %}
          </div>
          <div class="aging-bar">
            <div class="aging-fill good" style="width: {{ kpis.aging_16_30_percentage if kpis and kpis.aging_16_30_percentage else 0 }}%"></div>
          </div>
        </div>
      </div>

      <!-- 31-45 DAYS -->
      <div class="aging-cell warning" onclick="showAgingDetail('31-45')">
        <div class="aging-cell-header">
          <div class="aging-range">31-45D</div>
          <div class="aging-risk-badge warning">WATCH</div>
        </div>
        <div class="aging-cell-main">
          <div class="aging-amount">
            {% set aging_31_45_amount = 0 %}
            {% if kpis and kpis.aging_31_45_amount %}
              {% set aging_31_45_amount = kpis.aging_31_45_amount / 1000000 %}
            {% endif %}
            ${{ "{:.1f}M".format(aging_31_45_amount) if aging_31_45_amount > 0 else "0.0M" }}
          </div>
          <div class="aging-count">
            {% if kpis and kpis.aging_31_45_count %}
              {{ kpis.aging_31_45_count }} invoices
            {% else %}
              0 invoices
            {% endif %}
          </div>
        </div>
        <div class="aging-cell-footer">
          <div class="aging-percentage">
            {% if kpis and kpis.aging_31_45_percentage %}
              {{ "{:.1f}%".format(kpis.aging_31_45_percentage) }}
            {% else %}
              0.0%
            {% endif %}
          </div>
          <div class="aging-bar">
            <div class="aging-fill warning" style="width: {{ kpis.aging_31_45_percentage if kpis and kpis.aging_31_45_percentage else 0 }}%"></div>
          </div>
        </div>
      </div>

      <!-- 46-60 DAYS -->
      <div class="aging-cell alert" onclick="showAgingDetail('46-60')">
        <div class="aging-cell-header">
          <div class="aging-range">46-60D</div>
          <div class="aging-risk-badge alert">ALERT</div>
        </div>
        <div class="aging-cell-main">
          <div class="aging-amount">
            {% set aging_46_60_amount = 0 %}
            {% if kpis and kpis.aging_46_60_amount %}
              {% set aging_46_60_amount = kpis.aging_46_60_amount / 1000000 %}
            {% endif %}
            ${{ "{:.1f}M".format(aging_46_60_amount) if aging_46_60_amount > 0 else "0.0M" }}
          </div>
          <div class="aging-count">
            {% if kpis and kpis.aging_46_60_count %}
              {{ kpis.aging_46_60_count }} invoices
            {% else %}
              0 invoices
            {% endif %}
          </div>
        </div>
        <div class="aging-cell-footer">
          <div class="aging-percentage">
            {% if kpis and kpis.aging_46_60_percentage %}
              {{ "{:.1f}%".format(kpis.aging_46_60_percentage) }}
            {% else %}
              0.0%
            {% endif %}
          </div>
          <div class="aging-bar">
            <div class="aging-fill alert" style="width: {{ kpis.aging_46_60_percentage if kpis and kpis.aging_46_60_percentage else 0 }}%"></div>
          </div>
        </div>
      </div>

      <!-- 61-90 DAYS -->
      <div class="aging-cell danger" onclick="showAgingDetail('61-90')">
        <div class="aging-cell-header">
          <div class="aging-range">61-90D</div>
          <div class="aging-risk-badge danger">DANGER</div>
        </div>
        <div class="aging-cell-main">
          <div class="aging-amount">
            {% set aging_61_90_amount = 0 %}
            {% if kpis and kpis.aging_61_90_amount %}
              {% set aging_61_90_amount = kpis.aging_61_90_amount / 1000000 %}
            {% endif %}
            ${{ "{:.1f}M".format(aging_61_90_amount) if aging_61_90_amount > 0 else "0.0M" }}
          </div>
          <div class="aging-count">
            {% if kpis and kpis.aging_61_90_count %}
              {{ kpis.aging_61_90_count }} invoices
            {% else %}
              0 invoices
            {% endif %}
          </div>
        </div>
        <div class="aging-cell-footer">
          <div class="aging-percentage">
            {% if kpis and kpis.aging_61_90_percentage %}
              {{ "{:.1f}%".format(kpis.aging_61_90_percentage) }}
            {% else %}
              0.0%
            {% endif %}
          </div>
          <div class="aging-bar">
            <div class="aging-fill danger" style="width: {{ kpis.aging_61_90_percentage if kpis and kpis.aging_61_90_percentage else 0 }}%"></div>
          </div>
        </div>
      </div>

      <!-- +90 DAYS -->
      <div class="aging-cell critical" onclick="showAgingDetail('90+')">
        <div class="aging-cell-header">
          <div class="aging-range">+90D</div>
          <div class="aging-risk-badge critical">CRITICAL</div>
        </div>
        <div class="aging-cell-main">
          <div class="aging-amount">
            {% set aging_90_plus_amount = 0 %}
            {% if kpis and kpis.aging_90_plus_amount %}
              {% set aging_90_plus_amount = kpis.aging_90_plus_amount / 1000000 %}
            {% endif %}
            ${{ "{:.1f}M".format(aging_90_plus_amount) if aging_90_plus_amount > 0 else "0.0M" }}
          </div>
          <div class="aging-count">
            {% if kpis and kpis.aging_90_plus_count %}
              {{ kpis.aging_90_plus_count }} invoices
            {% else %}
              0 invoices
            {% endif %}
          </div>
        </div>
        <div class="aging-cell-footer">
          <div class="aging-percentage">
            {% if kpis and kpis.aging_90_plus_percentage %}
              {{ "{:.1f}%".format(kpis.aging_90_plus_percentage) }}
            {% else %}
              0.0%
            {% endif %}
          </div>
          <div class="aging-bar">
            <div class="aging-fill critical" style="width: {{ kpis.aging_90_plus_percentage if kpis and kpis.aging_90_plus_percentage else 0 }}%"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Matrix Summary -->
    <div class="aging-matrix-summary">
      <div class="summary-metric">
        <div class="summary-label">TOTAL RECEIVABLES</div>
        <div class="summary-value">
          {% set total_receivables = 0 %}
          {% if kpis and kpis.total_monto_propuesto %}
            {% set total_receivables = kpis.total_monto_propuesto / 1000000 %}
          {% endif %}
          ${{ "{:.1f}M".format(total_receivables) if total_receivables > 0 else "0.0M" }}
        </div>
      </div>
      <div class="summary-metric">
        <div class="summary-label">WEIGHTED AVG DAYS</div>
        <div class="summary-value">
          {% if kpis and kpis.dso_actual and kpis.dso_actual > 0 %}
            {{ "{:.0f}D".format(kpis.dso_actual) }}
          {% else %}
            --D
          {% endif %}
        </div>
      </div>
      <div class="summary-metric">
        <div class="summary-label">AT RISK</div>
        <div class="summary-value critical">
          {% set at_risk = 0 %}
          {% if kpis and kpis.aging_46_60_amount and kpis.aging_61_90_amount and kpis.aging_90_plus_amount %}
            {% set at_risk = (kpis.aging_46_60_amount + kpis.aging_61_90_amount + kpis.aging_90_plus_amount) / 1000000 %}
          {% endif %}
          ${{ "{:.1f}M".format(at_risk) if at_risk > 0 else "0.0M" }}
        </div>
      </div>
      <div class="summary-metric">
        <div class="summary-label">COLLECTION EFFICIENCY</div>
        <div class="summary-value {{ 'positive' if kpis and kpis.collection_efficiency and kpis.collection_efficiency > 85 else 'warning' if kpis and kpis.collection_efficiency and kpis.collection_efficiency > 70 else 'critical' }}">
          {% if kpis and kpis.collection_efficiency and kpis.collection_efficiency > 0 %}
            {{ "{:.0f}%".format(kpis.collection_efficiency) }}
          {% else %}
            --%
          {% endif %}
        </div>
      </div>
    </div>
  </section>

  <!-- Main Analytics Grid -->
  <section class="analytics-grid">
    <!-- DSO Heatmap by Project Manager -->
    <div class="chart-panel half">
      <div class="chart-header">
        <div class="chart-title">DSO por Jefe Proyecto</div>
        <button class="chart-action critical" onclick="coordinateManagers()">Coordinar</button>
      </div>
      <div class="chart-container">
        <div class="dso-heatmap">
          {% if equipo_operacional and equipo_operacional|length > 0 %}
            <!-- DEBUG: Show equipo_operacional data -->
            <script>
              console.log('üîç Equipo Operacional Data:', {{ equipo_operacional | tojson }});
            </script>
            {% for jefe in equipo_operacional %}
            <div class="dso-cell {{ 'critical' if (jefe.dso_days or 0) > 60 else 'warning' if (jefe.dso_days or 0) > 40 else 'good' if (jefe.dso_days or 0) > 0 else 'neutral' }}" 
                 onclick="showManagerDetail('{{ jefe.nombre or "Sin Nombre" }}', '{{ jefe.dso_days or 0 }}d', '{{ "{:.1f}M".format((jefe.monto_gestionado or 0) / 1000000) }} CLP', '{{ jefe.proyectos_count or 0 }} proyectos')">
              <div class="dso-manager">
                {% if jefe.nombre and jefe.nombre.strip() %}
                  {{ jefe.nombre[:25] }}{{ "..." if jefe.nombre|length > 25 else "" }}
                {% else %}
                  SIN NOMBRE
                {% endif %}
              </div>
              <div class="dso-days" style="color: {{ '#ff0066' if (jefe.dso_days or 0) > 60 else '#ffa500' if (jefe.dso_days or 0) > 40 else '#00ff88' if (jefe.dso_days or 0) > 0 else '#888888' }}">
                {% if jefe.dso_days and jefe.dso_days > 0 %}
                  {{ jefe.dso_days }}d
                {% else %}
                  --
                {% endif %}
              </div>
              <div class="dso-amount">
                {% if jefe.monto_gestionado and jefe.monto_gestionado > 0 %}
                  {{ "{:.1f}M CLP".format(jefe.monto_gestionado / 1000000) }}
                {% else %}
                  Sin datos
                {% endif %}
              </div>
              <div class="dso-projects">
                {% if jefe.proyectos_count and jefe.proyectos_count > 0 %}
                  {{ jefe.proyectos_count }} proyectos
                {% else %}
                  Sin proyectos
                {% endif %}
              </div>
            </div>
            {% endfor %}
          {% else %}
            <div class="no-data-message">
              <div class="no-data-text">Sin datos de equipo operacional</div>
              <div class="no-data-subtext">Los datos aparecer√°n cuando haya proyectos con jefe asignado</div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Cash Flow Forecast Chart -->
    <div class="chart-panel half">
      <div class="chart-header">
        <div class="chart-title" onclick="showWeeklyForecastModal()" style="cursor: pointer;">Forecast Ingresos - Pr√≥ximos 7 D√≠as</div>
        <button class="chart-action" onclick="exportForecast()">Exportar</button>
      </div>
      <div class="chart-subheader">
        <div class="chart-clarification">% = Probabilidad de cobro</div>
      </div>
      <div class="chart-container">
        <div class="cashflow-bars">
          {% if kpis and (kpis.forecast_day_1 or kpis.forecast_day_2 or kpis.forecast_day_3 or kpis.forecast_day_4 or kpis.forecast_day_5 or kpis.forecast_day_6 or kpis.forecast_day_7) %}
            {% set forecast_data = [
              {'day': 'Lun', 'amount': kpis.forecast_day_1 or 0, 'prob': 0},
              {'day': 'Mar', 'amount': kpis.forecast_day_2 or 0, 'prob': 0},
              {'day': 'Mi√©', 'amount': kpis.forecast_day_3 or 0, 'prob': 0},
              {'day': 'Jue', 'amount': kpis.forecast_day_4 or 0, 'prob': 0},
              {'day': 'Vie', 'amount': kpis.forecast_day_5 or 0, 'prob': 0},
              {'day': 'S√°b', 'amount': kpis.forecast_day_6 or 0, 'prob': 0},
              {'day': 'Dom', 'amount': kpis.forecast_day_7 or 0, 'prob': 0}
            ] %}
            {% set max_amount = forecast_data | map(attribute='amount') | max %}
            {% if max_amount > 0 %}
              {% for item in forecast_data %}
              <div class="cashflow-day" onclick="showForecastDetail('{{ item.day }}', '{{ "{:.1f}M".format(item.amount) }}', '{{ item.prob }}% prob')">
                <div class="cashflow-bar" style="height: {{ (item.amount / max_amount * 80) | round(0) }}%">
                  <div class="cashflow-fill {{ 'high' if item.amount > 1.5 else 'medium' if item.amount > 0.5 else 'low' }}" style="height: 100%">
                    {% if item.amount > 0 %}
                      <div class="cashflow-value">{{ "{:.1f}M".format(item.amount) }}</div>
                    {% endif %}
                  </div>
                </div>
                <div class="cashflow-label">{{ item.day }}</div>
                <div class="cashflow-prob {{ 'high-prob' if item.prob > 70 else 'medium-prob' if item.prob > 50 else 'low-prob' if item.prob > 0 else 'no-prob' }}">
                  {% if item.prob > 0 %}{{ item.prob }}%{% else %}--{% endif %}
                </div>
              </div>
              {% endfor %}
            {% endif %}
          {% else %}
            <div class="no-forecast-data">
              <div class="no-forecast-text">Sin datos de forecast disponibles</div>
              <div class="no-forecast-subtext">Los datos se generar√°n cuando haya proyecciones</div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- DSO Trend Chart -->
    <div class="chart-panel half">
      <div class="chart-header">
        <div class="chart-title">Tendencia DSO</div>
        <button class="chart-action" onclick="analyzeDSOTrend()">Analizar</button>
      </div>
      <div class="chart-container">
        {% if kpis and kpis.dso_actual and kpis.dso_actual > 0 %}
          <canvas id="dsoTrendChart"></canvas>
        {% else %}
          <div class="no-chart-data">
            <div class="no-chart-text">Sin datos suficientes para mostrar tendencia DSO</div>
            <div class="no-chart-subtext">Se necesitan datos hist√≥ricos de DSO</div>
          </div>
        {% endif %}
      </div>
    </div>
 <!-- Executive Summary with AI -->
 <div class="executive-summary">
  <div class="summary-header">
    <div class="summary-title">
      <span>Resumen Ejecutivo</span>
      <div class="ai-badge">AI</div>
    </div>
    <div class="summary-confidence">
      <span>Confianza: {{ "94%" if kpis and kpis.ingresos_totales and kpis.ingresos_totales > 0 else "N/A" }}</span>
      <div class="confidence-bar">
        <div class="confidence-fill" style="width: {{ "94%" if kpis and kpis.ingresos_totales and kpis.ingresos_totales > 0 else "0%" }}"></div>
      </div>
    </div>
  </div>
  <div class="summary-content">
    <div class="summary-text">
      {% if kpis and kpis.ingresos_totales and kpis.ingresos_totales > 0 %}
        El portfolio presenta 
        <span class="summary-highlight">ingresos registrados</span> por
        <span class="summary-highlight">${{ "{:.1f}".format(kpis.ingresos_totales) }}M CLP</span>.
        {% if kpis.crecimiento_ingresos and kpis.crecimiento_ingresos > 0 %}
          Los ingresos han incrementado
          <span class="summary-highlight">{{ "{:.1f}".format(kpis.crecimiento_ingresos) }}%</span>
          vs per√≠odo anterior.
        {% endif %}
        {% if kpis.efficiency_score and kpis.efficiency_score > 0 %}
          La eficiencia operacional es del
          <span class="summary-highlight">{{ "{:.1f}".format(kpis.efficiency_score) }}%</span>.
        {% endif %}
        {% if kpis.critical_projects_count and kpis.critical_projects_count > 0 %}
          Se detectaron <span class="summary-highlight critical">{{ kpis.critical_projects_count }}</span> proyectos cr√≠ticos que requieren atenci√≥n.
        {% else %}
          No se detectaron proyectos en estado cr√≠tico.
        {% endif %}
      {% else %}
        El sistema est√° configurado y listo para analizar datos. 
        Las m√©tricas de rendimiento se mostrar√°n una vez que se registren EDPs y transacciones en el sistema.
      {% endif %}
    </div>
    <div class="summary-metrics">
      <div class="summary-metric">
        <div class="metric-label">ROI Promedio</div>
        <div class="metric-value">
          {% if kpis and kpis.roi_promedio and kpis.roi_promedio > 0 %}
            {{ "{:.1f}".format(kpis.roi_promedio) }}%
          {% else %}
            --
          {% endif %}
        </div>
      </div>
      <div class="summary-metric">
        <div class="metric-label">Proyectos Completados</div>
        <div class="metric-value">
          {{ kpis.proyectos_completados if kpis and kpis.proyectos_completados else 0 }}
        </div>
      </div>
      <div class="summary-metric">
        <div class="metric-label">Satisfacci√≥n Cliente</div>
        <div class="metric-value">
          {% if kpis and kpis.satisfaccion_cliente and kpis.satisfaccion_cliente > 0 %}
            {{ "{:.0f}".format(kpis.satisfaccion_cliente) }}%
          {% else %}
            --
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
  
  </section>

 
</div>



{% include 'management/modal-proyectos-criticos.html' %} {% endblock %}
